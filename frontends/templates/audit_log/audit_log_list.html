{% extends 'default/dashboard.html' %}
{% load i18n %}
{% load static %}

{% block title %}{% translate "System Audit Log" %}{% endblock %}


{% block extra_dashboard_css %}
<!--  Use external CSS -->
<link rel="stylesheet" href="{% static 'css/studies/study_43en/audit_log.css' %}">
{% endblock %}

{% block dashboard_content %}
<section class="content-header">
    <div class="container-fluid">
        <h1 class="h3 mb-0">
            {% translate "System Audit Log" %}
        </h1>
    </div>
</section>

<section class="content">
    <!-- Filter Card -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="bi bi-funnel me-2"></i>{% translate "Filters" %}
                </h3>
                <!--  Bootstrap 5 collapse button -->
                <button class="btn btn-sm btn-light" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#filterCollapse"
                        aria-expanded="true">
                    <i class="bi bi-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="collapse show" id="filterCollapse">
            <div class="card-body">
            <form method="get" action="">
                <div class="row">
                    <!-- User Filter -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="user">
                                <i class="fas fa-user mr-1"></i>
                                {% translate "User" %}
                            </label>
                            <select class="form-control select2" id="user" name="user">
                                <option value="">{% translate "All" %}</option>
                                {% for user_obj in users %}
                                    <option value="{{ user_obj.id }}" 
                                        {% if filters.user_id == user_obj.id|stringformat:"s" %}selected{% endif %}>
                                        {{ user_obj.username }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Action Filter -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="action">
                                <i class="fas fa-tasks mr-1"></i>
                                {% translate "Action" %}
                            </label>
                            <select class="form-control" id="action" name="action">
                                <option value="">{% translate "All" %}</option>
                                {% for action_choice in actions %}
                                    <option value="{{ action_choice }}" 
                                        {% if filters.action == action_choice %}selected{% endif %}>
                                        {{ action_choice }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Model Filter -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="model_name">
                                <i class="fas fa-table mr-1"></i>
                                {% translate "Data Table" %}
                            </label>
                            <select class="form-control" id="model_name" name="model_name">
                                <option value="">{% translate "All" %}</option>
                                {% for model in model_names %}
                                    <option value="{{ model }}" 
                                        {% if filters.model_name == model %}selected{% endif %}>
                                        {{ model }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Patient ID -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="patient_id">
                                <i class="fas fa-id-card mr-1"></i>
                                {% translate "Patient ID" %}
                            </label>
                            <input type="text" class="form-control" id="patient_id" 
                                   name="patient_id" value="{{ filters.patient_id }}"
                                   placeholder="PS0001, 01-001...">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Start Date -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="start_date">
                                <i class="fas fa-calendar mr-1"></i>
                                {% translate "From Date" %}
                            </label>
                            <input type="date" class="form-control" id="start_date" 
                                   name="start_date" value="{{ filters.start_date|date:'Y-m-d' }}">
                        </div>
                    </div>
                    
                    <!-- End Date -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="end_date">
                                <i class="fas fa-calendar mr-1"></i>
                                {% translate "To Date" %}
                            </label>
                            <input type="date" class="form-control" id="end_date" 
                                   name="end_date" value="{{ filters.end_date|date:'Y-m-d' }}">
                        </div>
                    </div>
                    
                    <!-- Search Query -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="q">
                                <i class="fas fa-search mr-1"></i>
                                {% translate "Search" %}
                            </label>
                            <input type="text" class="form-control" id="q" 
                                   name="q" value="{{ filters.query }}"
                                   placeholder="Username, Patient ID...">
                        </div>
                    </div>
                    
                    <!-- Buttons -->
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="form-group w-100">
                            <button type="submit" class="btn btn-primary btn-block">
                                <i class="fas fa-search"></i> {% translate "Search" %}
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <a href="/studies/{{ study_code }}/dashboard/" class="btn btn-default">Dashboard</a>
                            <i class="fas fa-sync"></i> {% translate "Reset Filters" %}
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Table -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    {% translate "Audit Log List" %}
                </h3>
                <span class="badge bg-light text-dark">
                    {% translate "Total:" %} {{ page_obj.paginator.count }} {% translate "records" %}
                </span>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark"> <!--  BS5 table-dark -->
                        <tr>
                            <th class="text-center">{% translate "Timestamp" %}</th>
                            <th class="text-center">{% translate "User" %}</th>
                            <th class="text-center">{% translate "Action" %}</th>
                            <th class="text-center">{% translate "Table" %}</th>
                            <th class="text-center">{% translate "Patient" %}</th>
                            <th class="text-center">{% translate "IP" %}</th>
                            <th class="text-center">{% translate "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in page_obj %}
                            <tr>
                                <td class="text-center">
                                    <small class="d-block">{{ log.timestamp|date:"d/m/Y" }}</small>
                                    <strong>{{ log.timestamp|date:"H:i:s" }}</strong>
                                </td>
                                <td class="text-center">
                                    <i class="bi bi-person-circle text-info me-1"></i>
                                    {{ log.username }}
                                </td>
                                <td class="text-center">
                                    {% if log.action == 'CREATE' %}
                                        <!--  BS5 badges -->
                                        <span class="badge bg-success">
                                            <i class="bi bi-plus"></i> Create
                                        </span>
                                    {% elif log.action == 'UPDATE' %}
                                        <span class="badge bg-warning">
                                            <i class="bi bi-pencil"></i> Update
                                        </span>
                                    {% elif log.action == 'DELETE' %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-trash"></i> Delete
                                        </span>
                                    {% else %}
                                        <span class="badge bg-info">
                                            <i ></i> View
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <code class="bg-light p-1">{{ log.model_name }}</code>
                                </td>
                                <td class="text-center">
                                    <strong>{{ log.patient_id }}</strong>
                                    {% if log.SITEID %}
                                        <br><small class="text-muted">Site: {{ log.SITEID }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <small><code>{{ log.ip_address|default:"N/A" }}</code></small>
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'study_'|add:study_code|lower|add:':audit_log_detail' log.id %}" 
                                       class="btn btn-sm btn-info">
                                        {% translate "Detail" %}
                                    </a>
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 mb-3 d-block"></i>
                                    {% translate "No audit logs found" %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!--  BS5 Pagination -->
        {% if page_obj.paginator.num_pages > 1 %}
        <div class="card-footer">
            <div class="row align-items-center">
                <div class="col-md-5">
                    <div class="text-muted small">
                        Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} 
                        of {{ page_obj.paginator.count }} records
                    </div>
                </div>
                <div class="col-md-7">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-end mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="bi bi-chevron-bar-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}

                            {% for i in page_obj.paginator.page_range %}
                                {% if page_obj.number == i %}
                                    <li class="page-item active" aria-current="page">
                                        <span class="page-link">{{ i }}</span>
                                    </li>
                                {% elif i > page_obj.number|add:"-3" and i < page_obj.number|add:"3" %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            {{ i }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                        <i class="bi bi-chevron-bar-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
<script nonce="{{ request.csp_nonce }}">
(function() {
    'use strict';
    
    if (window.auditLogListInitialized) {
        console.warn('[AuditLogList] Already initialized, skipping...');
        return;
    }
    window.auditLogListInitialized = true;
    
    $(document).ready(function() {
        console.log('[AuditLogList] Initializing...');
        
        // Initialize Select2 for user filter
        if (typeof $.fn.select2 !== 'undefined') {
            $('.select2').select2({
                placeholder: 'Select user...',
                allowClear: true,
                width: '100%'
            });
            console.log('[AuditLogList] Select2 initialized');
        }
        
        //  FORCE NAVIGATION - Like screening list
        $(document).on('click', '.btn-view-audit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            var href = $(this).attr('href');
            var logId = $(this).data('log-id');
            
            console.log('[AuditLogList] View clicked:', {
                logId: logId,
                href: href
            });
            
            //  FORCE navigation
            console.log('[AuditLogList] Force navigating to:', href);
            window.location.href = href;
            
            return false;
        });
        
        // Row hover effect
        $('tbody tr').hover(
            function() { $(this).addClass('table-active'); },
            function() { $(this).removeClass('table-active'); }
        );
        
        // Optional: Auto-submit on filter change
        $('#action, #model_name, #user').on('change', function() {
            // Uncomment to enable auto-submit on filter change
            // $(this).closest('form').submit();
        });
        
        // Log statistics
        var totalLogs = parseInt("{{ page_obj.paginator.count|default:0 }}");
        var currentPage = parseInt("{{ page_obj.number|default:1 }}");
        var totalPages = parseInt("{{ page_obj.paginator.num_pages|default:1 }}");
        
        console.log('[AuditLogList] Statistics:', {
            total: totalLogs,
            page: currentPage + '/' + totalPages
        });
        
        console.log('[AuditLogList] Initialized successfully');
    });
    
})();
</script>
{% endblock %}