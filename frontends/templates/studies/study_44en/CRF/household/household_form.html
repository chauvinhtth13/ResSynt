{% extends 'studies\study_44en\home_dashboard.html' %}
{% load static %}
{% load l10n %}

{% block dashboard_content %}
<div class="container-fluid">
    <h4 class="text-center fw-bold mb-4">A – HOUSEHOLD QUESTIONNAIRE</h4>
    
    <!-- Display form errors -->
    {% if household_form.errors or personal_data_form.errors or member_formset.errors or member_formset.non_form_errors %}
    <div class="alert alert-danger" role="alert">
        <h5>Form Validation Errors:</h5>
        
        {% if household_form.errors %}
        <p><strong>Household form errors:</strong></p>
        <ul>
            {% for field, errors in household_form.errors.items %}
            <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {% if personal_data_form.errors %}
        <p><strong>Address form errors:</strong></p>
        <ul>
            {% for field, errors in personal_data_form.errors.items %}
            <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        
        {% if member_formset.non_form_errors %}
        <p><strong>Member formset errors:</strong></p>
        <ul>
            {% for error in member_formset.non_form_errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}

    <form method="post" action="" id="householdCaseForm">
        {% csrf_token %}
        
        <!-- Hidden required fields -->
        <input type="hidden" name="STUDYID" value="44EN">
        <input type="hidden" name="CITY" value="Ho Chi Minh City">
        
        <!-- HHID field - leave empty for auto-generation -->
        <input type="hidden" name="HHID" value="{{ household.HHID|default:'' }}">
        
        <!-- Member formset management form (REQUIRED for formset to work) -->
        {{ member_formset.management_form }}
        
        {% if household and household.HHID %}
        <div class="mb-4">
            <span class="fw-bold">Household ID: {{ household.HHID }}</span>
        </div>
        {% else %}
        <div class="mb-4 text-muted">
            <small><em>Household ID will be auto-generated after saving</em></small>
        </div>
        {% endif %}

        <hr class="my-4">

            <!-- Respondent Member Number - auto-selected from member list -->
            <input type="hidden" name="RESPONDENT_MEMBER_NUM" value="{% if household_form.RESPONDENT_MEMBER_NUM.value %}{{ household_form.RESPONDENT_MEMBER_NUM.value }}{% elif household.RESPONDENT_MEMBER_NUM %}{{ household.RESPONDENT_MEMBER_NUM }}{% endif %}">
            <div class="mb-3 text-muted">
                <small><em>Note: Respondent will be selected from the member list below by checking "Is Respondent"</em></small>
            </div>

            <!-- ========================================= -->
            <!-- SMART ADDRESS SELECTION (CDN-based)        -->
            <!-- ========================================= -->
            <div class="mb-3">
                <p class="fw-bold mb-2">2. Household Address:</p>
                <div class="ms-md-3">
                    
                    <!-- District -->
                    <div class="mb-3">
                        <label class="form-label">Quận/Huyện: <span class="text-danger">*</span></label>
                        <select class="form-select" id="district-select" required>
                            <option value="">-- Loading... --</option>
                        </select>
                    </div>
                    
                    <!-- Ward -->
                    <div class="mb-3">
                        <label class="form-label">Phường/Xã: <span class="text-danger">*</span></label>
                        <select class="form-select" id="ward-select" disabled required>
                            <option value="">-- Chọn Quận/Huyện trước --</option>
                        </select>
                    </div>
                    
                    <!-- Street Autocomplete -->
                    <div class="mb-3 position-relative">
                        <label class="form-label">Tên đường:</label>
                        <input type="text" 
                            class="form-control" 
                            id="street-autocomplete"
                            placeholder="Gõ tên đường..."
                            autocomplete="off">
                        <div id="street-suggestions" class="list-group position-absolute w-100" 
                            style="z-index: 1000; max-height: 300px; overflow-y: auto; display: none;"></div>
                    </div>
                    
                    <!-- Full Address -->
                    <div class="mb-3">
                        <label class="form-label">Số nhà, Chi tiết:</label>
                        <input type="text" 
                            name="STREET" 
                            id="full-address-input"
                            class="form-control" 
                            placeholder="123/45, Căn hộ A1..."
                            value="{% firstof personal_data_form.STREET.value household.STREET '' %}">
                    </div>
                    
                    <!-- Hidden WARD field -->
                    <input type="hidden" name="WARD" id="ward-hidden-input" 
                        value="{% firstof personal_data_form.WARD.value household.WARD '' %}">
                    
                    <!-- Address Preview -->
                    <div class="alert alert-info" id="address-preview" style="display: none;">
                        <strong> Địa chỉ đầy đủ:</strong>
                        <div id="address-preview-text" class="mt-2"></div>
                    </div>
                    
                    <div class="mt-3"><strong>TP. Hồ Chí Minh</strong></div>
                </div>
            </div>


            <div class="mb-3 d-flex align-items-center">
                <p class="fw-bold mb-0 me-3">3. Total number of household members:</p>
                <input type="number" class="form-control text-center d-inline-block" name="TOTAL_MEMBERS" value="{% if household_form.TOTAL_MEMBERS.value %}{{ household_form.TOTAL_MEMBERS.value }}{% elif household.TOTAL_MEMBERS %}{{ household.TOTAL_MEMBERS }}{% endif %}" min="1" max="10" style="width: 100px;">
            </div>

            <!-- Rest of form remains the same... -->
            <!-- (Keep all existing sections from line 140 onwards) -->

            <div class="mb-4">
                <p class="fw-bold mb-2">4. Description of all household members:</p>

                <div class="table-responsive mb-4 ms-md-3">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 40px;">#</th>
                                <th style="width: 220px;">Mối quan hệ với chủ hộ</th>
                                <th style="width: 120px;" class="text-center">Năm sinh</th>
                                <th style="width: 120px;" class="text-center">Giới tính</th>
                                <th style="width: 120px;" class="text-center">Là người trả lời</th>
                            </tr>
                        </thead>
                        <tbody id="members-table-body">
                            {% for form in member_formset %}
                            <tr class="member-row" data-form-index="{{ forloop.counter0 }}">
                                <td class="text-center">
                                    {{ form.id }}
                                    {{ form.MEMBERID }}
                                    <input type="hidden" name="{{ form.MEMBER_NUM.html_name }}" value="{{ form.MEMBER_NUM.value|default:forloop.counter }}" class="member-num-input">
                                    <input type="hidden" name="{{ form.CHILD_ORDER.html_name }}" value="{{ form.CHILD_ORDER.value|default:'' }}" class="child-order-input">
                                    {{ forloop.counter }}
                                </td>
                                <td>
                                    <select class="form-select form-select-sm relationship-select" name="{{ form.RELATIONSHIP.html_name }}" id="{{ form.RELATIONSHIP.id_for_label }}">
                                        <option value="">Chọn mối quan hệ...</option>
                                        <option value="A" {% if form.RELATIONSHIP.value == 'A' %}selected{% endif %}>A. Chủ hộ</option>
                                        <option value="B" {% if form.RELATIONSHIP.value == 'B' %}selected{% endif %}>B. Vợ</option>
                                        <option value="C" {% if form.RELATIONSHIP.value == 'C' %}selected{% endif %}>C. Chồng</option>
                                        <option value="D" {% if form.RELATIONSHIP.value == 'D' %}selected{% endif %} class="child-option">D. Con</option>
                                        <option value="E" {% if form.RELATIONSHIP.value == 'E' %}selected{% endif %}>E. Bố/Mẹ</option>
                                        <option value="F" {% if form.RELATIONSHIP.value == 'F' %}selected{% endif %}>F. Ông/Bà</option>
                                        <option value="G" {% if form.RELATIONSHIP.value == 'G' %}selected{% endif %}>G. Khác</option>
                                    </select>
                                </td>
                                <td>{% localize off %}<input type="text" class="form-control form-control-sm text-center" name="{{ form.BIRTH_YEAR.html_name }}" id="{{ form.BIRTH_YEAR.id_for_label }}" value="{{ form.BIRTH_YEAR.value|default:'' }}" pattern="[0-9]{4}" maxlength="4" placeholder="YYYY">{% endlocalize %}</td>
                                <td>
                                    <select class="form-select form-select-sm" name="{{ form.GENDER.html_name }}" id="{{ form.GENDER.id_for_label }}">
                                        <option value="">Chọn...</option>
                                        <option value="Male" {% if form.GENDER.value == 'Male' %}selected{% endif %}>Nam</option>
                                        <option value="Female" {% if form.GENDER.value == 'Female' %}selected{% endif %}>Nữ</option>
                                    </select>
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" name="{{ form.ISRESPONDENT.html_name }}" id="{{ form.ISRESPONDENT.id_for_label }}" value="1" {% if form.ISRESPONDENT.value %}checked{% endif %}>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Keep all other sections (income, ownership, house details, assets, etc.) -->
            <!-- Copy from original template lines 191-450 -->

<!-- Submit Buttons -->
        <div class="mt-5 text-center">
            <button type="submit" class="btn btn-primary btn-lg px-5 me-2">Save & Continue to Part B</button>
            <a href="{% url 'study_44en:household:list' %}" class="btn btn-secondary btn-lg px-5">Cancel</a>
        </div>
    </form>
</div>

<!-- Change Reason Modal -->
{% include 'default/change_reason_modal.html' %}

{% endblock %}

{% block dashboard_js %}
{# Smart Address - External JS File #}
<script src="{% static 'studies/study_44en/js/smart_address_hcmc.js' %}"></script>

{# Other scripts #}
<script src="{% static 'studies/study_44en/js/change-reason-handler.js' %}"></script>
{% endblock %}