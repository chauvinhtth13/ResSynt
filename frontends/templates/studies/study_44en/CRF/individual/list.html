{% extends 'default/dashboard.html' %}
{% load static i18n %}

{% block title %}{% trans "Individual List" %} - 44EN Study{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col">
      <h2 class="mb-3">
        <i class="bi bi-people"></i> {% trans "Individual List" %}
      </h2>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <a href="{% url 'study_44en:individual:create' %}" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> {% trans "New Individual" %}
        </a>
        <form method="get" class="d-flex gap-2">
          <input type="search" name="search" class="form-control" placeholder="{% trans 'Search by Subject ID, Initials...' %}" value="{{ search_query }}" style="min-width: 300px;">
          <button type="submit" class="btn btn-secondary">
            <i class="bi bi-search"></i> {% trans "Search" %}
          </button>
          {% if search_query %}
          <a href="{% url 'study_44en:individual:list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-circle"></i> {% trans "Clear" %}
          </a>
          {% endif %}
        </form>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center border-primary">
        <div class="card-body">
          <h6 class="text-muted mb-2">Total Individuals</h6>
          <h3 class="text-primary mb-0">{{ total_count|default:0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center border-success">
        <div class="card-body">
          <h6 class="text-muted mb-2">With Exposure Data</h6>
          <h3 class="text-success mb-0">{{ exposure_count|default:0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center border-info">
        <div class="card-body">
          <h6 class="text-muted mb-2">With Follow-ups</h6>
          <h3 class="text-info mb-0">{{ followup_count|default:0 }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center border-warning">
        <div class="card-body">
          <h6 class="text-muted mb-2">With Samples</h6>
          <h3 class="text-warning mb-0">{{ sample_count|default:0 }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Individuals Table -->
  <div class="row">
    <div class="col">
      <div class="card">
        <div class="card-header bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              {% if search_query %}
                Search Results ({{ individuals.paginator.count }} found)
              {% else %}
                All Individuals ({{ individuals.paginator.count }})
              {% endif %}
            </h5>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
              <thead class="table-light sticky-top">
                <tr>
                  <th style="width: 12%;">{% trans "Subject ID" %}</th>
                  <th style="width: 10%;">{% trans "Initials" %}</th>
                  <th style="width: 8%;">{% trans "Age" %}</th>
                  <th style="width: 10%;">{% trans "Gender" %}</th>
                  <th style="width: 12%;">{% trans "Occupation" %}</th>
                  <th style="width: 10%;">{% trans "Education" %}</th>
                  <th style="width: 8%;" class="text-center">{% trans "Exposure" %}</th>
                  <th style="width: 8%;" class="text-center">{% trans "Follow-ups" %}</th>
                  <th style="width: 8%;" class="text-center">{% trans "Samples" %}</th>
                  <th style="width: 14%;">{% trans "Actions" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for individual in individuals %}
                <tr>
                  <td>
                    <a href="{% url 'study_44en:individual:detail' subjectid=individual.SUBJECTID %}" class="fw-bold text-decoration-none">
                      {{ individual.SUBJECTID }}
                    </a>
                  </td>
                  <td>{{ individual.INITIALS|default:"-" }}</td>
                  <td>
                    {% if individual.calculated_age %}
                      {{ individual.calculated_age|floatformat:0 }}
                      <small class="text-muted">({{ individual.age_category }})</small>
                    {% elif individual.AGE %}
                      {{ individual.AGE }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if individual.MEMBERID %}
                      {{ individual.MEMBERID.get_GENDER_display|default:individual.MEMBERID.GENDER }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    <span data-bs-toggle="tooltip" title="{{ individual.get_OCCUPATION_display }}">
                      {% if individual.OCCUPATION_DETAIL %}
                        {{ individual.OCCUPATION_DETAIL|truncatechars:20 }}
                      {% else %}
                        {{ individual.get_OCCUPATION_display|truncatechars:20|default:"-" }}
                      {% endif %}
                    </span>
                  </td>
                  <td>
                    <small>{{ individual.get_EDUCATION_display|truncatechars:15|default:"-" }}</small>
                  </td>
                  <td class="text-center">
                    {% if individual.has_exposure %}
                      <span class="badge bg-success">
                        <i class="bi bi-check-circle"></i>
                      </span>
                    {% else %}
                      <span class="badge bg-secondary">-</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% if individual.followup_count > 0 %}
                      <span class="badge bg-info">{{ individual.followup_count }}</span>
                    {% else %}
                      <span class="badge bg-secondary">0</span>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% if individual.sample_count > 0 %}
                      <span class="badge bg-warning text-dark">{{ individual.sample_count }}</span>
                    {% else %}
                      <span class="badge bg-secondary">0</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{% url 'study_44en:individual:detail' subjectid=individual.SUBJECTID %}" 
                         class="btn btn-outline-info" 
                         data-bs-toggle="tooltip" 
                         title="{% trans 'View Details' %}">
                        <i class="bi bi-eye"></i>
                      </a>
                      <a href="{% url 'study_44en:individual:update' subjectid=individual.SUBJECTID %}" 
                         class="btn btn-outline-primary"
                         data-bs-toggle="tooltip" 
                         title="{% trans 'Edit' %}">
                        <i class="bi bi-pencil"></i>
                      </a>
                      <a href="{% url 'study_44en:individual:exposure' subjectid=individual.SUBJECTID %}" 
                         class="btn btn-outline-success"
                         data-bs-toggle="tooltip" 
                         title="{% trans 'Exposure' %}">
                        <i class="bi bi-clipboard-data"></i>
                      </a>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="10" class="text-center text-muted py-5">
                    {% if search_query %}
                      <i class="bi bi-search display-4 d-block mb-3 text-muted"></i>
                      <p class="mb-2">{% trans "No individuals found matching your search." %}</p>
                      <a href="{% url 'study_44en:individual:list' %}" class="btn btn-sm btn-outline-secondary">
                        {% trans "Clear Search" %}
                      </a>
                    {% else %}
                      <i class="bi bi-people display-4 d-block mb-3 text-muted"></i>
                      <p class="mb-2">{% trans "No individuals recorded yet." %}</p>
                      <a href="{% url 'study_44en:individual:create' %}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus-circle"></i> {% trans "Add First Individual" %}
                      </a>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          {% if individuals.has_other_pages %}
          <div class="card-footer bg-light">
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center mb-0">
                {% if individuals.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">
                    {% trans "First" %}
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ individuals.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="bi bi-chevron-left"></i> {% trans "Previous" %}
                  </a>
                </li>
                {% endif %}

                {% for num in individuals.paginator.page_range %}
                  {% if individuals.number == num %}
                  <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                  </li>
                  {% elif num > individuals.number|add:'-3' and num < individuals.number|add:'3' %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">
                      {{ num }}
                    </a>
                  </li>
                  {% endif %}
                {% endfor %}

                {% if individuals.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ individuals.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                    {% trans "Next" %} <i class="bi bi-chevron-right"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ individuals.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">
                    {% trans "Last" %}
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
            <div class="text-center text-muted small mt-2">
              {% trans "Page" %} {{ individuals.number }} {% trans "of" %} {{ individuals.paginator.num_pages }}
              ({{ individuals.paginator.count }} {% trans "total" %})
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .card {
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .table thead.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  
  .badge {
    font-weight: 500;
  }
</style>

<script>
  // Initialize Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>

{% endblock %}
