{% extends 'default/dashboard.html' %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block title %}{% trans "Form Thông Tin Lâm Sàng 43EN" %}{% endblock %}

{% block page_title %}{% trans "Form Thông Tin Lâm Sàng 43EN" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'screening_case_list' %}">{% trans "Danh sách Bệnh nhân 43EN" %}</a></li>                
<li class="breadcrumb-item"><a href="{% url 'patient_detail' usubjid=enrollment_case.USUBJID %}">{% trans "Bệnh nhân" %} {{ enrollment_case.USUBJID }}</a></li>
<li class="breadcrumb-item active">{% trans "Thông tin lâm sàng" %}</li>
{% endblock %}

<script>
  var isReadOnly = {% if is_readonly %}true{% else %}false{% endif %};
</script>

{% block extra_head_dashboard %}
<!-- Link to custom CSS -->
<link rel="stylesheet" href="{% static 'css/clinical_form.css' %}">
{% endblock %}

{% block dashboard_content %}

<div class="row">
  <div class="col-md-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-stethoscope mr-2"></i>{% trans "Thông Tin Lâm Sàng 43EN" %} {{ enrollment_case.USUBJID }}
        </h3>
        <div class="card-tools">
          <span class="badge badge-info">CL {{ is_create|yesno:"(Mới),(Cập nhật)" }}</span>
        </div>
      </div>
      <div class="card-body">
        {% if form.errors %}
        <div class="alert alert-danger">
          <h5><i class="icon fas fa-ban"></i> {% trans "Lỗi!" %}</h5>
          <ul>
            {% for field in form %}
              {% for error in field.errors %}
                <li><strong>{{ field.label }}</strong>: {{ error }}</li>
              {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        
        {% if is_readonly %}
        <div class="alert alert-info">
          <i class="fas fa-eye mr-2"></i> {% trans "Bạn đang ở chế độ chỉ xem. Để chỉnh sửa, vui lòng nhấn nút Chỉnh sửa phía dưới." %}
        </div>

        <div class="mb-3 text-right">
          <a href="{% url 'study_43en:clinical_form' usubjid=enrollment_case.USUBJID %}" class="btn btn-info">
            <i class="fas fa-edit mr-1"></i> {% trans "Chỉnh sửa" %}
          </a>
        </div>
        {% endif %}

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs custom-tabs" id="clinicalTabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" id="page1-tab" data-toggle="tab" href="#page1" role="tab" aria-controls="page1" aria-selected="true">
              {% trans "Trang" %} 1 ({% trans "Thông tin chung" %})
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="page2-tab" data-toggle="tab" href="#page2" role="tab" aria-controls="page2" aria-selected="false">
              {% trans "Trang" %} 2 ({% trans "Triệu chứng" %})
            </a>
          </li>
          <!-- Thêm tab thứ 3 cho Clinical Case Form -->
          <li class="nav-item">
            <a class="nav-link" id="page3-tab" data-toggle="tab" href="#page3" role="tab" aria-controls="page3" aria-selected="false">
              {% trans "Trang" %} 3 ({% trans "Chi tiết lâm sàng" %})
            </a>
          </li>
        </ul>
        
        <form method="post" id="clinicalForm" class="mt-4" data-enrollment-id="{{ enrollment_case.USUBJID }}" {% if is_readonly %}data-read-only="true"{% endif %}>
          {% csrf_token %}
          <input type="hidden" name="EVENT" value="CASE">
          
          {% if clinical_case.USUBJID_id %}
          <input type="hidden" name="USUBJID" value="{{ clinical_case.USUBJID_id }}" id="id_USUBJID" />
          {% elif enrollment_case.USUBJID %}
          <input type="hidden" name="USUBJID" value="{{ enrollment_case.pk }}" id="id_USUBJID" />
          {% endif %}
          
          <!-- Thêm các trường ẩn cho audit logging -->
          <input type="hidden" id="oldDataJson" name="oldDataJson">
          <input type="hidden" id="newDataJson" name="newDataJson">
          <input type="hidden" id="reasons_json" name="reasons_json">
          <input type="hidden" id="change_reason" name="change_reason">
          
          <!-- Tab Content -->
          <div class="tab-content" id="clinicalTabsContent">
            <!-- Page 1 - Thông tin chung -->
            <div class="tab-pane fade show active" id="page1" role="tabpanel" aria-labelledby="page1-tab">
              <div class="clinical-case-container">
                <div class="clinical-case-header">
                  <div class="row">
                    <div class="col">
                      <h4 class="m-0">CLINICAL - CASE</h4>
                    </div>
                    <div class="col text-right">
                      <span class="page-indicator">CL1 (1/10)</span>
                    </div>
                  </div>
                </div>
                
                <div class="clinical-case-content p-3">
                  <div class="row">
                    <!-- Mã số nghiên cứu -->
                    <div class="col-md-3">
                      <div class="form-group">
                        <label>{% trans "Mã số nghiên cứu [43EN]" %}</label>
                        <input type="text" name="STUDYID" class="form-control" value="{{ form.STUDYID.value|default:'43EN' }}" readonly>
                      </div>
                    </div>
                    
                    <!-- Địa điểm NC -->
                    <div class="col-md-3">
                      <div class="form-group">
                        <label>{% trans "Địa điểm NC" %}</label>
                        <input type="text" name="SITEID" class="form-control" value="{{ form.SITEID.value|default:enrollment_case.USUBJID.SITEID }}" readonly>
                      </div>
                    </div>
                    
                    <!-- Mã đối tượng -->
                    <div class="col-md-3">
                      <div class="form-group">
                        <label>{% trans "Mã đối tượng [A]" %}</label>
                        <input type="text" class="form-control" value="A" readonly>
                      </div>
                    </div>
                    
                    <!-- Mã số đối tượng NC -->
                    <div class="col-md-3">
                      <div class="form-group">
                        <label>{% trans "Mã số đối tượng NC" %}</label>
                        <input type="text" name="SUBJID" class="form-control" value="{{ form.SUBJID.value|default:enrollment_case.USUBJID.SUBJID }}" readonly>
                      </div>
                    </div>
                  </div>
                  
                  <div class="form-section-header mt-3">
                    {% trans "Thông tin lâm sàng của đối tượng tham gia nghiên cứu" %}
                  </div>
                  
                  <!-- 1. Ngày nhập viện -->
                  <div class="numbered-item" data-number="1">
                    <div class="form-group">
                      <label for="{{ form.ADMISDATE.id_for_label }}">{% trans "Ngày nhập viện (ngày/tháng/năm)" %}</label>
                      <div class="input-group date">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        </div>
                        <input type="text" class="form-control datepicker" id="id_ADMISDATE" name="ADMISDATE" value="{{ form.ADMISDATE.value|default:'' }}" placeholder="YYYY-MM-DD">
                      </div>
                    </div>
                  </div>
                  
                  <!-- 2. Lý do nhập viện -->
                  <div class="numbered-item" data-number="2">
                    <div class="form-group">
                      <label for="{{ form.ADMISREASON.id_for_label }}">{% trans "Lý do nhập viện" %}</label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fas fa-clipboard-list"></i></span>
                        </div>
                        <textarea class="form-control" id="id_ADMISREASON" name="ADMISREASON" rows="3">{{ form.ADMISREASON.value|default:'' }}</textarea>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 3. Ngày khởi phát triệu chứng -->
                  <div class="numbered-item" data-number="3">
                    <div class="form-group">
                      <label for="{{ form.SYMPTOMONSETDATE.id_for_label }}">{% trans "Ngày khởi phát triệu chứng (ngày/tháng/năm)" %}</label>
                      <div class="input-group date">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                        </div>
                        <input type="text" class="form-control datepicker" id="id_SYMPTOMONSETDATE" name="SYMPTOMONSETDATE" value="{{ form.SYMPTOMONSETDATE.value|default:'' }}" placeholder="YYYY-MM-DD">
                      </div>
                    </div>
                  </div>
                  
                  <!-- 4. Nhập viện vào khoa -->
                  <div class="numbered-item" data-number="4">
                    <div class="form-group">
                      <label for="{{ form.ADMISDEPT.id_for_label }}">{% trans "Nhập viện vào khoa" %}</label>
                      <div class="input-group">
                        <div class="input-group-prepend">
                          <span class="input-group-text"><i class="fas fa-hospital"></i></span>
                        </div>
                        <input type="text" class="form-control" id="id_ADMISDEPT" name="ADMISDEPT" value="{{ form.ADMISDEPT.value|default:'' }}">
                      </div>
                    </div>
                  </div>
                  
                  <!-- 5. Chẩn đoán lúc nhập viện -->
                  <div class="numbered-item" data-number="5">
                    <div class="form-group">
                      <label>{% trans "Chẩn đoán lúc nhập viện" %}</label>
                      <div class="row">
                        <!-- 5a. Khoa khám bệnh/Cấp cứu -->
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="{{ form.OUTPATIENT_ERDEPT.id_for_label }}">{% trans "5a. Khoa khám bệnh/Cấp cứu" %}</label>
                            <input type="text" class="form-control" id="id_OUTPATIENT_ERDEPT" name="OUTPATIENT_ERDEPT" value="{{ form.OUTPATIENT_ERDEPT.value|default:'' }}">
                          </div>
                        </div>
                        
                        <!-- 5b. Khoa nhập viện -->
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="{{ form.SYMPTOMADMISDEPT.id_for_label }}">{% trans "5b. Khoa nhập viện" %}</label>
                            <input type="text" class="form-control" id="id_SYMPTOMADMISDEPT" name="SYMPTOMADMISDEPT" value="{{ form.SYMPTOMADMISDEPT.value|default:'' }}">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 6. Sinh hiệu lúc nhập viện -->
                  <div class="numbered-item" data-number="6">
                    <div class="form-group">
                      <label>{% trans "Sinh hiệu lúc nhập viện" %}</label>
                      
                      <!-- 6a. Ý thức -->
                      <div class="row mt-2">
                        <div class="col-md-12">
                          <div class="form-group">
                            <label for="{{ form.AWARENESS.id_for_label }}">{% trans "a. Ý thức" %}</label>
                            <input type="text" class="form-control" id="id_AWARENESS" name="AWARENESS" value="{{ form.AWARENESS.value|default:'' }}">
                          </div>
                        </div>
                      </div>
                      
                      <!-- 6b. GCS -->
                      <div class="row">
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="{{ form.GCS.id_for_label }}">{% trans "b. GCS" %} ({% trans "điểm" %})</label>
                            <input type="number" class="form-control" id="id_GCS" name="GCS" value="{{ form.GCS.value|default:'7' }}">
                            <div class="invalid-feedback">{% trans "Please enter a valid GCS score (3-15)" %}</div>
                          </div>
                        </div>
                        <div class="col-md-9">
                          <div class="row mt-2">
                            <div class="col-md-4">
                              <div class="form-group">
                                <label for="{{ form.EYES.id_for_label }}">{% trans "Mắt (E)" %}</label>
                                <input type="number" class="form-control" id="id_EYES" name="EYES" value="{{ form.EYES.value|default:'' }}">
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="form-group">
                                <label for="{{ form.MOTOR.id_for_label }}">{% trans "Vận động (M)" %}</label>
                                <input type="number" class="form-control" id="id_MOTOR" name="MOTOR" value="{{ form.MOTOR.value|default:'' }}">
                              </div>
                            </div>
                            <div class="col-md-4">
                              <div class="form-group">
                                <label for="{{ form.VERBAL.id_for_label }}">{% trans "Lời nói (V)" %}</label>
                                <input type="number" class="form-control" id="id_VERBAL" name="VERBAL" value="{{ form.VERBAL.value|default:'' }}">
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- 6c. Mạch -->
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ form.PULSE.id_for_label }}">{% trans "c. Mạch" %} ({% trans "lần/phút" %})</label>
                            <input type="text" class="form-control" id="id_PULSE" name="PULSE" value="{{ form.PULSE.value|default:'' }}">
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ form.AMPLITUDE.id_for_label }}">{% trans "Biên độ" %}</label>
                            <input type="text" class="form-control" id="id_AMPLITUDE" name="AMPLITUDE" value="{{ form.AMPLITUDE.value|default:'' }}">
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ form.CAPILLARYMOIS.id_for_label }}">{% trans "Độ ẩm chì" %}</label>
                            <input type="text" class="form-control" id="id_CAPILLARYMOIS" name="CAPILLARYMOIS" value="{{ form.CAPILLARYMOIS.value|default:'' }}">
                          </div>
                        </div>
                      </div>
                      
                      <!-- 6d. CRT -->
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ form.CRT.id_for_label }}">{% trans "d. CRT" %} ({% trans "giây" %})</label>
                            <input type="text" class="form-control" id="id_CRT" name="CRT" value="{{ form.CRT.value|default:'' }}">
                          </div>
                        </div>
                        <div class="col-md-8">
                          <div class="form-check form-check-inline mt-4">
                            <input class="form-check-input" type="radio" name="CRT_OPTION" id="id_CRT_OPTION_2" value="2">
                            <label class="form-check-label" for="id_CRT_OPTION_2">{% trans "< 2 giây" %}</label>
                          </div>
                        </div>
                      </div>
                      
                      <!-- 6e. Nhiệt độ -->
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ form.TEMPERATURE.id_for_label }}">{% trans "e. Nhiệt độ" %} (°C)</label>
                            <input type="text" class="form-control" id="id_TEMPERATURE" name="TEMPERATURE" value="{{ form.TEMPERATURE.value|default:'' }}">
                          </div>
                        </div>
                      </div>
                      
                      <!-- 6f. Huyết áp -->
                      <div class="row">
                        <div class="col-md-6">
                          <div class="form-group">
                            <label for="{{ form.BLOODPRESSURE_SYS.id_for_label }}">{% trans "f. Huyết áp" %} (mmHg)</label>
                            <div class="input-group">
                              <input type="text" class="form-control" id="id_BLOODPRESSURE_SYS" name="BLOODPRESSURE_SYS" value="{{ form.BLOODPRESSURE_SYS.value|default:'' }}" placeholder="{% trans 'Tâm thu' %}">
                              <div class="input-group-prepend input-group-append">
                                <span class="input-group-text">/</span>
                              </div>
                              <input type="number" class="form-control" id="id_BLOODPRESSURE_DIAS" name="BLOODPRESSURE_DIAS" value="{{ form.BLOODPRESSURE_DIAS.value|default:'' }}" placeholder="{% trans 'Tâm trương' %}">
                              <input type="text" class="form-control" id="id_BLOODPRESSURE_DIAS" name="BLOODPRESSURE_DIAS" value="{{ form.BLOODPRESSURE_DIAS.value|default:'' }}" placeholder="{% trans 'Tâm trương' %}">
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <!-- 6g. Nhịp thở -->
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ form.RESPRATE.id_for_label }}">{% trans "g. Nhịp thở" %} ({% trans "lần/phút" %})</label>
                            <input type="text" class="form-control" id="id_RESPRATE" name="RESPRATE" value="{{ form.RESPRATE.value|default:'' }}">
                          </div>
                        </div>
                      </div>
                      
                      <!-- 6h. SpO2 -->
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ form.SPO2.id_for_label }}">{% trans "h. SpO2" %} (%)</label>
                            <input type="text" class="form-control" id="id_SPO2" name="SPO2" value="{{ form.SPO2.value|default:'' }}">
                          </div>
                        </div>
                      </div>
                      
                      <!-- 6i. FiO2 -->
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-group">
                            <label for="{{ form.FIO2.id_for_label }}">{% trans "i. FiO2" %} (%)</label>
                            <input type="text" class="form-control" id="id_FIO2" name="FIO2" value="{{ form.FIO2.value|default:'' }}">
                          </div>
                        </div>
                      </div>
                      
                      <!-- 6j. Kiểu hô hấp -->
                      <div class="row">
                        <div class="col-md-12">
                          <label>{% trans "j. Kiểu hô hấp" %}</label>
                          <div class="mt-2">
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="RESPPATTERN" id="id_RESPPATTERN_1" value="Kussmaul" {% if form.RESPPATTERN.value == 'Kussmaul' %}checked{% endif %}>
                              <label class="form-check-label" for="id_RESPPATTERN_1">{% trans "Kussmaul" %}</label>
                            </div>
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="RESPPATTERN" id="id_RESPPATTERN_2" value="Thở chậm/cơn ngưng thở" {% if form.RESPPATTERN.value == 'Thở chậm/cơn ngưng thở' %}checked{% endif %}>
                              <label class="form-check-label" for="id_RESPPATTERN_2">{% trans "Thở chậm/cơn ngưng thở" %}</label>
                            </div>
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="RESPPATTERN" id="id_RESPPATTERN_3" value="Thở bình thường" {% if form.RESPPATTERN.value == 'Thở bình thường' or form.RESPPATTERN.value == 'NormalBreath' %}checked{% endif %}>
                              <label class="form-check-label" for="id_RESPPATTERN_3">{% trans "Thở bình thường" %}</label>
                            </div>
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="RESPPATTERN" id="id_RESPPATTERN_OTHER" value="Khác" {% if form.RESPPATTERN.value and form.RESPPATTERN.value != 'Kussmaul' and form.RESPPATTERN.value != 'Thở chậm/cơn ngưng thở' and form.RESPPATTERN.value != 'Thở bình thường' and form.RESPPATTERN.value != 'NormalBreath' %}checked{% endif %}>
                              <label class="form-check-label" for="id_RESPPATTERN_OTHER">{% trans "Khác, ghi rõ:" %}</label>
                            </div>
                          </div>

                          <div id="resppattern_other_detail" class="mt-2" style="display:{% if form.RESPPATTERN.value and form.RESPPATTERN.value != 'Kussmaul' and form.RESPPATTERN.value != 'Thở chậm/cơn ngưng thở' and form.RESPPATTERN.value != 'Thở bình thường' and form.RESPPATTERN.value != 'NormalBreath' %}block{% else %}none{% endif %};">
                            <input type="text" class="form-control" id="id_RESPPATTERNOTHERSPEC" name="RESPPATTERNOTHERSPEC" value="{{ form.RESPPATTERNOTHERSPEC.value|default:'' }}" placeholder="{% trans 'Ghi rõ kiểu thở' %}">
                          </div>
                        </div>
                      </div>

                      
                      <!-- 6k. Hỗ trợ hô hấp -->
                      <div class="row mt-3">
                        <div class="col-md-12">
                          <label>{% trans "k. Hỗ trợ hô hấp" %}</label>
                          <div class="mt-2">
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="RESPSUPPORT" id="id_RESPSUPPORT_1" value="Oxy mũi/mask" {% if form.RESPSUPPORT.value == 'Oxy mũi/mask' or form.RESPSUPPORT.value == 'MaskO2' or form.RESPSUPPORT.value == 'Mask O2' or form.RESPSUPPORT.value == 'OxyMask' or form.RESPSUPPORT.value == 'Oxy' %}checked{% endif %}>
                              <label class="form-check-label" for="id_RESPSUPPORT_1">{% trans "Oxy mũi/mask" %}</label>
                            </div>
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="RESPSUPPORT" id="id_RESPSUPPORT_2" value="Đặt nội khí quản" {% if form.RESPSUPPORT.value == 'Đặt nội khí quản' or form.RESPSUPPORT.value == 'Intub' or form.RESPSUPPORT.value == 'Intubation' or form.RESPSUPPORT.value == 'Intubated' %}checked{% endif %}>
                              <label class="form-check-label" for="id_RESPSUPPORT_2">{% trans "Đặt nội khí quản" %}</label>
                            </div>
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="RESPSUPPORT" id="id_RESPSUPPORT_3" value="Không" {% if form.RESPSUPPORT.value == 'Không' or form.RESPSUPPORT.value == 'NoSupport' or form.RESPSUPPORT.value == 'None' or form.RESPSUPPORT.value == '' %}checked{% endif %}>
                              <label class="form-check-label" for="id_RESPSUPPORT_3">{% trans "Không" %}</label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <!-- 6l. Thuốc vận mạch -->
                      <div class="row mt-3">
                        <div class="col-md-6">
                          <label>{% trans "l. Thuốc vận mạch" %}</label>
                          <div class="mt-2">
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="VASOMEDS" id="id_VASOMEDS_YES" value="1" {% if form.VASOMEDS.value %}checked{% endif %}>
                              <label class="form-check-label" for="id_VASOMEDS_YES">{% trans "Có" %}</label>
                            </div>
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="VASOMEDS" id="id_VASOMEDS_NO" value="0" {% if form.VASOMEDS.value == False %}checked{% endif %}>
                              <label class="form-check-label" for="id_VASOMEDS_NO">{% trans "Không" %}</label>
                            </div>
                          </div>
                        </div>
                        
                        <!-- 6m. Có tụt huyết áp không? -->
                        <div class="col-md-6">
                          <label>{% trans "m. Có tụt huyết áp không?" %}</label>
                          <div class="mt-2">
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="HYPOTENSION" id="id_HYPOTENSION_YES" value="1" {% if form.HYPOTENSION.value %}checked{% endif %}>
                              <label class="form-check-label" for="id_HYPOTENSION_YES">{% trans "Có" %}</label>
                            </div>
                            <div class="form-check form-check-inline">
                              <input class="form-check-input" type="radio" name="HYPOTENSION" id="id_HYPOTENSION_NO" value="0" {% if form.HYPOTENSION.value == False %}checked{% endif %}>
                              <label class="form-check-label" for="id_HYPOTENSION_NO">{% trans "Không" %}</label>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 7. qSOFA -->
                  <div class="numbered-item" data-number="7">
                    <label>{% trans "qSOFA" %}</label>
                    <div class="mt-2">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="QSOFA" id="id_QSOFA_0" value="0" {% if form.QSOFA.value == 0 %}checked{% endif %}>
                        <label class="form-check-label" for="id_QSOFA_0">0</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="QSOFA" id="id_QSOFA_1" value="1" {% if form.QSOFA.value == 1 %}checked{% endif %}>
                        <label class="form-check-label" for="id_QSOFA_1">1</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="QSOFA" id="id_QSOFA_2" value="2" {% if form.QSOFA.value == 2 %}checked{% endif %}>
                        <label class="form-check-label" for="id_QSOFA_2">2</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="QSOFA" id="id_QSOFA_3" value="3" {% if form.QSOFA.value == 3 %}checked{% endif %}>
                        <label class="form-check-label" for="id_QSOFA_3">3</label>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 8. NEWS2 -->
                  <div class="numbered-item" data-number="8">
                    <label>{% trans "NEWS2" %}</label>
                    <div class="mt-2">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="NEWS2" id="id_NEWS2_0_4" value="0-4" {% if form.NEWS2.value == '0-4' or form.NEWS2.value == '0to4' %}checked{% endif %}>
                        <label class="form-check-label" for="id_NEWS2_0_4">0 - 4</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="NEWS2" id="id_NEWS2_5_6" value="5-6" {% if form.NEWS2.value == '5-6' or form.NEWS2.value == '5to6' %}checked{% endif %}>
                        <label class="form-check-label" for="id_NEWS2_5_6">5 - 6</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="NEWS2" id="id_NEWS2_7" value="≥7" {% if form.NEWS2.value == '≥7' or form.NEWS2.value == 'MoreThan7' or form.NEWS2.value == 'More than 7' or form.NEWS2.value == 'MoreThanSeven' %}checked{% endif %}>
                        <label class="form-check-label" for="id_NEWS2_7">≥ 7</label>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between">
                    <a href="{% url 'study_43en:patient_detail' usubjid=enrollment_case.USUBJID %}" class="btn btn-secondary">
                      <i class="fas fa-arrow-left"></i> {% trans "Quay lại thông tin bệnh nhân" %}
                    </a>
                    <div>
                      <!-- Thay thế nút submit bằng nút next -->
                      <button type="button" class="btn btn-primary" id="page1-next" onclick="$('#page2-tab').tab('show');">
                        <i class="fas fa-arrow-right"></i> {% trans "Tiếp theo" %}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Page 2 - Triệu chứng -->
            <div class="tab-pane fade" id="page2" role="tabpanel" aria-labelledby="page2-tab">
              <div class="clinical-case-container">
                <div class="clinical-case-header">
                  <div class="row">
                    <div class="col">
                      <h4 class="m-0">CLINICAL - CASE</h4>
                    </div>
                    <div class="col text-right">
                      <span class="page-indicator">CL1 (2/10)</span>
                    </div>
                  </div>
                </div>
                
                <div class="clinical-case-content p-3">
                  <!-- 9. Triệu chứng cơ năng -->
                  <div class="numbered-item" data-number="9">
                    <label>{% trans "Triệu chứng cơ năng (ghi nhận từ bệnh nhân)" %} {% trans "(vui lòng chọn tất cả các lựa chọn đúng)" %}</label>
                    
                    <div class="checkbox-group mt-3">
                      <div class="checkbox-columns">
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="FEVER" id="id_FEVER" {% if form.FEVER.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_FEVER">{% trans "Sốt" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="FATIGUE" id="id_FATIGUE" {% if form.FATIGUE.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_FATIGUE">{% trans "Mệt mỏi" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="MUSCLEPAIN" id="id_MUSCLEPAIN" {% if form.MUSCLEPAIN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_MUSCLEPAIN">{% trans "Đau cơ" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="LOSSAPPETITE" id="id_LOSSAPPETITE" {% if form.LOSSAPPETITE.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_LOSSAPPETITE">{% trans "Chán ăn" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="COUGH" id="id_COUGH" {% if form.COUGH.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_COUGH">{% trans "Ho" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="CHESTPAIN" id="id_CHESTPAIN" {% if form.CHESTPAIN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_CHESTPAIN">{% trans "Đau ngực" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="SHORTBREATH" id="id_SHORTBREATH" {% if form.SHORTBREATH.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_SHORTBREATH">{% trans "Thở mệt" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="JAUNDICE" id="id_JAUNDICE" {% if form.JAUNDICE.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_JAUNDICE">{% trans "Vàng da" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="PAINURINATION" id="id_PAINURINATION" {% if form.PAINURINATION.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_PAINURINATION">{% trans "Tiểu đau" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="BLOODYURINE" id="id_BLOODYURINE" {% if form.BLOODYURINE.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_BLOODYURINE">{% trans "Tiểu máu" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="CLOUDYURINE" id="id_CLOUDYURINE" {% if form.CLOUDYURINE.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_CLOUDYURINE">{% trans "Tiểu đục" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="EPIGASTRICPAIN" id="id_EPIGASTRICPAIN" {% if form.EPIGASTRICPAIN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_EPIGASTRICPAIN">{% trans "Đau thượng vị" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="LOWERABDPAIN" id="id_LOWERABDPAIN" {% if form.LOWERABDPAIN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_LOWERABDPAIN">{% trans "Đau bụng dưới" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="FLANKPAIN" id="id_FLANKPAIN" {% if form.FLANKPAIN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_FLANKPAIN">{% trans "Đau hông lưng" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="URINARYHESITANCY" id="id_URINARYHESITANCY" {% if form.URINARYHESITANCY.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_URINARYHESITANCY">{% trans "Tiểu khó/thắt" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="SUBCOSTALPAIN" id="id_SUBCOSTALPAIN" {% if form.SUBCOSTALPAIN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_SUBCOSTALPAIN">{% trans "Đau hạ sườn" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="HEADACHE" id="id_HEADACHE" {% if form.HEADACHE.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_HEADACHE">{% trans "Nhức đầu" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="POORCONTACT" id="id_POORCONTACT" {% if form.POORCONTACT.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_POORCONTACT">{% trans "Tiếp xúc kém/li bì" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="DELIRIUMAGITATION" id="id_DELIRIUMAGITATION" {% if form.DELIRIUMAGITATION.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_DELIRIUMAGITATION">{% trans "Sảng/kích động" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="VOMITING" id="id_VOMITING" {% if form.VOMITING.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_VOMITING">{% trans "Nôn" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="SEIZURES" id="id_SEIZURES" {% if form.SEIZURES.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_SEIZURES">{% trans "Co giật" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="EYEPAIN" id="id_EYEPAIN" {% if form.EYEPAIN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_EYEPAIN">{% trans "Đau mắt" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="REDEYES" id="id_REDEYES" {% if form.REDEYES.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_REDEYES">{% trans "Đỏ mắt" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="NAUSEA" id="id_NAUSEA" {% if form.NAUSEA.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_NAUSEA">{% trans "Buồn nôn" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="BLURREDVISION" id="id_BLURREDVISION" {% if form.BLURREDVISION.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_BLURREDVISION">{% trans "Mờ mắt" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="SKINLESIONS" id="id_SKINLESIONS" {% if form.SKINLESIONS.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_SKINLESIONS">{% trans "Sang thương da" %}</label>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Triệu chứng khác -->
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" name="OTHERSYMPTOM" id="id_OTHERSYMPTOM" {% if form.OTHERSYMPTOM.value %}checked{% endif %}>
                      <label class="form-check-label" for="id_OTHERSYMPTOM">{% trans "Khác, ghi rõ:" %}</label>
                    </div>
                    <div id="othersymptom_detail" style="display:{% if form.OTHERSYMPTOM.value %}block{% else %}none{% endif %};" class="mt-2">
                      <input type="text" class="form-control" id="id_SPECIFYOTHERSYMPTOM" name="SPECIFYOTHERSYMPTOM" value="{{ form.SPECIFYOTHERSYMPTOM.value|default:'' }}">
                    </div>
                  </div>
                  
                  <!-- 10. Triệu chứng thực thể -->
                  <div class="numbered-item mt-4" data-number="10">
                    <label>{% trans "Triệu chứng thực thể (ghi nhận qua thăm khám/có cơ trong 72 giờ đầu nhập viện)" %} {% trans "(vui lòng chọn tất cả các lựa chọn đúng)" %}</label>
                    
                    <!-- BMI -->
                    <div class="row mt-3">
                      <div class="col-md-3">
                        <div class="form-group">
                          <label for="{{ form.WEIGHT.id_for_label }}">{% trans "Cân nặng" %} (kg)</label>
                          <input type="number" step="0.1" class="form-control" id="id_WEIGHT" name="WEIGHT" value="{{ form.WEIGHT.value|default:'' }}">
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="form-group">
                          <label for="{{ form.HEIGHT.id_for_label }}">{% trans "Chiều cao" %} (cm)</label>
                          <input type="number" step="0.1" class="form-control" id="id_HEIGHT" name="HEIGHT" value="{{ form.HEIGHT.value|default:'' }}">
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="form-group">
                          <label for="{{ form.BMI.id_for_label }}">BMI</label>
                          <input type="number" step="0.01" class="form-control" id="id_BMI" name="BMI" value="{{ form.BMI.value|default:'' }}" readonly>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Triệu chứng thực thể -->
                    <div class="checkbox-group mt-3">
                      <div class="checkbox-columns">
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="FEVER_2" id="id_FEVER_2" {% if form.FEVER_2.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_FEVER_2">{% trans "Sốt" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="RASH" id="id_RASH" {% if form.RASH.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_RASH">{% trans "Phát ban" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="SKINBLEEDING" id="id_SKINBLEEDING" {% if form.SKINBLEEDING.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_SKINBLEEDING">{% trans "Xuất huyết da" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="MUCOSALBLEEDING" id="id_MUCOSALBLEEDING" {% if form.MUCOSALBLEEDING.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_MUCOSALBLEEDING">{% trans "Xuất huyết niêm mạc" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="SKINLESIONS_2" id="id_SKINLESIONS_2" {% if form.SKINLESIONS_2.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_SKINLESIONS_2">{% trans "Sang thương da" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="LUNGCRACKLES" id="id_LUNGCRACKLES" {% if form.LUNGCRACKLES.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_LUNGCRACKLES">{% trans "Ran ở phổi" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="CONSOLIDATIONSYNDROME" id="id_CONSOLIDATIONSYNDROME" {% if form.CONSOLIDATIONSYNDROME.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_CONSOLIDATIONSYNDROME">{% trans "Hội chứng đông đặc" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="PLEURALEFFUSION" id="id_PLEURALEFFUSION" {% if form.PLEURALEFFUSION.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_PLEURALEFFUSION">{% trans "Tràn dịch màng phổi" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="PNEUMOTHORAX" id="id_PNEUMOTHORAX" {% if form.PNEUMOTHORAX.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_PNEUMOTHORAX">{% trans "Tràn khí màng phổi" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="HEARTMURMUR" id="id_HEARTMURMUR" {% if form.HEARTMURMUR.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_HEARTMURMUR">{% trans "Âm thổi tim" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="ABNORHEARTSOUNDS" id="id_ABNORHEARTSOUNDS" {% if form.ABNORHEARTSOUNDS.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_ABNORHEARTSOUNDS">{% trans "Tiếng tim bất thường" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="JUGULARVEIN" id="id_JUGULARVEIN" {% if form.JUGULARVEIN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_JUGULARVEIN">{% trans "Tĩnh mạch cổ nổi" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="HEPATOSPLENOMEGALY" id="id_HEPATOSPLENOMEGALY" {% if form.HEPATOSPLENOMEGALY.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_HEPATOSPLENOMEGALY">{% trans "Dấu hiệu suy gan" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="LIVERSPLEEN" id="id_LIVERSPLEEN" {% if form.LIVERSPLEEN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_LIVERSPLEEN">{% trans "Dấu hiệu TALTMC" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="TENDERPERCUSSION" id="id_TENDERPERCUSSION" {% if form.TENDERPERCUSSION.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_TENDERPERCUSSION">{% trans "Gõ/Lách to" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="CONSCIOUSNESSDISTURBANCE" id="id_CONSCIOUSNESSDISTURBANCE" {% if form.CONSCIOUSNESSDISTURBANCE.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_CONSCIOUSNESSDISTURBANCE">{% trans "Rối loạn ý thức" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="LIMBWEAKNESSPARALYSIS" id="id_LIMBWEAKNESSPARALYSIS" {% if form.LIMBWEAKNESSPARALYSIS.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_LIMBWEAKNESSPARALYSIS">{% trans "Yếu/liệt chi" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="WEAKANKLES" id="id_WEAKANKLES" {% if form.WEAKANKLES.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_WEAKANKLES">{% trans "Liệt TK sọ" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="MENINGITIS" id="id_MENINGITIS" {% if form.MENINGITIS.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_MENINGITIS">{% trans "Dấu màng não" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="REDEYES_2" id="id_REDEYES_2" {% if form.REDEYES_2.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_REDEYES_2">{% trans "Đỏ mắt" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="SELFPROTECT" id="id_SELFPROTECT" {% if form.SELFPROTECT.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_SELFPROTECT">{% trans "Tư mở tấn phòng" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="LUNGPLUERA" id="id_LUNGPLUERA" {% if form.LUNGPLUERA.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_LUNGPLUERA">{% trans "Phù" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="CUSHINGSYNDROME" id="id_CUSHINGSYNDROME" {% if form.CUSHINGSYNDROME.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_CUSHINGSYNDROME">{% trans "Kiểu hình Cushing" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="EPIGASTRICPAIN_2" id="id_EPIGASTRICPAIN_2" {% if form.EPIGASTRICPAIN_2.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_EPIGASTRICPAIN_2">{% trans "Đau thượng vị" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="RIGHTUPPERABDPAIN" id="id_RIGHTUPPERABDPAIN" {% if form.RIGHTUPPERABDPAIN.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_RIGHTUPPERABDPAIN">{% trans "Đau hạ vị" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="FLANKPAIN_2" id="id_FLANKPAIN_2" {% if form.FLANKPAIN_2.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_FLANKPAIN_2">{% trans "Đau hông lưng" %}</label>
                          </div>
                        </div>
                        <div class="checkbox-item">
                          <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="LOWERABDPAIN_2" id="id_LOWERABDPAIN_2" {% if form.LOWERABDPAIN_2.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_LOWERABDPAIN_2">{% trans "Đau hạ sườn" %}</label>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Triệu chứng khác -->
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" name="OTHERSYMPTOM_2" id="id_OTHERSYMPTOM_2" {% if form.OTHERSYMPTOM_2.value %}checked{% endif %}>
                      <label class="form-check-label" for="id_OTHERSYMPTOM_2">{% trans "Khác, ghi rõ:" %}</label>
                    </div>
                    <div id="othersymptom_2_detail" style="display:{% if form.OTHERSYMPTOM_2.value %}block{% else %}none{% endif %};" class="mt-2">
                      <input type="text" class="form-control" id="id_SPECIFYOTHERSYMPTOM_2" name="SPECIFYOTHERSYMPTOM_2" value="{{ form.SPECIFYOTHERSYMPTOM_2.value|default:'' }}">
                    </div>
                  </div>
                  
                  <!-- Người hoàn thiện -->
                  <div class="form-section-header mt-4">
                    {% trans "Thông tin người hoàn thiện" %}
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="{{ form.COMPLETEDBY.id_for_label }}">{% trans "Người hoàn thiện" %}</label>
                        <input type="text" class="form-control" id="id_COMPLETEDBY" name="COMPLETEDBY" value="{{ form.COMPLETEDBY.value|default:request.user.get_full_name }}" required>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="{{ form.COMPLETEDDATE.id_for_label }}">{% trans "Ngày hoàn thiện" %}</label>
                        <div class="input-group date">
                          <div class="input-group-prepend">
                            <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                          </div>
                          <input type="text" class="form-control datepicker" id="id_COMPLETEDDATE" name="COMPLETEDDATE" value="{{ form.COMPLETEDDATE.value|date:'Y-m-d'|default:today|date:'Y-m-d' }}" required>
                        </div>
                      </div>
                    </div>
                    <div class="row mt-4">
                      <div class="col-6">
                        <button type="button" class="btn btn-secondary prev-page" data-target="page1-tab">
                          <i class="fas fa-chevron-left mr-1"></i> {% trans "Quay lại" %}
                        </button>
                      </div>
                      <div class="col-6 text-right">
                        {% if not is_readonly %}
                          <button type="button" class="btn btn-primary" onclick="$('#page3-tab').tab('show');">
                            <i class="fas fa-arrow-right"></i> {% trans "Tiếp theo" %}
                          </button>
                        {% else %}
                          <button type="button" class="btn btn-primary" onclick="$('#page3-tab').tab('show');">
                            <i class="fas fa-arrow-right"></i> {% trans "Tiếp theo" %}
                          </button>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="page3" role="tabpanel" aria-labelledby="page3-tab">
              <div class="clinical-case-container">
                <div class="clinical-case-header">
                  <div class="row">
                    <div class="col">
                      <h4 class="m-0">CLINICAL - CASE (Chi tiết)</h4>
                    </div>
                    <div class="col text-right">
                      <span class="page-indicator">CL1 (3/10)</span>
                    </div>
                  </div>
                </div>
                  
                  <div class="clinical-case-content p-3">
                    <!-- PHẦN 1: ĐẶC ĐIỂM TÌNH TRẠNG Ổ NHIỄM TRÙNG -->
                    <div class="form-section-header">
                      <i class="fas fa-bug"></i> {% trans "ĐẶC ĐIỂM TÌNH TRẠNG Ổ NHIỄM TRÙNG" %}
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <label for="{{ form.INFECTFOCUS48H.id_for_label }}">{% trans "Nguồn nhiễm khuẩn sau 48 giờ nhập viện" %}</label>
                        {{ form.INFECTFOCUS48H }}
                        <div class="form-group mt-2" id="infectfocus-other-section" style="display:none;">
                          <label for="{{ form.SPECIFYOTHERINFECT48H.id_for_label }}">{% trans "Khác, ghi rõ" %}</label>
                          {{ form.SPECIFYOTHERINFECT48H }}
                        </div>
                      </div>
                    </div>     
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "28. Nhiễm trùng huyết" %}</h5>
                        <label>{% trans "Nhiễm trùng huyết?" %}</label>
                        <div class="row mt-2">
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="sepsis_yes" name="BLOODINFECT" value="yes" {% if form.BLOODINFECT.value == 'yes' %}checked{% endif %}>
                              <label class="form-check-label" for="sepsis_yes">{% trans "Có" %}</label>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="sepsis_no" name="BLOODINFECT" value="no" {% if form.BLOODINFECT.value == 'no' %}checked{% endif %}>
                              <label class="form-check-label" for="sepsis_no">{% trans "Không" %}</label>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="sepsis_unknown" name="BLOODINFECT" value="unknown" {% if form.BLOODINFECT.value == 'unknown' %}checked{% endif %}>
                              <label class="form-check-label" for="sepsis_unknown">{% trans "Không biết" %}</label>
                            </div>
                          </div>
                        </div>
                        <!-- SOFA scores (thêm ngay dưới Nhiễm trùng huyết) -->
                        <div class="row mt-3">
                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="id_SOFABASELINE">{% trans "Điểm SOFA nền" %}</label>
                              {% if form.SOFABASELINE %}
                                {{ form.SOFABASELINE }}
                              {% else %}
                                <input type="number" min="0" class="form-control" id="id_SOFABASELINE" name="SOFABASELINE" value="{% if clinical_case.SOFABASELINE %}{{ clinical_case.SOFABASELINE }}{% endif %}">
                              {% endif %}
                            </div>
                          </div>

                          <div class="col-md-6">
                            <div class="form-group">
                              <label for="id_DIAGSOFA">{% trans "Điểm SOFA lúc chẩn đoán" %}</label>
                              {% if form.DIAGSOFA %}
                                {{ form.DIAGSOFA }}
                              {% else %}
                                <input type="number" min="0" class="form-control" id="id_DIAGSOFA" name="DIAGSOFA" value="{% if clinical_case.DIAGSOFA %}{{ clinical_case.DIAGSOFA }}{% endif %}">
                              {% endif %}
                            </div>
                          </div>
                        </div>
                        <div class="row mt-3">
                          <div class="col-md-12">
                            <h5>{% trans "29. Sốc nhiễm trùng" %}</h5>
                            <label>{% trans "Sốc nhiễm trùng?" %}</label>
                            <div class="row mt-2">
                              <div class="col-md-3">
                                <div class="form-check">
                                  <input type="radio" class="form-check-input" id="septic_shock_yes" name="SEPTICSHOCK" value="yes" {% if form.SEPTICSHOCK.value == 'yes' %}checked{% endif %}>
                                  <label class="form-check-label" for="septic_shock_yes">{% trans "Có" %}</label>
                                </div>
                              </div>
                              <div class="col-md-3">
                                <div class="form-check">
                                  <input type="radio" class="form-check-input" id="septic_shock_no" name="SEPTICSHOCK" value="no" {% if form.SEPTICSHOCK.value == 'no' %}checked{% endif %}>
                                  <label class="form-check-label" for="septic_shock_no">{% trans "Không" %}</label>
                                </div>
                              </div>
                              <div class="col-md-3">
                                <div class="form-check">
                                  <input type="radio" class="form-check-input" id="septic_shock_unknown" name="SEPTICSHOCK" value="unknown" {% if form.SEPTICSHOCK.value == 'unknown' %}checked{% endif %}>
                                  <label class="form-check-label" for="septic_shock_unknown">{% trans "Không biết" %}</label>
                                </div>
                              </div>
                            </div>
                        <div class="row mt-3">
                          <div class="col-md-12">
                            <h5>{% trans "30. Nguồn gốc nhiễm trùng" %}</h5>
                            <label>{% trans "Nguồn gốc nhiễm trùng?" %}</label>
                            <div class="row mt-2">
                              <div class="col-md-3">
                                <div class="form-check">
                                  <input type="radio" class="form-check-input" id="infectsrc_community" name="infectsrc" value="Community">
                                  <label class="form-check-label" for="infectsrc_community">{% trans "Cộng đồng" %}</label>
                                </div>
                              </div>
                              <div class="col-md-5">
                                <div class="form-check">
                                  <input type="radio" class="form-check-input" id="infectsrc_healthcare" name="infectsrc" value="HealthcareAssociated">
                                  <label class="form-check-label" for="infectsrc_healthcare">{% trans "Liên quan CSYT" %}</label>
                                </div>
                              </div>
                              <div class="col-md-4">
                                <div class="form-check">
                                  <input type="radio" class="form-check-input" id="infectsrc_unknown" name="infectsrc" value="Unknown">
                                  <label class="form-check-label" for="infectsrc_unknown">{% trans "Không phân loại" %}</label>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="d-none">
                          {{ form.BLOODINFECT }}
                          {{ form.SEPTICSHOCK }}
                          {{ form.INFECTSRC }}
                        </div>
                      </div>
                    </div>

                    <!-- PHẦN 2: CAN THIỆP TRONG QUÁ TRÌNH NẰM VIỆN -->
                    <div class="form-section-header">
                      <i class="fas fa-procedures"></i> {% trans "CAN THIỆP TRONG QUÁ TRÌNH NẰM VIỆN" %}
                    </div>
                      
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "31. Hỗ trợ hô hấp" %}</h5>
                        <label>{% trans "Hỗ trợ hô hấp?" %}</label>
                        <div class="row mt-2">
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="respisupport_yes" name="RESPISUPPORT" value="true"
                                {% if form.RESPISUPPORT.value %}checked{% endif %}>
                              <label class="form-check-label" for="respisupport_yes">{% trans "Có" %}</label>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="respisupport_no" name="RESPISUPPORT" value="false"
                                {% if form.RESPISUPPORT.value is not None and not form.RESPISUPPORT.value %}checked{% endif %}>
                              <label class="form-check-label" for="respisupport_no">{% trans "Không" %}</label>
                            </div>
                          </div>
                        </div>
                        <div class="d-none">
                          {{ form.RESPISUPPORT }}
                        </div>
                      </div>
                    </div>

                    <div id="respi-support-section" class="row mb-3" style="display: {% if form.RESPISUPPORT.value %}block{% else %}none{% endif %};">
                      <div class="col-md-12">
                        <label>{{ form.SUPPORTTYPE.label }}</label>
                        <div class="row">
                          {% for value, label in form.fields.SUPPORTTYPE.choices %}
                            <div class="col-md-4">
                              <div class="form-check">
                                <input type="checkbox"
                                      class="form-check-input"
                                      name="SUPPORTTYPE"
                                      id="id_SUPPORTTYPE_{{ forloop.counter }}"
                                      value="{{ value }}"
                                      {% if value in form.SUPPORTTYPE.value %}checked{% endif %}>
                                <label class="form-check-label" for="id_SUPPORTTYPE_{{ forloop.counter }}">{{ label }}</label>
                              </div>
                            </div>
                          {% endfor %}
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.OXYMASKDURATION.id_for_label }}">{{ form.OXYMASKDURATION.label }}</label>
                          {{ form.OXYMASKDURATION }}
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.HFNCNIVDURATION.id_for_label }}">{{ form.HFNCNIVDURATION.label }}</label>
                          {{ form.HFNCNIVDURATION }}
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="form-group">
                          <label for="{{ form.VENTILATORDURATION.id_for_label }}">{{ form.VENTILATORDURATION.label }}</label>
                          {{ form.VENTILATORDURATION }}
                        </div>
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "32. Dịch truyền hồi sức" %}</h5>
                        <label>{% trans "Dịch truyền hồi sức?" %}</label>
                        <div class="row mt-2">
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="resusfluid_yes" name="resusfluid_radio" value="true"
                                  {% if form.RESUSFLUID.value %}checked{% endif %}>
                              <label class="form-check-label" for="resusfluid_yes">{% trans "Có" %}</label>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="resusfluid_no" name="resusfluid_radio" value="false"
                                  {% if not form.RESUSFLUID.value %}checked{% endif %}>
                              <label class="form-check-label" for="resusfluid_no">{% trans "Không" %}</label>
                            </div>
                          </div>
                        </div>
                        <div class="d-none">
                          <input type="checkbox" id="id_RESUSFLUID" name="RESUSFLUID" {% if form.RESUSFLUID.value %}checked{% endif %}>
                        </div>
                      </div>
                    </div>
                    
                    <div id="resus-fluid-section" class="toggle-section">
                      <div class="row mb-3">
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="{{ form.FLUID6HOURS.id_for_label }}">{{ form.FLUID6HOURS.label }}</label>
                            {{ form.FLUID6HOURS }}
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="{{ form.CRYSTAL6HRS.id_for_label }}">{{ form.CRYSTAL6HRS.label }}</label>
                            {{ form.CRYSTAL6HRS }}
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="{{ form.COL6HRS.id_for_label }}">{{ form.COL6HRS.label }}</label>
                            {{ form.COL6HRS }}
                          </div>
                        </div>
                      </div>
                      
                      <div class="row mb-3">
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="{{ form.FLUID24HOURS.id_for_label }}">{{ form.FLUID24HOURS.label }}</label>
                            {{ form.FLUID24HOURS }}
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="{{ form.CRYSTAL24HRS.id_for_label }}">{{ form.CRYSTAL24HRS.label }}</label>
                            {{ form.CRYSTAL24HRS }}
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="form-group">
                            <label for="{{ form.COL24HRS.id_for_label }}">{{ form.COL24HRS.label }}</label>
                            {{ form.COL24HRS }}
                          </div>
                        </div>
                      </div>
                    </div>            
                    
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "33. Vận mạch/tăng co bóp cơ tim" %}</h5>
                        <label>{% trans "Dùng thuốc vận mạch?" %}</label>
                        <div class="row mt-2">
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="vasoinotropes_yes" name="vasoinotropes_radio" value="true"
                                {% if form.VASOINOTROPES.value %}checked{% endif %}>
                              <label class="form-check-label" for="vasoinotropes_yes">{% trans "Có" %}</label>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="vasoinotropes_no" name="vasoinotropes_radio" value="false"
                                {% if not form.VASOINOTROPES.value %}checked{% endif %}>
                              <label class="form-check-label" for="vasoinotropes_no">{% trans "Không" %}</label>
                            </div>
                          </div>
                        </div>
                        <div class="d-none">
                          <input type="checkbox" id="id_VASOINOTROPES" name="VASOINOTROPES" {% if form.VASOINOTROPES.value %}checked{% endif %}>
                        </div>
                      </div>
                    </div>

                    <div id="vasodrug-section" class="toggle-section" style="display: none;">
                      <div class="row mb-3">
                      <div class="col-12">                
                        <div id="vasoidrug-formset">{{ vaso_drug_formset.management_form }}
                          <table class="table table-bordered">
                            <thead>
                              <tr>
                                <th>{% trans "Tên thuốc" %}</th>
                                <th>{% trans "Liều dùng" %}</th>
                                <th>{% trans "Ngày bắt đầu" %}</th>
                                <th>{% trans "Ngày kết thúc" %}</th>
                                <th>{% trans "Xóa" %}</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for form in vaso_drug_formset.forms %}
                              <tr class="vasoidrug-form">
                                <td>
                                  {{ form.id }}
                                  {{ form.VASOIDRUGNAME }}
                                  {% if form.VASOIDRUGNAME.errors %}
                                  <span class="text-danger">{{ form.VASOIDRUGNAME.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.VASOIDRUGDOSAGE }}
                                  {% if form.VASOIDRUGDOSAGE.errors %}
                                  <span class="text-danger">{{ form.VASOIDRUGDOSAGE.errors }}</span>
                                  {% endif %}                        </td>
                                <td>
                                  <input type="text" name="{{ form.VASOIDRUGSTARTDTC.html_name }}" 
                                        class="form-control datepicker" 
                                        value="{{ form.VASOIDRUGSTARTDTC.value|default:'' }}"
                                        id="{{ form.VASOIDRUGSTARTDTC.id_for_label }}">
                                  {% if form.VASOIDRUGSTARTDTC.errors %}
                                  <span class="text-danger">{{ form.VASOIDRUGSTARTDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  <input type="text" name="{{ form.VASOIDRUGENDDTC.html_name }}" 
                                        class="form-control datepicker" 
                                        value="{{ form.VASOIDRUGENDDTC.value|default:'' }}"
                                        id="{{ form.VASOIDRUGENDDTC.id_for_label }}">
                                  {% if form.VASOIDRUGENDDTC.errors %}
                                  <span class="text-danger">{{ form.VASOIDRUGENDDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.DELETE }}
                                </td>
                              </tr>                      
                              {% empty %}
                              <!-- Empty row shown when no forms exist -->                      
                               <tr class="vasoidrug-form empty-row">
                                <td colspan="5" class="text-center">
                                  <em>{% trans "Không có dữ liệu thuốc vận mạch. Hãy nhấn nút thêm để tạo thuốc mới." %}</em>
                                </td>
                              </tr>
                              {% endfor %}
                            </tbody>
                          </table>                  
                          <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-row" 
                                  data-formset="#vasoidrug-formset">
                            <i class="fas fa-plus"></i> {% trans "Thêm thuốc vận mạch" %}
                          </button>
                        </div>
                      </div>
                    </div>            
                    </div>
                    <div class="row mb-3">              
                      <div class="col-md-12">
                        <h5>{% trans "34. Lọc máu" %}</h5>
                      </div>
                    </div>
                    <div class="row mb-3">              
                      <div class="col-md-12">
                        <label>{% trans "Có lọc máu?" %}</label>
                        <div class="row mt-2">
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="dialysis_yes" name="dialysis_radio" value="yes">
                              <label class="form-check-label" for="dialysis_yes">{% trans "Có" %}</label>
                            </div>
                          </div>
                          <div class="col-md-3">
                            <div class="form-check">
                              <input type="radio" class="form-check-input" id="dialysis_no" name="dialysis_radio" value="no">
                              <label class="form-check-label" for="dialysis_no">{% trans "Không" %}</label>
                            </div>
                          </div>
                        </div>
                        <div class="d-none">
                          {{ form.DIALYSIS }}
                        </div>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "35. Dẫn lưu" %}</h5>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label>{% trans "Có dẫn lưu?" %}</label>
                          <div class="form-check">
                            <input type="radio" class="form-check-input" id="drainage_yes" name="drainage_radio" value="yes">
                            <label class="form-check-label" for="drainage_yes">{% trans "Có" %}</label>
                          </div>
                          <div class="form-check">
                            <input type="radio" class="form-check-input" id="drainage_no" name="drainage_radio" value="no">
                            <label class="form-check-label" for="drainage_no">{% trans "Không" %}</label>
                          </div>
                          <div class="d-none">
                            {{ form.DRAINAGE }}
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6" id="drainage_type_section" style="display: none;">
                        <div class="form-group">
                          <label>{% trans "Hình thức dẫn lưu:" %}</label>
                          <div class="form-check">
                            <input type="radio" class="form-check-input" id="drainage_type_1" name="drainage_type_radio" value="Empyema">
                            <label class="form-check-label" for="drainage_type_1">{% trans "Màng phổi" %}</label>
                          </div>
                          <div class="form-check">
                            <input type="radio" class="form-check-input" id="drainage_type_2" name="drainage_type_radio" value="Abscess">
                            <label class="form-check-label" for="drainage_type_2">{% trans "Ổ áp xe" %}</label>
                          </div>
                          <div class="form-check">
                            <input type="radio" class="form-check-input" id="drainage_type_3" name="drainage_type_radio" value="Other">
                            <label class="form-check-label" for="drainage_type_3">{% trans "Khác, ghi rõ:" %}</label>
                              {{ form.SPECIFYOTHERDRAINAGE }}
                          </div>
                          <div class="d-none">
                            {{ form.DRAINAGETYPE }}
                          </div>
                        </div>
                      </div>
                    </div>


                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>{% trans "37. Biến cố trong quá trình nằm viện" %}</h5>
                            <div class="form-check mb-3">
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="has_aehospevent_yes" name="has_aehospevent" value="yes">
                                    <label class="form-check-label" for="has_aehospevent_yes">{% trans "Yes" %}</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="has_aehospevent_no" name="has_aehospevent" value="no" checked>
                                    <label class="form-check-label" for="has_aehospevent_no">{% trans "No" %}</label>
                                </div>
                            </div>
                            <div id="aehospevent-formset" style="display: none;">
                                {{ aehospevent_formset.management_form }}
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Biến cố" %}</th>
                                            <th>{% trans "Chi tiết biến cố" %}</th>
                                            <th>{% trans "Thời gian đánh giá" %}</th>
                                            <th>{% trans "Xóa" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for form in aehospevent_formset.forms %}
                                        <tr class="aehospevent-form-row">
                                            <td>
                                                {% if form.instance.pk %}
                                                {{ form.id }}
                                                {% endif %}
                                                {{ form.AENAME }}
                                                {% if form.AENAME.errors %}
                                                    <span class="text-danger">{{ form.AENAME.errors }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.AEDETAILS }}
                                                {% if form.AEDETAILS.errors %}
                                                    <span class="text-danger">{{ form.AEDETAILS.errors }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <input type="text"
                                                      name="{{ form.AEDTC.html_name }}"
                                                      class="form-control datepicker"
                                                      value="{% if form.AEDTC.value %}{{ form.AEDTC.value|date:'Y-m-d' }}{% endif %}"
                                                      id="{{ form.AEDTC.id_for_label }}"
                                                      placeholder="YYYY-MM-DD">
                                                {% if form.AEDTC.errors %}
                                                    <span class="text-danger">{{ form.AEDTC.errors }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.DELETE }}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr class="aehospevent-form-row empty-row">
                                            <td colspan="4" class="text-center">
                                                <em>{% trans "Không có dữ liệu biến cố. Hãy nhấn nút thêm để tạo mới." %}</em>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-row"
                                        data-formset="#aehospevent-formset">
                                    <i class="fas fa-plus"></i> {% trans "Thêm biến cố" %}
                                </button>
                                <input type="hidden" name="aehospevent_id" id="aehospevent_id" value="1">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>{% trans "38. Cải thiện triệu chứng thực thể ban đầu" %}</h5>
                            <div class="form-check mb-3">
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="has_improvesympt_yes" name="has_improvesympt" value="yes">
                                    <label class="form-check-label" for="has_improvesympt_yes">{% trans "Yes" %}</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="has_improvesympt_no" name="has_improvesympt" value="no" checked>
                                    <label class="form-check-label" for="has_improvesympt_no">{% trans "No" %}</label>
                                </div>
                            </div>
                            <div id="improvesympt-formset" style="display: none;">
                                {{ improvesympt_formset.management_form }}
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Cải thiện triệu chứng?" %}</th>
                                            <th>{% trans "Triệu chứng" %}</th>
                                            <th>{% trans "Tình trạng cải thiện" %}</th>
                                            <th>{% trans "Thời gian đánh giá" %}</th>
                                            <th>{% trans "Xóa" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for form in improvesympt_formset.forms %}
                                        <tr class="improvesympt-form-row">
                                            <td>
                                                {% if form.instance.pk %}
                                                {{ form.id }}
                                                {% endif %}
                                                {{ form.IMPROVE_SYMPTS }}
                                                {% if form.IMPROVE_SYMPTS.errors %}
                                                    <span class="text-danger">{{ form.IMPROVE_SYMPTS.errors }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.SYMPTS }}
                                                {% if form.SYMPTS.errors %}
                                                    <span class="text-danger">{{ form.SYMPTS.errors }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.IMPROVE_CONDITIONS }}
                                                {% if form.IMPROVE_CONDITIONS.errors %}
                                                    <span class="text-danger">{{ form.IMPROVE_CONDITIONS.errors }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <input type="text"
                                                      name="{{ form.SYMPTSDTC.html_name }}"
                                                      class="form-control datepicker"
                                                      value="{% if form.SYMPTSDTC.value %}{{ form.SYMPTSDTC.value|date:'Y-m-d' }}{% endif %}"
                                                      id="{{ form.SYMPTSDTC.id_for_label }}"
                                                      placeholder="YYYY-MM-DD">
                                                {% if form.SYMPTSDTC.errors %}
                                                    <span class="text-danger">{{ form.SYMPTSDTC.errors }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {{ form.DELETE }}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr class="improvesympt-form-row empty-row">
                                            <td colspan="5" class="text-center">
                                                <em>{% trans "Không có dữ liệu cải thiện triệu chứng. Hãy nhấn nút thêm để tạo mới." %}</em>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-row"
                                        data-formset="#improvesympt-formset">
                                    <i class="fas fa-plus"></i> {% trans "Thêm cải thiện triệu chứng" %}
                                </button>
                                <input type="hidden" name="improvesympt_id" id="improvesympt_id" value="1">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "36. Quá trình nằm viện" %}</h5>
                      </div>
                    </div>
                    <div class="row mb-4">
                      <div class="col-12">
                        <div id="hospiprocess-formset">
                          {{ hospiprocess_formset.management_form }}
                          <table class="table table-bordered">
                            <thead>
                              <tr>
                                <th>{% trans "Khoa" %}</th>
                                <th>{% trans "Từ thời gian (nn/tt/nnnn)" %}</th>
                                <th>{% trans "Đến thời gian (nn/tt/nnnn)" %}</th>
                                <th>{% trans "Lý do chuyển" %}</th>
                                <th>{% trans "Xóa" %}</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for form in hospiprocess_formset.forms %}
                              <tr class="hospiprocess-form-row">
                                <td>
                                  {% if form.instance.pk %}
                                  {{ form.id }}
                                  {% endif %}
                                  {{ form.DEPTNAME }}
                                  {% if form.DEPTNAME.errors %}
                                    <span class="text-danger">{{ form.DEPTNAME.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  <input type="text"
                                        name="{{ form.STARTDTC.html_name }}"
                                        class="form-control datepicker"
                                        value="{% if form.STARTDTC.value %}{{ form.STARTDTC.value|date:'Y-m-d' }}{% endif %}"
                                        id="{{ form.STARTDTC.id_for_label }}"
                                        placeholder="YYYY-MM-DD">
                                  {% if form.STARTDTC.errors %}
                                    <span class="text-danger">{{ form.STARTDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  <input type="text"
                                        name="{{ form.ENDDTC.html_name }}"
                                        class="form-control datepicker"
                                        value="{% if form.ENDDTC.value %}{{ form.ENDDTC.value|date:'Y-m-d' }}{% endif %}"
                                        id="{{ form.ENDDTC.id_for_label }}"
                                        placeholder="YYYY-MM-DD">
                                  {% if form.ENDDTC.errors %}
                                    <span class="text-danger">{{ form.ENDDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.TRANSFER_REASON }}
                                  {% if form.TRANSFER_REASON.errors %}
                                    <span class="text-danger">{{ form.TRANSFER_REASON.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.DELETE }}
                                </td>
                              </tr>
                              {% empty %}
                              <tr class="hospiprocess-form-row empty-row">
                                <td colspan="5" class="text-center">
                                  <em>{% trans "Không có dữ liệu quá trình nằm viện. Hãy nhấn nút thêm để tạo mới." %}</em>
                                </td>
                              </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                          <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-row"
                                  data-formset="#hospiprocess-formset">
                            <i class="fas fa-plus"></i> {% trans "Thêm quá trình nằm viện" %}
                          </button>
                        </div>
                      </div>
                    </div>
                    <!-- PHẦN 3: KHÁNG SINH ĐIỀU TRỊ -->
                    <div class="form-section-header">
                      <i class="fas fa-pills"></i> {% trans "KHÁNG SINH ĐIỀU TRỊ" %}
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "37. Kháng sinh điều trị chính" %}</h5>
                      </div>
                    </div>
                    <div class="row mb-4">
                      <div class="col-12">
                        <div id="main-antibiotic-formset">{{ main_antibiotic_formset.management_form }}
                          <table class="table table-bordered">
                            <thead>
                              <tr>
                                <th>{% trans "Tên kháng sinh" %}</th>
                                <th>{% trans "Liều dùng" %}</th>
                                <th>{% trans "Ngày bắt đầu" %}</th>
                                <th>{% trans "Ngày kết thúc" %}</th>
                                <th>{% trans "Xóa" %}</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for form in main_antibiotic_formset.forms %}                      
                              <tr class="antibiotic-form main-antibiotic-form-row">
                                <td>
                                  {{ form.id }}
                                  {{ form.MAINANTIBIONAME }}
                                  {% if form.MAINANTIBIONAME.errors %}
                                  <span class="text-danger">{{ form.MAINANTIBIONAME.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.MAINANTIBIODOSAGE }}
                                  {% if form.MAINANTIBIODOSAGE.errors %}
                                  <span class="text-danger">{{ form.MAINANTIBIODOSAGE.errors }}</span>
                                  {% endif %}                        </td>
                                <td>
                                  <input type="text" name="{{ form.MAINANTIBIOSTARTDTC.html_name }}" 
                                        class="form-control datepicker" 
                                        value="{{ form.MAINANTIBIOSTARTDTC.value|default:'' }}"
                                        id="{{ form.MAINANTIBIOSTARTDTC.id_for_label }}">
                                  {% if form.MAINANTIBIOSTARTDTC.errors %}
                                  <span class="text-danger">{{ form.MAINANTIBIOSTARTDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  <input type="text" name="{{ form.MAINANTIBIOENDDTC.html_name }}" 
                                        class="form-control datepicker" 
                                        value="{{ form.MAINANTIBIOENDDTC.value|default:'' }}"
                                        id="{{ form.MAINANTIBIOENDDTC.id_for_label }}">
                                  {% if form.MAINANTIBIOENDDTC.errors %}
                                  <span class="text-danger">{{ form.MAINANTIBIOENDDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.DELETE }}
                                </td>
                              </tr>                      
                              {% empty %}                      
                              <tr class="antibiotic-form main-antibiotic-form-row empty-row">
                                <td colspan="5" class="text-center">
                                  <em>{% trans "Không có dữ liệu kháng sinh chính. Hãy nhấn nút thêm để tạo mới." %}</em>
                                </td>
                              </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                          <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-row" 
                                  data-formset="#main-antibiotic-formset">
                            <i class="fas fa-plus"></i> {% trans "Thêm kháng sinh" %}
                          </button>
                        </div>
                      </div>
                    </div>        
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "38. Kháng sinh trước nhập viện" %}</h5>
                      </div>
                    </div>            
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <div class="form-group">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="id_PRIORANTIBIOTIC" name="PRIORANTIBIOTIC" {% if form.PRIORANTIBIOTIC.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_PRIORANTIBIOTIC">{% trans "Kháng sinh trước nhập viện" %}</label>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div id="prior-antibiotic-section" class="toggle-section" style="display: none;">
                      <div class="row mb-4">
                      <div class="col-12">
                        <div id="prior-antibiotic-formset">{{ prior_antibiotic_formset.management_form }}
                          <table class="table table-bordered">
                            <thead>
                              <tr>
                                <th>{% trans "Tên kháng sinh" %}</th>
                                <th>{% trans "Liều dùng" %}</th>
                                <th>{% trans "Ngày bắt đầu" %}</th>
                                <th>{% trans "Ngày kết thúc" %}</th>
                                <th>{% trans "Xóa" %}</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for form in prior_antibiotic_formset.forms %}
                              <tr class="antibiotic-form prior-antibiotic-form-row">
                                <td>
                                  {{ form.id }}
                                  {{ form.PRIORANTIBIONAME }}
                                  {% if form.PRIORANTIBIONAME.errors %}
                                  <span class="text-danger">{{ form.PRIORANTIBIONAME.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.PRIORANTIBIODOSAGE }}
                                  {% if form.PRIORANTIBIODOSAGE.errors %}
                                  <span class="text-danger">{{ form.PRIORANTIBIODOSAGE.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  <input type="text" name="{{ form.PRIORANTIBIOSTARTDTC.html_name }}" 
                                        class="form-control datepicker" 
                                        value="{{ form.PRIORANTIBIOSTARTDTC.value|default:'' }}"
                                        id="{{ form.PRIORANTIBIOSTARTDTC.id_for_label }}">
                                  {% if form.PRIORANTIBIOSTARTDTC.errors %}
                                  <span class="text-danger">{{ form.PRIORANTIBIOSTARTDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  <input type="text" name="{{ form.PRIORANTIBIOENDDTC.html_name }}" 
                                        class="form-control datepicker" 
                                        value="{{ form.PRIORANTIBIOENDDTC.value|default:'' }}"
                                        id="{{ form.PRIORANTIBIOENDDTC.id_for_label }}">
                                  {% if form.PRIORANTIBIOENDDTC.errors %}
                                  <span class="text-danger">{{ form.PRIORANTIBIOENDDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.DELETE }}
                                </td>
                              </tr>
                              {% empty %}
                              <tr class="antibiotic-form prior-antibiotic-form-row empty-row">
                                <td colspan="5" class="text-center">
                                  <em>{% trans "Không có dữ liệu kháng sinh trước. Hãy nhấn nút thêm để tạo mới." %}</em>
                                </td>
                              </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                          <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-row" 
                                  data-formset="#prior-antibiotic-formset">
                            <i class="fas fa-plus"></i> {% trans "Thêm kháng sinh" %}
                          </button>
                        </div>
                      </div>
                    </div>
                    </div> <!-- End prior-antibiotic-section -->
                    
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "39. Kháng sinh ban đầu tại thời điểm nhập viện" %}</h5>
                      </div>
                    </div>
                    
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <div class="form-group">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="id_INITIALANTIBIOTIC" name="INITIALANTIBIOTIC" {% if form.INITIALANTIBIOTIC.value %}checked{% endif %}>
                            <label class="form-check-label" for="id_INITIALANTIBIOTIC">{% trans "Kháng sinh ban đầu" %}</label>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div id="initial-antibiotic-section" class="toggle-section" style="display: none;">
                      <div class="row mb-4">
                      <div class="col-12">
                        <div id="initial-antibiotic-formset">{{ initial_antibiotic_formset.management_form }}
                          <table class="table table-bordered">
                            <thead>
                              <tr>
                                <th>{% trans "Tên kháng sinh" %}</th>
                                <th>{% trans "Liều dùng" %}</th>
                                <th>{% trans "Ngày bắt đầu" %}</th>
                                <th>{% trans "Ngày kết thúc" %}</th>
                                <th>{% trans "Xóa" %}</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for form in initial_antibiotic_formset.forms %}
                              <tr class="antibiotic-form initial-antibiotic-form-row">
                                <td>
                                  {{ form.id }}
                                  {{ form.INITIALANTIBIONAME }}
                                  {% if form.INITIALANTIBIONAME.errors %}
                                  <span class="text-danger">{{ form.INITIALANTIBIONAME.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.INITIALANTIBIODOSAGE }}
                                  {% if form.INITIALANTIBIODOSAGE.errors %}
                                  <span class="text-danger">{{ form.INITIALANTIBIODOSAGE.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  <input type="text" name="{{ form.INITIALANTIBIOSTARTDTC.html_name }}" 
                                        class="form-control datepicker" 
                                        value="{{ form.INITIALANTIBIOSTARTDTC.value|default:'' }}"
                                        id="{{ form.INITIALANTIBIOSTARTDTC.id_for_label }}">
                                  {% if form.INITIALANTIBIOSTARTDTC.errors %}
                                  <span class="text-danger">{{ form.INITIALANTIBIOSTARTDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  <input type="text" name="{{ form.INITIALANTIBIOENDDTC.html_name }}" 
                                        class="form-control datepicker" 
                                        value="{{ form.INITIALANTIBIOENDDTC.value|default:'' }}"
                                        id="{{ form.INITIALANTIBIOENDDTC.id_for_label }}">
                                  {% if form.INITIALANTIBIOENDDTC.errors %}
                                  <span class="text-danger">{{ form.INITIALANTIBIOENDDTC.errors }}</span>
                                  {% endif %}
                                </td>
                                <td>
                                  {{ form.DELETE }}
                                </td>
                              </tr>
                              {% empty %}
                              <tr class="antibiotic-form initial-antibiotic-form-row empty-row">
                                <td colspan="5" class="text-center">
                                  <em>{% trans "Không có dữ liệu kháng sinh ban đầu. Hãy nhấn nút thêm để tạo mới." %}</em>
                                </td>
                              </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                          <button type="button" class="btn btn-sm btn-outline-primary mt-2 add-row" 
                                  data-formset="#initial-antibiotic-formset">
                            <i class="fas fa-plus"></i> {% trans "Thêm kháng sinh" %}
                          </button>
                        </div>
                      </div>
                    </div>
                    </div> <!-- End initial-antibiotic-section -->
                    
                    <div class="row mb-3">
                      <div class="col-md-12">
                        <h5>{% trans "40. Điều trị kháng sinh ban đầu phù hợp?" %}</h5>
                      </div>
                    </div>
                    
                    <div class="row mb-4">
                      <div class="col-md-6">
                        <div class="form-group">
                          <div class="form-check">
                            <input type="radio" class="form-check-input" id="abx_approp_yes" name="abx_appropriate" value="yes">
                            <label class="form-check-label" for="abx_approp_yes">{% trans "Có" %}</label>
                          </div>
                          <div class="form-check">
                            <input type="radio" class="form-check-input" id="abx_approp_no" name="abx_appropriate" value="no">
                            <label class="form-check-label" for="abx_approp_no">{% trans "Không" %}</label>
                          </div>
                          <div class="form-check">
                            <input type="radio" class="form-check-input" id="abx_approp_unknown" name="abx_appropriate" value="unknown">
                            <label class="form-check-label" for="abx_approp_unknown">{% trans "Không biết" %}</label>
                          </div>
                          <div class="d-none">
                            {{ form.INITIALABXAPPROP }}
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Navigation buttons -->
                    <div class="row mt-4">
                      <div class="col-6">
                        <button type="button" class="btn btn-secondary prev-page" data-target="page2-tab">
                          <i class="fas fa-chevron-left mr-1"></i> {% trans "Quay lại" %}
                        </button>
                      </div>
                      <div class="col-6 text-right">
                        <button type="submit" class="btn btn-success">
                          <i class="fas fa-save"></i> {% trans "Hoàn thành" %}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js_dashboard %}
{% include 'studies/study_43en/CRF/includes/datepicker_scripts.html' %}

<!-- Then load other form scripts -->
<script src="{% static 'js/clinical_form.js' %}"></script>
<!-- Load audit log scripts first -->
<script src="{% static 'js/audit-log/base.js' %}"></script>
<script src="{% static 'js/audit-log/clinical-form.js' %}"></script>


{% endblock %}
