{% extends 'default/dashboard.html' %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block title %}{{ title }}{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">{% trans "Dashboard" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'screening_contact_list' %}">{% trans "Người tiếp xúc" %}</a></li>
<li class="breadcrumb-item active">{{ title }}</li>
{% endblock %}

{% block dashboard_content %}
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header{% if is_view_only %} bg-info{% endif %}">
        <h3 class="card-title">
          {% trans "Thông tin Người tiếp xúc" %}
        </h3>
        {% if is_view_only %}
          <span class="badge badge-warning readonly-badge">
            <i class="fas fa-eye"></i> {% trans "Chỉ xem" %}
          </span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if form.errors %}
          <div class="alert alert-danger alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            <h5><i class="icon fas fa-ban"></i> {% trans "Lỗi!" %}</h5>
            <ul>
              {% for field in form %}
                {% for error in field.errors %}
                  <li><strong>{{ field.label }}</strong>: {{ error }}</li>
                {% endfor %}
              {% endfor %}
              {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if not is_view_only %}
        <form method="post" id="contactScreeningForm">
          {% csrf_token %}
          <!-- Hidden fields for audit logging -->
          <input type="hidden" id="oldDataJson" name="oldDataJson" value="">
          <input type="hidden" id="newDataJson" name="newDataJson" value="">
          <input type="hidden" id="change_reason" name="change_reason" value="">
          <input type="hidden" id="reasons_json" name="reasons_json" value="">
        {% else %}
        <div id="screeningContactFormReadonly" class="readonly-form">
        {% endif %}

        <!-- Thông tin cơ bản -->
        <div class="card card-default">
          <div class="card-header">
            <h3 class="card-title">{% trans "Thông tin cơ bản" %}</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                {% bootstrap_field form.SCRID layout='horizontal' %}
              </div>
              {# USUBJID chỉ render nếu có trong form.fields #}
              {% if form.USUBJID %}
              <div class="col-md-6">
                {% bootstrap_field form.USUBJID layout='horizontal' %}
              </div>
              {% endif %}
              <div class="col-md-6">
                <div class="form-group row">
                  <label for="id_SITEID" class="col-sm-4 col-form-label">{{ form.SITEID.label }}</label>
                  <div class="col-sm-8">
                    {% if selected_site_id == 'all' %}
                      <!-- Dropdown select cho trường hợp chọn "Tất cả các site" -->
                      <select class="form-control" id="id_SITEID" 
                              name="SITEID" data-initial-value="{{ form.instance.SITEID|default:'' }}" 
                              {% if is_readonly %}disabled{% endif %} required>
                                <option value="" {% if not form.SITEID.value %}selected{% endif %}>-- Chọn Site ID --</option>
                                <option value="003" {% if form.SITEID.value == '003' %}selected{% endif %}>003 - Bệnh viện Bệnh Nhiệt đới</option>
                                <option value="020" {% if form.SITEID.value == '020' %}selected{% endif %}>020 - Bệnh Nhiệt đới Trung ương</option>
                                <option value="011" {% if form.SITEID.value == '011' %}selected{% endif %}>011 - Bệnh viện Chợ Rẫy</option>
                      </select>
                    {% else %}
                      <!-- Text input cho trường hợp đã chọn site cụ thể -->
                      <input type="text" class="form-control" id="id_SITEID" 
                             name="SITEID" value="{{ selected_site_id|default:form.SITEID.value|default:'' }}" 
                             data-initial-value="{{ form.instance.SITEID|default:'' }}"
                             readonly required>
                    {% endif %}
                    {% if form.SITEID.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.SITEID.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                {% bootstrap_field form.INITIAL layout='horizontal' %}
              </div>
              <div class="col-md-12">
                {% bootstrap_field form.SUBJIDENROLLSTUDY layout='horizontal' %}
              </div>
              <div class="col-md-6">
                {% bootstrap_field form.SCREENINGFORMDATE layout='horizontal' field_class='datepicker' %}
              </div>
            </div>
          </div>
        </div>

        <!-- Tiêu chí tiếp xúc -->
        <div class="card card-default mt-3">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-check-circle mr-2"></i>
              {% trans "Tiêu chí tiếp xúc" %}
            </h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="control-label">{{ form.LIVEIN5DAYS3MTHS.label }}*</label>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_LIVEIN5DAYS3MTHS_1" name="LIVEIN5DAYS3MTHS" value="1" class="custom-control-input"
                  {% if form.instance.LIVEIN5DAYS3MTHS == True %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_LIVEIN5DAYS3MTHS_1">{% trans "Có" %}</label>
              </div>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_LIVEIN5DAYS3MTHS_0" name="LIVEIN5DAYS3MTHS" value="0" class="custom-control-input"
                  {% if form.instance.LIVEIN5DAYS3MTHS == False or form.instance.LIVEIN5DAYS3MTHS == None %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_LIVEIN5DAYS3MTHS_0">{% trans "Không" %}</label>
              </div>
              {% if form.LIVEIN5DAYS3MTHS.errors %}
                <div class="text-danger">{{ form.LIVEIN5DAYS3MTHS.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group">
              <label class="control-label">{{ form.MEALCAREONCEDAY.label }}*</label>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_MEALCAREONCEDAY_1" name="MEALCAREONCEDAY" value="1" class="custom-control-input"
                  {% if form.instance.MEALCAREONCEDAY == True %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_MEALCAREONCEDAY_1">{% trans "Có" %}</label>
              </div>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_MEALCAREONCEDAY_0" name="MEALCAREONCEDAY" value="0" class="custom-control-input"
                  {% if form.instance.MEALCAREONCEDAY == False or form.instance.MEALCAREONCEDAY == None %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_MEALCAREONCEDAY_0">{% trans "Không" %}</label>
              </div>
              {% if form.MEALCAREONCEDAY.errors %}
                <div class="text-danger">{{ form.MEALCAREONCEDAY.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group">
              <label class="control-label">{{ form.CONSENTTOSTUDY.label }}*</label>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_CONSENTTOSTUDY_1" name="CONSENTTOSTUDY" value="1" class="custom-control-input"
                  {% if form.instance.CONSENTTOSTUDY == True %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_CONSENTTOSTUDY_1">{% trans "Có" %}</label>
              </div>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_CONSENTTOSTUDY_0" name="CONSENTTOSTUDY" value="0" class="custom-control-input"
                  {% if form.instance.CONSENTTOSTUDY == False or form.instance.CONSENTTOSTUDY == None %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_CONSENTTOSTUDY_0">{% trans "Không" %}</label>
              </div>
              {% if form.CONSENTTOSTUDY.errors %}
                <div class="text-danger">{{ form.CONSENTTOSTUDY.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Thông tin hoàn thành -->
        <div class="card card-default mt-3">
          <div class="card-header">
            <h3 class="card-title">{% trans "Thông tin hoàn thành" %}</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                {% bootstrap_field form.COMPLETEDBY layout='horizontal' %}
              </div>
              <div class="col-md-6">
                {% bootstrap_field form.COMPLETEDDATE layout='horizontal' field_class='datepicker' %}
              </div>
            </div>
          </div>
        </div>

        <!-- Nút hành động -->
        <div class="mt-4">
          {% if not is_view_only %}
            <button type="submit" class="btn btn-primary" id="submitButton">
              <i class="fas fa-save mr-1"></i> {% trans "Lưu" %}
            </button>
          {% endif %}
          <a href="{% url 'screening_contact_list' %}" class="btn btn-secondary">
            <i class="fas fa-times-circle mr-1"></i> {% if is_view_only %}{% trans "Quay lại" %}{% else %}{% trans "Hủy" %}{% endif %}
          </a>
          {% if contact and not is_view_only %}
            <a href="{% url 'screening_contact_delete' contact.USUBJID|default:contact.SCRID %}" class="btn btn-danger float-right">
              <i class="fas fa-trash"></i> {% trans "Xóa" %}
            </a>
          {% endif %}
          {% if contact.USUBJID %}
          {% if not contact.enrollmentcontact %}
            <a href="{% url 'enrollment_contact_create' usubjid=contact.USUBJID %}" class="btn btn-info">
              <i class="fas fa-user-plus"></i> Đăng ký thông tin chi tiết
            </a>
          {% else %}
            <a href="{% url 'enrollment_contact_view' usubjid=contact.USUBJID %}" class="btn btn-success">
              <i class="fas fa-eye"></i> Xem đăng ký chi tiết
            </a>
            <a href="{% url 'enrollment_contact_update' usubjid=contact.USUBJID %}" class="btn btn-warning">
              <i class="fas fa-edit"></i> Sửa đăng ký chi tiết
            </a>
          {% endif %}
        {% endif %}
        </div>

        {% if not is_view_only %}   
        </form>
        {% else %}
        </div>
        {% endif %}
      </div>
    </div> 
  </div>
</div>
{% endblock %}

{% block extra_js_dashboard %}
{% include 'studies/study_43en/CRF/includes/datepicker_scripts.html' %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Add audit log scripts -->
<script src="{% static 'js/audit-log/base.js' %}"></script>
<script src="{% static 'js/audit-log/contact-screening.js' %}"></script>
<script>
  // Set view mode global variable
  window.isReadonly = {% if is_view_only %}true{% else %}false{% endif %};
  console.log("Template: setting window.isViewOnly =", window.isReadonly);
  
  $(document).ready(function() {
    // Xử lý SITEID field dựa trên selected_site_id
    var selectedSiteId = "{{ selected_site_id }}";
    
    if (selectedSiteId && selectedSiteId !== 'all') {
      // Nếu đã chọn site cụ thể, đặt readonly
      $('#id_SITEID').prop('readonly', true);
    }
    
    // Add data-initial-value attributes to bootstrap_field form elements
    $('input, select, textarea').each(function() {
      const name = $(this).attr('name');
      if (name && !$(this).attr('data-initial-value') && name !== 'csrfmiddlewaretoken') {
        let value = $(this).val() || '';
        if ($(this).is(':radio')) {
          if ($(this).is(':checked')) {
            value = $(this).val();
          } else {
            return; // Skip unchecked radios
          }
        }
        console.log("Adding data-initial-value to", name, "=", value);
        $(this).attr('data-initial-value', value);
      }
    });
    
    // Debug output of form fields for diagnosis
    console.log("=== FORM FIELDS ===");
    const formFields = {};
    $('input, select, textarea').each(function() {
      const name = $(this).attr('name');
      if (name && name !== 'csrfmiddlewaretoken') {
        let value = $(this).val() || '';
        if (!formFields[name]) {
          formFields[name] = value;
        }
      }
    });
    console.log(formFields);
    console.log("=================");
    
    // Cài đặt Select2
    $('.select2').select2({
      placeholder: "{% trans 'Chọn bệnh nhân' %}",
      allowClear: true
    });
    
    // Cài đặt datepicker
    $('.datepicker').datepicker({
      format: 'dd/mm/yyyy',
      autoclose: true,
      todayHighlight: true
    });
    
    // Đánh dấu các radio button có class custom-control
    $('.custom-control-input').parent().addClass('custom-control');
    
    // Debug form submission
    $('#contactScreeningForm').on('submit', function() {
      console.log("Form submission from inline script");
    });
    
    
    // Add emergency keyboard shortcut for form submission (Ctrl+Alt+S)
    $(document).keydown(function(e) {
      if (e.ctrlKey && e.altKey && e.which === 83) { // Ctrl+Alt+S
        e.preventDefault();
        console.log("Emergency keyboard shortcut triggered");
        emergencySubmitForm();
      }
    });
    
    // Double-click on submit button for emergency submission
    $('#submitButton').dblclick(function(e) {
      e.preventDefault();
      console.log("Emergency double-click submission triggered");
      emergencySubmitForm();
    });
    
    // Emergency form submission function
    function emergencySubmitForm() {
      // Show saving indicator
      $('#submitButton').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i> Đang lưu khẩn cấp...');
      
      // Prepare hidden fields with current data
      const formData = {};
      $('#contactScreeningForm').serializeArray().forEach(function(item) {
        if (item.name !== 'csrfmiddlewaretoken') {
          formData[item.name] = item.value.trim();
        }
      });
      
      // Handle checkboxes
      $('#contactScreeningForm').find('input[type="checkbox"]').each(function() {
        const name = $(this).attr('name');
        if (name) {
          formData[name] = $(this).prop('checked') ? '1' : '0';
        }
      });
      
      // Set basic values in hidden fields
      $('#oldDataJson').val(JSON.stringify({}));
      $('#newDataJson').val(JSON.stringify(formData));
      $('#change_reason').val("Emergency submission");
      $('#reasons_json').val(JSON.stringify({"_emergency": {"reason": "Emergency submission", "label": "Emergency"}}));
      
      // Submit form directly
      try {
        $('#contactScreeningForm').off('submit').submit();
        console.log("Emergency form submitted via jQuery");
      } catch(e) {
        console.error("jQuery emergency submit failed:", e);
        try {
          document.getElementById('contactScreeningForm').submit();
          console.log("Emergency form submitted via vanilla JS");
        } catch(e2) {
          console.error("Vanilla JS emergency submit failed:", e2);
          
          // Last resort - directly submit the form
          try {
            const form = document.getElementById('contactScreeningForm');
            if (form) {
              form.setAttribute('data-emergency', 'true');
              const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
              form.dispatchEvent(submitEvent);
              console.log("Emergency form submitted via Event dispatch");
            }
          } catch(e3) {
            console.error("All emergency submit methods failed:", e3);
            alert("Could not submit form - please try saving again or contact support");
            $('#submitButton').prop('disabled', false).html('<i class="fas fa-save mr-1"></i> Lưu');
          }
        }
      }
    }
    
    // Add debug keyboard shortcut (Ctrl+Alt+D)
    $(document).keydown(function(e) {
      if (e.ctrlKey && e.altKey && e.which === 68) { // Ctrl+Alt+D
        e.preventDefault();
        debugFormStatus();
      }
    });
    
    // Debug function to check form status
    function debugFormStatus() {
      console.log("=== FORM DEBUG INFO ===");
      console.log("Form exists:", $('#contactScreeningForm').length > 0);
      console.log("isReadOnly:", window.isReadonly);
      
      // Check radio buttons
      const radioFields = ['LIVEIN5DAYS3MTHS', 'MEALCAREONCEDAY', 'CONSENTTOSTUDY'];
      radioFields.forEach(field => {
        console.log(`${field}:`, $(`input[name="${field}"]:checked`).val());
      });
      
      // Check other important fields
      console.log("SCRID:", $('input[name="SCRID"]').val());
      console.log("INITIAL:", $('input[name="INITIAL"]').val());
      console.log("SITEID:", $('input[name="SITEID"]').val());
      
      // Check hidden audit fields
      console.log("oldDataJson:", $('#oldDataJson').val());
      console.log("newDataJson:", $('#newDataJson').val());
      console.log("change_reason:", $('#change_reason').val());
      console.log("reasons_json:", $('#reasons_json').val());
      
      // Show alert with summary
      alert("Form debug info has been logged to console.\n\nTo force submit the form, press Ctrl+Alt+S or double-click the Save button.");
    }
    
    // Nếu đang ở chế độ xem thì disable tất cả các trường
    {% if is_view_only %}
      $('#screeningContactFormReadonly input, #screeningContactFormReadonly select, #screeningContactFormReadonly textarea').attr('disabled', 'disabled');
    {% endif %}
  });
</script>
{% endblock %}