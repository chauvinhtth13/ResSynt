{% extends 'default/dashboard.html' %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}
{% include 'study_43en/change_reason_modal.html' %}

{% block title %}{% trans "Thông Tin Nuôi Cấy Vi Sinh 43EN" %}{% endblock %}

{% block page_title %}{% trans "Thông Tin Nuôi Cấy Vi Sinh 43EN" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'enrollment_case_list' %}">{% trans "Danh sách Bệnh nhân 43EN" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'patient_detail' usubjid=enrollment_case.USUBJID %}">{% trans "Bệnh nhân" %} {{ enrollment_case.USUBJID }}</a></li>
<li class="breadcrumb-item active">{% trans "Nuôi Cấy Vi Sinh" %}{% if is_view_only %} ({% trans "Xem" %}){% elif edit_mode %} ({% trans "Chỉnh sửa" %}){% endif %}</li>
{% endblock %}

{% block extra_head_dashboard %}
<style>
  /* Save indicator */
  #saveIndicator {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 1050;
    display: none;
  }
  
  /* Form thêm mới */
  .new-culture-form {
    background-color: #f8f9fa;
    border-left: 3px solid #17a2b8;
    padding: 15px 10px;
    margin-bottom: 10px;
    border-radius: 5px;
  }
  
  .saving-indicator, .saved-indicator {
    font-size: 0.85rem;
    padding: 3px 8px;
    border-radius: 3px;
  }
  
  .saved-indicator {
    background-color: #d4edda;
  }
  
  /* Add some styling for table */
  .table th {
    font-weight: 600;
    background-color: #f8f9fa;
  }
  
  .table td {
    vertical-align: middle;
  }
  
  /* Cải thiện form styling */
  .form-label {
    font-weight: 600;
    margin-bottom: 0.3rem;
    font-size: 0.95rem;
  }
  
  .form-control, .form-select {
    border-radius: 4px;
    border-color: #ced4da;
    padding: 0.4rem 0.75rem;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  
  .form-control::placeholder {
    color: #adb5bd;
    font-size: 0.9rem;
  }
  
  /* Card styling */
  .card-header.bg-primary {
    background-color: #0d6efd !important;
    font-weight: 500;
  }
  
  .culture-form-container {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
  }
  
  /* Buttons styling */
  .btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  
  /* Form groups spacing */
  .mb-3 {
    margin-bottom: 1rem !important;
  }
  
  /* Đảm bảo chiều cao nhất định cho các trường input */
  .form-select, .form-control {
    min-height: 38px;
  }
  
  /* Đảm bảo các nhãn có cùng chiều cao */
  .form-label {
    min-height: 24px;
    display: flex;
    align-items: center;
  }
  
  /* Đảm bảo khoảng cách đều giữa các dòng của form */
  .g-3 > .col,
  .g-3 > [class*="col-"] {
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
  }

  /* Styling cho badge trạng thái */
  .badge {
    font-weight: 500;
    font-size: 0.8rem;
    padding: 0.35em 0.65em;
  }

  .badge.bg-warning {
    color: #212529;
  }

  .badge.bg-light {
    border: 1px solid #dee2e6;
  }

  .readonly-form a.btn,
  .readonly-form .btn-primary {
    pointer-events: auto !important;
    opacity: 1 !important;
    display: inline-block !important;
  }
  
  /* Đảm bảo chỉ nút kháng sinh có thể nhấn */
  .readonly-form .d-flex a.btn-primary {
    cursor: pointer !important;
    pointer-events: auto !important;
  }
  
  /* Xóa bỏ hiệu ứng disabled từ nút chỉ xem */
  .btn.disabled {
    pointer-events: none;
  }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h3 class="card-title">{% trans "Thông tin nuôi cấy vi sinh bệnh nhân" %} {{ enrollment_case.USUBJID }}</h3>
          <div>
            <a href="{% url 'study_43en:clinical_case_update' usubjid=enrollment_case.USUBJID %}" class="btn btn-secondary btn-sm">
              <i class="fas fa-arrow-left"></i> {% trans "Quay lại thông tin lâm sàng" %}
            </a>
            
            {% if is_view_only %}
            <a href="{% url 'study_43en:microbiology_culture_list' enrollment_case.USUBJID %}?mode=edit" class="btn btn-warning btn-sm">
              <i class="fas fa-edit"></i> {% trans "Chuyển sang chế độ chỉnh sửa" %}
            </a>
            {% elif edit_mode %}
            <a href="{% url 'study_43en:microbiology_culture_list' enrollment_case.USUBJID %}?mode=view" class="btn btn-info btn-sm">
              <i class="fas fa-eye"></i> {% trans "Chuyển sang chế độ xem" %}
            </a>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="card-body {% if is_view_only %}readonly-form{% endif %}">
        <!-- Save indicator -->
        <div id="saveIndicator" class="alert alert-success" role="alert">
          <span class="message"></span>
        </div>
        <!-- Unified Form for Adding New Culture -->
        {% if not is_view_only %}
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">{% trans "Thêm mẫu nuôi cấy mới" %}</h5>
          </div>
          <div class="card-body culture-form-container">
            <form id="newCultureForm">
              <input type="hidden" id="oldDataJson" name="oldDataJson">
              <input type="hidden" id="newDataJson" name="newDataJson">
              <input type="hidden" id="reasonsJson" name="reasonsJson">
              <input type="hidden" id="change_reason" name="change_reason">
              <div class="row g-3">
                <!-- Cột 1: Loại bệnh phẩm và Mã số bệnh phẩm -->
                <div class="col-12 col-md-4">
                  <div class="mb-3">
                    <label for="new-sample-type" class="form-label">{% trans "Loại bệnh phẩm" %}:</label>
                    <select class="form-select" id="new-sample-type" name="SPECIMENTYPE">
                      <option value="">-- {% trans "Chọn loại bệnh phẩm" %} --</option>
                      {% for code, name in sample_types.items %}
                      <option value="{{ code }}">{{ name }}</option>
                      {% endfor %}
                      <option value="OTHER">{% trans "Khác" %}</option>
                    </select>
                  </div>
                  <div class="mb-3" id="other-sample-type-container" style="display: none;">
                    <label for="other-sample-type" class="form-label">{% trans "Loại bệnh phẩm khác" %}:</label>
                    <input type="text" class="form-control" id="other-sample-type" name="OTHERSPECIMEN" placeholder="Nhập loại bệnh phẩm khác...">
                  </div>
                  <div class="mb-3">
                    <label for="new-unified-sample-id" class="form-label">{% trans "Mã số bệnh phẩm (SID)" %}:</label>
                    <input type="text" class="form-control" id="new-unified-sample-id" name="SPECIMENID" placeholder="Nhập mã số...">
                  </div>
                </div>
                <!-- Cột 2: Kết quả và Chi tiết kết quả -->
                <div class="col-12 col-md-4">
                  <div class="mb-3">
                    <label for="new-unified-result-type" class="form-label">{% trans "Kết quả" %}:</label>
                    <select class="form-select" id="new-unified-result-type" name="RESULT">
                      <option value="">-- {% trans "Chọn kết quả" %} --</option>
                      <option value="POSITIVE">{% trans "Dương tính" %}</option>
                      <option value="NEGATIVE">{% trans "Âm tính" %}</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="new-unified-result-details" class="form-label">{% trans "Chi tiết kết quả" %}:</label>
                    <input type="text" class="form-control" id="new-unified-result-details" name="RESULTDETAILS" placeholder="Nhập chi tiết kết quả...">
                  </div>
                </div>
                <!-- Cột 3: Ngày thực hiện và nút gửi -->
                <div class="col-12 col-md-4">
                  <div class="mb-3">
                    <label for="new-unified-performed-date" class="form-label">{% trans "Ngày thực hiện" %}:</label>
                    <input type="date" class="form-control" id="new-unified-performed-date" name="PERFORMEDDATE">
                  </div>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12 text-end">
                  <button type="button" id="btnAddCulture" class="btn btn-primary">
                    <i class="fas fa-plus"></i> {% trans "Thêm mẫu nuôi cấy" %}
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        {% endif %}

        <!-- Danh sách mẫu nuôi cấy hiện có -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">{% trans "Danh sách mẫu nuôi cấy" %}</h5>
          </div>
          <div class="card-body">
            {% if cultures %}
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>{% trans "Loại bệnh phẩm" %}</th>
                      <th>{% trans "Mã số" %}</th>
                      <th>{% trans "Kết quả" %}</th>
                      <th>{% trans "Chi tiết kết quả" %}</th>
                      <th>{% trans "Ngày thực hiện" %}</th>
                      <th>{% trans "Trạng thái" %}</th>
                      <th class="text-center">{% trans "Thao tác" %}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for culture in cultures %}
                      <tr data-culture-id="{{ culture.id }}">
                        <td>{{ forloop.counter }}</td>
                        <td>
                          {% if culture.SPECIMENTYPE == 'OTHER' %}
                            {{ culture.OTHERSPECIMEN }}
                          {% else %}
                            {{ culture.get_SPECIMENTYPE_display|default:"-" }}
                          {% endif %}
                        </td>
                        <td>{{ culture.SPECIMENID|default:"-" }}</td>
                        <td>{{ culture.get_RESULT_display|default:"-" }}</td>
                        <td>{{ culture.RESULTDETAILS|default:"-" }}</td>
                        <td>{{ culture.PERFORMEDDATE|date:"d/m/Y"|default:"-" }}</td>
                        <td>
                          {% if culture.RESULT == 'NEGATIVE' %}
                            <span class="badge bg-info">{% trans "Âm tính" %}</span>
                          {% elif culture.RESULT == 'POSITIVE' %}
                            {% if culture.has_sensitivities %}
                              {% if culture.sensitivity_status == 'complete' %}
                                <span class="badge bg-success">{% trans "Hoàn thành độ nhạy KS" %}</span>
                              {% else %}
                                <span class="badge bg-warning text-dark">{% trans "Độ nhạy KS chưa hoàn thành" %}</span>
                              {% endif %}
                            {% else %}
                              <span class="badge bg-danger">{% trans "Chưa có độ nhạy KS" %}</span>
                            {% endif %}
                          {% else %}
                            <span class="badge bg-light">{% trans "Không xác định" %}</span>
                          {% endif %}
                        </td>
                        <td class="text-center">
                          {% if not is_view_only %}
                            <div class="btn-group">
                              <button type="button" class="btn btn-sm btn-warning btn-edit-culture" title="{% trans 'Chỉnh sửa' %}" data-culture-id="{{ culture.id }}">
                                <i class="fas fa-edit"></i>
                              </button>
                              {% if culture.RESULT == 'POSITIVE' %}
                                <a href="{% url 'study_43en:antibiotic_sensitivity_list' usubjid culture.id %}?mode=edit" class="btn btn-sm btn-primary" title="{% trans 'Độ nhạy kháng sinh' %}">
                                  <i class="fas fa-flask"></i>
                                </a>
                              {% endif %}
                            </div>
                          {% else %}
                            <div class="d-flex gap-1">
                              {% if culture.RESULT == 'POSITIVE' %}
                                <a href="{% url 'study_43en:antibiotic_sensitivity_list' usubjid culture.id %}?mode=view" class="btn btn-sm btn-primary" title="{% trans 'Xem độ nhạy kháng sinh' %}">
                                  <i class="fas fa-flask"></i>
                                </a>
                              {% else %}
                                <span class="btn btn-sm btn-secondary disabled">
                                  <i class="fas fa-ban"></i>
                                </span>
                              {% endif %}
                            </div>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> {% trans "Chưa có mẫu nuôi cấy nào. Hãy thêm mẫu nuôi cấy mới." %}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Modal chỉnh sửa mẫu nuôi cấy -->
        {% if not is_view_only %}
        <div class="modal fade" id="editCultureModal" tabindex="-1" aria-labelledby="editCultureModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editCultureModalLabel">{% trans "Chỉnh sửa thông tin mẫu nuôi cấy" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="editCultureForm">
                  <input type="hidden" id="edit-culture-id" name="culture_id">
                  <input type="hidden" id="oldDataJson" name="oldDataJson">
                  <input type="hidden" id="newDataJson" name="newDataJson">
                  <input type="hidden" id="reasonsJson" name="reasonsJson">
                  <input type="hidden" id="change_reason" name="change_reason">
                  <div class="row g-3">
                    <!-- Cột 1: Loại bệnh phẩm và Mã số bệnh phẩm -->
                    <div class="col-12 col-md-4">
                      <div class="mb-3">
                        <label for="edit-sample-type" class="form-label">{% trans "Loại bệnh phẩm" %}:</label>
                        <select class="form-select" id="edit-sample-type" name="SPECIMENTYPE">
                          <option value="">-- {% trans "Chọn loại bệnh phẩm" %} --</option>
                          {% for code, name in sample_types.items %}
                          <option value="{{ code }}">{{ name }}</option>
                          {% endfor %}
                          <option value="OTHER">{% trans "Khác" %}</option>
                        </select>
                      </div>
                      <div class="mb-3" id="edit-other-sample-container" style="display: none;">
                        <label for="edit-other-sample" class="form-label">{% trans "Loại bệnh phẩm khác" %}:</label>
                        <input type="text" class="form-control" id="edit-other-sample" name="OTHERSPECIMEN" placeholder="Nhập loại bệnh phẩm khác...">
                      </div>
                      <div class="mb-3">
                        <label for="edit-sample-id" class="form-label">{% trans "Mã số bệnh phẩm (SID)" %}:</label>
                        <input type="text" class="form-control" id="edit-sample-id" name="SPECIMENID" placeholder="Nhập mã số...">
                      </div>
                    </div>
                    <!-- Cột 2: Kết quả và Chi tiết kết quả -->
                    <div class="col-12 col-md-4">
                      <div class="mb-3">
                        <label for="edit-result-type" class="form-label">{% trans "Kết quả" %}:</label>
                        <select class="form-select" id="edit-result-type" name="RESULT">
                          <option value="">-- {% trans "Chọn kết quả" %} --</option>
                          <option value="POSITIVE">{% trans "Dương tính" %}</option>
                          <option value="NEGATIVE">{% trans "Âm tính" %}</option>
                        </select>
                      </div>
                      <div class="mb-3">
                        <label for="edit-result-details" class="form-label">{% trans "Chi tiết kết quả" %}:</label>
                        <input type="text" class="form-control" id="edit-result-details" name="RESULTDETAILS" placeholder="Nhập chi tiết kết quả...">
                      </div>
                    </div>
                    <!-- Cột 3: Ngày thực hiện -->
                    <div class="col-12 col-md-4">
                      <div class="mb-3">
                        <label for="edit-performed-date" class="form-label">{% trans "Ngày thực hiện" %}:</label>
                        <input type="date" class="form-control" id="edit-performed-date" name="PERFORMEDDATE">
                      </div>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Đóng" %}</button>
                <button type="button" id="btnSaveEditedCulture" class="btn btn-primary">{% trans "Lưu thay đổi" %}</button>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js_dashboard %}
<script src="{% static 'js/audit-log/base.js' %}"></script>
<script src="{% static 'js/studies/study_43en/audit-log/microbiology-form.js' %}"></script>
<script>
$(document).ready(function() {
  const usubjid = '{{ usubjid }}';
  const csrfToken = '{{ csrf_token }}';
  const isViewOnly = {% if is_view_only %}true{% else %}false{% endif %};
  let saveIndicatorTimeout;

  console.log("Microbiology culture JS loaded");
  console.log("USUBJID:", usubjid);
  console.log("View Only Mode:", isViewOnly);

  // Thiết lập CSRF cho AJAX
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      xhr.setRequestHeader("X-CSRFToken", csrfToken);
    }
  });

  // Xử lý hiển thị trường nhập loại bệnh phẩm khác khi chọn "Khác"
  $('#new-sample-type, #edit-sample-type').on('change', function() {
    const isOther = $(this).val() === 'OTHER';
    const container = $(this).attr('id') === 'new-sample-type' ? '#other-sample-type-container' : '#edit-other-sample-container';
    const input = $(this).attr('id') === 'new-sample-type' ? '#other-sample-type' : '#edit-other-sample';
    $(container).toggle(isOther);
    if (!isOther) $(input).val('');
  });

  // Hàm hiển thị thông báo
  function showMessage(message, type = 'success') {
    clearTimeout(saveIndicatorTimeout);
    const $indicator = $('#saveIndicator');
    $indicator.removeClass('alert-success alert-danger alert-warning alert-info')
             .addClass(`alert-${type}`);
    $indicator.find('.message').text(message);
    $indicator.show();
    
    saveIndicatorTimeout = setTimeout(() => {
      $indicator.hide();
    }, 3000);
  }

  // Khởi tạo DataTable nếu không phải chế độ chỉ xem
  if (!isViewOnly) {
    try {
      $('table').DataTable({
        order: [[0, 'desc']],
        responsive: true,
        columnDefs: [
          { orderable: false, targets: [7] }
        ]
      });
    } catch (e) {
      console.log("DataTable init failed:", e);
    }
  }

  // Xử lý nút edit
  $(document).on('click', '.btn-edit-culture', function() {
    const cultureId = $(this).data('culture-id');
    console.log("Edit clicked for culture:", cultureId);
    
    showMessage('Đang tải thông tin...', 'info');
    
    // Tạo URL động - Django sẽ tự động include language prefix và studies/43en/
    const getUrl = `{% url 'study_43en:microbiology_culture_get' usubjid=usubjid culture_id=0 %}`.replace('/0/', `/${cultureId}/`);
    console.log("GET URL:", getUrl);
    
    // Lấy thông tin mẫu
    $.ajax({
      url: getUrl,
      method: 'GET',
      success: function(response) {
        console.log("Get culture success:", response);
        
        // Điền dữ liệu vào modal
        $('#edit-culture-id').val(cultureId);
        $('#edit-sample-type').val(response.SPECIMENTYPE || '');
        $('#edit-result-type').val(response.RESULT || '');
        $('#edit-result-details').val(response.RESULTDETAILS || '');
        $('#edit-sample-id').val(response.SPECIMENID || '');
        $('#edit-performed-date').val(response.PERFORMEDDATE ? response.PERFORMEDDATE.substring(0, 10) : '');
        
        // Xử lý OTHER sample type
        if (response.SPECIMENTYPE === 'OTHER' && response.OTHERSPECIMEN) {
          $('#edit-other-sample-container').show();
          $('#edit-other-sample').val(response.OTHERSPECIMEN);
        } else {
          $('#edit-other-sample-container').hide();
          $('#edit-other-sample').val('');
        }
        
        // Hiển thị modal
        $('#editCultureModal').modal('show');
        $('#saveIndicator').hide();
      },
      error: function(xhr, status, error) {
        console.error("Get culture error:", error);
        showMessage('Không thể lấy thông tin mẫu nuôi cấy', 'danger');
      }
    });
  });

  // Reset form khi đóng modal
  $('#editCultureModal').on('hidden.bs.modal', function() {
    console.log("Modal hidden");
    $('#editCultureForm')[0].reset();
    $('#btnSaveEditedCulture').html('<i class="fas fa-save"></i> Lưu thay đổi').prop('disabled', false);
  });
});
</script>
{% endblock %}