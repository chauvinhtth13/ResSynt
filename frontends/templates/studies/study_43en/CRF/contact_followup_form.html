{% extends 'default/dashboard.html' %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block title %}
  {% if is_view_only %}
    {% trans "Xem Thông Tin Theo Dõi Contact" %}
  {% else %}
    {% trans "Form Theo Dõi Contact 43EN" %}
  {% endif %}
{% endblock %}

{% block page_title %}
  {% if is_view_only %}
    {% trans "Xem Thông Tin Theo Dõi Contact" %}
  {% else %}
    {% trans "Form Theo Dõi Contact 43EN" %}
  {% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'screening_contact_list' %}">{% trans "Danh sách Người tiếp xúc 43EN" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:contact_detail' usubjid=enrollment_contact.USUBJID %}">{{ enrollment_contact.USUBJID }}</a></li>
<li class="breadcrumb-item active">
  {% if followup_type == '28' %}
    {% trans "Theo dõi ngày 28" %}
  {% else %}
    {% trans "Theo dõi ngày 90" %}
  {% endif %}
</li>
{% endblock %}

{% block extra_head_dashboard %}
<link rel="stylesheet" href="{% static 'css/form-animations.css' %}">
<style>
  /* Reset và cơ bản */
  body {
    font-family: 'Roboto', sans-serif;
    color: #495057;
  }
  .card {
    border: none;
    margin-bottom: 25px;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: box-shadow 0.3s ease;
  }
  .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,.125);
    padding: 15px 20px;
  }
  .card-primary .card-header {
    background-color: #3b7ddd;
    color: white;
  }
  .form-section-header {
    background-color: #dce4f1;
    color: #333;
    font-weight: 600;
    padding: 10px 15px;
    margin-bottom: 15px;
    border-left: 4px solid #3b7ddd;
    border-radius: 3px;
    font-size: 1.1rem;
  }
  .followup-container {
    border: 1px solid #dee2e6;
    border-radius: 5px;
    margin-bottom: 20px;
    padding: 0;
    overflow: hidden;
  }
  .followup-header {
    background-color: #dce4f1;
    padding: 10px 15px;
    border-bottom: 1px solid #dee2e6;
    font-weight: 600;
    color: #333;
  }
  .form-group {
    margin-bottom: 1rem;
  }
  .form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #495057;
  }
  .form-control:focus {
    border-color: #3b7ddd;
    box-shadow: 0 0 0 0.2rem rgba(59, 125, 221, 0.25);
  }
  .input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
  }
  .btn {
    font-weight: 600;
    border-radius: 3px;
    transition: all 0.3s ease;
  }
  .btn-primary {
    background-color: #3b7ddd;
    border-color: #3b7ddd;
  }
  .btn-primary:hover {
    background-color: #326abc;
    border-color: #2f62b2;
  }
  .numbered-item {
    position: relative;
    padding-left: 25px;
    margin-bottom: 10px;
  }
  .numbered-item::before {
    content: attr(data-number) '.';
    position: absolute;
    left: 0;
    font-weight: 600;
  }
  .view-only-form .form-control,
  .view-only-form .custom-select,
  .view-only-form .form-check-input,
  .view-only-form select,
  .view-only-form input,
  .view-only-form textarea {
    pointer-events: none;
    background-color: #f8f9fa !important;
    border-color: #e9ecef !important;
    color: #495057 !important;
    opacity: 1;
    box-shadow: none !important;
    cursor: default !important;
  }
  .view-only-form .btn:not(.btn-back):not(.btn-edit) {
    display: none;
  }
  .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }
  .form-group label {
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #495057;
  }
  .form-group .form-control,
  .form-group select,
  .form-group input[type="text"],
  .form-group input[type="date"] {
    margin-top: 0;
    align-self: flex-start;
    height: 38px;
    padding: 0.375rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
  }
  .row .form-group {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
  }
  .row .form-group .form-control,
  .row .form-group select,
  .row .form-group input[type="text"],
  .row .form-group input[type="date"] {
    flex: 1;
    min-height: 38px;
    max-height: 38px;
  }
  .form-group .bootstrap-select,
  .form-group .select2-container {
    height: 38px;
  }
  .form-group .bootstrap-select .dropdown-toggle,
  .form-group .select2-selection {
    height: 38px;
    line-height: 1.5;
    padding: 0.375rem 0.75rem;
  }
  .form-group input[type="date"] {
    font-family: inherit;
    font-size: 1rem;
  }
  .form-group .form-select {
    height: 38px;
    padding: 0.375rem 0.75rem;
  }
  .table thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
  }
  .table-bordered td, .table-bordered th {
    border: 1px solid #dee2e6;
  }
  .card-info {
    border-top: 3px solid #17a2b8;
  }
  .card-warning {
    border-top: 3px solid #ffc107;
  }
  .card-danger {
    border-top: 3px solid #dc3545;
  }
  .card-success {
    border-top: 3px solid #28a745;
  }
  .card-purple {
    border-top: 3px solid #6f42c1;
  }
  .card-secondary {
    border-top: 3px solid #6c757d;
  }
  #saveIndicator {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 1050;
    display: none;
  }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="row">
  <div class="col-md-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">
          {% if is_view_only %}
            <i class="fas fa-user mr-2"></i>{% trans "Thông Tin Theo Dõi Contact" %} {{ enrollment_contact.USUBJID }}
          {% else %}
            <i class="fas fa-user-plus mr-2"></i>{% trans "Form Theo Dõi Contact 43EN" %} {{ enrollment_contact.USUBJID }}
          {% endif %}
        </h3>
        {% if is_view_only %}
        <div class="card-tools">
          <a href="{% url 'study_43en:contact_followup_28_update' usubjid=enrollment_contact.USUBJID %}" class="btn btn-primary btn-sm btn-edit">
            <i class="fas fa-edit"></i> {% trans "Chỉnh sửa" %}
          </a>
        </div>
        {% endif %}
      </div>
      <div class="card-body">
        <div id="saveIndicator" class="alert alert-success" role="alert">
          <span class="message"></span>
        </div>
        {% if form.errors and not is_view_only %}
        <div class="alert alert-danger">
          <ul class="mb-0">
            {% for field, errors in form.errors.items %}
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            {% endfor %}
            {% for error in medication_formset.non_form_errors %}
              <li>{{ error }}</li>
            {% endfor %}
            {% for form in medication_formset %}
              {% for field, errors in form.errors.items %}
                {% for error in errors %}
                  <li>{{ error }}</li>
                {% endfor %}
              {% endfor %}
            {% endfor %}
          </ul>
        </div>
        {% endif %}
        <form method="post" id="contactFollowUpForm" {% if is_view_only %}class="view-only-form"{% endif %} {% if not is_view_only %}data-ajax="true"{% endif %} data-is-new="{% if is_new %}true{% else %}false{% endif %}">
          {% csrf_token %}
          <input type="hidden" name="form_submitted" value="True">
          <input type="hidden" name="debug_info" value="form_version_1.0">
          <input type="hidden" name="COMPLETEDDATE" value="{% if form.COMPLETEDDATE.value %}{{ form.COMPLETEDDATE.value|date:'Y-m-d' }}{% else %}{{ today|date:'Y-m-d' }}{% endif %}">
          <input type="hidden" id="oldDataJson" name="oldDataJson" value="">
          <input type="hidden" id="newDataJson" name="newDataJson" value="">
          <input type="hidden" id="reasonsJson" name="reasonsJson" value="">
          <input type="hidden" id="change_reason" name="change_reason" value="">
          {{ medication_formset.management_form }}
          <div class="followup-container">
            <div class="followup-header">
              <div class="row">
                <div class="col">
                  <h4 class="m-0">FOLLOW UP - CONTACT (28 NGÀY)</h4>
                </div>
              </div>
            </div>
            <div class="followup-content p-3">
              <!-- Thông tin contact -->
              <div class="row mb-3">
                <div class="col-12">
                  <div class="card card-outline card-info">
                    <div class="card-header">
                      <h5 class="card-title">{% trans "Thông tin người tiếp xúc" %}</h5>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-3">
                          <strong>{% trans "Mã số nghiên cứu" %}:</strong><br>
                          <span class="text-primary">43EN</span>
                        </div>
                        <div class="col-md-3">
                          <strong>{% trans "Địa điểm NC" %}:</strong><br>
                          <span class="text-primary">{{ enrollment_contact.SITEID }}</span>
                        </div>
                        <div class="col-md-3">
                          <strong>{% trans "Mã số contact" %}:</strong><br>
                          <span class="text-primary">{{ enrollment_contact.SUBJID }}</span>
                        </div>
                        <div class="col-md-3">
                          <strong>{% trans "Mối quan hệ" %}:</strong><br>
                          <span class="text-primary">{{ enrollment_contact.RELATIONSHIP|default:"-" }}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Đánh giá tại thời điểm follow-up -->
              <div class="form-section-header mt-4 mb-2">
                {% trans "1. Người tiếp xúc gần được đánh giá tại ngày 28?" %}
              </div>
              <div class="row align-items-end">
                <div class="col-md-4">
                  <div class="form-group mb-0">
                    {% bootstrap_field form.ASSESSED %}
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group mb-0">
                    {% bootstrap_field form.ASSESSDATE %}
                  </div>
                </div>
              </div>
              <!-- Yếu tố nguy cơ tiếp xúc với y tế -->
              <div class="form-section-header mt-4">
                {% trans "2. Người tiếp xúc gần có từng tiếp xúc với chăm sóc y tế kể từ lần đánh giá trước?" %}
              </div>
              <div class="row">
                <div class="col-md-3">
                  <div class="form-check mb-2">
                    {% bootstrap_field form.HOSP2D %}
                  </div>
                  <div class="form-check mb-2">
                    {% bootstrap_field form.DIAL %}
                  </div>
                  <div class="form-check mb-2">
                    {% bootstrap_field form.CATHETER %}
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check mb-2">
                    {% bootstrap_field form.SONDE %}
                  </div>
                  <div class="form-check mb-2">
                    {% bootstrap_field form.HOMEWOUNDCARE %}
                  </div>
                  <div class="form-check mb-2">
                    {% bootstrap_field form.LONGTERMCAREFACILITY %}
                  </div>
                </div>
              </div>
              <!-- Sử dụng thuốc -->
              <div class="form-section-header mt-4">
                {% trans "3. Sử dụng thuốc (corticoid, PPI, kháng sinh,...)?" %}
              </div>
              <div class="form-check mb-3">
                {% bootstrap_field form.MEDICATIONUSE %}
              </div>
              <div class="table-responsive" id="medication-table-container">
                {{ medication_formset.management_form }}
                <table class="table table-bordered table-sm" id="medication_history_table">
                  <thead class="thead-light">
                    <tr>
                      <th width="25%">{% trans "Tên thuốc" %}</th>
                      <th width="20%">{% trans "Liều dùng" %}</th>
                      <th width="25%">{% trans "Thời gian sử dụng" %}</th>
                      <th width="30%">{% trans "Lý do" %}</th>
                      {% if not is_view_only %}
                      <th width="5%"></th>
                      {% endif %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for med_form in medication_formset %}
                      <tr>
                        <td style="display:none;">{{ med_form.id }}</td>
                        <td>{{ med_form.MEDICATIONNAME }}</td>
                        <td>{{ med_form.DOSAGE }}</td>
                        <td>{{ med_form.USAGE_PERIOD }}</td>
                        <td>{{ med_form.REASON }}</td>
                        {% if not is_view_only %}
                        <td class="text-center align-middle">
                          {{ med_form.DELETE }}
                        </td>
                        {% endif %}
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
                {% if not is_view_only %}
                <button type="button" class="btn btn-sm btn-success mt-2" id="add_medication_row">
                  <i class="fas fa-plus"></i> {% trans "Thêm thuốc" %}
                </button>
                {% endif %}
              </div>
              <!-- Thông tin hoàn thành -->
              <div class="form-section-header mt-4">
                {% trans "Chuyên viên" %}
              </div>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    {% bootstrap_field form.COMPLETEDBY %}
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    {% bootstrap_field form.COMPLETEDDATE %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="text-right mt-4 d-flex justify-content-between">
            <div>
              <a href="{% url 'screening_contact_list' %}" class="btn btn-secondary btn-back">
                <i class="fas fa-arrow-left mr-1"></i> {% trans "Quay lại" %}
              </a>
            </div>
            {% if not is_view_only %}
            <button type="button" id="btnSaveFollowUp" class="btn btn-primary btn-lg">
              <i class="fas fa-save mr-1"></i> {% trans "Lưu thông tin" %}
            </button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js_dashboard %}
{% include 'studies/study_43en/CRF/includes/datepicker_scripts.html' %}
<script src="{% static 'js/audit-log/base.js' %}"></script>
<script src="{% static 'js/audit-log/contact-followup-form.js' %}"></script>
<script>
$(document).ready(function() {
  // Hiển thị/ẩn bảng thuốc theo checkbox
  function toggleMedicationTable() {
    var checked = $('#id_MEDICATIONUSE').is(':checked');
    $('#medication-table-container').toggle(checked);
  }
  $('#id_MEDICATIONUSE').on('change', toggleMedicationTable);
  toggleMedicationTable();

  // Thêm dòng thuốc mới cho formset
  $('#add_medication_row').on('click', function() {
    var $table = $('#medication_history_table tbody');
    var totalForms = $('#id_{{ medication_formset.prefix }}-TOTAL_FORMS');
    var formIdx = parseInt(totalForms.val());

    var $emptyRow = $table.find('tr:last').clone(true);
    $emptyRow.find('input, select, textarea').each(function() {
      var name = $(this).attr('name');
      if (name) {
        var newName = name.replace(/-\d+-/, '-' + formIdx + '-');
        $(this).attr('name', newName).attr('id', 'id_' + newName);
        if (!name.endsWith('-id')) {
          if ($(this).is(':checkbox')) {
            $(this).prop('checked', false);
          } else {
            $(this).val('');
          }
        } else {
          $(this).val('');
        }
      }
    });

    $emptyRow.find('input[type="checkbox"]').prop('checked', false);
    $table.append($emptyRow);
    totalForms.val(formIdx + 1);
  });

  // Hiệu ứng hiển thị các phần của form
  $('.form-section-header').each(function(index) {
    $(this).css('opacity', '0').css('transform', 'translateY(20px)');
    setTimeout(function(el) {
      $(el).css('transition', 'all 0.5s ease')
        .css('opacity', '1')
        .css('transform', 'translateY(0)');
    }, index * 150, this);
  });

  // Thiết lập CSRF cho AJAX
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
    }
  });
});
</script>
{% endblock %}