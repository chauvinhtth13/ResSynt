{% extends 'default/dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}
  {% if is_readonly %}
    {% trans "Xem thông tin sàng lọc Contact" %}
  {% elif is_create %}
    {% trans "Nhập Contact 43EN" %}
  {% else %}
    {% trans "Cập nhật Contact 43EN" %}
  {% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:screening_contact_list' %}">{% trans "Sàng lọc Contact 43EN" %}</a></li>
<li class="breadcrumb-item active">
  {% if is_readonly %}
    {% trans "Xem thông tin" %}
  {% elif is_create %}
    {% trans "Tạo mới" %}
  {% else %}
    {% trans "Cập nhật" %}
  {% endif %}
</li>
{% endblock %}

{% block extra_head_dashboard %}
{% include 'studies/study_43en/CRF/includes/crf_styles.html' %}
{% endblock %}

{% block page_title %}
{% if is_readonly %}
  {% trans "Xem thông tin sàng lọc Contact" %}
{% elif is_create %}
  {% trans "Nhập Contact 43EN" %}
{% else %}
  {% trans "Cập nhật Contact 43EN" %}
{% endif %}
{% endblock %}

{% block dashboard_content %}
<div class="row">
  <div class="col-md-12">
    <!-- Screening Form Container -->
    <div class="screening-case-container">
      <div class="screening-case-header">
        <i class="fas fa-user-check"></i> {% trans "Sàng lọc Contact 43EN" %}
        <span class="contact-badge">CONTACT</span>
      </div>
      <div class="screening-case-content">
        
        {% if not is_readonly %}
        <form method="post" id="screeningContactForm">
          {% csrf_token %}
          
          <!-- Hidden field for optimistic locking -->
          {{ form.version }}
          
          <!-- Thông tin cơ bản -->
          <div class="card card-default">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-info-circle"></i>
                {% trans "Thông tin cơ bản - Contact" %}
              </h3>
            </div>
            <div class="card-body">
              <div class="row">
                <!-- SCRID - Always locked -->
                <div class="col-md-4">
                  <div class="form-group required-field">
                    <label for="{{ form.SCRID.id_for_label }}">{{ form.SCRID.label }}</label>
                    <input type="text" 
                           class="form-control" 
                           id="{{ form.SCRID.id_for_label }}" 
                           name="SCRID" 
                           value="{{ form.SCRID.value|default:'' }}" 
                           data-initial-value="{{ form.instance.SCRID|default:'' }}"
                           readonly
                           style="background-color: #e9ecef;"
                           required>
                    {% if form.SCRID.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.SCRID.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
                
                <!-- SITEID - Locked when set -->
                <div class="col-md-4">
                  <div class="form-group required-field">
                    <label for="{{ form.SITEID_DISPLAY.id_for_label }}">{{ form.SITEID_DISPLAY.label }}</label>
                    <!-- Display field (readonly) -->
                    <input type="text" 
                           class="form-control" 
                           id="{{ form.SITEID_DISPLAY.id_for_label }}" 
                           value="{% if form.instance.SITEID %}{{ form.instance.SITEID }} - {% if form.instance.SITEID == '003' %}HTD HCMC{% elif form.instance.SITEID == '020' %}NHTD{% elif form.instance.SITEID == '011' %}Cho Ray Hospital{% endif %}{% endif %}" 
                           readonly
                           disabled
                           style="background-color: #e9ecef;"
                           required>
                    <!-- Hidden field for submission -->
                    <input type="hidden" 
                           name="SITEID" 
                           id="{{ form.SITEID.id_for_label }}"
                           value="{{ form.instance.SITEID }}" 
                           data-initial-value="{{ form.instance.SITEID|default:'' }}">
                    {% if form.SITEID.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.SITEID.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
                
                <!-- STUDYID - Always locked (readonly only, NOT disabled) -->
                <div class="col-md-4">
                  <div class="form-group required-field">
                    <label for="{{ form.STUDYID.id_for_label }}">{{ form.STUDYID.label }}</label>
                    <input type="text" 
                           class="form-control" 
                           id="{{ form.STUDYID.id_for_label }}" 
                           name="STUDYID" 
                           value="{{ form.STUDYID.value|default:'43EN' }}" 
                           data-initial-value="{{ form.instance.STUDYID|default:'' }}"
                           readonly
                           style="background-color: #e9ecef;"
                           required>
                    {% if form.STUDYID.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.STUDYID.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
                
                <!-- INITIAL -->
                <div class="col-md-6">
                  <div class="form-group required-field">
                    <label for="{{ form.INITIAL.id_for_label }}">{{ form.INITIAL.label }}</label>
                    <input type="text" 
                           class="form-control" 
                           id="{{ form.INITIAL.id_for_label }}" 
                           name="INITIAL" 
                           value="{{ form.INITIAL.value|default:'' }}" 
                           data-initial-value="{{ form.instance.INITIAL|default:'' }}"
                           {% if is_readonly %}readonly{% endif %} 
                           required>
                    {% if form.INITIAL.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.INITIAL.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
                
                <!-- Related Patient -->
                <div class="col-md-6">
                  <div class="form-group required-field">
                    <label for="{{ form.SUBJIDENROLLSTUDY.id_for_label }}">
                      <i class="fas fa-user-md"></i> {{ form.SUBJIDENROLLSTUDY.label }}
                    </label>
                    <select class="form-control select2" 
                            id="{{ form.SUBJIDENROLLSTUDY.id_for_label }}" 
                            name="SUBJIDENROLLSTUDY" 
                            data-initial-value="{{ form.instance.SUBJIDENROLLSTUDY.USUBJID|default:'' }}"
                            {% if is_readonly %}disabled{% endif %} 
                            required>
                      <option value="">-- {% trans "Chọn bệnh nhân" %} --</option>
                      {% for patient in form.fields.SUBJIDENROLLSTUDY.queryset %}
                        <option value="{{ patient.USUBJID }}" 
                                {% if form.SUBJIDENROLLSTUDY.value == patient.USUBJID %}selected{% endif %}>
                          {{ patient.INITIAL }} ({{ patient.USUBJID }})
                        </option>
                      {% endfor %}
                    </select>
                    <small class="form-text text-muted">
                      <i class="fas fa-info-circle"></i> {% trans "Chọn bệnh nhân mà contact này liên quan" %}
                    </small>
                    {% if form.SUBJIDENROLLSTUDY.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.SUBJIDENROLLSTUDY.errors %}{{ error }}{% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
                
                <!-- SCREENINGFORMDATE -->
                <div class="col-md-6">
                  <div class="form-group required-field">
                    <label for="id_SCREENINGFORMDATE">
                      {% trans "Ngày Screening" %}
                    </label>
                    
                    {% if is_create %}
                      <input type="date" 
                             name="SCREENINGFORMDATE" 
                             id="id_SCREENINGFORMDATE"
                             class="form-control datepicker"
                             value="{{ form.SCREENINGFORMDATE.value|date:'Y-m-d' }}"
                             data-initial-value="">
                    {% else %}
                      <input type="date" 
                             name="SCREENINGFORMDATE" 
                             id="id_SCREENINGFORMDATE"
                             class="form-control datepicker"
                             value="{% if form.instance.SCREENINGFORMDATE %}{{ form.instance.SCREENINGFORMDATE|date:'Y-m-d' }}{% endif %}"
                             data-initial-value="{% if form.instance.SCREENINGFORMDATE %}{{ form.instance.SCREENINGFORMDATE|date:'Y-m-d' }}{% endif %}"
                             readonly>
                    {% endif %}
                    
                    {% if form.SCREENINGFORMDATE.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.SCREENINGFORMDATE.errors }}
                      </div>
                    {% endif %}
                  </div>
                </div>
                
                <!-- USUBJID (if exists) -->
                {% if form.instance.USUBJID %}
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.USUBJID.id_for_label }}">
                        <i class="fas fa-id-card"></i> {{ form.USUBJID.label }}
                      </label>
                      <input type="text" 
                             class="form-control" 
                             id="{{ form.USUBJID.id_for_label }}" 
                             name="USUBJID" 
                             value="{{ form.USUBJID.value|default:'' }}" 
                             data-initial-value="{{ form.instance.USUBJID|default:'' }}"
                             readonly>
                      <small class="form-text text-muted">
                        <i class="fas fa-info-circle"></i> {% trans "Format: SITE-B-XXX-Y" %}
                      </small>
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Tiêu chí tuyển chọn Contact (3 criteria) -->
          <div class="card card-default mt-3">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-check-circle"></i>
                {% trans "Tiêu chí tuyển chọn Contact" %}
                <span class="badge badge-info ml-2">3 tiêu chí</span>
              </h3>
            </div>
            <div class="card-body">
              
              <!-- Criterion 1: Lived together -->
              <div class="form-group">
                <label class="control-label">
                  {% trans "1. Sống chung ≥5 ngày trong 3 tháng qua" %}
                </label>
                <div class="custom-control custom-radio">
                  <input type="radio" 
                         id="id_LIVEIN5DAYS3MTHS_1" 
                         name="LIVEIN5DAYS3MTHS" 
                         value="1" 
                         class="custom-control-input" 
                         {% if form.instance.LIVEIN5DAYS3MTHS == True %}checked{% endif %} 
                         {% if is_readonly %}disabled{% endif %} 
                         data-initial-value="{% if form.instance.LIVEIN5DAYS3MTHS == True %}1{% elif form.instance.LIVEIN5DAYS3MTHS == False %}0{% else %}{% endif %}"
                         required>
                  <label class="custom-control-label" for="id_LIVEIN5DAYS3MTHS_1">
                    {% trans "Có" %}
                  </label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" 
                         id="id_LIVEIN5DAYS3MTHS_0" 
                         name="LIVEIN5DAYS3MTHS" 
                         value="0" 
                         class="custom-control-input" 
                         {% if form.instance.LIVEIN5DAYS3MTHS == False or form.instance.LIVEIN5DAYS3MTHS == None %}checked{% endif %}
                         {% if is_readonly %}disabled{% endif %} 
                         data-initial-value="{% if form.instance.LIVEIN5DAYS3MTHS == True %}1{% elif form.instance.LIVEIN5DAYS3MTHS == False %}0{% else %}0{% endif %}"
                         required>
                  <label class="custom-control-label" for="id_LIVEIN5DAYS3MTHS_0">
                    {% trans "Không" %}
                  </label>
                </div>
              </div>

              <!-- Criterion 2: Shared meals/care -->
              <div class="form-group">
                <label class="control-label">
                  {% trans "2. Ăn cùng/chăm sóc ≥1 lần/ngày" %}
                </label>
                <div class="custom-control custom-radio">
                  <input type="radio" 
                         id="id_MEALCAREONCEDAY_1" 
                         name="MEALCAREONCEDAY" 
                         value="1" 
                         class="custom-control-input" 
                         {% if form.instance.MEALCAREONCEDAY == True %}checked{% endif %}
                         {% if is_readonly %}disabled{% endif %} 
                         data-initial-value="{% if form.instance.MEALCAREONCEDAY == True %}1{% elif form.instance.MEALCAREONCEDAY == False %}0{% else %}{% endif %}"
                         required>
                  <label class="custom-control-label" for="id_MEALCAREONCEDAY_1">
                    {% trans "Có" %}
                  </label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" 
                         id="id_MEALCAREONCEDAY_0" 
                         name="MEALCAREONCEDAY" 
                         value="0" 
                         class="custom-control-input" 
                         {% if form.instance.MEALCAREONCEDAY == False or form.instance.MEALCAREONCEDAY == None %}checked{% endif %}
                         {% if is_readonly %}disabled{% endif %} 
                         data-initial-value="{% if form.instance.MEALCAREONCEDAY == True %}1{% elif form.instance.MEALCAREONCEDAY == False %}0{% else %}0{% endif %}"
                         required>
                  <label class="custom-control-label" for="id_MEALCAREONCEDAY_0">
                    {% trans "Không" %}
                  </label>
                </div>
              </div>

              <!-- Criterion 3: Consent -->
              <div class="form-group" id="consent_field">
                <label class="control-label">
                  {% trans "3. Contact đồng ý tham gia nghiên cứu" %}
                </label>
                <div class="custom-control custom-radio">
                  <input type="radio" 
                         id="id_CONSENTTOSTUDY_1" 
                         name="CONSENTTOSTUDY" 
                         value="1" 
                         class="custom-control-input" 
                         {% if form.instance.CONSENTTOSTUDY == True %}checked{% endif %}
                         {% if is_readonly %}disabled{% endif %} 
                         data-initial-value="{% if form.instance.CONSENTTOSTUDY == True %}1{% elif form.instance.CONSENTTOSTUDY == False %}0{% else %}{% endif %}"
                         required>
                  <label class="custom-control-label" for="id_CONSENTTOSTUDY_1">
                    {% trans "Có" %}
                  </label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" 
                         id="id_CONSENTTOSTUDY_0" 
                         name="CONSENTTOSTUDY" 
                         value="0" 
                         class="custom-control-input" 
                         {% if form.instance.CONSENTTOSTUDY == False or form.instance.CONSENTTOSTUDY == None %}checked{% endif %}
                         {% if is_readonly %}disabled{% endif %} 
                         data-initial-value="{% if form.instance.CONSENTTOSTUDY == True %}1{% elif form.instance.CONSENTTOSTUDY == False %}0{% else %}0{% endif %}"
                         required>
                  <label class="custom-control-label" for="id_CONSENTTOSTUDY_0">
                    {% trans "Không" %}
                  </label>
                </div>
              </div>
              
              <!-- Unrecruited reason -->
              <div class="form-group mt-3">
                <label for="{{ form.UNRECRUITED_REASON.id_for_label }}">
                  <i class="fas fa-comment-alt"></i> {{ form.UNRECRUITED_REASON.label }}
                </label>
                <textarea class="form-control" 
                          id="{{ form.UNRECRUITED_REASON.id_for_label }}" 
                          name="UNRECRUITED_REASON" 
                          rows="3"
                          placeholder="{% trans 'Nhập lý do nếu contact không đủ điều kiện...' %}"
                          data-initial-value="{{ form.instance.UNRECRUITED_REASON|default:'' }}"
                          {% if is_readonly %}readonly{% endif %}>{% if form.UNRECRUITED_REASON.value %}{{ form.UNRECRUITED_REASON.value }}{% endif %}</textarea>
                {% if form.UNRECRUITED_REASON.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.UNRECRUITED_REASON.errors %}{{ error }}{% endfor %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Eligibility Status Display -->
          <div class="eligibility-status mt-3" style="display: none;">
            <!-- Will be populated by JavaScript -->
          </div>
        
          
          <!-- Audit Trail Information -->
          {% if form.instance.pk and form.instance.last_modified_at %}
          <div class="card card-default mt-3">
            <div class="card-header bg-light">
              <h3 class="card-title">
                <i class="fas fa-history"></i>
                {% trans "Thông tin sửa đổi" %}
              </h3>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <p class="mb-2">
                    <strong><i class="fas fa-user-edit mr-1"></i> {% trans "Sửa lần cuối bởi" %}:</strong>
                    {{ form.instance.last_modified_by_username|default:"Không rõ" }}
                  </p>
                  <p class="mb-2">
                    <strong><i class="fas fa-clock mr-1"></i> {% trans "Thời gian sửa" %}:</strong>
                    {{ form.instance.last_modified_at|date:"d/m/Y H:i" }}
                  </p>
                  <p class="mb-0">
                    <strong><i class="fas fa-code-branch mr-1"></i> {% trans "Phiên bản" %}:</strong>
                    v{{ form.instance.version }}
                  </p>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          
          <!-- Action Buttons -->
          <div class="mt-4">
            <a href="{% url 'study_43en:screening_contact_list' %}" class="btn btn-secondary">
              <i class="fas fa-times-circle mr-1"></i> {% trans "Hủy" %}
            </a>
            <button type="reset" class="btn btn-warning btn-reset">
              <i class="fas fa-undo mr-1"></i> {% trans "Làm lại" %}
            </button>
            <button type="submit" class="btn btn-primary" id="submitButton">
              <i class="fas fa-save mr-1"></i> {% trans "Lưu" %}
            </button>
          </div>
        </form>
        
        {% else %}
        <!-- READ-ONLY MODE -->
        <div class="readonly-form">
          <div class="card card-default">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-info-circle"></i>
                {% trans "Thông tin cơ bản - Contact" %}
              </h3>
              <span class="badge badge-light readonly-badge">
                <i class="fas fa-eye"></i> {% trans "Chế độ xem" %}
              </span>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>{{ form.SCRID.label }}</label>
                    <input type="text" class="form-control" value="{{ form.instance.SCRID }}" readonly>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>{{ form.SITEID.label }}</label>
                    <input type="text" class="form-control" value="{{ form.instance.SITEID }}" readonly>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>{{ form.STUDYID.label }}</label>
                    <input type="text" class="form-control" value="{{ form.instance.STUDYID }}" readonly>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>{{ form.INITIAL.label }}</label>
                    <input type="text" class="form-control" value="{{ form.instance.INITIAL }}" readonly>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label><i class="fas fa-user-md"></i> {% trans "Bệnh nhân liên quan" %}</label>
                    <input type="text" class="form-control" 
                           value="{{ form.instance.SUBJIDENROLLSTUDY.INITIAL }} ({{ form.instance.SUBJIDENROLLSTUDY.USUBJID }})" 
                           readonly>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>{% trans "Ngày Screening" %}</label>
                    <input type="text" class="form-control" 
                           value="{% if form.instance.SCREENINGFORMDATE %}{{ form.instance.SCREENINGFORMDATE|date:'d/m/Y' }}{% endif %}" 
                           readonly>
                  </div>
                </div>
                {% if form.instance.USUBJID %}
                <div class="col-md-6">
                  <div class="form-group">
                    <label><i class="fas fa-id-card"></i> {{ form.USUBJID.label }}</label>
                    <input type="text" class="form-control" value="{{ form.instance.USUBJID }}" readonly>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Criteria in read-only (3 criteria) -->
          <div class="card card-default mt-3">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-check-circle"></i>
                {% trans "Tiêu chí Contact" %}
                <span class="badge badge-info ml-2">3 tiêu chí</span>
              </h3>
            </div>
            <div class="card-body">
              <table class="table table-bordered">
                <tbody>
                  <tr>
                    <td width="70%">{% trans "1. Sống chung ≥5 ngày trong 3 tháng qua" %}</td>
                    <td>
                      {% if form.instance.LIVEIN5DAYS3MTHS %}
                        <span class="badge badge-success">{% trans "Có" %}</span>
                      {% else %}
                        <span class="badge badge-secondary">{% trans "Không" %}</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr>
                    <td>{% trans "2. Ăn cùng/chăm sóc ≥1 lần/ngày" %}</td>
                    <td>
                      {% if form.instance.MEALCAREONCEDAY %}
                        <span class="badge badge-success">{% trans "Có" %}</span>
                      {% else %}
                        <span class="badge badge-secondary">{% trans "Không" %}</span>
                      {% endif %}
                    </td>
                  </tr>
                  <tr class="table-success">
                    <td>{% trans "3. Contact đồng ý tham gia nghiên cứu" %}</td>
                    <td>
                      {% if form.instance.CONSENTTOSTUDY %}
                        <span class="badge badge-success">{% trans "Có" %}</span>
                      {% else %}
                        <span class="badge badge-secondary">{% trans "Không" %}</span>
                      {% endif %}
                    </td>
                  </tr>
                </tbody>
              </table>
              
              {% if form.instance.UNRECRUITED_REASON %}
              <div class="mt-3">
                <label><strong>{% trans "Lý do không tuyển dụng:" %}</strong></label>
                <p class="p-2 bg-light border rounded">{{ form.instance.UNRECRUITED_REASON }}</p>
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Action buttons for read-only mode -->
          <div class="mt-4">
            <a href="{% url 'study_43en:screening_contact_list' %}" class="btn btn-secondary">
              <i class="fas fa-arrow-left mr-1"></i> {% trans "Quay lại" %}
            </a>
            {% if perms.study_43en.change_scr_contact %}
            <a href="{% url 'study_43en:screening_contact_update' form.instance.SCRID %}" class="btn btn-warning">
              <i class="fas fa-edit mr-1"></i> {% trans "Chỉnh sửa" %}
            </a>
            {% endif %}
            {% if form.instance.USUBJID and form.instance.is_confirmed %}
              <a href="{% url 'study_43en:contact_detail' form.instance.USUBJID %}" class="btn btn-success">
                <i class="fas fa-users mr-1"></i> {% trans "Xem contact" %}
              </a>
            {% endif %}
          </div>
        </div>
        {% endif %}
        
      </div>
    </div>
  </div>
</div>

<!-- Include Change Reason Modal -->
{% if not is_readonly %}
  {% include 'default/change_reason_modal.html' %}
{% endif %}

{% endblock %}

{% block extra_js_dashboard %}
{% include 'studies/study_43en/CRF/includes/datepicker_scripts.html' %}

<!-- Include Change Reason Handler -->
{% if not is_readonly %}
<script nonce="{{ request.csp_nonce }}" src="{% static 'studies/study_43en/js/change-reason-handler.js' %}"></script>
{% endif %}

<script nonce="{{ request.csp_nonce }}">
  var isReadonly = {% if is_readonly %}true{% else %}false{% endif %};
  var isCreate = {% if is_create %}true{% else %}false{% endif %};
  
  $(document).ready(function() {
    
    console.log(' Contact Screening form init - readonly:', isReadonly, 'create:', isCreate);
    
    // ========================================
    // SITEID FROM URL/CONTEXT
    // ========================================
    var currentSiteId = "{{ form.instance.SITEID|default:'' }}";
    
    console.log(' Current SITEID:', currentSiteId);
    
    // ========================================
    // FILTER RELATED PATIENT BY SITEID
    // ========================================
    function filterPatientsBySite(siteid) {
      console.log(' Filtering patients by SITEID:', siteid);
      
      if (!siteid) {
        // No filter, show all
        $('#id_SUBJIDENROLLSTUDY option').show();
        return;
      }
      
      // Hide all options first
      $('#id_SUBJIDENROLLSTUDY option').each(function() {
        var optionValue = $(this).val();
        
        if (!optionValue) {
          // Keep empty option
          $(this).show();
          return;
        }
        
        // Check if USUBJID starts with SITEID
        // Format: 003-A-001, 020-A-002, etc.
        if (optionValue.startsWith(siteid + '-')) {
          $(this).show();
        } else {
          $(this).hide();
        }
      });
      
      // Count visible options
      var visibleCount = $('#id_SUBJIDENROLLSTUDY option:visible').length - 1; // Exclude empty option
      console.log(' Visible patients:', visibleCount);
      
      // Reset selection if current selection is hidden
      var currentSelection = $('#id_SUBJIDENROLLSTUDY').val();
      if (currentSelection && !currentSelection.startsWith(siteid + '-')) {
        $('#id_SUBJIDENROLLSTUDY').val('').trigger('change');
      }
    }
    
    // Apply filter on load
    if (currentSiteId) {
      filterPatientsBySite(currentSiteId);
    }
    
    // Initialize Select2 for patient selection AFTER filtering
    $('.select2').select2({
      theme: 'bootstrap4',
      placeholder: '-- {% trans "Chọn bệnh nhân" %} --',
      allowClear: true
    });
    
    // ========================================
    // ELIGIBILITY CHECKING (3 criteria)
    // ========================================
    function checkEligibilityCriteria() {
      var lived = $('input[name="LIVEIN5DAYS3MTHS"]:checked').val();
      var meals = $('input[name="MEALCAREONCEDAY"]:checked').val();
      var consent = $('input[name="CONSENTTOSTUDY"]:checked').val();

      var eligible = (lived === '1' && meals === '1' && consent === '1');

      var statusDiv = $('.eligibility-status');
      
      if (lived && meals && consent) {
        statusDiv.show();
        
        if (eligible) {
          statusDiv.removeClass('not-eligible').addClass('eligible')
            .html('<i class="fas fa-check-circle mr-2"></i> {% trans "Contact đủ điều kiện tham gia nghiên cứu" %}');
          
          $('#submitButton')
            .removeClass('btn-primary')
            .addClass('btn-success btn-pulse')
            .html('<i class="fas fa-arrow-circle-right mr-1"></i> {% trans "Lưu & Tiếp tục" %}');
        } else {
          statusDiv.removeClass('eligible').addClass('not-eligible')
            .html('<i class="fas fa-times-circle mr-2"></i> {% trans "Contact không đủ điều kiện tham gia nghiên cứu" %}');
          
          $('#submitButton')
            .removeClass('btn-success btn-pulse')
            .addClass('btn-primary')
            .html('<i class="fas fa-save mr-1"></i> {% trans "Lưu" %}');
        }
      } else {
        statusDiv.hide();
        $('#submitButton')
          .removeClass('btn-success btn-pulse')
          .addClass('btn-primary')
          .html('<i class="fas fa-save mr-1"></i> {% trans "Lưu" %}');
      }
    }
    
    // ========================================
    // SET DEFAULT RADIO VALUES
    // ========================================
    function setDefaultRadioValues() {
      var criteriaFields = ['LIVEIN5DAYS3MTHS', 'MEALCAREONCEDAY', 'CONSENTTOSTUDY'];
      
      criteriaFields.forEach(function(fieldName) {
        if (!$('input[name="' + fieldName + '"]:checked').length) {
          $('#id_' + fieldName + '_0').prop('checked', true);
        }
      });
    }
    
    // ========================================
    // EVENT HANDLERS
    // ========================================
    
    // Eligibility criteria change
    $('input[name="LIVEIN5DAYS3MTHS"], input[name="MEALCAREONCEDAY"], input[name="CONSENTTOSTUDY"]')
      .change(function() {
        checkEligibilityCriteria();
      });
    
    // Reset button
    $('.btn-reset').click(function() {
      setTimeout(function() {
        setDefaultRadioValues();
        checkEligibilityCriteria();
        $('.eligibility-status').hide();
      }, 10);
    });
    
    // ========================================
    // INITIAL SETUP
    // ========================================
    setDefaultRadioValues();
    checkEligibilityCriteria();
    
    // Highlight required fields
    $('input[required]:not([type="radio"]), select[required]')
      .closest('.form-group')
      .addClass('required-field');
    
    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
    
    console.log(' Contact Screening form initialized');
  });
</script>
{% endblock %}