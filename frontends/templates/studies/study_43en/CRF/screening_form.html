{% extends 'default/dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}
  {% if is_readonly %}
    {% trans "Xem thông tin sàng lọc" %}
  {% elif is_create %}
    {% trans "Nhập Bệnh nhân 43EN" %}
  {% else %}
    {% trans "Cập nhật Bệnh nhân 43EN" %}
  {% endif %}
{% endblock %}

{% block page_title %}
  {% if is_readonly %}
    {% trans "Xem thông tin sàng lọc" %} - {{ screening_case.USUBJID }}
  {% elif is_create %}
    {% trans "Nhập Bệnh nhân 43EN" %}
  {% else %}
    {% trans "Cập nhật Bệnh nhân 43EN" %} - {{ form.instance.USUBJID }}
  {% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:screening_case_list' %}">{% trans "Sàng lọc 43EN" %}</a></li>
<li class="breadcrumb-item active">
  {% if is_readonly %}
    {% trans "Xem thông tin" %}
  {% elif is_create %}
    {% trans "Tạo mới" %}
  {% else %}
    {% trans "Cập nhật" %}
  {% endif %}
</li>
{% endblock %}

{% block extra_head_dashboard %}
<style>
  /* Thay đổi cách hiển thị dấu sao cho các trường bắt buộc */
  .required-field label::after {
    content: " *";
    color: red;
  }
  
  /* Ngăn hiển thị dấu sao cho radio buttons */
  .custom-radio label::after {
    content: none !important;
  }
  
  /* CSS khác giữ nguyên */
  .eligibility-status {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 5px;
    text-align: center;
    font-size: 1.1em;
    font-weight: 500;
  }
  
  .eligibility-status.eligible {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
  }
  
  .eligibility-status.not-eligible {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
  }
  
  .custom-control-input:checked ~ .custom-control-label::before {
    border-color: #007bff;
    background-color: #007bff;
  }
  
  .card-header .card-title i {
    margin-right: 5px;
  }
  
  .form-steps .step {
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 15px;
    background-color: #f8f9fa;
    border-left: 4px solid #ddd;
  }
  
  .form-steps .step.active {
    border-left: 4px solid #007bff;
    background-color: #e9f5ff;
  }
  
  .form-steps .step.completed {
    border-left: 4px solid #28a745;
  }
  
  /* Hiệu ứng nút "Lưu & Tiếp tục" */
  .btn-pulse {
    animation: pulse-animation 1.5s infinite;
  }

  @keyframes pulse-animation {
    0% {
      box-shadow: 0 0 0 0px rgba(40, 167, 69, 0.4);
    }
    100% {
      box-shadow: 0 0 0 15px rgba(40, 167, 69, 0);
    }
  }
  
  /* Hiệu ứng chuyển tiếp */
  .next-step-info {
    transition: all 0.3s ease;
  }
  
  /* CSS cho chế độ read-only */
  .readonly-form {
    opacity: 0.9;
  }
  
  .readonly-form .form-control:disabled,
  .readonly-form .form-control[readonly] {
    background-color: #f8f9fa !important;
    opacity: 1;
    border: 1px solid #e9ecef;
  }
  
  .readonly-form .custom-radio input[type="radio"]:disabled + label {
    opacity: 0.8;
    cursor: not-allowed;
  }
  
  .readonly-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 10;
  }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <!-- ... existing code ... -->
      <div class="card-body">
        <!-- ... existing code ... -->

        {% if not is_readonly %}
        <form method="post" id="screeningForm">
          {% csrf_token %}
          
          <!-- Hidden fields for audit logging -->
          <input type="hidden" id="oldDataJson" name="oldDataJson" value="">
          <input type="hidden" id="newDataJson" name="newDataJson" value="">
          <input type="hidden" id="change_reason" name="change_reason" value="">
          <input type="hidden" id="reasons_json" name="reasons_json" value="">
        {% else %}
        <div id="screeningFormReadonly">
        {% endif %}
          
          
          <!-- Thông tin cơ bản -->
          <div class="card card-default">
            <div class="card-header">
              <h3 class="card-title">{% trans "Thông tin cơ bản" %}</h3>
            </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <!-- Thay thế bootstrap_field bằng HTML thủ công để thêm data-initial-value -->
                    <div class="form-group">
                      <label for="{{ form.SCRID.id_for_label }}">{{ form.SCRID.label }}</label>
                      <input type="text" class="form-control" id="{{ form.SCRID.id_for_label }}" 
                             name="SCRID" value="{{ form.SCRID.value|default:'' }}" 
                             data-initial-value="{{ form.instance.SCRID|default:'' }}"
                             {% if is_readonly %}readonly{% endif %} required>
                      {% if form.SCRID.errors %}
                        <div class="invalid-feedback d-block">
                          {% for error in form.SCRID.errors %}{{ error }}{% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.SITEID.id_for_label }}">{{ form.SITEID.label }}</label>
                      {% if selected_site_id == 'all' %}
                        <!-- Dropdown select cho trường hợp chọn "Tất cả các site" -->
                        <select class="form-control" id="{{ form.SITEID.id_for_label }}" 
                                name="SITEID" data-initial-value="{{ form.instance.SITEID|default:'' }}" 
                                {% if is_readonly %}disabled{% endif %} required>
                                  <option value="" {% if not form.SITEID.value %}selected{% endif %}>-- Chọn Site ID --</option>
                                  <option value="003" {% if form.SITEID.value == '003' %}selected{% endif %}>003 - Bệnh viện Bệnh Nhiệt đới</option>
                                  <option value="020" {% if form.SITEID.value == '020' %}selected{% endif %}>020 - Bệnh Nhiệt đới Trung ương</option>
                                  <option value="011" {% if form.SITEID.value == '011' %}selected{% endif %}>011 - Bệnh viện Chợ Rẫy</option>
                        </select>
                      {% else %}
                        <!-- Text input cho trường hợp đã chọn site cụ thể -->
                        <input type="text" class="form-control" id="{{ form.SITEID.id_for_label }}" 
                               name="SITEID" value="{{ form.SITEID.value|default:selected_site_id|default:'' }}" 
                               data-initial-value="{{ form.instance.SITEID|default:'' }}"
                               readonly required>
                      {% endif %}
                      {% if form.SITEID.errors %}
                        <div class="invalid-feedback d-block">
                          {% for error in form.SITEID.errors %}{{ error }}{% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.STUDYID.id_for_label }}">{{ form.STUDYID.label }}</label>
                      <input type="text" class="form-control" id="{{ form.STUDYID.id_for_label }}" 
                             name="STUDYID" value="{{ form.STUDYID.value|default:'' }}" 
                             data-initial-value="{{ form.instance.STUDYID|default:'' }}"
                             {% if is_readonly %}readonly{% endif %} required>
                      {% if form.STUDYID.errors %}
                        <div class="invalid-feedback d-block">
                          {% for error in form.STUDYID.errors %}{{ error }}{% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.INITIAL.id_for_label }}">{{ form.INITIAL.label }}</label>
                      <input type="text" class="form-control" id="{{ form.INITIAL.id_for_label }}" 
                             name="INITIAL" value="{{ form.INITIAL.value|default:'' }}" 
                             data-initial-value="{{ form.instance.INITIAL|default:'' }}"
                             {% if is_readonly %}readonly{% endif %} required>
                      {% if form.INITIAL.errors %}
                        <div class="invalid-feedback d-block">
                          {% for error in form.INITIAL.errors %}{{ error }}{% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.SCREENINGFORMDATE.id_for_label }}">{{ form.SCREENINGFORMDATE.label }}</label>
                      <input type="text" class="form-control datepicker" id="{{ form.SCREENINGFORMDATE.id_for_label }}" 
                             name="SCREENINGFORMDATE" value="{{ form.SCREENINGFORMDATE.value|date:'Y-m-d'|default:'' }}" 
                             data-initial-value="{{ form.instance.SCREENINGFORMDATE|date:'Y-m-d'|default:'' }}"
                             placeholder="YYYY-MM-DD" {% if is_readonly %}readonly{% endif %} required>
                      {% if form.SCREENINGFORMDATE.errors %}
                        <div class="invalid-feedback d-block">
                          {% for error in form.SCREENINGFORMDATE.errors %}{{ error }}{% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                  {# Hiển thị USUBJID chỉ khi đã có (readonly) #}
                  {% if form.fields.USUBJID %}
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="{{ form.USUBJID.id_for_label }}">{{ form.USUBJID.label }}</label>
                        <input type="text" class="form-control" id="{{ form.USUBJID.id_for_label }}" 
                               name="USUBJID" value="{{ form.USUBJID.value|default:'' }}" 
                               data-initial-value="{{ form.instance.USUBJID|default:'' }}"
                               readonly>
                        {% if form.USUBJID.errors %}
                          <div class="invalid-feedback d-block">
                            {% for error in form.USUBJID.errors %}{{ error }}{% endfor %}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Điều kiện Eligibility -->
          <div class="card card-default">
            <div class="card-header">
              <h3 class="card-title">
                <i class="fas fa-check-circle mr-2"></i>
                {% trans "Tiêu chí tuyển chọn" %}
              </h3>
            </div>
            <div class="card-body">
              <!-- Criterion 1: Tuổi trên 16 -->
              <div class="form-group">
                <label class="control-label">{% trans "1. Tuổi trên 16" %}</label>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_UPPER16AGE_1" name="UPPER16AGE" value="1" class="custom-control-input" 
                        {% if form.instance.UPPER16AGE == True %}checked{% endif %} 
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.UPPER16AGE == True %}1{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_UPPER16AGE_1">{% trans "Có" %}</label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_UPPER16AGE_0" name="UPPER16AGE" value="0" class="custom-control-input" 
                        {% if form.instance.UPPER16AGE == False or form.instance.UPPER16AGE == None %}checked{% endif %}
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.UPPER16AGE == False or form.instance.UPPER16AGE == None %}0{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_UPPER16AGE_0">{% trans "Không" %}</label>
                </div>
              </div>

              <!-- Criterion 2: Nhiễm khuẩn trước 2h hoặc sau 48h nhập viện -->
              <div class="form-group">
                <label class="control-label">{% trans "2. Nhiễm khuẩn trước 2h hoặc sau 48h nhập viện" %}</label>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_INFPRIOR2OR48HRSADMIT_1" name="INFPRIOR2OR48HRSADMIT" value="1" class="custom-control-input" 
                        {% if form.instance.INFPRIOR2OR48HRSADMIT == True %}checked{% endif %}
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.INFPRIOR2OR48HRSADMIT == True %}1{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_INFPRIOR2OR48HRSADMIT_1">{% trans "Có" %}</label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_INFPRIOR2OR48HRSADMIT_0" name="INFPRIOR2OR48HRSADMIT" value="0" class="custom-control-input" 
                        {% if form.instance.INFPRIOR2OR48HRSADMIT == False or form.instance.INFPRIOR2OR48HRSADMIT == None %}checked{% endif %}
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.INFPRIOR2OR48HRSADMIT == False or form.instance.INFPRIOR2OR48HRSADMIT == None %}0{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_INFPRIOR2OR48HRSADMIT_0">{% trans "Không" %}</label>
                </div>
              </div>

              <!-- Criterion 3: Phân lập được K.pneumoniae từ nhiễm khuẩn hoặc máu -->
              <div class="form-group">
                <label class="control-label">{% trans "3. Phân lập được K.pneumoniae từ nhiễm khuẩn hoặc máu" %}</label>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_ISOLATEDKPNFROMINFECTIONORBLOOD_1" name="ISOLATEDKPNFROMINFECTIONORBLOOD" value="1" class="custom-control-input" 
                        {% if form.instance.ISOLATEDKPNFROMINFECTIONORBLOOD == True %}checked{% endif %}
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.ISOLATEDKPNFROMINFECTIONORBLOOD == True %}1{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_ISOLATEDKPNFROMINFECTIONORBLOOD_1">{% trans "Có" %}</label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_ISOLATEDKPNFROMINFECTIONORBLOOD_0" name="ISOLATEDKPNFROMINFECTIONORBLOOD" value="0" class="custom-control-input" 
                        {% if form.instance.ISOLATEDKPNFROMINFECTIONORBLOOD == False or form.instance.ISOLATEDKPNFROMINFECTIONORBLOOD == None %}checked{% endif %}
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.ISOLATEDKPNFROMINFECTIONORBLOOD == False or form.instance.ISOLATEDKPNFROMINFECTIONORBLOOD == None %}0{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_ISOLATEDKPNFROMINFECTIONORBLOOD_0">{% trans "Không" %}</label>
                </div>
              </div>
            </div>

              <!-- Criterion 4: K.pneumoniae chưa điều trị ổn định -->
              <!-- Điều kiện Eligibility: Tiêu chuẩn loại trừ -->
              <div class="card card-default mt-4">
                <div class="card-header">
                  <h3 class="card-title text-danger">
                    <i class="fas fa-times-circle mr-2"></i>
                    {% trans "Tiêu chuẩn loại trừ" %}
                  </h3>
                </div>
                <div class="card-body">
                  <!-- Criterion 4 -->
                  <div class="form-group">
                    <label class="control-label">{% trans "4. K.pneumoniae chưa điều trị ổn định" %}</label>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_KPNISOUNTREATEDSTABLE_1" name="KPNISOUNTREATEDSTABLE" value="1" class="custom-control-input" 
                        {% if form.instance.KPNISOUNTREATEDSTABLE == True %}checked{% endif %}
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.KPNISOUNTREATEDSTABLE == True %}1{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_KPNISOUNTREATEDSTABLE_1">{% trans "Có" %}</label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_KPNISOUNTREATEDSTABLE_0" name="KPNISOUNTREATEDSTABLE" value="0" class="custom-control-input" 
                        {% if form.instance.KPNISOUNTREATEDSTABLE == False or form.instance.KPNISOUNTREATEDSTABLE == None %}checked{% endif %}
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.KPNISOUNTREATEDSTABLE == False or form.instance.KPNISOUNTREATEDSTABLE == None %}0{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_KPNISOUNTREATEDSTABLE_0">{% trans "Không" %}</label>
                </div>
              </div>
            </div>


              <!-- Đồng ý tham gia nghiên cứu -->
              <div class="card card-default mt-4">
                <div class="card-header">
                  <h3 class="card-title text-success">
                    <i class="fas fa-user-check mr-2"></i>
                    {% trans "Đồng ý tham gia nghiên cứu" %}
                  </h3>
                </div>
                <div class="card-body">
                  <div class="form-group" id="consent_field">
                    <label class="control-label">{% trans "5. Bệnh nhân đồng ý tham gia nghiên cứu" %}</label>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_CONSENTTOSTUDY_1" name="CONSENTTOSTUDY" value="1" class="custom-control-input" 
                        {% if form.instance.CONSENTTOSTUDY == True %}checked{% endif %}
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.CONSENTTOSTUDY == True %}1{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_CONSENTTOSTUDY_1">{% trans "Có" %}</label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" id="id_CONSENTTOSTUDY_0" name="CONSENTTOSTUDY" value="0" class="custom-control-input" 
                        {% if form.instance.CONSENTTOSTUDY == False or form.instance.CONSENTTOSTUDY == None %}checked{% endif %}
                        {% if is_readonly %}disabled{% endif %} required
                        data-initial-value="{% if form.instance.CONSENTTOSTUDY == False or form.instance.CONSENTTOSTUDY == None %}0{% else %}{% endif %}">
                  <label class="custom-control-label" for="id_CONSENTTOSTUDY_0">{% trans "Không" %}</label>
                </div>
                <div class="form-group row align-items-center">
                  <div class="col-sm-6">
                    <!-- Thay thế bootstrap_field cho UNRECRUITED_REASON -->
                    <div class="form-group">
                      <label for="{{ form.UNRECRUITED_REASON.id_for_label }}">{{ form.UNRECRUITED_REASON.label }}</label>
                      <textarea class="form-control" id="{{ form.UNRECRUITED_REASON.id_for_label }}" 
                                name="UNRECRUITED_REASON" rows="3"
                                data-initial-value="{{ form.instance.UNRECRUITED_REASON|default:'' }}"
                                {% if is_readonly %}readonly{% endif %}>{% if form.UNRECRUITED_REASON.value %}{{ form.UNRECRUITED_REASON.value }}{% endif %}</textarea>
                      {% if form.UNRECRUITED_REASON.errors %}
                        <div class="invalid-feedback d-block">
                          {% for error in form.UNRECRUITED_REASON.errors %}{{ error }}{% endfor %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          
          <!-- Thông báo bước tiếp theo -->
          <div class="next-step-info mt-3 mb-2 d-none" id="nextStepInfo">
            <div class="alert alert-info">
              <i class="fas fa-info-circle mr-2"></i> 
              {% trans "Sau khi lưu thông tin sàng lọc, bạn sẽ được chuyển đến form nhập thông tin chi tiết cho bệnh nhân này." %}
            </div>
          </div>
          
          <!-- Nút Submit -->
          <div class="mt-4">
            {% if not is_readonly %}
              <a href="{% url 'study_43en:screening_case_list' %}" class="btn btn-secondary">
                <i class="fas fa-times-circle mr-1"></i> {% trans "Hủy" %}
              </a>
              <button type="reset" class="btn btn-warning btn-reset">
                <i class="fas fa-undo mr-1"></i> {% trans "Làm lại" %}
              </button>
              
              <!-- Nút động tùy thuộc vào trạng thái đủ điều kiện -->
              <button type="submit" class="btn btn-primary" id="submitButton">
                <i class="fas fa-save mr-1"></i> {% trans "Lưu" %}
              </button>
            {% else %}
              <!-- Chế độ chỉ xem -->
              <a href="{% url 'study_43en:screening_case_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left mr-1"></i> {% trans "Quay lại" %}
              </a>
              <a href="{% url 'study_43en:screening_case_update' screening_case.SCRID %}" class="btn btn-warning">
                <i class="fas fa-edit mr-1"></i> {% trans "Chỉnh sửa" %}
              </a>
              {% if screening_case.UPPER16AGE and screening_case.INFPRIOR2OR48HRSADMIT and screening_case.ISOLATEDKPNFROMINFECTIONORBLOOD and screening_case.KPNISOUNTREATEDSTABLE and screening_case.CONSENTTOSTUDY %}
                <a href="{% url 'study_43en:patient_detail' screening_case.USUBJID %}" class="btn btn-success">
                  <i class="fas fa-user-md mr-1"></i> {% trans "Xem bệnh nhân" %}
                </a>
              {% endif %}
            {% endif %}
          </div>
        {% if not is_readonly %}
        </form>
        {% else %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js_dashboard %}
{% include 'studies/study_43en/CRF/includes/datepicker_scripts.html' %}
<!-- Thêm các script cần thiết -->
<script src="{% static 'js/audit-log/base.js' %}"></script>
<script src="{% static 'js/audit-log/screening-form.js' %}"></script>
<!-- Include modal thay đổi dữ liệu -->
<script>
  var isReadonly = {% if is_readonly %}true{% else %}false{% endif %};
  
  $(document).ready(function() {
    // Xử lý SITEID field dựa trên selected_site_id
    var selectedSiteId = "{{ selected_site_id }}";
    
    if (selectedSiteId && selectedSiteId !== 'all') {
      // Nếu đã chọn site cụ thể, đặt readonly
      $('#id_SITEID').prop('readonly', true);
    }
    
    if (isReadonly) {
      $('#screeningFormReadonly').addClass('readonly-form');
      $('input[type="radio"]').attr('onclick', 'return false;');
    } else {
      $('#screeningForm').on('submit', function(e) {
        console.log('=== FORM SUBMISSION DEBUG ===');
        
        // Log all radio button values
        var criteriaFields = ['UPPER16AGE', 'INFPRIOR2OR48HRSADMIT', 'ISOLATEDKPNFROMINFECTIONORBLOOD', 'KPNISOUNTREATEDSTABLE', 'CONSENTTOSTUDY'];
        criteriaFields.forEach(function(fieldName) {
          var checkedValue = $('input[name="' + fieldName + '"]:checked').val();
          console.log(fieldName + ': ' + checkedValue);
        });
        
        // Log form data that will be submitted
        var formData = new FormData(this);
        console.log('Form data to be submitted:');
        for (var pair of formData.entries()) {
          console.log(pair[0] + ': ' + pair[1]);
        }
        console.log('===============================');
      });
    }
    
    // Xử lý hiển thị các bước form
    function updateFormSteps() {
        var step1Completed = $('#id_SITEID').val() && 
                            $('#id_STUDYID').val() && 
                            $('#id_INITIAL').val();
      
      if (step1Completed) {
        $('#step-basic').removeClass('active').addClass('completed');
        $('#step-eligibility').addClass('active');
      }
      
      var upper16age = $('input[name="UPPER16AGE"]:checked').val();
      var infprior = $('input[name="INFPRIOR2OR48HRSADMIT"]:checked').val();
      var isolated = $('input[name="ISOLATEDKPNFROMINFECTIONORBLOOD"]:checked').val();
      var untreated = $('input[name="KPNISOUNTREATEDSTABLE"]:checked').val();
      
      if (upper16age && infprior && isolated && untreated) {
        $('#step-eligibility').removeClass('active').addClass('completed');
        $('#step-status').addClass('active');
      }
    }
    
    function checkEligibilityCriteria() {
      var upper16age = $('input[name="UPPER16AGE"]:checked').val();
      var infprior = $('input[name="INFPRIOR2OR48HRSADMIT"]:checked').val();
      var isolated = $('input[name="ISOLATEDKPNFROMINFECTIONORBLOOD"]:checked').val();
      var untreated = $('input[name="KPNISOUNTREATEDSTABLE"]:checked').val();

      var eligible = (upper16age === '1' && infprior === '1' && isolated === '1' && untreated === '0');

      var statusDiv = $('.eligibility-status');
      if (upper16age && infprior && isolated && untreated) {
        if (eligible) {
          statusDiv.removeClass('not-eligible').addClass('eligible')
            .html('<i class="fas fa-check-circle mr-2"></i> {% trans "Bệnh nhân đủ điều kiện tham gia nghiên cứu" %}');
          // $('#consent_field').removeClass('d-none'); // BỎ DÒNG NÀY
          $('#submitButton').html('<i class="fas fa-save mr-1"></i> {% trans "Lưu" %}');
          $('#submitButton').attr('title', '{% trans "Lưu thông tin sàng lọc" %}');
        } else {
          statusDiv.removeClass('eligible').addClass('not-eligible')
            .html('<i class="fas fa-times-circle mr-2"></i> {% trans "Bệnh nhân không đủ điều kiện tham gia nghiên cứu" %}');
          // $('#consent_field').addClass('d-none'); // BỎ DÒNG NÀY
          $('#id_CONSENTTOSTUDY_0').prop('checked', true);
          $('#submitButton').html('<i class="fas fa-save mr-1"></i> {% trans "Lưu" %}');
          $('#submitButton').attr('title', '{% trans "Lưu thông tin sàng lọc" %}');
        }
        updateFormSteps();
        updateNextStepInfo();
      } else {
        // $('#consent_field').addClass('d-none'); // BỎ DÒNG NÀY
        $('#nextStepInfo').addClass('d-none');
      }
    }

    function updateNextStepInfo() {
      var upper16age = $('input[name="UPPER16AGE"]:checked').val();
      var infprior = $('input[name="INFPRIOR2OR48HRSADMIT"]:checked').val();
      var isolated = $('input[name="ISOLATEDKPNFROMINFECTIONORBLOOD"]:checked').val();
      var untreated = $('input[name="KPNISOUNTREATEDSTABLE"]:checked').val();
      var consent = $('input[name="CONSENTTOSTUDY"]:checked').val();

      var eligible = (upper16age === '1' && infprior === '1' && isolated === '1' && untreated === '0');

      if (eligible && consent === '1') {
        $('#nextStepInfo').removeClass('d-none');
        $('#submitButton')
          .removeClass('btn-primary')
          .addClass('btn-success btn-pulse')
          .html('<i class="fas fa-arrow-circle-right mr-1"></i> {% trans "Lưu & Tiếp tục" %}');
      } else {
        $('#nextStepInfo').addClass('d-none');
        $('#submitButton')
          .removeClass('btn-success btn-pulse')
          .addClass('btn-primary')
          .html('<i class="fas fa-save mr-1"></i> {% trans "Lưu" %}');
      }
    }

    // Hiệu ứng nhấp nháy cho nút
    function pulseButton() {
      $('#submitButton').removeClass('btn-pulse');
      setTimeout(function() {
          $('#submitButton').addClass('btn-pulse');
      }, 10);
    }
    
    // Kiểm tra ban đầu
    checkEligibilityCriteria();
    updateUsubjid();
    
    // Đảm bảo các radio button mặc định được chọn là "Không" khi form mới
    function setDefaultRadioValues() {
      // Chỉ đặt mặc định nếu không có giá trị nào được chọn
      var criteriaFields = ['UPPER16AGE', 'INFPRIOR2OR48HRSADMIT', 'ISOLATEDKPNFROMINFECTIONORBLOOD', 'KPNISOUNTREATEDSTABLE', 'CONSENTTOSTUDY'];
      
      criteriaFields.forEach(function(fieldName) {
        if (!$('input[name="' + fieldName + '"]:checked').length) {
          // Nếu không có giá trị nào được chọn, chọn "Không" (value="0")
          $('#id_' + fieldName + '_0').prop('checked', true);
        }
      });
    }
    
    // Gọi hàm đặt giá trị mặc định
    setDefaultRadioValues();
    
    // Cập nhật USUBJID khi thay đổi SITEID hoặc SUBJID
    $('#id_SITEID').change(function() {
      updateUsubjid();
    });
    
    // Kiểm tra khi thay đổi tiêu chí
    $('input[name="UPPER16AGE"], input[name="INFPRIOR2OR48HRSADMIT"], input[name="ISOLATEDKPNFROMINFECTIONORBLOOD"], input[name="KPNISOUNTREATEDSTABLE"]').change(function() {
      checkEligibilityCriteria();
      updateNextStepInfo(); // Cập nhật lại thông tin bước tiếp theo mỗi khi có thay đổi tiêu chí
    });
    
    // Theo dõi khi người dùng chọn có đồng ý tham gia
    $('input[name="CONSENTTOSTUDY"]').change(function() {
      updateNextStepInfo();
      
      var consent = $(this).val();
      var upper16age = $('input[name="UPPER16AGE"]:checked').val();
      var infprior = $('input[name="INFPRIOR2OR48HRSADMIT"]:checked').val();
      var isolated = $('input[name="ISOLATEDKPNFROMINFECTIONORBLOOD"]:checked').val();
      var untreated = $('input[name="KPNISOUNTREATEDSTABLE"]:checked').val();
      
      var allCriteriaYes = (upper16age === '1' && infprior === '1' && isolated === '1' && untreated === '1');
      
      if (allCriteriaYes && consent === '1') {
        pulseButton();
      }
    });
    
    // Kiểm tra khi nhập thông tin cơ bản
    $('#id_SITEID, #id_SUBJID, #id_STUDYID, #id_INITIAL').change(function() {
      updateFormSteps();
    });
    
    // Reset form
    $('.btn-reset').click(function() {
      $('#screeningForm')[0].reset();
      checkEligibilityCriteria();
      
      // Reset các bước form
      $('.step').removeClass('active completed');
      $('#step-basic').addClass('active');
      
      // Ẩn thông báo bước tiếp theo
      $('#nextStepInfo').addClass('d-none');
      
      // Khôi phục nút submit
      $('#submitButton')
        .removeClass('btn-success btn-pulse')
        .addClass('btn-primary')
        .html('<i class="fas fa-save mr-1"></i> {% trans "Lưu" %}');
    });
    
    // Highlight các trường bắt buộc
    $('input[required]:not([type="radio"]), select[required]').closest('.form-group').addClass('required-field');
    
    // Tooltip cho các trường bắt buộc
    $('[data-toggle="tooltip"]').tooltip();

    // Hiệu ứng focus cho step hiện tại
    $('.step').click(function() {
      var stepId = $(this).attr('id');
      
      if (stepId === 'step-basic') {
        $('html, body').animate({
          scrollTop: $('#id_SITEID').closest('.card').offset().top - 50
        }, 500);
      } else if (stepId === 'step-eligibility') {
        $('html, body').animate({
          scrollTop: $('#id_UPPER16AGE_1').closest('.card').offset().top - 50
        }, 500);
      } else if (stepId === 'step-status') {
        $('html, body').animate({
          scrollTop: $('#consent_field').offset().top - 50
        }, 500);
      }
    });

    // Hiện thị thông tin về các bước 
    $('.step').popover({
      trigger: 'hover',
      placement: 'bottom',
      content: function() {
        var stepId = $(this).attr('id');
        
        if (stepId === 'step-basic') {
          return '{% trans "Điền thông tin cơ bản về bệnh nhân." %}';
        } else if (stepId === 'step-eligibility') {
          return '{% trans "Đánh giá các tiêu chí để xác định bệnh nhân có đủ điều kiện tham gia nghiên cứu không." %}';
        } else if (stepId === 'step-status') {
          return '{% trans "Xác định xem bệnh nhân có đồng ý tham gia nghiên cứu không." %}';
        }
      }
    });

    // Tự động cuộn đến trạng thái khi trang được tải
    setTimeout(function() {
      if ($('.eligibility-status').html()) {
        $('html, body').animate({
          scrollTop: $('.eligibility-status').offset().top - 100
        }, 800);
      }
    }, 500);
  });
</script>
{% endblock %}