{% extends 'default/dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}
  {% if is_view_only %}
    {% trans "Xem phiếu kết thúc nghiên cứu" %}
  {% elif is_create %}
    {% trans "Tạo phiếu kết thúc nghiên cứu" %}
  {% else %}
    {% trans "Cập nhật phiếu kết thúc nghiên cứu" %}
  {% endif %}
{% endblock %}

{% block page_title %}
  {% if is_view_only %}
    {% trans "Xem phiếu kết thúc nghiên cứu" %} - {{ enrollment_case.USUBJID }}
  {% elif is_create %}
    {% trans "Tạo phiếu kết thúc nghiên cứu" %} - {{ enrollment_case.USUBJID }}
  {% else %}
    {% trans "Cập nhật phiếu kết thúc nghiên cứu" %} - {{ enrollment_case.USUBJID }}
  {% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:patient_list' %}">{% trans "Bệnh nhân 43EN" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:patient_detail' enrollment_case.USUBJID.USUBJID %}">{{ enrollment_case.USUBJID.USUBJID }}</a></li>
<li class="breadcrumb-item active">
  {% if is_view_only %}
    {% trans "Xem phiếu kết thúc" %}
  {% elif is_create %}
    {% trans "Tạo phiếu kết thúc" %}
  {% else %}
    {% trans "Cập nhật phiếu kết thúc" %}
  {% endif %}
</li>
{% endblock %}

{% block extra_head_dashboard %}
<style>
  /* Simplified styling */
  .form-section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
  }
  
  .section-title {
    font-weight: bold;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #3b7ddd;
    color: #333;
  }
  
  .form-group label {
    font-weight: 600;
  }
  
  .question-number {
    font-weight: bold;
    margin-right: 5px;
  }
  
  /* View only styling */
  .view-only-form .form-control,
  .view-only-form select,
  .view-only-form input,
  .view-only-form textarea {
    background-color: #f8f9fa;
    pointer-events: none;
  }
  
  .indent-section {
    margin-left: 1.5rem;
  }
  
  /* Required field styling */
  .required-field label::after {
    content: " *";
    color: red;
  }
  #saveIndicator {
    position: fixed;
    top: 70px;
    right: 20px;
    z-index: 1050;
    display: none;
  }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-clipboard-check mr-2"></i>
          {% if is_view_only %}
            {% trans "Xem phiếu kết thúc nghiên cứu" %}
          {% elif is_create %}
            {% trans "Tạo phiếu kết thúc nghiên cứu" %}
          {% else %}
            {% trans "Cập nhật phiếu kết thúc nghiên cứu" %}
          {% endif %}
        </h3>
      </div>
      
      <div class="card-body">
        {% if form.errors and not is_view_only %}
          <div class="alert alert-danger">
            <h5><i class="icon fas fa-ban"></i> {% trans "Lỗi!" %}</h5>
            <ul>
              {% for field in form %}
                {% for error in field.errors %}
                  <li><strong>{{ field.label }}</strong>: {{ error }}</li>
                {% endfor %}
              {% endfor %}
              {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        
        <form method="post" id="endcaseForm" action="{% if is_view_only %}{% else %}{% if is_create %}{% url 'study_43en:endcasecrf_create' usubjid=enrollment_case.USUBJID.USUBJID %}{% else %}{% url 'study_43en:endcasecrf_update' usubjid=enrollment_case.USUBJID.USUBJID %}{% endif %}{% endif %}" {% if is_view_only %}class="view-only-form"{% endif %} data-is-create="{% if is_create %}true{% else %}false{% endif %}">
          {% csrf_token %}
          <!-- Hidden inputs for audit logging -->
          <input type="hidden" id="oldDataJson" name="oldDataJson" value="">
          <input type="hidden" id="newDataJson" name="newDataJson" value="">
          <input type="hidden" id="reasonsJson" name="reasonsJson" value="">
          <input type="hidden" id="change_reason" name="change_reason" value="">
          <div id="saveIndicator" class="alert alert-success" style="display: none;">
            <span class="message"></span>
          </div>
          
          <!-- Thông tin cơ bản -->
          <div class="form-section">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="{{ form.ENDDATE.id_for_label }}">
                    <span class="question-number">1.</span>
                    {% trans "Ngày ghi nhận" %}
                  </label>
                    <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                    </div>
                    <input type="text" class="form-control datepicker" id="{{ form.ENDDATE.id_for_label }}" 
                          name="ENDDATE" value="{{ form.ENDDATE.value|date:'Y-m-d'|default:'' }}" 
                          data-initial-value="{{ form.ENDDATE.value|date:'Y-m-d'|default:'' }}"
                          placeholder="YYYY-MM-DD">
                    </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-group">
                  <label for="{{ form.ENDFORMDATE.id_for_label }}">
                    <span class="question-number">2.</span>
                    {% trans "Ngày kết thúc nghiên cứu" %}
                  </label>
                    <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                    </div>
                    <input type="text" class="form-control datepicker" id="{{ form.ENDFORMDATE.id_for_label }}" 
                          name="ENDFORMDATE" value="{{ form.ENDFORMDATE.value|date:'Y-m-d'|default:'' }}" 
                          data-initial-value="{{ form.ENDFORMDATE.value|date:'Y-m-d'|default:'' }}"
                          placeholder="YYYY-MM-DD">
                    </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Các lần thăm đã hoàn thành -->
          <div class="form-section">
            <div class="form-group">
              <label>
                <span class="question-number">3.</span>
                {% trans "Đánh dấu tất cả các lần thăm hỏi đã hoàn thành" %}
              </label>
              <div class="row mt-2">
                <div class="col-md-3">
                  <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="VICOMPLETED" 
                        id="{{ form.VICOMPLETED.id_for_label }}" value="1"
                        data-initial-value="{% if form.VICOMPLETED.value %}1{% else %}0{% endif %}"
                      {% if form.VICOMPLETED.value %}checked{% endif %}>
                    <label class="form-check-label" for="{{ form.VICOMPLETED.id_for_label }}">
                      {% trans "V1 (Tham gia nghiên cứu)" %}
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="V2COMPLETED" 
                        id="{{ form.V2COMPLETED.id_for_label }}" value="1"
                        data-initial-value="{% if form.V2COMPLETED.value %}1{% else %}0{% endif %}"
                      {% if form.V2COMPLETED.value %}checked{% endif %}>
                    <label class="form-check-label" for="{{ form.V2COMPLETED.id_for_label }}">
                      {% trans "V2 (Ngày 10±3)" %}
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="V3COMPLETED" 
                        id="{{ form.V3COMPLETED.id_for_label }}" value="1"
                        data-initial-value="{% if form.V3COMPLETED.value %}1{% else %}0{% endif %}"
                      {% if form.V3COMPLETED.value %}checked{% endif %}>
                    <label class="form-check-label" for="{{ form.V3COMPLETED.id_for_label }}">
                      {% trans "V3 (Ngày 28±3)" %}
                    </label>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="V4COMPLETED" 
                        id="{{ form.V4COMPLETED.id_for_label }}" value="1"
                        data-initial-value="{% if form.V4COMPLETED.value %}1{% else %}0{% endif %}"
                      {% if form.V4COMPLETED.value %}checked{% endif %}>
                    <label class="form-check-label" for="{{ form.V4COMPLETED.id_for_label }}">
                      {% trans "V4 (Ngày 90±3)" %}
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Rút khỏi nghiên cứu -->
          <div class="form-section">
            <div class="form-group">
              <label>
                <span class="question-number">4.</span>
                {% trans "Người tham gia rút khỏi hoặc bị yêu cầu rút khỏi nghiên cứu?" %}
              </label>
              <div class="mt-2">
                <div class="form-check mb-2">
                  <input type="radio" name="WITHDRAWREASON" id="id_WITHDRAWREASON_0" value="withdraw"
                    {% if form.WITHDRAWREASON.value == 'withdraw' %}checked data-initial-value="withdraw"{% endif %} class="form-check-input">
                  <label class="form-check-label" for="id_WITHDRAWREASON_0">
                    {% trans "Rút khỏi nghiên cứu" %} <small class="text-muted">({% trans "Người tham gia ngưng đồng thuật tham gia nghiên cứu" %})</small>
                  </label>
                </div>
                <div class="form-check mb-2">
                  <input type="radio" name="WITHDRAWREASON" id="id_WITHDRAWREASON_1" value="forced" 
                         {% if form.WITHDRAWREASON.value == 'forced' %}checked data-initial-value="forced"{% endif %} class="form-check-input">
                  <label class="form-check-label" for="id_WITHDRAWREASON_1">
                    {% trans "Bị rút khỏi nghiên cứu" %} <small class="text-muted">({% trans "Người tham gia không đáp ứng yêu cầu" %})</small>
                  </label>
                </div>
                <div class="form-check">
                  <input type="radio" name="WITHDRAWREASON" id="id_WITHDRAWREASON_2" value="na" 
                         {% if form.WITHDRAWREASON.value == 'na' or not form.WITHDRAWREASON.value %}checked data-initial-value="na"{% endif %} class="form-check-input">
                  <label class="form-check-label" for="id_WITHDRAWREASON_2">
                    {% trans "Không áp dụng" %}
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Không thể hoàn tất nghiên cứu -->
          <div class="form-section">
            <div class="form-group">
              <label>
                <span class="question-number">5.</span>
                {% trans "Người tham gia không thể hoàn tất nghiên cứu?" %}
              </label>
              <div class="mt-2">
                <div class="form-check form-check-inline mr-4">
                  <input type="radio" name="INCOMPLETE" id="id_INCOMPLETE_0" value="yes" 
                         {% if form.INCOMPLETE.value == 'yes' %}checked data-initial-value="yes"{% endif %} class="form-check-input">
                  <label class="form-check-label" for="id_INCOMPLETE_0">{% trans "Có" %}</label>
                </div>
                <div class="form-check form-check-inline mr-4">
                  <input type="radio" name="INCOMPLETE" id="id_INCOMPLETE_1" value="no" 
                         {% if form.INCOMPLETE.value == 'no' %}checked data-initial-value="no"{% endif %} class="form-check-input">
                  <label class="form-check-label" for="id_INCOMPLETE_1">{% trans "Không" %}</label>
                </div>
                <div class="form-check form-check-inline">
                  <input type="radio" name="INCOMPLETE" id="id_INCOMPLETE_2" value="na" 
                         {% if form.INCOMPLETE.value == 'na' or not form.INCOMPLETE.value %}checked data-initial-value="na"{% endif %} class="form-check-input">
                  <label class="form-check-label" for="id_INCOMPLETE_2">{% trans "Không áp dụng" %}</label>
                </div>
              </div>
            </div>
            
            <!-- Chi tiết lý do không hoàn tất -->
            <div id="incomplete_reasons" class="indent-section mt-3" {% if form.INCOMPLETE.value != 'yes' %}style="display:none;"{% endif %}>
              <div class="card bg-light">
                <div class="card-body">
                  <p class="mb-3">{% trans "Nếu Có, xin vui lòng nêu lý do:" %}</p>
                  
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" name="INCOMPLETEDEATH" id="{{ form.INCOMPLETEDEATH.id_for_label }}" value="1"
                      {% if form.INCOMPLETEDEATH.value %}checked data-initial-value="1"{% endif %} data-initial-value="{% if form.INCOMPLETEDEATH.value %}1{% else %}0{% endif %}">
                    <label class="form-check-label" for="{{ form.INCOMPLETEDEATH.id_for_label }}">
                      {% trans "Người tham gia tử vong" %}
                    </label>
                  </div>
                  
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" name="INCOMPLETEMOVED" id="{{ form.INCOMPLETEMOVED.id_for_label }}" value="1"
                      {% if form.INCOMPLETEMOVED.value %}checked data-initial-value="1"{% endif %} data-initial-value="{% if form.INCOMPLETEMOVED.value %}1{% else %}0{% endif %}">
                    <label class="form-check-label" for="{{ form.INCOMPLETEMOVED.id_for_label }}">
                      {% trans "Người tham gia không thể đến địa điểm nghiên cứu" %}
                    </label>
                  </div>
                  
                  <div class="form-group mt-3">
                    <label for="{{ form.INCOMPLETEOTHER.id_for_label }}">{% trans "Khác, ghi rõ:" %}</label>
                    <input type="text" class="form-control" id="{{ form.INCOMPLETEOTHER.id_for_label }}" name="INCOMPLETEOTHER" 
                           value="{{ form.INCOMPLETEOTHER.value|default:'' }}" data-initial-value="{{ form.INCOMPLETEOTHER.value|default:'' }}">
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Mất liên lạc -->
          <div class="form-section">
            <div class="form-group">
              <label>
                <span class="question-number">6.</span>
                {% trans "Người tham gia bị mất liên lạc?" %}
              </label>
              <div class="mt-2">
                <div class="form-check form-check-inline mr-4">
                  <input type="radio" name="LOSTTOFOLLOWUP" id="id_LOSTTOFOLLOWUP_0" value="yes" 
                         {% if form.LOSTTOFOLLOWUP.value == 'yes' %}checked data-initial-value="yes"{% endif %} class="form-check-input">
                  <label class="form-check-label" for="id_LOSTTOFOLLOWUP_0">{% trans "Có" %}</label>
                </div>
                <div class="form-check form-check-inline mr-4">
                  <input type="radio" name="LOSTTOFOLLOWUP" id="id_LOSTTOFOLLOWUP_1" value="no" 
                         {% if form.LOSTTOFOLLOWUP.value == 'no' %}checked data-initial-value="no"{% endif %} class="form-check-input">
                  <label class="form-check-label" for="id_LOSTTOFOLLOWUP_1">{% trans "Không" %}</label>
                </div>
                <div class="form-check form-check-inline">
                  <input type="radio" name="LOSTTOFOLLOWUP" id="id_LOSTTOFOLLOWUP_2" value="na" 
                         {% if form.LOSTTOFOLLOWUP.value == 'na' or not form.LOSTTOFOLLOWUP.value %}checked data-initial-value="na"{% endif %} class="form-check-input">
                  <label class="form-check-label" for="id_LOSTTOFOLLOWUP_2">{% trans "Không áp dụng" %}</label>
                </div>
              </div>
              <small class="text-muted d-block mt-2">
                {% trans "(được xác định bằng việc không thể liên hệ với người tham gia sau ít nhất 3 lần nỗ lực liên lạc trong thời gian 1 tháng sau khi người tham gia bỏ lỡ một lần thăm hỏi)" %}
              </small>
            </div>
          </div>
          
          <!-- Footer buttons -->
          <div class="mt-4 d-flex justify-content-between">
            <div>
              <a href="{% url 'study_43en:patient_detail' enrollment_case.USUBJID.USUBJID %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Quay lại" %}
              </a>
              {% if not is_view_only %}
              <button type="reset" class="btn btn-warning ml-2">
                <i class="fas fa-undo"></i> {% trans "Làm lại" %}
              </button>
              {% endif %}
            </div>
            {% if not is_view_only %}
            <button type="button" id="btnSaveEndcase" class="btn btn-primary">
              <i class="fas fa-save"></i> {% trans "Lưu thông tin" %}
            </button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js_dashboard %}
<script>
  $(document).ready(function() {
    // Toggle các trường phụ thuộc INCOMPLETE
    $('input[name="INCOMPLETE"]').on('change', function() {
      if ($(this).val() === 'yes') {
        $('#incomplete_reasons').slideDown();
      } else {
        $('#incomplete_reasons').slideUp();
        {% if not is_view_only %}
        $('#id_INCOMPLETEDEATH').prop('checked', false);
        $('#id_INCOMPLETEMOVED').prop('checked', false);
        $('#id_INCOMPLETEOTHER').val('');
        {% endif %}
      }
    });
    
    // Kiểm tra trạng thái ban đầu
    if ($('input[name="INCOMPLETE"]:checked').val() === 'yes') {
      $('#incomplete_reasons').show();
    }
    
    // Chế độ chỉ đọc
    {% if is_view_only %}
    $('#endcaseForm input:not([type="hidden"])').attr('readonly', true);
    $('#endcaseForm select').attr('disabled', true);
    $('#endcaseForm textarea').attr('readonly', true);
    $('#endcaseForm input[type="checkbox"], #endcaseForm input[type="radio"]').attr('disabled', true);
    {% endif %}
  });
</script>
{% include 'studies/study_43en/CRF/includes/datepicker_scripts.html' %}
<script src="{% static 'js/audit-log/base.js' %}"></script>
<script src="{% static 'js/audit-log/endcasecrf-form.js' %}"></script>
{% endblock %}