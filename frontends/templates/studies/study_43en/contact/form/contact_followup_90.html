{% extends 'studies\study_43en\home_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}
{% if is_readonly %}
    {% trans "View Contact Follow-up Day 90" %}
{% else %}
    {% if is_create %}
        {% trans "Follow-up Day 90" %}
    {% else %}
        {% trans "Follow-up Day 90" %}
    {% endif %}
{% endif %}
{% endblock %}

{% block page_title %}
{% if is_readonly %}
    {% trans "View Contact Follow-up Day 90" %}
{% else %}
    {% if is_create %}
        {% trans "Follow-up Day 90" %}
    {% else %}
        {% trans "Follow-up Day 90" %}
    {% endif %}
{% endif %}
{% endblock %}

{% block dashboard_css %}
{% include 'studies/study_43en/includes/crf_styles.html' %}
<style>
  /* Contact purple theme */
  .contact-badge {
    background: var(--crf-gradient-primary);
    color: white;
    padding: 6px 14px;
    border-radius: 6px;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item">
        <a href="{% url 'study_43en:contact_list' %}">
            <i class="fas fa-users"></i> {% trans "Contact List" %}
        </a>
    </li>
    <li class="breadcrumb-item">
        <a href="{% url 'study_43en:contact_detail' usubjid=enrollment_contact.USUBJID %}">
            {{ enrollment_contact.USUBJID }}
        </a>
    </li>
    <li class="breadcrumb-item active">
        {% trans "Day 90 Follow-up" %}
    </li>
</ol>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid followup-form">
    <!-- Contact Info Card -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card card-outline card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-user"></i> 
                        {% trans "Contact Information" %}
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>{% trans "Contact ID" %}:</strong><br>
                            <span class="text-primary font-weight-bold">
                                {{ enrollment_contact.USUBJID }}
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>{% trans "Site ID" %}:</strong><br>
                            {{ enrollment_contact.SITEID }}
                        </div>
                        <div class="col-md-3">
                            <strong>{% trans "Relationship" %}:</strong><br>
                            {{ enrollment_contact.RELATIONSHIP|default:"-" }}
                        </div>
                        <div class="col-md-3">
                            <strong>{% trans "Status" %}:</strong><br>
                            {% if followup_case %}
                                <span class="badge badge-success">
                                    <i class="fas fa-check-circle"></i> {% trans "Data Available" %}
                                </span>
                            {% else %}
                                <span class="badge badge-warning">
                                    <i class="fas fa-exclamation-triangle"></i> {% trans "No Data" %}
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <form id="contactFollowUpForm" method="post" novalidate 
          data-is-create="{{ is_create|yesno:'true,false' }}"
          {% if is_readonly %}class="readonly-form"{% endif %}>
        {% csrf_token %}

        <!-- Section 1: Assessment at Day 90 -->
        <div class="card card-outline card-info">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-clipboard-check"></i>
                    {% trans "1. Close contacts were assessed as of Day 90?" %}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- ASSESSED Radio -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label">
                                {{ followup_form.ASSESSED.label }}
                                {% if followup_form.ASSESSED.field.required %}
                                    <span class="text-danger">*</span>
                                {% endif %}
                            </label>
                            <div>
                                {% for choice_value, choice_label in followup_form.ASSESSED.field.choices %}
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" 
                                               type="radio" 
                                               name="ASSESSED" 
                                               id="id_ASSESSED_{{ forloop.counter }}" 
                                               value="{{ choice_value }}"
                                               {% if followup_form.ASSESSED.value == choice_value %}checked{% endif %}
                                               {% if is_readonly %}disabled{% endif %}>
                                        <label class="form-check-label" for="id_ASSESSED_{{ forloop.counter }}">
                                            {{ choice_label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if followup_form.ASSESSED.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ followup_form.ASSESSED.errors }}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- ASSESSDATE -->
                    <div class="col-md-6" id="assessdate-field">
                        <div class="form-group">
                            <label for="id_ASSESSDATE" class="form-label">
                                {{ followup_form.ASSESSDATE.label }}
                            </label>
                            {{ followup_form.ASSESSDATE }}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> Format: DD/MM/YYYY
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Healthcare Exposure -->
        <div class="card card-outline card-warning">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-hospital-user"></i>
                    {% trans "2. Has the close contact had any Healthcare exposure since the last assessment?" %}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="HOSP2D" 
                                   id="id_HOSP2D"
                                   {% if followup_form.HOSP2D.value %}checked{% endif %}
                                   {% if is_readonly %}disabled{% endif %}>
                            <label class="form-check-label" for="id_HOSP2D">
                                {{ followup_form.HOSP2D.label }}
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="DIAL" 
                                   id="id_DIAL"
                                   {% if followup_form.DIAL.value %}checked{% endif %}
                                   {% if is_readonly %}disabled{% endif %}>
                            <label class="form-check-label" for="id_DIAL">
                                {{ followup_form.DIAL.label }}
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="CATHETER" 
                                   id="id_CATHETER"
                                   {% if followup_form.CATHETER.value %}checked{% endif %}
                                   {% if is_readonly %}disabled{% endif %}>
                            <label class="form-check-label" for="id_CATHETER">
                                {{ followup_form.CATHETER.label }}
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check mb-2">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="SONDE" 
                                   id="id_SONDE"
                                   {% if followup_form.SONDE.value %}checked{% endif %}
                                   {% if is_readonly %}disabled{% endif %}>
                            <label class="form-check-label" for="id_SONDE">
                                {{ followup_form.SONDE.label }}
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="HOME_WOUND_CARE" 
                                   id="id_HOME_WOUND_CARE"
                                   {% if followup_form.HOME_WOUND_CARE.value %}checked{% endif %}
                                   {% if is_readonly %}disabled{% endif %}>
                            <label class="form-check-label" for="id_HOME_WOUND_CARE">
                                {{ followup_form.HOME_WOUND_CARE.label }}
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="LONG_TERM_CARE" 
                                   id="id_LONG_TERM_CARE"
                                   {% if followup_form.LONG_TERM_CARE.value %}checked{% endif %}
                                   {% if is_readonly %}disabled{% endif %}>
                            <label class="form-check-label" for="id_LONG_TERM_CARE">
                                {{ followup_form.LONG_TERM_CARE.label }}
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 3: Medication Use -->
        <div class="card card-outline card-success">
            <div class="card-header">
                <h3 class="card-title">
                    <i ></i>
                    {% trans "3. History of medication use (corticoid, PPI, antibiotics)?" %}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-check mb-3">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   name="MEDICATION_USE" 
                                   id="id_MEDICATION_USE"
                                   {% if followup_form.MEDICATION_USE.value %}checked{% endif %}
                                   {% if is_readonly %}disabled{% endif %}>
                            <label class="form-check-label" for="id_MEDICATION_USE">
                                {{ followup_form.MEDICATION_USE.label }}
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Medication Details -->
                <div id="medication-section" class="mt-3" style="display: none;">
                    <h5 class="text-muted">
                        <i class="fas fa-list"></i>
                        {% trans "If Yes, medication details" %}
                    </h5>
                    
                    <!-- Table Header -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="thead-light">
                                <tr>
                                    <th style="width: 10%;">{% trans "Episode" %}</th>
                                    <th style="width: 30%;">{% trans "Drug Name" %}</th>
                                    <th style="width: 15%;">{% trans "Dose" %}</th>
                                    <th style="width: 20%;">{% trans "Duration of Use" %}</th>
                                    <th style="width: 25%;">{% trans "Reason for Use" %}</th>
                                </tr>
                            </thead>
                            <tbody id="medication-formset">
                                {{ medication_formset.management_form }}
                                {% for form in medication_formset %}
                                    <tr class="medication-form">
                                        <td>
                                            {{ form.EPISODE }}
                                            {% for hidden in form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                        </td>
                                        <td>{{ form.MEDICATION_NAME }}</td>
                                        <td>{{ form.DOSAGE }}</td>
                                        <td>{{ form.USAGE_PERIOD }}</td>
                                        <td>{{ form.REASON }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if not is_readonly %}
                    <button type="button" id="add-medication" class="btn btn-success btn-sm">
                        <i class="fas fa-plus"></i> {% trans "Add Medication" %}
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card">
            <div class="card-body text-center">
                {% if not is_readonly %}
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> {% trans "Save" %}
                    </button>
                    <a href="{% url 'study_43en:contact_detail' usubjid=enrollment_contact.USUBJID %}" 
                       class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left"></i> {% trans "Back" %}
                    </a>
                {% else %}
                    <a href="{% url 'study_43en:contact_followup_90_update' usubjid=enrollment_contact.USUBJID %}" 
                       class="btn btn-warning btn-lg">
                        <i ></i> {% trans "Edit" %}
                    </a>
                    <a href="{% url 'study_43en:contact_detail' usubjid=enrollment_contact.USUBJID %}" 
                       class="btn btn-secondary btn-lg">
                        <i class="fas fa-arrow-left"></i> {% trans "Back" %}
                    </a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<!-- Change Reason Modal -->
{% if not is_readonly %}
    {% include 'default/change_reason_modal.html' %}
{% endif %}

{% endblock %}

{% block dashboard_js %}
<!-- Datepicker Scripts -->
{% include 'studies/study_43en/includes/datepicker_scripts.html' %}

<!-- Change Reason Handler -->
<script nonce="{{ request.csp_nonce }}" src="{% static 'studies/study_43en/js/change-reason-handler.js' %}"></script>

<script nonce="{{ request.csp_nonce }}">
$(document).ready(function() {
    console.log(" Initializing Contact Follow-up Day 90 form...");

    // ==========================================
    // CONFIGURATION
    // ==========================================
    const PREFIX_MED = 'medication90';  // ← Day 90 prefix

    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    function toggleSection(checkboxId, sectionId) {
        const isChecked = $(`#${checkboxId}`).is(':checked');
        console.log(`Toggle ${sectionId}: ${checkboxId} = ${isChecked}`);
        
        if (isChecked) {
            $(sectionId).slideDown(300);
        } else {
            $(sectionId).slideUp(300);
        }
    }

    function initializeSections() {
        // ASSESSED → ASSESSDATE
        const assessed = $('input[name="ASSESSED"]:checked').val();
        if (assessed !== 'Yes') {
            $('#assessdate-field').hide();
        }

        // MEDICATION_USE → Medication section
        toggleSection('id_MEDICATION_USE', '#medication-section');
    }

    // ==========================================
    // EVENT HANDLERS
    // ==========================================

    // ASSESSED change
    $(document).on('change', 'input[name="ASSESSED"]', function() {
        if ($(this).val() === 'Yes') {
            $('#assessdate-field').slideDown(300);
        } else {
            $('#assessdate-field').slideUp(300);
        }
    });

    // MEDICATION_USE change
    $('#id_MEDICATION_USE').on('change', function() {
        toggleSection('id_MEDICATION_USE', '#medication-section');
    });

    // ==========================================
    // ADD MEDICATION FORM
    // ==========================================
    $('#add-medication').click(function() {
        console.log(' Adding medication row (Day 90)...');
        
        const tbody = $('#medication-formset');
        const totalForms = parseInt($(`#id_${PREFIX_MED}-TOTAL_FORMS`).val());
        
        console.log(`Current total forms: ${totalForms}`);
        
        // Calculate next episode number from EXISTING forms
        let maxEpisode = 0;
        $('.medication-form').each(function() {
            const episodeInput = $(this).find('input[id$="-EPISODE"]');
            if (episodeInput.length) {
                const episodeVal = parseInt(episodeInput.val());
                console.log(`Found episode: ${episodeVal}`);
                if (!isNaN(episodeVal) && episodeVal > maxEpisode) {
                    maxEpisode = episodeVal;
                }
            }
        });
        const newEpisode = maxEpisode + 1;
        
        console.log(`Max episode: ${maxEpisode}, New episode: ${newEpisode}`);

        const newRowHtml = `
            <tr class="medication-form">
                <td>
                    <input type="number" name="${PREFIX_MED}-${totalForms}-EPISODE" 
                           value="${newEpisode}" readonly class="form-control form-control-sm" 
                           id="id_${PREFIX_MED}-${totalForms}-EPISODE">
                    <input type="hidden" name="${PREFIX_MED}-${totalForms}-id">
                    <input type="hidden" name="${PREFIX_MED}-${totalForms}-USUBJID">
                </td>
                <td>
                    <input type="text" name="${PREFIX_MED}-${totalForms}-MEDICATION_NAME" 
                           class="form-control form-control-sm" placeholder="Drug name..."
                           id="id_${PREFIX_MED}-${totalForms}-MEDICATION_NAME">
                </td>
                <td>
                    <input type="text" name="${PREFIX_MED}-${totalForms}-DOSAGE" 
                           class="form-control form-control-sm" placeholder="Dose..."
                           id="id_${PREFIX_MED}-${totalForms}-DOSAGE">
                </td>
                <td>
                    <input type="text" name="${PREFIX_MED}-${totalForms}-USAGE_PERIOD" 
                           class="form-control form-control-sm" placeholder="e.g., 7 days"
                           id="id_${PREFIX_MED}-${totalForms}-USAGE_PERIOD">
                </td>
                <td>
                    <textarea name="${PREFIX_MED}-${totalForms}-REASON" 
                              class="form-control form-control-sm" rows="2" placeholder="Reason for use..."
                              id="id_${PREFIX_MED}-${totalForms}-REASON"></textarea>
                </td>
            </tr>
        `;

        tbody.append(newRowHtml);
        $(`#id_${PREFIX_MED}-TOTAL_FORMS`).val(totalForms + 1);

        console.log(` Added medication row #${totalForms}, Episode: ${newEpisode} (Day 90)`);
    });

    // ==========================================
    // INITIALIZATION
    // ==========================================
    setTimeout(initializeSections, 200);

    console.log(" Contact Follow-up Day 90 form initialized successfully!");
});
</script>
{% endblock %}