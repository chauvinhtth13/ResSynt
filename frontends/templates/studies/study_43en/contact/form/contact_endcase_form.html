{% extends 'studies\study_43en\home_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}
  {% if is_readonly %}
    {% trans "View End of Study Form (Contact)" %}
  {% elif is_create %}
    {% trans "Create End of Study Form (Contact)" %}
  {% else %}
    {% trans "Update End of Study Form (Contact)" %}
  {% endif %}
{% endblock %}

{% block page_title %}
  {% if is_readonly %}
    {% trans "View End of Study Form (Contact)" %} - {{ enrollment_contact.USUBJID }}
  {% elif is_create %}
    {% trans "Create End of Study Form (Contact)" %} - {{ enrollment_contact.USUBJID }}
  {% else %}
    {% trans "Update End of Study Form (Contact)" %} - {{ enrollment_contact.USUBJID }}
  {% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:contact_list' %}">{% trans "43EN Contacts" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:contact_detail' enrollment_contact.USUBJID %}">{{ enrollment_contact.USUBJID }}</a></li>
<li class="breadcrumb-item active">
  {% if is_readonly %}
    {% trans "View End Form" %}
  {% elif is_create %}
    {% trans "Create End Form" %}
  {% else %}
    {% trans "Update End Form" %}
  {% endif %}
</li>
{% endblock %}

{% block dashboard_css %}
{% include 'studies/study_43en/includes/crf_styles.html' %}
{% endblock %}

{% block dashboard_content %}
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-clipboard-check mr-2"></i>
          {% if is_readonly %}
            {% trans "View End of Study Form (Contact)" %}
          {% elif is_create %}
            {% trans "Create End of Study Form (Contact)" %}
          {% else %}
            {% trans "Update End of Study Form (Contact)" %}
          {% endif %}
          <span class="contact-badge ml-2">CONTACT</span>
        </h3>
      </div>
      
      <div class="card-body">
        {#  DISPLAY ERRORS #}
        {% if form.errors and not is_readonly %}
          <div class="alert alert-danger">
            <h5><i class="icon fas fa-ban"></i> {% trans "Error!" %}</h5>
            <ul>
              {% for field in form %}
                {% for error in field.errors %}
                  <li><strong>{{ field.label }}</strong>: {{ error }}</li>
                {% endfor %}
              {% endfor %}
              {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
        
        {#  MAIN FORM #}
        <form method="post" 
              id="contactendcaseForm" 
              {% if is_readonly %}class="view-only-form"{% endif %}>
          {% csrf_token %}
          
          {#  Contact Info Summary #}
          <div class="alert alert-info">
            <div class="row">
              <div class="col-md-3">
                <strong>{% trans "Contact ID" %}:</strong><br>
                <span class="text-primary">{{ enrollment_contact.USUBJID }}</span>
              </div>
              <div class="col-md-3">
                <strong>{% trans "Enrollment Date" %}:</strong><br>
                {{ enrollment_contact.ENRDATE|date:"d/m/Y"|default:"-" }}
              </div>
              <div class="col-md-3">
                <strong>{% trans "Site" %}:</strong><br>
                {{ enrollment_contact.SITEID }}
              </div>
              <div class="col-md-3">
                <strong>{% trans "Status" %}:</strong><br>
                {% if endcase %}
                  <span class="badge badge-success">
                    <i class="fas fa-check-circle"></i> {% trans "Data Available" %}
                  </span>
                {% else %}
                  <span class="badge badge-warning">
                    <i class="fas fa-exclamation-triangle"></i> {% trans "No Data" %}
                  </span>
                {% endif %}
              </div>
            </div>
          </div>
          
          {# ========== SECTION 1: DATES ========== #}
          <div class="form-section">
            <h5 class="section-title">
              <i class="fas fa-calendar mr-2"></i>
              {% trans "Date Information" %}
            </h5>
            
            <div class="row">
              {# 1. End Date #}
              <div class="col-md-6">
                <div class="form-group">
                  <label for="{{ form.ENDDATE.id_for_label }}">
                    <span class="question-number">1.</span>
                    {% trans "End Date Recorded" %}
                  </label>
                  <div class="input-group">
                    <div >
                      <span ><i ></i></span>
                    </div>
                    {{ form.ENDDATE }}
                  </div>
                  {% if form.ENDDATE.errors %}
                    <small class="text-danger">{{ form.ENDDATE.errors.0 }}</small>
                  {% endif %}
                  <small class="form-text text-muted">
                    <i class="fas fa-info-circle"></i> Date when contact ended study participation
                  </small>
                </div>
              </div>
              
              {# 2. Form Completion Date #}
              <div class="col-md-6">
                <div class="form-group">
                  <label for="{{ form.ENDFORMDATE.id_for_label }}">
                    <span class="question-number">2.</span>
                    {% trans "Study End Date" %}
                  </label>
                  <div class="input-group">
                    <div >
                      <span ><i ></i></span>
                    </div>
                    {{ form.ENDFORMDATE }}
                  </div>
                  {% if form.ENDFORMDATE.errors %}
                    <small class="text-danger">{{ form.ENDFORMDATE.errors.0 }}</small>
                  {% endif %}
                  <small class="form-text text-muted">
                    <i class="fas fa-info-circle"></i> Date when end case form was completed
                  </small>
                </div>
              </div>
            </div>
          </div>
          
          {# ========== SECTION 2: VISIT COMPLETION (3 visits for contacts) ========== #}
          <div class="form-section">
            <h5 class="section-title">
              <i class="fas fa-check-double mr-2"></i>
              {% trans "3. Visits Completed" %}
              <span class="badge badge-info ml-2">3 visits</span>
            </h5>
            
            <div class="row">
              <div class="col-md-4">
                <div class="visit-card">
                  <div class="form-check">
                    {{ form.VICOMPLETED }}
                    <label class="form-check-label" for="{{ form.VICOMPLETED.id_for_label }}">
                      <i class="fas fa-user-plus mr-2"></i>
                      {{ form.VICOMPLETED.label }}
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="visit-card">
                  <div class="form-check">
                    {{ form.V2COMPLETED }}
                    <label class="form-check-label" for="{{ form.V2COMPLETED.id_for_label }}">
                      <i class="fas fa-heartbeat mr-2"></i>
                      {{ form.V2COMPLETED.label }}
                    </label>
                    <small class="text-muted d-block mt-1">
                      <i class="fas fa-info-circle"></i> {% trans "Contact V2 is Day 28Â±3" %}
                    </small>
                  </div>
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="visit-card">
                  <div class="form-check">
                    {{ form.V3COMPLETED }}
                    <label class="form-check-label" for="{{ form.V3COMPLETED.id_for_label }}">
                      <i class="fas fa-walking mr-2"></i>
                      {{ form.V3COMPLETED.label }}
                    </label>
                  </div>
                </div>
              </div>
            </div>
            
            {#  Completion Summary #}
            {% if endcase %}
            <div class="alert alert-info mt-3">
              <strong><i class="fas fa-info-circle mr-2"></i>{% trans "Completion Summary" %}:</strong>
              {{ endcase.total_visits_completed }}/3 visits ({{ endcase.completion_rate|floatformat:0 }}%)
            </div>
            {% endif %}
          </div>
          
          {# ========== SECTION 3: WITHDRAWAL ========== #}
          <div class="form-section">
            <h5 class="section-title">
              <i class="fas fa-sign-out-alt mr-2"></i>
              {% trans "4. Study Withdrawal" %}
            </h5>
            
            <div class="form-group">
              <label>
                <span class="question-number">4.</span>
                {{ form.WITHDRAWREASON.label }}
              </label>
              <div class="mt-2">
                {% for choice_value, choice_label in form.WITHDRAWREASON.field.choices %}
                  <div class="form-check mb-2">
                    <input type="radio" 
                           name="WITHDRAWREASON" 
                           id="id_WITHDRAWREASON_{{ forloop.counter0 }}" 
                           value="{{ choice_value }}"
                           {% if form.WITHDRAWREASON.value == choice_value %}checked{% endif %}
                           {% if is_readonly %}disabled{% endif %}
                           class="form-check-input">
                    <label class="form-check-label" for="id_WITHDRAWREASON_{{ forloop.counter0 }}">
                      {{ choice_label }}
                    </label>
                  </div>
                {% endfor %}
              </div>
              {% if form.WITHDRAWREASON.errors %}
                <small class="text-danger">{{ form.WITHDRAWREASON.errors.0 }}</small>
              {% endif %}
            </div>
            
            {# Conditional: Withdrawal Details #}
            <div id="withdrawal-details" 
                 class="indent-section mt-3" 
                 {% if form.WITHDRAWREASON.value == 'na' %}style="display:none;"{% endif %}>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="{{ form.WITHDRAWDATE.id_for_label }}">
                      {% trans "4a. Withdrawal Date" %}
                    </label>
                    <div class="input-group">
                      <div >
                        <span ><i ></i></span>
                      </div>
                      {{ form.WITHDRAWDATE }}
                    </div>
                    {% if form.WITHDRAWDATE.errors %}
                      <small class="text-danger">{{ form.WITHDRAWDATE.errors.0 }}</small>
                    {% endif %}
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="{{ form.WITHDRAWDETAILS.id_for_label }}">
                      {% trans "4b. Withdrawal Details" %}
                    </label>
                    {{ form.WITHDRAWDETAILS }}
                    {% if form.WITHDRAWDETAILS.errors %}
                      <small class="text-danger">{{ form.WITHDRAWDETAILS.errors.0 }}</small>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {# ========== SECTION 4: INCOMPLETE ========== #}
          <div class="form-section">
            <h5 class="section-title">
              <i class="fas fa-exclamation-circle mr-2"></i>
              {% trans "5. Unable to Complete Study" %}
            </h5>
            
            <div class="form-group">
              <label>
                <span class="question-number">5.</span>
                {{ form.INCOMPLETE.label }}
              </label>
              <div class="mt-2">
                {% for choice_value, choice_label in form.INCOMPLETE.field.choices %}
                  <div class="form-check form-check-inline mr-4">
                    <input type="radio" 
                           name="INCOMPLETE" 
                           id="id_INCOMPLETE_{{ forloop.counter0 }}" 
                           value="{{ choice_value }}"
                           {% if form.INCOMPLETE.value == choice_value %}checked{% endif %}
                           {% if is_readonly %}disabled{% endif %}
                           class="form-check-input">
                    <label class="form-check-label" for="id_INCOMPLETE_{{ forloop.counter0 }}">
                      {{ choice_label }}
                    </label>
                  </div>
                {% endfor %}
              </div>
              {% if form.INCOMPLETE.errors %}
                <small class="text-danger">{{ form.INCOMPLETE.errors.0 }}</small>
              {% endif %}
            </div>
            
            {# Conditional: Incomplete Reasons #}
            <div id="incomplete-reasons" 
                 class="indent-section mt-3" 
                 {% if form.INCOMPLETE.value != 'yes' %}style="display:none;"{% endif %}>
              <div class="card bg-light">
                <div class="card-body">
                  <p class="mb-3">
                    <strong>{% trans "If Yes, please state the reason:" %}</strong>
                  </p>
                  
                  <div class="form-check mb-2">
                    {{ form.INCOMPLETEDEATH }}
                    <label class="form-check-label" for="{{ form.INCOMPLETEDEATH.id_for_label }}">
                      <i class="fas fa-cross mr-2"></i>
                      {{ form.INCOMPLETEDEATH.label }}
                    </label>
                  </div>
                  
                  <div class="form-check mb-2">
                    {{ form.INCOMPLETEMOVED }}
                    <label class="form-check-label" for="{{ form.INCOMPLETEMOVED.id_for_label }}">
                      <i class="fas fa-truck-moving mr-2"></i>
                      {{ form.INCOMPLETEMOVED.label }}
                    </label>
                  </div>
                  
                  <div class="form-group mt-3">
                    <label for="{{ form.INCOMPLETEOTHER.id_for_label }}">
                      <i class="fas fa-edit mr-2"></i>
                      {{ form.INCOMPLETEOTHER.label }}
                    </label>
                    {{ form.INCOMPLETEOTHER }}
                    {% if form.INCOMPLETEOTHER.errors %}
                      <small class="text-danger">{{ form.INCOMPLETEOTHER.errors.0 }}</small>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {# ========== SECTION 5: LOST TO FOLLOW-UP ========== #}
          <div class="form-section">
            <h5 class="section-title">
              <i class="fas fa-user-times mr-2"></i>
              {% trans "6. Lost to Follow-up" %}
            </h5>
            
            <div class="form-group">
              <label>
                <span class="question-number">6.</span>
                {{ form.LOSTTOFOLLOWUP.label }}
              </label>
              <div class="mt-2">
                {% for choice_value, choice_label in form.LOSTTOFOLLOWUP.field.choices %}
                  <div class="form-check form-check-inline mr-4">
                    <input type="radio" 
                           name="LOSTTOFOLLOWUP" 
                           id="id_LOSTTOFOLLOWUP_{{ forloop.counter0 }}" 
                           value="{{ choice_value }}"
                           {% if form.LOSTTOFOLLOWUP.value == choice_value %}checked{% endif %}
                           {% if is_readonly %}disabled{% endif %}
                           class="form-check-input">
                    <label class="form-check-label" for="id_LOSTTOFOLLOWUP_{{ forloop.counter0 }}">
                      {{ choice_label }}
                    </label>
                  </div>
                {% endfor %}
              </div>
              {% if form.LOSTTOFOLLOWUP.errors %}
                <small class="text-danger">{{ form.LOSTTOFOLLOWUP.errors.0 }}</small>
              {% endif %}
              <small class="text-muted d-block mt-2">
                {% trans "(defined as inability to contact participant after at least 3 contact attempts within 1 month after participant missed a visit)" %}
              </small>
            </div>
            
            {# Conditional: Lost to Follow-up Date #}
            <div id="ltfu-date" 
                 class="indent-section mt-3" 
                 {% if form.LOSTTOFOLLOWUP.value != 'yes' %}style="display:none;"{% endif %}>
              <div class="form-group">
                <label for="{{ form.LOSTTOFOLLOWUPDATE.id_for_label }}">
                  {% trans "6a. Lost to Follow-up Date" %}
                </label>
                <div class="input-group">
                  <div >
                    <span ><i ></i></span>
                  </div>
                  {{ form.LOSTTOFOLLOWUPDATE }}
                </div>
                {% if form.LOSTTOFOLLOWUPDATE.errors %}
                  <small class="text-danger">{{ form.LOSTTOFOLLOWUPDATE.errors.0 }}</small>
                {% endif %}
              </div>
            </div>
          </div>
          
          {# ========== AUDIT INFORMATION ========== #}
          {% if endcase and not is_create %}
          <div class="form-section">
            <h5 class="section-title">
              <i class="fas fa-history mr-2"></i>
              {% trans "Modification Information" %}
            </h5>
            
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label>{% trans "Last Modified By" %}</label>
                  <input type="text" 
                         class="form-control" 
                         value="{{ endcase.last_modified_by_username|default:'N/A' }}" 
                         readonly>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label>{% trans "Modified At" %}</label>
                  <input type="text" 
                         class="form-control"
                         value="{{ endcase.last_modified_at|date:'d/m/Y H:i'|default:'N/A' }}" 
                         readonly>
                </div>
              </div>
              <div class="col-md-4">
                <div class="form-group">
                  <label>{% trans "Version" %}</label>
                  <input type="text" 
                         class="form-control" 
                         value="v{{ endcase.version|default:'0' }}" 
                         readonly>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          
          {# ========== ACTION BUTTONS ========== #}
          <div class="mt-4 d-flex justify-content-between">
            <div>
              <a href="{% url 'study_43en:contact_detail' enrollment_contact.USUBJID %}" 
                 class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Back" %}
              </a>
              {% if not is_readonly %}
              <button type="reset" class="btn btn-warning ml-2">
                <i class="fas fa-undo"></i> {% trans "Reset" %}
              </button>
              {% endif %}
            </div>
            
            {% if not is_readonly %}
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fas fa-save"></i> {% trans "Save" %}
            </button>
            {% else %}
            <a href="{% url 'study_43en:contactendcase_update' usubjid=enrollment_contact.USUBJID %}" 
               class="btn btn-warning">
              <i ></i> {% trans "Edit" %}
            </a>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{#  CHANGE REASON MODAL (Only for UPDATE, not CREATE) #}
{% if not is_readonly and not is_create %}
  {% include 'default/change_reason_modal.html' %}
{% endif %}

{% endblock %}

{% block dashboard_js %}
{#  Datepicker Scripts #}
{% include 'studies/study_43en/includes/datepicker_scripts.html' %}

{#  Change Reason Handler (Only for UPDATE) #}
{% if not is_readonly and not is_create %}
<script nonce="{{ request.csp_nonce }}" src="{% static 'studies/study_43en/js/change-reason-handler.js' %}"></script>
{% endif %}

<script nonce="{{ request.csp_nonce }}">
$(document).ready(function() {
  console.log(" Initializing Contact End Case form...");
  
  // ==========================================
  // CONFIGURATION
  // ==========================================
  const isReadonly = {% if is_readonly %}true{% else %}false{% endif %};
  const isCreate = {% if is_create %}true{% else %}false{% endif %};
  
  console.log(`Mode: ${isCreate ? 'CREATE' : 'UPDATE'}, Readonly: ${isReadonly}`);
  
  // ==========================================
  // CONDITIONAL SECTIONS
  // ==========================================
  
  // Toggle withdrawal details
  $('input[name="WITHDRAWREASON"]').on('change', function() {
    const value = $(this).val();
    console.log(`WITHDRAWREASON changed to: ${value}`);
    
    if (value === 'na') {
      $('#withdrawal-details').slideUp(300);
      {% if not is_readonly %}
      $('#id_WITHDRAWDATE').val('');
      $('#id_WITHDRAWDETAILS').val('');
      {% endif %}
    } else {
      $('#withdrawal-details').slideDown(300);
    }
  });
  
  // Toggle incomplete reasons
  $('input[name="INCOMPLETE"]').on('change', function() {
    const value = $(this).val();
    console.log(`INCOMPLETE changed to: ${value}`);
    
    if (value === 'yes') {
      $('#incomplete-reasons').slideDown(300);
    } else {
      $('#incomplete-reasons').slideUp(300);
      {% if not is_readonly %}
      $('#id_INCOMPLETEDEATH').prop('checked', false);
      $('#id_INCOMPLETEMOVED').prop('checked', false);
      $('#id_INCOMPLETEOTHER').val('');
      {% endif %}
    }
  });
  
  // Toggle lost to follow-up date
  $('input[name="LOSTTOFOLLOWUP"]').on('change', function() {
    const value = $(this).val();
    console.log(`LOSTTOFOLLOWUP changed to: ${value}`);
    
    if (value === 'yes') {
      $('#ltfu-date').slideDown(300);
    } else {
      $('#ltfu-date').slideUp(300);
      {% if not is_readonly %}
      $('#id_LOSTTOFOLLOWUPDATE').val('');
      {% endif %}
    }
  });
  
  // ==========================================
  // INITIALIZE SECTIONS ON LOAD
  // ==========================================
  function initializeSections() {
    // Withdrawal
    const withdrawReason = $('input[name="WITHDRAWREASON"]:checked').val();
    if (withdrawReason !== 'na') {
      $('#withdrawal-details').show();
    }
    
    // Incomplete
    const incomplete = $('input[name="INCOMPLETE"]:checked').val();
    if (incomplete === 'yes') {
      $('#incomplete-reasons').show();
    }
    
    // Lost to follow-up
    const ltfu = $('input[name="LOSTTOFOLLOWUP"]:checked').val();
    if (ltfu === 'yes') {
      $('#ltfu-date').show();
    }
  }
  
  // ==========================================
  // READ-ONLY MODE
  // ==========================================
  {% if is_readonly %}
  console.log('ðŸ“– Setting readonly mode...');
  $('#contactendcaseForm input:not([type="hidden"])').attr('readonly', true);
  $('#contactendcaseForm select').attr('disabled', true);
  $('#contactendcaseForm textarea').attr('readonly', true);
  $('#contactendcaseForm input[type="checkbox"], #contactendcaseForm input[type="radio"]').attr('disabled', true);
  {% endif %}
  
  // ==========================================
  // VISIT COMPLETION SUMMARY (3 visits for contacts)
  // ==========================================
  function updateCompletionSummary() {
    const v1 = $('#id_VICOMPLETED').is(':checked');
    const v2 = $('#id_V2COMPLETED').is(':checked');
    const v3 = $('#id_V3COMPLETED').is(':checked');
    
    const completed = [v1, v2, v3].filter(Boolean).length;
    const rate = (completed / 3 * 100).toFixed(0);
    
    console.log(`Contact visit completion: ${completed}/3 (${rate}%)`);
    
    // You can update UI here if needed
  }
  
  {% if not is_readonly %}
  $('input[type="checkbox"][id^="id_V"]').on('change', updateCompletionSummary);
  {% endif %}
  
  // ==========================================
  // INITIALIZATION
  // ==========================================
  setTimeout(initializeSections, 200);
  updateCompletionSummary();
  
  console.log(" Contact End Case form initialized successfully!");
});
</script>
{% endblock %}