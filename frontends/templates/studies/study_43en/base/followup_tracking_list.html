{% extends 'studies\study_43en\home_dashboard.html' %}
{% load static %}
{% load i18n %}
{% block title %}Theo d√µi l·ªãch h·∫πn{% endblock %}

{% block page_title %}Theo d√µi l·ªãch h·∫πn{% endblock %}


{% block dashboard_content %}

<!-- Alert container for notifications -->
<div id="alertContainer" style="position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px;"></div>

<!-- B·ªô l·ªçc -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">B·ªô l·ªçc t√¨m ki·∫øm</h6>
        <div>
            <button class="btn btn-sm btn-primary" type="button" data-toggle="collapse" data-target="#filterCollapse">
                <i class="fas fa-filter mr-1"></i> Hi·ªÉn th·ªã/·∫®n b·ªô l·ªçc
            </button>
        </div>
    </div>
    <div class="collapse show" id="filterCollapse">
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="row">
                    <!-- Kho·∫£ng th·ªùi gian -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Kho·∫£ng th·ªùi gian</label>
                            <div class="input-group">

                                <input type="text" class="form-control datepicker" name="date_from" id="date_from" 
                                    value="{% if date_from %}{{ date_from|date:'d/m/Y' }}{% endif %}" placeholder="DD/MM/YYYY" data-provide="datepicker">
                                <div class="input-group-prepend input-group-append">
                                    <span class="input-group-text">ƒë·∫øn</span>
                                </div>
                                <input type="text" class="form-control datepicker" name="date_to" id="date_to" 
                                    value="{% if date_to %}{{ date_to|date:'d/m/Y' }}{% endif %}" placeholder="DD/MM/YYYY" data-provide="datepicker">
                            </div>
                        </div>
                    </div>

                    <!-- B·ªô l·ªçc nhanh -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>B·ªô l·ªçc nhanh</label>
                            <div class="btn-group btn-block">
                                <button type="button" class="btn btn-outline-primary" id="thisWeek">Tu·∫ßn n√†y</button>
                                <button type="button" class="btn btn-outline-primary" id="nextWeek">Tu·∫ßn sau</button>
                                <button type="button" class="btn btn-outline-primary" id="thisMonth">Th√°ng n√†y</button>
                                <button type="button" class="btn btn-outline-primary" id="all">T·∫•t c·∫£</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="subject_type">Lo·∫°i ƒë·ªëi t∆∞·ª£ng</label>
                            <select name="subject_type" id="subject_type" class="form-control">
                                <option value="">-- T·∫•t c·∫£ ƒë·ªëi t∆∞·ª£ng --</option>
                                {% for value, text in subject_type_choices %}
                                    <option value="{{ value }}" {% if current_subject_type == value %}selected{% endif %}>
                                        {{ text }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="visit">L·∫ßn thƒÉm</label>
                            <select name="visit" id="visit" class="form-control">
                                <option value="">-- T·∫•t c·∫£ l·∫ßn thƒÉm --</option>
                                {% for value, text in visit_choices %}
                                    <option value="{{ value }}" {% if current_visit == value %}selected{% endif %}>
                                        {{ text }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="status">Tr·∫°ng th√°i</label>
                            <select name="status" id="status" class="form-control">
                                <option value="">-- T·∫•t c·∫£ tr·∫°ng th√°i --</option>
                                {% for value, text in status_choices %}
                                    <option value="{{ value }}" {% if current_status == value %}selected{% endif %}>
                                        {{ text }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="search">T√¨m ki·∫øm</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                placeholder="M√£ b·ªánh nh√¢n, t√™n vi·∫øt t·∫Øt..." value="{{ search_query|default:'' }}">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 text-right">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search mr-1"></i> T√¨m ki·∫øm
                        </button>
                        <a href="{% url 'study_43en:followup_tracking_list' %}" class="btn btn-secondary">
                            <i class="fas fa-sync-alt mr-1"></i> ƒê·∫∑t l·∫°i
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- PENDING FOLLOW-UPS TABLE -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-warning">
            <i class="fas fa-clock mr-2"></i>Danh s√°ch c·∫ßn theo d√µi
            <span class="badge badge-warning ml-2">{{ pending_followups.paginator.count }}</span>
        </h6>
    </div>
    <div class="card-body">
        <!-- ADD WRAPPER HERE -->
        <div class="table-outline-wrapper">
            <div class="table-responsive">
                <table class="table table-bordered" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th width="5%">STT</th>
                        <th width="10%">M√£ BN</th>
                        <th width="10%">T√™n vi·∫øt t·∫Øt</th>
                        <th width="10%">Lo·∫°i</th>
                        <th width="10%">L·∫ßn kh√°m</th>
                        <th width="12%">Ng√†y d·ª± ki·∫øn</th>
                        <th width="10%">Tr·∫°ng th√°i</th>
                        <th width="10%">Li√™n h·ªá</th>
                        <th width="13%">Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
                    {% for followup in pending_followups %}
                    <tr class="
                        {% if followup.STATUS == 'LATE' %}table-warning{% endif %}
                        {% if followup.STATUS == 'MISSED' %}table-danger{% endif %}
                        " id="followup-row-{{ followup.pk }}">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ followup.USUBJID }}</td>
                        <td>{{ followup.INITIAL }}</td>
                        <td>
                            {% if followup.SUBJECT_TYPE == 'PATIENT' %}
                            <span class="badge badge-primary ">B·ªánh nh√¢n</span>
                            {% else %}
                            <span class="badge badge-info ">Ng∆∞·ªùi ti·∫øp x√∫c</span>
                            {% endif %}
                        </td>
                        <td>{{ followup.get_VISIT_display }}</td>
                        <td>
                            <span class="text-nowrap">{{ followup.EXPECTED_DATE|date:"d/m/Y" }}</span>
                            <small class="d-block text-muted" title="Kho·∫£ng th·ªùi gian d·ª± ki·∫øn">
                                {% if followup.EXPECTED_FROM and followup.EXPECTED_TO %}
                                    {{ followup.EXPECTED_FROM|date:"d/m" }} - {{ followup.EXPECTED_TO|date:"d/m/Y" }}
                                {% endif %}
                            </small>
                        </td>
                        <td>
                            {% if followup.STATUS == 'LATE' %}
                                <span class="badge badge-warning text-dark "><i class="fas fa-exclamation-circle mr-1"></i>Tr·ªÖ h·∫πn</span>
                            {% elif followup.STATUS == 'MISSED' %}
                                <span class="badge badge-danger  "><i class="fas fa-times-circle mr-1"></i>B·ªè l·ª°</span>
                            {% elif followup.STATUS == 'UPCOMING' %}
                                <span class="badge badge-primary "><i ></i>S·∫Øp t·ªõi</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if followup.PHONE %}
                                <a href="tel:{{ followup.PHONE }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-phone-alt"></i> {{ followup.PHONE }}
                                </a>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <!--  COMPLETE BUTTON -->
                            <button class="btn btn-sm btn-success complete-followup-btn" 
                                data-id="{{ followup.pk }}"
                                data-usubjid="{{ followup.USUBJID }}"
                                data-visit="{{ followup.get_VISIT_display }}"
                                data-expected="{{ followup.EXPECTED_DATE|date:'Y-m-d' }}"
                                title="ƒê√°nh d·∫•u ho√†n th√†nh">
                                <i class="fas fa-check-circle mr-1"></i> Ho√†n th√†nh
                            </button>
                            <!--  MISSED BUTTON -->
                            <button class="btn btn-sm btn-danger missed-followup-btn" 
                                data-id="{{ followup.pk }}"
                                data-usubjid="{{ followup.USUBJID }}"
                                data-visit="{{ followup.get_VISIT_display }}"
                                data-expected="{{ followup.EXPECTED_DATE|date:'Y-m-d' }}"
                                title="ƒê√°nh d·∫•u Missed">
                                <i class="fas fa-times-circle mr-1"></i> Missed
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center">
                            <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                            <p class="text-muted">Kh√¥ng c√≥ l·ªãch h·∫πn c·∫ßn theo d√µi</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination for pending -->
        {% if pending_followups.has_other_pages %}
        <nav aria-label="{% trans 'Pending pagination' %}" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if pending_followups.has_previous %}
                <!-- First page -->
                <li class="page-item">
                    <a class="page-link" 
                    href="?pending_page=1{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                    title="{% trans 'First page' %}">
                        {% trans "First" %}
                    </a>
                </li>
                
                <!-- Previous page -->
                <li class="page-item">
                    <a class="page-link" 
                    href="?pending_page={{ pending_followups.previous_page_number }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                    title="{% trans 'Previous page' %}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                
                <!-- Page numbers with range -->
                {% for num in pending_followups.paginator.page_range %}
                    {% if pending_followups.number == num %}
                        <!-- Current page -->
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > pending_followups.number|add:'-3' and num < pending_followups.number|add:'3' %}
                        <!-- Pages within range -->
                        <li class="page-item">
                            <a class="page-link" 
                            href="?pending_page={{ num }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                                {{ num }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if pending_followups.has_next %}
                <!-- Next page -->
                <li class="page-item">
                    <a class="page-link" 
                    href="?pending_page={{ pending_followups.next_page_number }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                    title="{% trans 'Next page' %}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                
                <!-- Last page -->
                <li class="page-item">
                    <a class="page-link" 
                    href="?pending_page={{ pending_followups.paginator.num_pages }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                    title="{% trans 'Last page' %}">
                        {% trans "Last" %}
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- COMPLETED FOLLOW-UPS TABLE -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-success">
            <i class="fas fa-check-circle mr-2"></i>Danh s√°ch ƒë√£ ho√†n th√†nh
            <span class="badge badge-success ml-2">{{ completed_followups.paginator.count }}</span>
        </h6>
    </div>
    <div class="card-body">
        <!-- ADD WRAPPER HERE -->
        <div class="table-outline-wrapper">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="thead-light">
                    <tr>
                        <th width="5%">STT</th>
                        <th width="12%">M√£ BN</th>
                        <th width="12%">T√™n vi·∫øt t·∫Øt</th>
                        <th width="10%">Lo·∫°i</th>
                        <th width="10%">L·∫ßn kh√°m</th>
                        <th width="13%">Ng√†y d·ª± ki·∫øn</th>
                        <th width="13%">Ng√†y ho√†n th√†nh</th>
                        <th width="10%">Tr·∫°ng th√°i</th>
                        <th width="15%">Li√™n h·ªá</th>
                    </tr>
                </thead>
                <tbody>
                    {% for followup in completed_followups %}
                    <tr class="table-success">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ followup.USUBJID }}</td>
                        <td>{{ followup.INITIAL }}</td>
                        <td>
                            {% if followup.SUBJECT_TYPE == 'PATIENT' %}
                            <span class="badge badge-primary ">B·ªánh nh√¢n</span>
                            {% else %}
                            <span class="badge badge-info text-dark">Ng∆∞·ªùi ti·∫øp x√∫c</span>
                            {% endif %}
                        </td>
                        <td>{{ followup.get_VISIT_display }}</td>
                        <td>
                            <span class="text-nowrap">{{ followup.EXPECTED_DATE|date:"d/m/Y" }}</span>
                        </td>
                        <td>
                            <strong class="text-success">{{ followup.ACTUAL_DATE|date:"d/m/Y" }}</strong>
                        </td>
                        <td>
                            <span class="btn btn-sm btn-success complete-followup-btn ">
                                <i class="fas fa-check-circle mr-1"></i>Ho√†n th√†nh
                            </span>
                        </td>
                        <td>
                            {% if followup.PHONE %}
                                <a href="tel:{{ followup.PHONE }}" class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-phone-alt"></i> {{ followup.PHONE }}
                                </a>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            Ch∆∞a c√≥ l·ªãch h·∫πn n√†o ƒë∆∞·ª£c ho√†n th√†nh
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination for completed -->
        {% if completed_followups.has_other_pages %}
        <nav aria-label="{% trans 'Completed pagination' %}" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if completed_followups.has_previous %}
                <!-- First page -->
                <li class="page-item">
                    <a class="page-link" 
                    href="?completed_page=1{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                    title="{% trans 'First page' %}">
                        {% trans "First" %}
                    </a>
                </li>
                
                <!-- Previous page -->
                <li class="page-item">
                    <a class="page-link" 
                    href="?completed_page={{ completed_followups.previous_page_number }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                    title="{% trans 'Previous page' %}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                
                <!-- Page numbers with range -->
                {% for num in completed_followups.paginator.page_range %}
                    {% if completed_followups.number == num %}
                        <!-- Current page -->
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > completed_followups.number|add:'-3' and num < completed_followups.number|add:'3' %}
                        <!-- Pages within range -->
                        <li class="page-item">
                            <a class="page-link" 
                            href="?completed_page={{ num }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                                {{ num }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if completed_followups.has_next %}
                <!-- Next page -->
                <li class="page-item">
                    <a class="page-link" 
                    href="?completed_page={{ completed_followups.next_page_number }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                    title="{% trans 'Next page' %}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                
                <!-- Last page -->
                <li class="page-item">
                    <a class="page-link" 
                    href="?completed_page={{ completed_followups.paginator.num_pages }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}{% if visit %}&visit={{ visit }}{% endif %}{% if status %}&status={{ status }}{% endif %}{% if subject_type %}&subject_type={{ subject_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                    title="{% trans 'Last page' %}">
                        {% trans "Last" %}
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>


<!-- MISSED FOLLOW-UPS TABLE -->
<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-danger">
            <i class="fas fa-times-circle mr-2"></i>Danh s√°ch Missed (M·∫•t li√™n l·∫°c)
            <span class="badge badge-danger ml-2">{{ missed_followups.paginator.count }}</span>
        </h6>
    </div>
    <div class="card-body">
        <!-- ADD WRAPPER HERE -->
        <div class="table-outline-wrapper">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                <thead class="thead-light">
                    <tr>
                        <th width="5%">STT</th>
                        <th width="10%">M√£ BN</th>
                        <th width="10%">T√™n vi·∫øt t·∫Øt</th>
                        <th width="8%">Lo·∫°i</th>
                        <th width="8%">L·∫ßn kh√°m</th>
                        <th width="12%">Ng√†y d·ª± ki·∫øn</th>
                        <th width="12%">Ng√†y Missed</th>
                        <th width="20%">L√Ω do</th>
                        <th width="8%">Tr·∫°ng th√°i</th>
                        <th width="7%">Li√™n h·ªá</th>
                    </tr>
                </thead>
                <tbody>
                    {% for followup in missed_followups %}
                    <tr class="table-danger">
                        <td>{{ forloop.counter }}</td>
                        <td>{{ followup.USUBJID }}</td>
                        <td>{{ followup.INITIAL }}</td>
                        <td>
                            {% if followup.SUBJECT_TYPE == 'PATIENT' %}
                            <span class="badge badge-primary ">B·ªánh nh√¢n</span>
                            {% else %}
                            <span class="badge badge-info text-dark">Ng∆∞·ªùi ti·∫øp x√∫c</span>
                            {% endif %}
                        </td>
                        <td>{{ followup.get_VISIT_display }}</td>
                        <td>
                            <span class="text-nowrap">{{ followup.EXPECTED_DATE|date:"d/m/Y" }}</span>
                        </td>
                        <td>
                            <strong class="text-danger">{{ followup.MISSED_DATE|date:"d/m/Y" }}</strong>
                        </td>
                        <td>
                            <small>{{ followup.MISSED_REASON|truncatewords:10 }}</small>
                        </td>
                        <td>
                            <span class="badge badge-danger ">
                                <i class="fas fa-times-circle mr-1"></i>Missed
                            </span>
                        </td>
                        <td>
                            {% if followup.PHONE %}
                                <a href="tel:{{ followup.PHONE }}" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-phone-alt mr-1"></i>{{ followup.PHONE }}
                                </a>
                            {% else %}
                                <span class="text-muted">Kh√¥ng c√≥</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center text-muted">
                            Ch∆∞a c√≥ l·ªãch h·∫πn n√†o b·ªã missed
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!--  Pagination for missed -->
        {% if missed_followups.has_other_pages %}
        <nav aria-label="Missed pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if missed_followups.has_previous %}
                <li class="page-item">
                    <a class="page-link" 
                        href="?missed_page=1{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}"
                        title="First page">First</a>
                </li>
                <li class="page-item">
                    <a class="page-link" 
                        href="?missed_page={{ missed_followups.previous_page_number }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}"
                        title="Previous"><i class="bi bi-chevron-left"></i></a>
                </li>
                {% endif %}
                
                {% for num in missed_followups.paginator.page_range %}
                    {% if missed_followups.number == num %}
                        <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > missed_followups.number|add:'-3' and num < missed_followups.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" 
                                href="?missed_page={{ num }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if missed_followups.has_next %}
                <li class="page-item">
                    <a class="page-link" 
                        href="?missed_page={{ missed_followups.next_page_number }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}"
                        title="Next"><i class="bi bi-chevron-right"></i></a>
                </li>
                <li class="page-item">
                    <a class="page-link" 
                        href="?missed_page={{ missed_followups.paginator.num_pages }}{% if date_from %}&date_from={{ date_from|date:'Y-m-d' }}{% endif %}{% if date_to %}&date_to={{ date_to|date:'Y-m-d' }}{% endif %}"
                        title="Last">Last</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div> 
</div>

<!--  COMPLETE FOLLOW-UP MODAL -->
<div class="modal fade" id="completeFollowupModal" tabindex="-1" role="dialog" aria-labelledby="completeFollowupModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
        <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="completeFollowupModalLabel">
                <i class="fas fa-check-circle mr-2"></i>ƒê√°nh d·∫•u ho√†n th√†nh
            </h5>
        </div>
        <div class="modal-body">
            <form id="completeFollowupForm">
                {% csrf_token %}
                <input type="hidden" id="followup_id_complete" name="followup_id">
                
                <div class="alert alert-info">
                    <strong id="complete_usubjid"></strong> - <span id="complete_visit"></span>
                </div>
                
                <div class="form-group">
                    <label for="actual_date_complete" class="font-weight-bold">
                        <i class="fas fa-calendar-check mr-1"></i>Ng√†y ho√†n th√†nh <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control datepicker" id="actual_date_complete" name="actual_date" placeholder="DD/MM/YYYY" required>
                    <small class="form-text text-muted">
                        <i class="fas fa-info-circle mr-1"></i>
                        Ng√†y d·ª± ki·∫øn: <strong id="expected_date_display"></strong>
                    </small>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>L∆∞u √Ω:</strong> Sau khi ƒë√°nh d·∫•u ho√†n th√†nh, th√¥ng tin s·∫Ω ƒë∆∞·ª£c ƒë·ªìng b·ªô v·ªõi CRF form t∆∞∆°ng ·ª©ng.
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelCompleteFollowup">
                <i class="fas fa-times mr-1"></i>H·ªßy
            </button>
            <button type="button" class="btn btn-success" id="saveCompleteFollowup">
                <i class="fas fa-check-circle mr-1"></i>X√°c nh·∫≠n ho√†n th√†nh
            </button>
        </div>
    </div>
</div>
</div>

<!-- MISSED FOLLOW-UP MODAL -->
<div class="modal fade" id="missedFollowupModal" tabindex="-1" role="dialog" aria-labelledby="missedFollowupModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
        <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="missedFollowupModalLabel">
                <i class="fas fa-times-circle mr-2"></i>ƒê√°nh d·∫•u Missed (M·∫•t li√™n l·∫°c)
            </h5>
        </div>
        <div class="modal-body">
            <form id="missedFollowupForm">
                {% csrf_token %}
                <input type="hidden" id="followup_id_missed" name="followup_id">
                
                <div class="alert alert-info">
                    <strong id="missed_usubjid"></strong> - <span id="missed_visit"></span>
                </div>
                
                <div class="form-group">
                    <label for="missed_date_input" class="font-weight-bold">
                        <i ></i>Ng√†y Missed <span class="text-danger">*</span>
                    </label>
                    <input type="text" class="form-control datepicker" id="missed_date_input" name="missed_date" placeholder="DD/MM/YYYY" required>
                    <small class="form-text text-muted">
                        <i class="fas fa-info-circle mr-1"></i>
                        Ng√†y d·ª± ki·∫øn: <strong id="missed_expected_date_display"></strong>
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="missed_reason_input" class="font-weight-bold">
                        <i ></i>L√Ω do Missed <span class="text-danger">*</span>
                    </label>
                    <textarea class="form-control" id="missed_reason_input" name="missed_reason" rows="3" 
                                placeholder="Vui l√≤ng nh·∫≠p l√Ω do (VD: M·∫•t li√™n l·∫°c, kh√¥ng tr·∫£ l·ªùi ƒëi·ªán tho·∫°i, chuy·ªÉn ƒë·ªãa ch·ªâ...)" 
                                required></textarea>
                </div>
                
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>L∆∞u √Ω:</strong> Sau khi ƒë√°nh d·∫•u Missed, th√¥ng tin s·∫Ω ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng v√† kh√¥ng th·ªÉ ho√†n th√†nh ƒë∆∞·ª£c n·ªØa.
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="cancelMissedFollowup">
                <i class="fas fa-times mr-1"></i>H·ªßy
            </button>
            <button type="button" class="btn btn-danger" id="saveMissedFollowup">
                <i class="fas fa-times-circle mr-1"></i>X√°c nh·∫≠n Missed
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block dashboard_js %}
<script nonce="{{ request.csp_nonce }}">
    $(document).ready(function() {
        console.log('üìã Follow-up tracking page loaded');
        
        // ==========================================
        // FIX: TOGGLE COLLAPSE BUTTON (Bootstrap compatibility)
        // ==========================================
        $('#filterCollapse').on('show.bs.collapse', function() {
            console.log(' Filter expanded');
        }).on('hide.bs.collapse', function() {
            console.log(' Filter collapsed');
        });
        
        // Manual toggle if Bootstrap collapse not working
        $('[data-toggle="collapse"]').click(function(e) {
            const target = $(this).data('target');
            
            if ($(target).hasClass('show')) {
                $(target).removeClass('show');
                console.log('üîΩ Hiding filter');
            } else {
                $(target).addClass('show');
                console.log('üîº Showing filter');
            }
        });
        
        // ==========================================
        // CUSTOM NOTIFICATION FUNCTION (Bootstrap Alert)
        // ==========================================
        function showNotification(message, type = 'success', title = '') {
            const alertTypes = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };
            
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-times-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            
            const alertClass = alertTypes[type] || 'alert-success';
            const iconClass = icons[type] || 'fa-check-circle';
            const displayTitle = title ? `<strong>${title}</strong><br>` : '';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show shadow-sm" role="alert" style="animation: slideInRight 0.3s;">
                    <i class="fas ${iconClass} mr-2"></i>
                    ${displayTitle}${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            
            $('#alertContainer').append(alertHtml);
            
            // Auto dismiss after 4 seconds
            setTimeout(function() {
                $('#alertContainer .alert:first').fadeOut(300, function() {
                    $(this).remove();
                });
            }, 4000);
        }
        
        // Create alias functions for compatibility
        window.toastr = {
            success: function(message, title) { showNotification(message, 'success', title); },
            error: function(message, title) { showNotification(message, 'error', title); },
            warning: function(message, title) { showNotification(message, 'warning', title); },
            info: function(message, title) { showNotification(message, 'info', title); }
        };
        
        // ==========================================
        // QUICK FILTERS + DATE CONVERSION
        // ==========================================
        
        // Simple helper: DD/MM/YYYY ‚Üí YYYY-MM-DD
        function toIso(ddmmyyyy) {
            if (!ddmmyyyy) return '';
            const parts = ddmmyyyy.split('/');
            if (parts.length === 3) {
                return parts[2] + '-' + parts[1].padStart(2, '0') + '-' + parts[0].padStart(2, '0');
            }
            return ddmmyyyy;
        }

        // Robust ISO date parser YYYY-MM-DD -> Date or null
        function parseIsoDate(iso) {
            if (!iso) return null;
            // strip time if present (e.g. "2026-01-15 00:00:00" or ISO timestamp)
            const dateOnly = iso.toString().split('T')[0].split(' ')[0];
            const parts = dateOnly.split('-');
            if (parts.length !== 3) return null;
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10);
            const d = parseInt(parts[2], 10);
            if (Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) return null;
            // Month is 0-based in JS Date
            const dt = new Date(y, m - 1, d);
            // Validate constructed date matches parts (guards against invalid dates like 2026-02-30)
            if (dt.getFullYear() !== y || dt.getMonth() !== (m - 1) || dt.getDate() !== d) return null;
            return dt;
        }

        // Parse DD/MM/YYYY -> Date or null
        function parseDmy(dmy) {
            if (!dmy) return null;
            const parts = dmy.split('/');
            if (parts.length !== 3) return null;
            const d = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10);
            const y = parseInt(parts[2], 10);
            if (Number.isNaN(y) || Number.isNaN(m) || Number.isNaN(d)) return null;
            const dt = new Date(y, m - 1, d);
            if (dt.getFullYear() !== y || dt.getMonth() !== (m - 1) || dt.getDate() !== d) return null;
            return dt;
        }
        
        // Quick filter buttons
        $('#thisWeek, #nextWeek, #thisMonth, #all').click(function() {
            const period = $(this).attr('id');
            const today = new Date();
            let from, to;
            
            if (period === 'thisWeek') {
                const day = today.getDay();
                const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                from = new Date(today.getFullYear(), today.getMonth(), diff);
                to = new Date(from);
                to.setDate(from.getDate() + 6);
            } else if (period === 'nextWeek') {
                const day = today.getDay();
                const diff = today.getDate() - day + (day === 0 ? -6 : 1) + 7;
                from = new Date(today.getFullYear(), today.getMonth(), diff);
                to = new Date(from);
                to.setDate(from.getDate() + 6);
            } else if (period === 'thisMonth') {
                from = new Date(today.getFullYear(), today.getMonth(), 1);
                to = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            } else {
                from = new Date('2024-01-01');
                to = new Date();
            }
            
            $('#date_from').datepicker('setDate', from);
            $('#date_to').datepicker('setDate', to);
            $('#filterForm').submit();
        });
        
        // Convert dates before submit using hidden inputs
        $('#filterForm').on('submit', function(e) {
            const fromVal = $('#date_from').val();
            const toVal = $('#date_to').val();
            
            // Remove old hidden inputs if any
            $('#filterForm input[name=\"date_from_iso\"]').remove();
            $('#filterForm input[name=\"date_to_iso\"]').remove();
            
            // Create hidden inputs with ISO format
            if (fromVal) {
                $('<input>').attr({
                    type: 'hidden',
                    name: 'date_from',
                    value: toIso(fromVal)
                }).appendTo('#filterForm');
                $('#date_from').attr('name', 'date_from_display');
            }
            if (toVal) {
                $('<input>').attr({
                    type: 'hidden',
                    name: 'date_to',
                    value: toIso(toVal)
                }).appendTo('#filterForm');
                $('#date_to').attr('name', 'date_to_display');
            }
        });
        
        // ==========================================
        // COMPLETE FOLLOW-UP MODAL
        // ==========================================
        $('.complete-followup-btn').click(function() {
            const followupId = $(this).data('id');
            const usubjid = $(this).data('usubjid');
            const visit = $(this).data('visit');
            const expected = $(this).data('expected'); // YYYY-MM-DD format
            
            $('#followup_id_complete').val(followupId);
            $('#complete_usubjid').text(usubjid);
            $('#complete_visit').text(visit);
            
            // Parse and display expected date using robust parser; fallback to table cell if needed
            let expDate = parseIsoDate(expected);
            if (!expDate) {
                // fallback: read displayed date (DD/MM/YYYY) from the same table row
                const rowDisplay = $(this).closest('tr').find('span.text-nowrap').first().text().trim();
                expDate = parseDmy(rowDisplay);
                if (expDate) {
                    $('#expected_date_display').text(rowDisplay);
                    $('#actual_date_complete').datepicker('setDate', expDate);
                } else {
                    $('#expected_date_display').text('-');
                }
            } else {
                const expDisplay = expDate.getDate().toString().padStart(2, '0') + '/' + 
                                   (expDate.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                   expDate.getFullYear();
                $('#expected_date_display').text(expDisplay);
                $('#actual_date_complete').datepicker('setDate', expDate);
            }
            
            $('#completeFollowupModal').modal('show');
        });
        
        $('#cancelCompleteFollowup').click(function() {
            $('#completeFollowupForm')[0].reset();
            $('#completeFollowupModal').modal('hide');
        });
        
        $('#saveCompleteFollowup').click(function() {
            const $btn = $(this);
            const followupId = $('#followup_id_complete').val();
            const actualDate = $('#actual_date_complete').val(); // DD/MM/YYYY from datepicker
            
            if (!actualDate) {
                toastr.error('Vui l√≤ng ch·ªçn ng√†y ho√†n th√†nh!');
                return;
            }
            
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>ƒêang l∆∞u...');
            
            $.ajax({
                url: `/studies/43en/followup-tracking/${followupId}/complete/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                data: {
                    'actual_date': toIso(actualDate) // Convert to YYYY-MM-DD
                },
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        $('#completeFollowupModal').modal('hide');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        toastr.error(response.message);
                        $btn.prop('disabled', false).html('<i class="fas fa-check-circle mr-1"></i>X√°c nh·∫≠n ho√†n th√†nh');
                    }
                },
                error: function(xhr) {
                    let msg = 'ƒê√£ x·∫£y ra l·ªói!';
                    if (xhr.responseJSON?.message) msg = xhr.responseJSON.message;
                    else if (xhr.status === 404) msg = 'Kh√¥ng t√¨m th·∫•y l·ªãch h·∫πn';
                    else if (xhr.status === 500) msg = 'L·ªói server';
                    toastr.error(msg);
                    $btn.prop('disabled', false).html('<i class="fas fa-check-circle mr-1"></i>X√°c nh·∫≠n ho√†n th√†nh');
                }
            });
        });



        // ==========================================
        // MISSED FOLLOW-UP MODAL
        // ==========================================
        $('.missed-followup-btn').click(function() {
            const followupId = $(this).data('id');
            const usubjid = $(this).data('usubjid');
            const visit = $(this).data('visit');
            const expected = $(this).data('expected');
            
            $('#followup_id_missed').val(followupId);
            $('#missed_usubjid').text(usubjid);
            $('#missed_visit').text(visit);
            
            // Parse and display expected date using robust parser; fallback to table cell if needed
            let missedExpDate = parseIsoDate(expected);
            if (!missedExpDate) {
                const rowDisplay = $(this).closest('tr').find('span.text-nowrap').first().text().trim();
                missedExpDate = parseDmy(rowDisplay);
                if (missedExpDate) {
                    $('#missed_expected_date_display').text(rowDisplay);
                } else {
                    $('#missed_expected_date_display').text('-');
                }
            } else {
                const expDisplay = missedExpDate.getDate().toString().padStart(2, '0') + '/' + 
                                   (missedExpDate.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                                   missedExpDate.getFullYear();
                $('#missed_expected_date_display').text(expDisplay);
            }
            
            // Set today as default
            $('#missed_date_input').datepicker('setDate', new Date());
            
            $('#missedFollowupModal').modal('show');
        });

        $('#cancelMissedFollowup').click(function() {
            $('#missedFollowupForm')[0].reset();
            $('#missedFollowupModal').modal('hide');
        });

        $('#saveMissedFollowup').click(function() {
            const $btn = $(this);
            const followupId = $('#followup_id_missed').val();
            const missedDate = $('#missed_date_input').val();
            const missedReason = $('#missed_reason_input').val().trim();
            
            if (!missedDate) {
                toastr.error('Vui l√≤ng ch·ªçn ng√†y missed!');
                return;
            }
            if (!missedReason) {
                toastr.error('Vui l√≤ng nh·∫≠p l√Ω do!');
                return;
            }
            
            $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i>ƒêang l∆∞u...');
            
            $.ajax({
                url: `/studies/43en/followup-tracking/${followupId}/missed/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                data: {
                    'missed_date': toIso(missedDate),
                    'missed_reason': missedReason
                },
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message);
                        $('#missedFollowupModal').modal('hide');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        toastr.error(response.message);
                        $btn.prop('disabled', false).html('<i class="fas fa-times-circle mr-1"></i>X√°c nh·∫≠n Missed');
                    }
                },
                error: function(xhr) {
                    let msg = xhr.responseJSON?.message || 'ƒê√£ x·∫£y ra l·ªói!';
                    toastr.error(msg);
                    $btn.prop('disabled', false).html('<i class="fas fa-times-circle mr-1"></i>X√°c nh·∫≠n Missed');
                }
            });
        });

        console.log(' Follow-up tracking ready');
        
        // ==========================================
        //  EXPORT EXCEL
        // ==========================================
        $('#exportExcel').click(function() {
            const queryString = window.location.search;
            const url = `/studies/43en/followup-tracking/export/${queryString}`;
            console.log('üì• Exporting to:', url);
            window.location.href = url;
        });
        
        console.log(' Follow-up tracking ready');
    });
</script>
{% include 'studies/study_43en/includes/datepicker_scripts.html' %}
{% endblock %}