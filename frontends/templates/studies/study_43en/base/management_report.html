{% extends 'studies/study_43en/home_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'studies/study_43en/css/home_dashboard.css' %}">
{% endblock %}

{% block dashboard_content %}


<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center mb-3 me-1">
        <div class="min-w-0 flex-grow-1">
            <h5 class="h5 fw-bold mb-1">{% trans "43EN Management Dashboard" %}</h5>
            <p class="text-white-80 mb-0 small line-clamp-2" title="{{ study_name }}">
                {{ study_name }}
            </p>
        </div>
        <button class="btn-cyber-outline-sm flex-shrink-0" id="refreshBtn">
            <i class="bi bi-arrow-clockwise" id="refreshIcon"></i>
            {% trans "Refresh" %}
        </button>
    </div>

    <!-- Bottom Row: Stats -->
    <div class="d-flex justify-content-between align-items-center border-top border-white border-opacity-25 pt-3">
        <div class="d-flex flex-column justify-content-center">
            <span class="small text-uppercase fw-semibold text-white-80 mb-1">
                {% trans "Study Site" %}
            </span>

            {% if user_sites_count == 1 %}
            <span class="text-white fw-bold">
                <i class="bi bi-geo-alt-fill text-accent-cyan me-1"></i>{{ site_name }}
            </span>
            {% else %}
            <div class="dropdown" id="siteSelectContainer">
                <button class="btn btn-cyber-dropdown-sm dropdown-toggle" style="width: 8rem;" type="button"
                    id="siteSelectBtn" data-bs-toggle="dropdown" aria-expanded="false"
                    aria-label="{% trans 'Select study site' %}">
                    <span id="selectedSiteLabel" class="text-truncate">{{ site_name }}</span>
                </button>

                <div class="dropdown-menu dropdown-menu-base dropdown-menu-select p-0" style="width: 8rem;"
                    aria-labelledby="siteSelectBtn">

                    {# Site List - Clickable items with auto-apply #}
                    <div class="site-option-list px-2 py-2" id="siteOptionsList"
                        style="max-height: 280px; overflow-y: auto;">

                        {# All Sites Option #}
                        <button type="button" class="site-option-btn d-flex align-items-center gap-2 w-100"
                            data-value="all" data-display="{% trans 'All Sites' %}">
                            <span class="text-truncate">{% trans "All Sites" %}</span>
                        </button>

                        {# Divider #}
                        <hr class="my-1 border-white border-opacity-25">

                        {# Individual Sites #}
                        {% for site_item in accessible_sites_data %}
                        <button type="button" class="site-option-btn d-flex align-items-center gap-2 w-100"
                            data-value="{{ site_item.code }}" data-display="{{ site_item.display }}">
                            <span class="text-truncate">{{ site_item.display }}</span>
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <input type="hidden" id="selectedSiteInput" name="site"
                value="{% if filter_type == 'all' %}all{% else %}{{ site_filter }}{% endif %}">
            {% endif %}
        </div>

        <div class="d-flex justify-content-center gap-2">
            <div class="icon-box icon-box--light">
                <i class="bi bi-clock-history text-white"></i>
            </div>
            <div class="d-flex flex-column justify-content-center">
                <span class="small text-uppercase fw-semibold text-white-80">{% trans "Last Update" %}</span>
                <span class="text-white fw-bold">{{ today|date:"d/m/Y H:i" }}</span>
            </div>
        </div>
    </div>
</div>

<div class="card chart-card mb-4">
    <div class="chart-card-header">
        <span class="fw-bold">{% trans "Patient Enrollment Progress" %}</span>
    </div>
    <div class="card-body p-0">
        <div id="chartLoading" style="display: flex;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="loading-text">{% trans "Loading chart data..." %}</span>
        </div>
        <div id="enrollmentChart"></div>
    </div>
</div>

<div class="row g-4 mb-4">
    {# Screening & Enrollment Patients Monthly #}
    <div class="col-12 col-xl-6">
        <div class="card chart-card">
            <div class="chart-card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="fw-bold">{% trans "Screening & Enrollment Patients Monthly" %}</span>

                {# Simple Filter: View Mode + Year #}
                <div class="d-flex align-items-center gap-2">
                    {# View Mode Selector (Year, Quarter or Month) #}
                    <select class="form-select form-select-sm" id="patientViewMode" style="width: auto;">
                        <option value="year">{% trans "By Year" %}</option>
                        <option value="quarter" selected>{% trans "By Quarter" %}</option>
                        <option value="month">{% trans "By Month" %}</option>
                    </select>

                    {# Year Selector #}
                    <select class="form-select form-select-sm" id="patientYear" style="width: auto;">
                        <option value="all" selected>{% trans "All Years" %}</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
            </div>
            <div class="card-body position-relative">
                <div id="patientChartLoading" class="chart-loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="loading-text mt-2">{% trans "Loading chart data..." %}</span>
                </div>
                <div id="patientMonthlyChart"></div>

                {# Data Table - Scrollable container for better UX #}
                <div class="table-responsive mt-3 mb-1" id="patientDataTableContainer" style="display: none;">
                    <table class="table table-bordered table-hover table-striped table-sm mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="text-center align-middle bg-light" style="width: 25%;">{% trans "Timeline" %}
                                </th>
                                <th class="text-center align-middle bg-light" style="width: 25%;">
                                    {% trans "Screening" %}<br>
                                    <small class="fw-normal text-muted" id="patientScreeningTotal">(N=0)</small>
                                </th>
                                <th class="text-center align-middle bg-light" style="width: 25%;">
                                    {% trans "Enrollment" %}<br>
                                    <small class="fw-normal text-muted" id="patientEnrollmentTotal">(N=0)</small>
                                </th>
                                <th class="text-center align-middle bg-light" style="width: 25%;">
                                    {% trans "Rate" %} (%)<br>
                                    <small class="fw-normal text-muted" id="patientRateTotal">(0%)</small>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="patientDataTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {# Screening & Enrollment Contact Monthly #}
    <div class="col-12 col-xl-6">
        <div class="card chart-card">
            <div class="chart-card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="fw-bold">{% trans "Screening & Enrollment Contact Monthly" %}</span>

                {# Simple Filter: View Mode + Year #}
                <div class="d-flex align-items-center gap-2">
                    {# View Mode Selector (Year, Quarter or Month) #}
                    <select class="form-select form-select-sm" id="contactViewMode" style="width: auto;">
                        <option value="year">{% trans "By Year" %}</option>
                        <option value="quarter" selected>{% trans "By Quarter" %}</option>
                        <option value="month">{% trans "By Month" %}</option>
                    </select>

                    {# Year Selector #}
                    <select class="form-select form-select-sm" id="contactYear" style="width: auto;">
                        <option value="all" selected>{% trans "All Years" %}</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
            </div>
            <div class="card-body position-relative">
                <div id="contactChartLoading" class="chart-loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="loading-text mt-2">{% trans "Loading chart data..." %}</span>
                </div>
                <div id="contactMonthlyChart"></div>

                {# Data Table - Scrollable container for better UX #}
                <div class="table-responsive mt-3 mb-1" id="contactDataTableContainer" style="display: none;">
                    <table class="table table-bordered table-hover table-striped table-sm mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="text-center align-middle bg-light" style="width: 25%;">{% trans "Timeline" %}
                                </th>
                                <th class="text-center align-middle bg-light" style="width: 25%;">
                                    {% trans "Screening" %}<br>
                                    <small class="fw-normal text-muted" id="contactScreeningTotal">(N=0)</small>
                                </th>
                                <th class="text-center align-middle bg-light" style="width: 25%;">
                                    {% trans "Enrollment" %}<br>
                                    <small class="fw-normal text-muted" id="contactEnrollmentTotal">(N=0)</small>
                                </th>
                                <th class="text-center align-middle bg-light" style="width: 25%;">
                                    {% trans "Rate" %} (%)<br>
                                    <small class="fw-normal text-muted" id="contactRateTotal">(0%)</small>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="contactDataTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {# Screening & Enrollment Status #}
    <div class="col-12">
        <div class="card chart-card">
            <div class="chart-card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="fw-bold">{% trans "Screening & Enrollment Summary Status" %}</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm mb-0" id="summaryStatusTable">
                        <thead>
                            <tr>
                                <th rowspan="2" class="text-center align-middle" style="width: 12%;"></th>
                                <th colspan="2" class="text-center align-middle fw-bold">
                                    {% trans "Total" %}
                                </th>
                                <th colspan="2" class="text-center align-middle fw-bold">
                                    {% trans "HTD" %}<br>
                                    <small class="fw-normal text-muted">({% trans "from" %} 01Jul2024)</small>
                                </th>
                                <th colspan="2" class="text-center align-middle fw-bold">
                                    {% trans "Cho Ray Hospital" %}<br>
                                    <small class="fw-normal text-muted">({% trans "from" %} 13Oct2025)</small>
                                </th>
                                <th colspan="2" class="text-center align-middle fw-bold">
                                    {% trans "NHTD" %}<br>
                                    <small class="fw-normal text-muted">({% trans "from" %} 05Nov2025)</small>
                                </th>
                            </tr>
                            <tr>
                                <th class="text-center align-middle fw-bold" style="width: 10%;">{% trans "PATIENT" %}
                                </th>
                                <th class="text-center align-middle fw-bold" style="width: 10%;">{% trans "CONTACT" %}
                                </th>
                                <th class="text-center align-middle fw-bold" style="width: 10%;">{% trans "PATIENT" %}
                                </th>
                                <th class="text-center align-middle fw-bold" style="width: 10%;">{% trans "CONTACT" %}
                                </th>
                                <th class="text-center align-middle fw-bold" style="width: 10%;">{% trans "PATIENT" %}
                                </th>
                                <th class="text-center align-middle fw-bold" style="width: 10%;">{% trans "CONTACT" %}
                                </th>
                                <th class="text-center align-middle fw-bold" style="width: 10%;">{% trans "PATIENT" %}
                                </th>
                                <th class="text-center align-middle fw-bold" style="width: 10%;">{% trans "CONTACT" %}
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="fw-bold">{% trans "Screened" %}</td>
                                <td class="text-center">780</td>
                                <td class="text-center">160</td>
                                <td class="text-center">538</td>
                                <td class="text-center">107</td>
                                <td class="text-center">213</td>
                                <td class="text-center">48</td>
                                <td class="text-center">29</td>
                                <td class="text-center">5</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">{% trans "Enrolled" %}</td>
                                <td class="text-center">160</td>
                                <td class="text-center">77</td>
                                <td class="text-center">107</td>
                                <td class="text-center">63</td>
                                <td class="text-center">47</td>
                                <td class="text-center">13</td>
                                <td class="text-center">6</td>
                                <td class="text-center">1</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">{% trans "Ineligible" %}</td>
                                <td class="text-center">532</td>
                                <td class="text-center">59</td>
                                <td class="text-center">371</td>
                                <td class="text-center">31</td>
                                <td class="text-center">138</td>
                                <td class="text-center">24</td>
                                <td class="text-center">23</td>
                                <td class="text-center">4</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">{% trans "Missed" %}</td>
                                <td class="text-center">69</td>
                                <td class="text-center">0</td>
                                <td class="text-center">45</td>
                                <td class="text-center">0</td>
                                <td class="text-center">24</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">{% trans "Declined" %}</td>
                                <td class="text-center">19</td>
                                <td class="text-center">24</td>
                                <td class="text-center">15</td>
                                <td class="text-center">13</td>
                                <td class="text-center">4</td>
                                <td class="text-center">11</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">{% trans "Death" %}</td>
                                <td class="text-center">18</td>
                                <td class="text-center">0</td>
                                <td class="text-center">11</td>
                                <td class="text-center">0</td>
                                <td class="text-center">6</td>
                                <td class="text-center">0</td>
                                <td class="text-center">1</td>
                                <td class="text-center">0</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">{% trans "Withdrawn" %}</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">{% trans "Lost to Follow Up" %}</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                                <td class="text-center">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {# Missed/Declined Reason Patients #}
    <div class="col-12 col-xl-6">
        <div class="card chart-card">
            <div class="chart-card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="fw-bold">{% trans "Missed/Declined Reason Patients" %}</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm mb-0" id="missedDeclinedPatientTable">
                        <thead>
                            <tr>
                                <th class="align-middle fw-bold" style="width: 70%;">{% trans "Missed/Declined Reason"%}</th>
                                <th class="text-center align-middle fw-bold" style="width: 30%;">{% trans "No. of Patient" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{% trans "Participant does not want to participate in research" %}</td>
                                <td class="text-center">17</td>
                            </tr>
                            <tr>
                                <td>{% trans "Not enough time/ too busy to commit" %}</td>
                                <td class="text-center">2</td>
                            </tr>
                            <tr>
                                <td>{% trans "Not able to get informed consent" %}</td>
                                <td class="text-center">51</td>
                            </tr>
                            <tr>
                                <td>{% trans "Dr/RN too busy to screen participant properly" %}</td>
                                <td class="text-center">18</td>
                            </tr>
                            <tr class="table-light">
                                <td class="fw-bold">{% trans "Total" %}</td>
                                <td class="text-center fw-bold">88</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {# Missed/Declined Reason Contact #}
    <div class="col-12 col-xl-6">
        <div class="card chart-card">
            <div class="chart-card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="fw-bold">{% trans "Missed/Declined Reason Contact" %}</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover table-sm mb-0" id="missedDeclinedPatientTable">
                        <thead>
                            <tr>
                                <th class="align-middle fw-bold" style="width: 70%;">{% trans "Missed/Declined Reason"%}</th>
                                <th class="text-center align-middle fw-bold" style="width: 30%;">{% trans "No. of Contact" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>{% trans "Participant does not want to participate in research" %}</td>
                                <td class="text-center">17</td>
                            </tr>
                            <tr>
                                <td>{% trans "Not enough time/ too busy to commit" %}</td>
                                <td class="text-center">2</td>
                            </tr>
                            <tr>
                                <td>{% trans "Not able to get informed consent" %}</td>
                                <td class="text-center">51</td>
                            </tr>
                            <tr>
                                <td>{% trans "Dr/RN too busy to screen participant properly" %}</td>
                                <td class="text-center">18</td>
                            </tr>
                            <tr class="table-light">
                                <td class="fw-bold">{% trans "Total" %}</td>
                                <td class="text-center fw-bold">88</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {# Sampling Follow-up Summary Table - Left (col-4) #}
    <div class="col-12 col-xl-4">
        <div class="card chart-card">
            <div class="chart-card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="fw-bold">{% trans "Sampling Follow-up Summary" %}</span>
            </div>
            <div class="card-body position-relative">
                {# Loading Indicator #}
                <div id="samplingLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="loading-text mt-2">{% trans "Loading data..." %}</span>
                </div>

                <div class="table-responsive" id="samplingTableContainer">
                    <table class="table table-bordered table-hover table-sm mb-0" id="samplingFollowupTable">
                        <thead>
                            <tr>
                                <th class="text-center align-middle fw-bold" style="width: 35%;">{% trans "Schedule" %}</th>
                                <th class="text-center align-middle fw-bold" style="width: 32.5%;">{% trans "PATIENT" %}</th>
                                <th class="text-center align-middle fw-bold" style="width: 32.5%;">{% trans "CONTACT" %}</th>
                            </tr>
                        </thead>
                        <tbody id="samplingTableBody">
                            <tr>
                                <td colspan="3" class="text-center text-muted">{% trans "Loading..." %}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        {% trans "Shows number of samples collected at each timepoint." %}
                    </small>
                </div>
            </div>
        </div>
    </div>

    {# K. pneumoniae Isolation Statistics Table - Right (col-8) #}
    <div class="col-12 col-xl-8">
        <div class="card chart-card">
            <div class="chart-card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="fw-bold">{% trans "K. pneumoniae Isolation Summary" %}</span>
            </div>
            <div class="card-body position-relative">
                {# Loading Indicator #}
                <div id="kpneumoniaeLoading" class="chart-loading-overlay" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="loading-text mt-2">{% trans "Loading data..." %}</span>
                </div>

                <div class="table-responsive" id="kpneumoniaeTableContainer">
                    <table class="table table-bordered table-hover table-sm mb-0" id="kpneumoniaeTable">
                        <thead>
                            <tr>
                                <th rowspan="2" class="text-center align-middle fw-bold" style="width: 12%;">{% trans "Sample Type" %}</th>
                                <th colspan="2" class="text-center align-middle fw-bold">{% trans "Total" %}</th>
                                <th colspan="2" class="text-center align-middle fw-bold">{% trans "HTD" %}</th>
                                <th colspan="2" class="text-center align-middle fw-bold">{% trans "Cho Ray" %}</th>
                                <th colspan="2" class="text-center align-middle fw-bold">{% trans "NHTD" %}</th>
                            </tr>
                            <tr>
                                <th class="text-center align-middle fw-bold" style="width: 11%;">{% trans "P" %}</th>
                                <th class="text-center align-middle fw-bold" style="width: 11%;">{% trans "C" %}</th>
                                <th class="text-center align-middle fw-bold" style="width: 11%;">{% trans "P" %}</th>
                                <th class="text-center align-middle fw-bold" style="width: 11%;">{% trans "C" %}</th>
                                <th class="text-center align-middle fw-bold" style="width: 11%;">{% trans "P" %}</th>
                                <th class="text-center align-middle fw-bold" style="width: 11%;">{% trans "C" %}</th>
                                <th class="text-center align-middle fw-bold" style="width: 11%;">{% trans "P" %}</th>
                                <th class="text-center align-middle fw-bold" style="width: 11%;">{% trans "C" %}</th>
                            </tr>
                        </thead>
                        <tbody id="kpneumoniaeTableBody">
                            <tr>
                                <td colspan="9" class="text-center text-muted">{% trans "Loading..." %}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        {% trans "P = Patient, C = Contact. Clinical Kp. only applies to Patients." %}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block dashboard_js %}
{# Common Utilities - Site Selection #}
<script nonce="{{ request.csp_nonce }}" src="{% static 'studies/study_43en/js/common/site-selector.js' %}"></script>

{# Dashboard Charts - Enrollment Progress #}
<script nonce="{{ request.csp_nonce }}"
    src="{% static 'studies/study_43en/js/dashboard/enrollment-progress.js' %}"></script>

{# Dashboard Charts - Monthly Statistics (Patient & Contact) #}
<script nonce="{{ request.csp_nonce }}"
    src="{% static 'studies/study_43en/js/dashboard/monthly-statistics.js' %}"></script>

{# Dashboard Tables - Sampling Follow-up & K. pneumoniae #}
<script nonce="{{ request.csp_nonce }}"
    src="{% static 'studies/study_43en/js/dashboard/sampling-followup.js' %}"></script>
<script nonce="{{ request.csp_nonce }}"
    src="{% static 'studies/study_43en/js/dashboard/kpneumoniae-isolation.js' %}"></script>
{% endblock %}