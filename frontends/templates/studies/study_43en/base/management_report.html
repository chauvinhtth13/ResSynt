{% extends 'studies/study_43en/home_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block dashboard_css %}
<link rel="stylesheet" href="{% static 'studies/study_43en/css/home_dashboard.css' %}">
{% endblock %}

{% block dashboard_content %}


<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center mb-3 me-1">
        <div class="min-w-0 flex-grow-1">
            <h5 class="h5 fw-bold mb-1">{% trans "43EN Management Dashboard" %}</h5>
            <p class="text-white-80 mb-0 small line-clamp-2" title="{{ study_name }}">
                {{ study_name }}
            </p>
        </div>
        <button class="btn-cyber-outline-sm flex-shrink-0" id="refreshBtn">
            <i class="bi bi-arrow-clockwise" id="refreshIcon"></i>
            {% trans "Refresh" %}
        </button>
    </div>

    <!-- Bottom Row: Stats -->
    <div class="d-flex justify-content-between align-items-center border-top border-white border-opacity-25 pt-3">
        <div class="d-flex flex-column justify-content-center">
                <span class="small text-uppercase fw-semibold text-white-80 mb-1">
                    {% trans "Study Site" %}
                </span>

                {% if user_sites_count == 1 %}
                    <span class="text-white fw-bold">
                        <i class="bi bi-geo-alt-fill text-accent-cyan me-1"></i>{{ site_name }}
                    </span>
                {% else %}
                    <div class="dropdown" id="siteSelectContainer">
                        <button class="btn btn-cyber-dropdown-sm dropdown-toggle" 
                                style="width: 8rem;"
                                type="button" 
                                id="siteSelectBtn" 
                                data-bs-toggle="dropdown" 
                                aria-expanded="false"
                                aria-label="{% trans 'Select study site' %}">
                            <span id="selectedSiteLabel" class="text-truncate">{{ site_name }}</span>
                        </button>
                        
                        <div class="dropdown-menu dropdown-menu-base dropdown-menu-select p-0" 
                             style="width: 8rem;" 
                             aria-labelledby="siteSelectBtn">
                            
                            {# Site List - Clickable items with auto-apply #}
                            <div class="site-option-list px-2 py-2" id="siteOptionsList" 
                                 style="max-height: 280px; overflow-y: auto;">
                                
                                {# All Sites Option #}
                                <button type="button" 
                                        class="site-option-btn d-flex align-items-center gap-2 w-100"
                                        data-value="all"
                                        data-display="{% trans 'All Sites' %}">
                                    <span class="text-truncate">{% trans "All Sites" %}</span>
                                </button>
                                
                                {# Divider #}
                                <hr class="my-1 border-white border-opacity-25">
                                
                                {# Individual Sites #}
                                {% for site_item in accessible_sites_data %}
                                <button type="button" 
                                        class="site-option-btn d-flex align-items-center gap-2 w-100"
                                        data-value="{{ site_item.code }}"
                                        data-display="{{ site_item.display }}">
                                    <span class="text-truncate">{{ site_item.display }}</span>
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="selectedSiteInput" name="site" value="{% if filter_type == 'all' %}all{% else %}{{ site_filter }}{% endif %}">
                {% endif %}
        </div>

        <div class="d-flex justify-content-center gap-2">
            <div class="icon-box icon-box--light">
                <i class="bi bi-clock-history text-white"></i>
            </div>
            <div class="d-flex flex-column justify-content-center">
                <span class="small text-uppercase fw-semibold text-white-80">{% trans "Last Update" %}</span>
                <span class="text-white fw-bold">{{ today|date:"d/m/Y H:i" }}</span>
            </div>
        </div>
    </div>
</div>

<div class="card chart-card mb-4">
    <div class="chart-card-header">
        <span class="fw-bold">{% trans "Patient Enrollment Progress" %}</span>
    </div>
    <div class="card-body p-0">
        <div id="chartLoading" style="display: flex;">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="loading-text">{% trans "Loading chart data..." %}</span>
        </div>
        <div id="enrollmentChart"></div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-12 col-xl-6">
        <div class="card chart-card">
            <div class="chart-card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="fw-bold">{% trans "Screening & Enrollment Patients" %}</span>
                
                {# Simple Filter: View Mode + Year #}
                <div class="d-flex align-items-center gap-2">
                    {# View Mode Selector (Quarter or Month) #}
                    <select class="form-select form-select-sm" id="patientViewMode" style="width: auto;">
                        <option value="quarter" selected>{% trans "By Quarter" %}</option>
                        <option value="month">{% trans "By Month" %}</option>
                    </select>
                    
                    {# Year Selector #}
                    <select class="form-select form-select-sm" id="patientYear" style="width: auto;">
                        <option value="all" selected>{% trans "All" %}</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
            </div>
            <div class="card-body position-relative">
                <div id="patientChartLoading" class="chart-loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="loading-text mt-2">{% trans "Loading chart data..." %}</span>
                </div>
                <div id="patientMonthlyChart"></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-xl-6">
        <div class="card chart-card">
            <div class="chart-card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                <span class="fw-bold">{% trans "Screening & Enrollment Contact" %}</span>
                
                {# Simple Filter: View Mode + Year #}
                <div class="d-flex align-items-center gap-2">
                    {# View Mode Selector (Quarter or Month) #}
                    <select class="form-select form-select-sm" id="contactViewMode" style="width: auto;">
                        <option value="quarter" selected>{% trans "By Quarter" %}</option>
                        <option value="month">{% trans "By Month" %}</option>
                    </select>
                    
                    {# Year Selector #}
                    <select class="form-select form-select-sm" id="contactYear" style="width: auto;">
                        <option value="all" selected>{% trans "All" %}</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
            </div>
            <div class="card-body position-relative">
                <div id="contactChartLoading" class="chart-loading-overlay">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="loading-text mt-2">{% trans "Loading chart data..." %}</span>
                </div>
                <div id="contactMonthlyChart"></div>
            </div>
        </div>
    </div>


<!-- {# Sample Management & K. pneumoniae Tables - Combined Row #}
<div class="row g-4 mb-4">
    {# K. pneumoniae Isolation Statistics Table - 60% #}
    <div class="col-12 col-xl-7">
        <div class="card chart-card chart-card--full-height">
            <div class="chart-card__header">
                <div class="header-flex">
                    <h6 class="chart-card__title">
                        <i class="bi bi-virus text-danger"></i>
                        {% trans "K. pneumoniae isolated from throat swab & stool/rectal swab samples" %}
                    </h6>

                    {# Site Filter Dropdown #}
                    <select class="site-filter kpneumoniae-site-select" data-chart="kpneumoniae">
                        <option value="all">{% trans "All Sites" %}</option>
                        {% for site in accessible_sites %}
                        <option value="{{ site }}">{{ site }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="card-body">
                {# Loading indicator #}
                <div id="kpneumoniaeLoading" class="loading-container">
                    <div class="spinner-border loading-spinner--danger" role="status">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                    <p class="loading-text">{% trans "Loading K. pneumoniae data..." %}</p>
                </div>

                {# K. pneumoniae Table #}
                <div id="kpneumoniaeTableContainer" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th rowspan="2" class="align-middle">{% trans "Study site" %}</th>
                                    <th rowspan="2" class="align-middle">{% trans "Subject" %}</th>
                                    <th rowspan="2" class="align-middle text-center">{% trans "No. of participant" %}
                                    </th>
                                    <th rowspan="2" class="align-middle text-center">{% trans "Clinical Kp." %}</th>
                                    <th colspan="4" class="text-center bg-info bg-opacity-10">{% trans "Throat swab" %}
                                    </th>
                                    <th colspan="4" class="text-center bg-warning bg-opacity-10">{% trans "Stool/Rectalswab" %}</th>
                                </tr>
                                <tr>
                                    <th class="text-center bg-info bg-opacity-10">{% trans "Day 1" %}</th>
                                    <th class="text-center bg-info bg-opacity-10">{% trans "Day 10" %}</th>
                                    <th class="text-center bg-info bg-opacity-10">{% trans "Day 28" %}</th>
                                    <th class="text-center bg-info bg-opacity-10">{% trans "Day 90" %}</th>
                                    <th class="text-center bg-warning bg-opacity-10">{% trans "Day 1" %}</th>
                                    <th class="text-center bg-warning bg-opacity-10">{% trans "Day 10" %}</th>
                                    <th class="text-center bg-warning bg-opacity-10">{% trans "Day 28" %}</th>
                                    <th class="text-center bg-warning bg-opacity-10">{% trans "Day 90" %}</th>
                                </tr>
                            </thead>
                            <tbody id="kpneumoniaeTableBody">
                                <tr>
                                    <td colspan="12" class="text-center text-muted">{% trans "Loading..." %}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="alert-note alert-note--secondary">
                        <small>
                            <i class="bi bi-asterisk"></i>
                            <strong>*</strong>
                            {% trans "K. pneumoniae positive sample / Total collected samples" %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Sampling Follow-up Table (Patient & Contact) - 40% #}
    <div class="col-12 col-xl-5">
        <div class="card chart-card chart-card--full-height">
            <div class="chart-card__header">
                <div class="header-flex">
                    <h6 class="chart-card__title">
                        <i class="bi bi-clipboard-data text-info"></i>
                        {% trans "Sample Management: Patient & Contact Sampling Follow-up" %}
                    </h6>

                    {# Site Filter Dropdown #}
                    <select class="site-filter sampling-site-select" data-chart="sampling">
                        <option value="all">{% trans "All Sites" %}</option>
                        {% for site in accessible_sites %}
                        <option value="{{ site }}">{{ site }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="card-body">
                {# Loading indicator #}
                <div id="samplingLoading" class="loading-container">
                    <div class="spinner-border loading-spinner--info" role="status">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                    <p class="loading-text">{% trans "Loading sampling data..." %}</p>
                </div>

                {# Sampling Table #}
                <div id="samplingTableContainer" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th rowspan="2" class="align-middle">{% trans "Schedule" %}</th>
                                    <th colspan="2" class="text-center bg-primary bg-opacity-10">{% trans "PATIENT" %}
                                    </th>
                                    <th colspan="2" class="text-center bg-success bg-opacity-10">{% trans "CONTACT" %}
                                    </th>
                                </tr>
                                <tr>
                                    <th class="text-center bg-primary bg-opacity-10">{% trans "Total Sampling" %}</th>
                                    <th class="text-center bg-primary bg-opacity-10">{% trans "Blood Sampling" %}</th>
                                    <th class="text-center bg-success bg-opacity-10">{% trans "Total Sampling" %}</th>
                                    <th class="text-center bg-success bg-opacity-10">{% trans "Blood Sampling" %}</th>
                                </tr>
                            </thead>
                            <tbody id="samplingTableBody">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">{% trans "Loading..." %}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="alert-note alert-note--info">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            <strong>{% trans "Note:" %}</strong>
                            {% trans "Total Sampling includes Stool, Rectal Swab, and Throat Swab samples (excludes
                            blood). Blood Sampling is counted separately." %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> -->

{% endblock %}


{% block dashboard_js %}
{# Site Selection Dropdown JavaScript #}
<script nonce="{{ request.csp_nonce }}"
    src="{% static 'studies/study_43en/js/management-dashboard/site-selector.js' %}"></script>

{# Dashboard JavaScript - Enrollment Progress Chart #}
<script nonce="{{ request.csp_nonce }}"
    src="{% static 'studies/study_43en/js/management-dashboard/enrollment-progress.js' %}"></script>

{# Monthly Statistics Charts - Patient & Contact #}
<script nonce="{{ request.csp_nonce }}"
    src="{% static 'studies/study_43en/js/management-dashboard/monthly-statistics.js' %}"></script>
{% endblock %}