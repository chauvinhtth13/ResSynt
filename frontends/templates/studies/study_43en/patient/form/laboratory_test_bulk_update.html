{% extends 'studies\study_43en\home_dashboard.html' %}
{% load static %}
{% load i18n %}
{% load study_43en_tags %}

{% block title %}
  {% if is_update %}
    {% trans "C·∫≠p Nh·∫≠t X√©t Nghi·ªám" %}
  {% else %}
    {% trans "Nh·∫≠p K·∫øt Qu·∫£ X√©t Nghi·ªám" %}
  {% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:patient_detail' usubjid=usubjid %}">{% trans "B·ªánh nh√¢n" %} {{ usubjid }}</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:laboratory_test_list' usubjid=usubjid %}">{% trans "X√©t nghi·ªám" %}</a></li>
<li class="breadcrumb-item active">{{ lab_type_display }}</li>
{% endblock %}

{% block dashboard_css %}
<!-- Include CRF unified styles -->
{% include 'studies/study_43en/includes/crf_styles.html' %}
<style>
  /* Laboratory-specific overrides only */
  
  .patient-info-box .info-label {
    font-weight: 600;
    color: #0e7490;
    margin-bottom: 5px;
  }
  
  .patient-info-box .info-value {
    font-size: 1.1rem;
    color: #0c4a6e;
    font-weight: 600;
  }
  
  .category-title {
    color: #667eea;
    font-weight: 600;
    background: linear-gradient(135deg, #f8f9fc 0%, #e9ecef 100%);
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #667eea;
    font-size: 1.1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .lab-test-card {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 18px;
    transition: all 0.3s ease;
    border-left: 4px solid #e9ecef;
    margin-bottom: 12px;
  }
  
  .lab-test-card.performed {
    border-left-color: #10b981;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  }
  
  .lab-test-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
  }
  
  .form-check-input {
    cursor: pointer;
    width: 20px;
    height: 20px;
    margin-top: 2px;
  }
  
  .form-check-input:checked {
    background-color: #10b981;
    border-color: #10b981;
  }
  
  .test-details input, 
  .test-details textarea {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #e5e7eb;
    border-radius: 6px;
    transition: all 0.2s ease;
    font-size: 0.95rem;
  }
  
  .test-details input:focus, 
  .test-details textarea:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
  }
  
  .btn-primary:hover {
    background: linear-gradient(135deg, #5568d3 0%, #64408a 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }
  /* ========== NEW: CATEGORY DATE PICKER ========== */
  .category-date-picker {
    background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
    border: 2px solid #fb923c;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .category-date-picker label {
    font-weight: 600;
    color: #c2410c;
    margin: 0;
    white-space: nowrap;
  }
  
  .category-date-picker input {
    flex: 1;
    padding: 8px 12px;
    border: 2px solid #fb923c;
    border-radius: 6px;
    font-size: 0.95rem;
  }
  
  .category-date-picker button {
    background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .category-date-picker button:hover {
    background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(251, 146, 60, 0.4);
  }
  
  /* ========== NEW: UNIT DISPLAY ========== */
  .test-unit {
    color: #6b7280;
    font-size: 0.85rem;
    font-style: italic;
    margin-left: 5px;
  }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="row">
  <div class="col-md-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-flask mr-2"></i>
          {% if is_readonly %}
            {% trans "Xem K·∫øt Qu·∫£ X√©t Nghi·ªám" %}
            <span class="readonly-badge">
              <i class="fas fa-eye mr-1"></i>{% trans "Ch·ªâ xem" %}
            </span>
          {% else %}
            {% trans "C·∫≠p Nh·∫≠t X√©t Nghi·ªám" %}
          {% endif %}
          - {{ lab_type_display }}
        </h3>
      </div>
      
      <div class="card-body {% if is_readonly %}readonly-mode{% endif %}">
        <!-- Patient Information Box -->
        <div class="patient-info-box">
          <div class="row">
            <div class="col-md-4">
              <div class="info-label">
                <i class="fas fa-user-tag mr-2"></i>{% trans "M√£ b·ªánh nh√¢n" %}
              </div>
              <div class="info-value">{{ usubjid }}</div>
            </div>
            <div class="col-md-4">
              <div class="info-label">
                <i class="fas fa-vial mr-2"></i>{% trans "L·∫ßn x√©t nghi·ªám" %}
              </div>
              <div class="info-value">{{ lab_type_display }}</div>
            </div>
            <div class="col-md-4">
              <div class="info-label">
                <i class="fas fa-hospital mr-2"></i>{% trans "Site ID" %}
              </div>
              <div class="info-value">{{ screening_case.SITEID }}</div>
            </div>
          </div>
        </div>
        
        <!--  CONDITIONAL: Only show form if NOT readonly -->
        {% if not is_readonly %}
        <!-- Main Form -->
        <form method="post" id="lab-form">
        {% endif %}
        
          {% csrf_token %}
          {{ formset.management_form }}
          
          <!-- Categories with tests -->
          {% for category_code, category_name in all_categories %}
            <div class="lab-category" id="category-{{ category_code }}" data-category="{{ category_code }}">
              <h5 class="category-title">
                <i class="fas fa-folder-open mr-2"></i>{{ category_name }}
              </h5>
              
              <!--  HIDE date picker in readonly mode -->
              {% if not is_readonly %}
              <div class="category-date-picker">
                <label for="category-date-{{ category_code }}">
                  <i class="far fa-calendar-alt mr-2"></i>{% trans "Ng√†y chung cho danh m·ª•c n√†y:" %}
                </label>
                <input 
                  type="text" 
                  id="category-date-{{ category_code }}" 
                  class="form-control datepicker category-date-input"
                  data-category="{{ category_code }}"
                  placeholder="DD/MM/YYYY">
                <button 
                  type="button" 
                  class="apply-category-date"
                  data-category="{{ category_code }}">
                  <i class="fas fa-check mr-2"></i>{% trans "√Åp d·ª•ng cho t·∫•t c·∫£" %}
                </button>
              </div>
              {% endif %}
              
              <div class="lab-tests-list">
                {% for form in formset %}
                  {% if form.instance.TESTTYPE in category_test_map|get_item:category_code %}
                    <div class="lab-test-row" data-test-code="{{ form.instance.TESTTYPE }}">
                      <div class="lab-test-card {% if form.instance.PERFORMED %}performed{% endif %}">
                        {{ form.id }}
                        
                        <div class="test-header">
                          <div class="form-check">
                            <!--  DISABLE checkbox in readonly mode -->
                            {% if is_readonly %}
                              <input type="checkbox" 
                                     class="form-check-input" 
                                     {% if form.instance.PERFORMED %}checked{% endif %}
                                     disabled>
                            {% else %}
                              {{ form.PERFORMED }}
                            {% endif %}
                            <label class="form-check-label" for="{{ form.PERFORMED.auto_id }}">
                              <strong>{{ form.instance.get_TESTTYPE_display }}</strong>
                              <span class="test-code">({{ form.instance.TESTTYPE }})</span>
                              {% with unit=form.instance.TESTTYPE|get_test_unit %}
                                {% if unit %}
                                  <span class="test-unit">{{ unit }}</span>
                                {% endif %}
                              {% endwith %}
                            </label>
                          </div>
                        </div>
                        
                        <div class="test-details" style="{% if not form.instance.PERFORMED %}display:none;{% endif %}">
                          <div class="row">
                            <div class="col-md-4">
                              <label for="{{ form.PERFORMEDDATE.auto_id }}">
                                <i class="far fa-calendar-alt mr-1"></i>{% trans "Ng√†y th·ª±c hi·ªán" %}
                              </label>
                              <!--  DISABLE in readonly mode -->
                              {% if is_readonly %}
                                <input type="text" 
                                       class="form-control" 
                                       value="{{ form.instance.PERFORMEDDATE|date:'d/m/Y' }}"
                                       disabled>
                              {% else %}
                                {{ form.PERFORMEDDATE }}
                              {% endif %}
                              {% if form.PERFORMEDDATE.errors %}
                                <div class="invalid-feedback d-block">
                                  {{ form.PERFORMEDDATE.errors.0 }}
                                </div>
                              {% endif %}
                            </div>
                            
                            <div class="col-md-8">
                              <label for="{{ form.RESULT.auto_id }}">
                                <i class="fas fa-notes-medical mr-1"></i>{% trans "K·∫øt qu·∫£" %}
                                {% with unit=form.instance.TESTTYPE|get_test_unit %}
                                  {% if unit %}
                                    <span class="test-unit">{{ unit }}</span>
                                  {% endif %}
                                {% endwith %}
                              </label>
                              <!--  DISABLE in readonly mode -->
                              {% if is_readonly %}
                                <textarea class="form-control" rows="2" disabled>{{ form.instance.RESULT }}</textarea>
                              {% else %}
                                {{ form.RESULT }}
                              {% endif %}
                              {% if form.RESULT.errors %}
                                <div class="invalid-feedback d-block">
                                  {{ form.RESULT.errors.0 }}
                                </div>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endfor %}
          
          <!-- Action Buttons -->
          <div class="d-flex justify-content-between mt-4">
            <div>
              <a href="{% url 'study_43en:laboratory_test_list' usubjid=usubjid %}" 
                 class="btn btn-secondary">
                <i class="fas fa-arrow-left mr-1"></i>{% trans "Quay L·∫°i" %}
              </a>
            </div>
            {% if not is_readonly %}
            <div>
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save mr-1"></i>{% trans "L∆∞u T·∫•t C·∫£ Thay ƒê·ªïi" %}
              </button>
            </div>
            {% else %}
            <!--  Show Edit button if has change permission -->
            {% if perms.study_43en.change_laboratorytest %}
            <div>
              <a href="{% url 'study_43en:laboratory_test_bulk_update' usubjid=usubjid lab_type=lab_type %}" 
                 class="btn btn-warning btn-lg">
                <i class="fas fa-edit mr-1"></i>{% trans "Ch·ªânh S·ª≠a" %}
              </a>
            </div>
            {% endif %}
            {% endif %}
          </div>
        
        {% if not is_readonly %}
        </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Change Reason Modal -->
{% if show_reason_form and detected_changes %}
  {% include 'default/change_reason_modal.html' %}
{% endif %}
{% endblock %}

{% block dashboard_js %}
<!-- Include datepicker scripts -->
{% include 'studies/study_43en/includes/datepicker_scripts.html' %}

<script nonce="{{ request.csp_nonce }}">
$(document).ready(function() {
  console.log('=== LABORATORY TEST FORM ===');
  console.log('jQuery version:', $.fn.jquery);
  console.log('Patient ID:', "{{ usubjid }}");
  console.log('Lab type:', "{{ lab_type }}");
  
  // ========================================
  //  NEW: Category Date Auto-fill
  // ========================================
  $('.apply-category-date').on('click', function() {
    var $btn = $(this);
    var categoryCode = $btn.data('category');
    var $categoryDiv = $('#category-' + categoryCode);
    var categoryDate = $('#category-date-' + categoryCode).val();
    
    if (!categoryDate) {
      alert(' Vui l√≤ng ch·ªçn ng√†y tr∆∞·ªõc!');
      return;
    }
    
    console.log('üìÖ Applying date to category:', categoryCode, 'Date:', categoryDate);
    
    // Find all date inputs in this category
    var $dateInputs = $categoryDiv.find('.datepicker').not('.category-date-input');
    var count = 0;
    
    $dateInputs.each(function() {
      var $input = $(this);
      var $card = $input.closest('.lab-test-card');
      var $checkbox = $card.find('.lab-performed-checkbox');
      
      // Only apply to performed tests
      if ($checkbox.is(':checked')) {
        $input.val(categoryDate);
        count++;
      }
    });
    
    console.log(` Applied date to ${count} tests in category ${categoryCode}`);
    
    // Visual feedback
    $btn.html('<i class="fas fa-check-double mr-2"></i>ƒê√£ √°p d·ª•ng!');
    $btn.css('background', 'linear-gradient(135deg, #10b981 0%, #059669 100%)');
    
    setTimeout(function() {
      $btn.html('<i class="fas fa-check mr-2"></i>{% trans "√Åp d·ª•ng cho t·∫•t c·∫£" %}');
      $btn.css('background', '');
    }, 2000);
  });
  
  // ========================================
  //  IMPROVED: Checkbox handler with category date sync
  // ========================================
  $(document).on('change', '.lab-performed-checkbox', function() {
    var $checkbox = $(this);
    var checkboxId = $checkbox.attr('id') || 'NO_ID';
    var checkboxName = $checkbox.attr('name') || 'NO_NAME';
    var isChecked = $checkbox.is(':checked');
    
    console.log(' Checkbox changed:', {
      id: checkboxId,
      name: checkboxName,
      checked: isChecked
    });
    
    var $card = $checkbox.closest('.lab-test-card');
    var $detailsDiv = $card.find('.test-details');
    var $category = $checkbox.closest('.lab-category');
    var categoryCode = $category.data('category');
    
    if (isChecked) {
      $detailsDiv.slideDown(300);
      $card.addClass('performed');
      
      //  Auto-fill date from category if available
      var categoryDate = $('#category-date-' + categoryCode).val();
      if (categoryDate) {
        var $dateInput = $detailsDiv.find('.datepicker').first();
        if ($dateInput.length && !$dateInput.val()) {
          $dateInput.val(categoryDate);
          console.log('üìÖ Auto-filled date from category:', categoryDate);
        }
      }
      
      setTimeout(function() {
        var $dateInput = $detailsDiv.find('.datepicker').first();
        if ($dateInput.length && !$dateInput.val()) {
          $dateInput.focus();
          console.log('üìÖ Focused on date input');
        } else {
          var $resultInput = $detailsDiv.find('textarea').first();
          if ($resultInput.length) {
            $resultInput.focus();
            console.log('üìù Focused on result textarea');
          }
        }
      }, 350);
    } else {
      $detailsDiv.slideUp(300);
      $card.removeClass('performed');
    }
  });
  
  // ========================================
  //  NEW: Sync category date when individual date changes
  // ========================================
  $(document).on('change', '.datepicker', function() {
    if ($(this).hasClass('category-date-input')) {
      return; // Skip category date input itself
    }
    
    var $input = $(this);
    var $category = $input.closest('.lab-category');
    var categoryCode = $category.data('category');
    var newDate = $input.val();
    
    // Check if this is the first date in the category
    var $categoryDateInput = $('#category-date-' + categoryCode);
    if (!$categoryDateInput.val() && newDate) {
      $categoryDateInput.val(newDate);
      console.log('üìÖ Auto-set category date:', newDate);
    }
  });
  
  // ========================================
  // Form submit handler
  // ========================================
  $('#lab-form').on('submit', function(e) {
    console.log('='.repeat(60));
    console.log(' FORM SUBMITTING');
    console.log('='.repeat(60));
    
    var formData = new FormData(this);
    var performedCount = 0;
    var incompleteCount = 0;
    
    // Check for incomplete tests
    $('.lab-performed-checkbox:checked').each(function() {
      performedCount++;
      var $card = $(this).closest('.lab-test-card');
      var $dateInput = $card.find('.datepicker');
      var $resultInput = $card.find('textarea');
      
      if (!$dateInput.val() || !$resultInput.val().trim()) {
        incompleteCount++;
      }
    });
    
    console.log(`Total tests to save: ${performedCount}`);
    console.log(`Incomplete tests: ${incompleteCount}`);
    
    if (incompleteCount > 0) {
      var message = ` C√≥ ${incompleteCount} x√©t nghi·ªám ƒë√£ ƒë√°nh d·∫•u "ƒê√£ th·ª±c hi·ªán" nh∆∞ng thi·∫øu th√¥ng tin.\n\nB·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u?`;
      if (!confirm(message)) {
        e.preventDefault();
        console.log(' User cancelled submission');
        return false;
      }
    }
    
    console.log('='.repeat(60));
  });
  
  // Debug initial state
  var checkboxCount = $('.lab-performed-checkbox').length;
  console.log(`Found ${checkboxCount} checkboxes`);
  
  $('.lab-performed-checkbox').slice(0, 5).each(function(i) {
    console.log(`Checkbox ${i+1}:`, {
      id: $(this).attr('id'),
      name: $(this).attr('name'),
      checked: $(this).is(':checked')
    });
  });
  
  console.log('Laboratory test form initialized');
});
</script>

<script nonce="{{ request.csp_nonce }}" src="{% static 'studies/study_43en/js/change-reason-handler.js' %}"></script>
{% endblock %}