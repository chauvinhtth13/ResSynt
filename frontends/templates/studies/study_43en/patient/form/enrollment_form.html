{% extends 'studies\study_43en\home_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}
 {% if is_readonly %}
 {% trans "View Patient Information 43EN" %}
 {% else %}
 {% trans "Patient Enrollment Form 43EN" %}
 {% endif %}
{% endblock %}

{% block page_title %}
 {% if is_readonly %}
 {% trans "View Patient Information 43EN" %}
 {% else %}
 {% trans "Patient Enrollment Form 43EN" %}
 {% endif %}
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:screening_case_list' %}">{% trans "Patient List 43EN" %}</a></li>
<li class="breadcrumb-item active">{% trans "Patient Enrollment" %}</li>
{% endblock %}

{% block dashboard_css %}

<!-- Include CRF unified styles -->
{% include 'studies/study_43en/includes/crf_styles.html' %}
{% if not is_readonly %}
<style>
 /* Enrollment-specific overrides only */
 .risk-factor-options {
 flex-direction: column;
 align-items: flex-start;
 gap: 10px;
 }
 /* Address Selection Group */
.address-selection-group {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
 gap: 15px;
 margin-bottom: 25px;
}

.address-option {
 position: relative;
}

.address-option input[type="radio"] {
 position: absolute;
 opacity: 0;
 width: 0;
 height: 0;
}

.address-option-label {
 display: block;
 padding: 15px 20px;
 background: white;
 border: 2px solid #e9ecef;
 border-radius: 8px;
 cursor: pointer;
 transition: all 0.3s ease;
 margin: 0;
}

.address-option-label:hover {
 border-color: #667eea;
 box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
 transform: translateY(-2px);
}

.address-option input[type="radio"]:checked + .address-option-label {
 border-color: #667eea;
 background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
 box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

.address-option-header {
 display: flex;
 align-items: center;
 font-size: 1rem;
}

.address-option-header i {
 font-size: 1.3rem;
 margin-right: 10px;
}

/* Address Fields Container */
.address-fields-container {
 margin-top: 20px;
 animation: slideDown 0.4s ease-out;
}

.address-subsection {
 background: #f8f9fa;
 border-left: 4px solid #667eea;
 border-radius: 6px;
 padding: 20px;
 margin-bottom: 20px;
}

.address-subsection-header {
 display: flex;
 align-items: center;
 margin-bottom: 15px;
 padding-bottom: 10px;
 border-bottom: 2px solid #e9ecef;
 font-size: 1.05rem;
}

.address-subsection-header i {
 font-size: 1.2rem;
}

/* Address Preview */
.address-preview-content {
 min-height: 40px;
 padding: 10px 15px;
 background: white;
 border-radius: 6px;
 font-size: 1.05rem;
}

.address-preview-content.has-address {
 color: #374151;
 font-weight: 500;
}

.address-preview-section {
 margin-bottom: 8px;
 padding: 8px 12px;
 background: #e3f2fd;
 border-left: 3px solid #2196F3;
 border-radius: 4px;
}

.address-preview-section:last-child {
 margin-bottom: 0;
}

.address-preview-label {
 font-weight: 600;
 color: #1976d2;
 margin-right: 8px;
 font-size: 0.9rem;
}

.address-preview-value {
 color: #374151;
}

/* Badge Enhancements */
.badge-success {
 background-color: #10b981;
 font-weight: 500;
 padding: 4px 10px;
}

.badge-secondary {
 background-color: #6b7280;
 font-weight: 500;
 padding: 4px 10px;
}

.badge-primary {
 background-color: #667eea;
 font-weight: 500;
 padding: 4px 10px;
}

/* Animation */
@keyframes slideDown {
 from {
 opacity: 0;
 transform: translateY(-15px);
 }
 to {
 opacity: 1;
 transform: translateY(0);
 }
}

/* Responsive Design */
@media (max-width: 768px) {
 .address-selection-group {
 grid-template-columns: 1fr;
 }

 .address-option-header {
 flex-wrap: wrap;
 }
}
 /* All address selection styles are now in crf-forms.css */
</style>
{% endif %}
{% endblock %}

{% block dashboard_content %}
<div class="row">
 <div class="col-md-12">
 <div class="card card-primary">
 <div class="card-header">
 <h3 class="card-title">
 {% if is_readonly %}
 <i class="fas fa-eye mr-2"></i>{% trans "Patient Information" %} {{ screening_case.USUBJID }}
 {% else %}
 </i>{% trans "Patient Enrollment Form" %} {{ screening_case.USUBJID }}
 {% endif %}
 </h3>

 {% if is_readonly %}
 <div class="card-tools">
 <a href="{% url 'study_43en:enrollment_case_update' usubjid=screening_case.USUBJID %}"
 class="btn btn-primary btn-sm">
 <i ></i> {% trans "Edit" %}
 </a>
 </div>
 {% endif %}
 </div>

 <div class="card-body">
 {# Error Messages #}
 {% if form.errors and not is_readonly %}
 <div class="alert alert-danger">
 <h5> {% trans "Errors Found" %}</h5>
 <ul class="mb-0">
 {% for field, errors in form.errors.items %}
 <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
 {% endfor %}
 </ul>
 </div>
 {% endif %}

 {% if personal_form.errors and not is_readonly %}
 <div class="alert alert-danger">
 <h5> {% trans "Personal Data Errors" %}</h5>
 <ul class="mb-0">
 {% for field, errors in personal_form.errors.items %}
 <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
 {% endfor %}
 </ul>
 </div>
 {% endif %}

 {% if medhisdrug_formset.errors %}
 <div class="alert alert-warning">
 <h5> {% trans "Medication Errors" %}</h5>
 <ul class="mb-0">
 {% for error in medhisdrug_formset.errors %}
 <li>{{ error }}</li>
 {% endfor %}
 </ul>
 </div>
 {% endif %}

 {% if underlying_form.errors %}
 <div class="alert alert-warning">
 <h5> {% trans "Underlying Conditions Errors" %}</h5>
 <ul class="mb-0">
 {% for field, errors in underlying_form.errors.items %}
 <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
 {% endfor %}
 </ul>
 </div>
 {% endif %}

 {# Main Form #}
 <form method="post"
 id="enrollmentForm"
 data-screening-id="{{ screening_case.USUBJID }}"
 {% if is_readonly %}class="view-only-form"{% endif %}>
 {% csrf_token %}
 {{ form.version }}

 {# ========== ENROLLMENT CASE CONTAINER ========== #}
 <div class="enr-case-container">
 <div class="enr-case-header">
 </i>ENROLLMENT - CASE
 </div>

 <div class="enr-case-content">
 {# Study Identifiers #}
 <div class="row mb-4">
 <div class="col-md-3">
 <div class="form-group">
 <label>{% trans "Study Code [43EN]" %}</label>
 <input type="text" class="form-control" value="43EN" readonly>
 </div>
 </div>
 <div class="col-md-3">
 <div class="form-group">
 <label>{% trans "Site" %}</label>
 <input type="text" class="form-control" value="{{ screening_case.SITEID }}" readonly>
 </div>
 </div>
 <div class="col-md-3">
 <div class="form-group">
 <label>{% trans "Subject Type [A]" %}</label>
 <input type="text" class="form-control" value="A" readonly>
 </div>
 </div>
 <div class="col-md-3">
 <div class="form-group">
 <label>{% trans "Subject ID" %}</label>
 <input type="text" class="form-control" value="{{ screening_case.SUBJID }}" readonly>
 </div>
 </div>
 </div>

 {# THÊM SECTION MỚI: CONTACT INFORMATION #}
 <div class="form-section-header" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
 {% trans "Personal Contact Information" %}
 <small class="float-right text-white-50">
 </i>{% trans "Confidential" %}
 </small>
 </div>

 <div class="row mb-4">
 <div class="col-md-6">
 <div class="form-group">
 <label for="{{ personal_form.FULLNAME.id_for_label }}" class="required">
 {% trans "Full Name" %}
 <span class="text-danger">*</span>
</label>
 <div class="input-group">
 <div >

</span>
 </div>
 {{ personal_form.FULLNAME }}
 </div>
 {% if personal_form.FULLNAME.errors %}
 <small class="text-danger">

 {{ personal_form.FULLNAME.errors.0 }}
 </small>
 {% endif %}
 <small class="form-text text-muted">

 {% trans "Enter patient's full legal name" %}
 </small>
 </div>
 </div>

 <div class="col-md-6">
 <div class="form-group">
 <label for="{{ personal_form.PHONE.id_for_label }}" class="required">
 {% trans "Phone Number" %}
 <span class="text-danger">*</span>
</label>
 <div class="input-group">
 <div >

</span>
 </div>
 {{ personal_form.PHONE }}
 </div>
 {% if personal_form.PHONE.errors %}
 <small class="text-danger">

 {{ personal_form.PHONE.errors.0 }}
 </small>
 {% endif %}
 <small class="form-text text-muted">

 {% trans "Format: 0XXXXXXXXX or +84XXXXXXXXX" %}
 </small>
 </div>
 </div>
 </div>

 {# Privacy Notice #}
 <div class="alert alert-warning mb-4" role="alert">
 <div class="d-flex align-items-center">

 <div>
 <strong>{% trans "Privacy Notice" %}:</strong>
 {% trans "Full name and phone number are confidential personal information and will be protected according to data privacy regulations." %}
 </div>
 </div>
 </div>

 {# ========== BASIC INFORMATION ========== #}
 <div class="form-section-header">
 {% trans "Participant Information" %}
 </div>

 {# 1. Enrollment Date #}
 <div class="numbered-item" data-number="1">
 <label for="{{ form.ENRDATE.id_for_label }}">
 {% trans "Enrollment Date (YYYY-MM-DD)" %}
</label>
 <div class="input-group">
 <div >
 <span ></span>
 </div>
 {{ form.ENRDATE }}
 </div>
 {% if form.ENRDATE.errors %}
 <small class="text-danger">{{ form.ENRDATE.errors.0 }}</small>
 {% endif %}
 </div>

 {# 2. Recruitment Department #}
 <div class="numbered-item" data-number="2">
 <label for="{{ form.RECRUITDEPT.id_for_label }}">
 {% trans "Recruitment Department" %}
</label>
 <div class="input-group">
 <div >
 <span ></span>
 </div>
 {{ form.RECRUITDEPT }}
 </div>
 </div>

 {# 3. Date of Birth #}
 <div class="numbered-item" data-number="3">
 <label>{% trans "Date of Birth" %}</label>
 <div class="row">
 <div class="col-md-2">
 <label class="text-muted small">{% trans "Day" %}</label>
 {{ form.DAYOFBIRTH }}
 </div>
 <div class="col-md-2">
 <label class="text-muted small">{% trans "Month" %}</label>
 {{ form.MONTHOFBIRTH }}
 </div>
 <div class="col-md-2">
 <label class="text-muted small">{% trans "Year" %}</label>
 {{ form.YEAROFBIRTH }}
 </div>
 <div class="col-md-3">
 <label class="text-muted small">{% trans "Age if DOB unknown" %}</label>
 {{ form.AGEIFDOBUNKNOWN }}
 </div>
 <div class="col-md-3">
 <label class="text-muted small">{% trans "Calculated Age" %}</label>
 <div id="calculated-age" class="form-control bg-light">

 <span class="ml-2">--</span>
 </div>
 </div>
 </div>
 </div>

 {# 4. Sex #}
 <div class="numbered-item" data-number="4">
 <label for="{{ form.SEX.id_for_label }}">{% trans "Sex" %}</label>
 {{ form.SEX }}
 </div>

 {# 5. Ethnicity #}
 <div class="numbered-item" data-number="5">
 <label for="{{ form.ETHNICITY.id_for_label }}">{% trans "Ethnicity" %}</label>
 <div class="input-group">
 <div >
 <span ></span>
 </div>
 {{ form.ETHNICITY }}
 </div>
 </div>

 {# 6. Occupation #}
 <div class="numbered-item" data-number="6">
 <label for="{{ form.OCCUPATION.id_for_label }}">{% trans "Occupation" %}</label>
 <div class="input-group">
 <div >
 <span ></span>
 </div>
 {{ form.OCCUPATION }}
 </div>
 </div>

 <div class="numbered-item" data-number="7">
 <label for="{{ personal_form.MEDRECORDID.id_for_label }}">
 {% trans "Medical Record Number" %}
</label>
 <div class="input-group">
 {{ personal_form.MEDRECORDID }}
 </div>
 {% if personal_form.MEDRECORDID.errors %}
 <small class="text-danger">

 {{ personal_form.MEDRECORDID.errors.0 }}
 </small>
 {% endif %}
 <small class="form-text text-muted">

 {% trans "Enter patient's hospital medical record identification number" %}
 </small>
 </div>

 {# ========== HOSPITAL TRANSFER ========== #}
 <div class="form-section-header">
 {% trans "Hospital Transfer" %}
 </div>

 {# 7. Transferred from Other Hospital #}
 <div class="numbered-item" data-number="8">
 <label>{% trans "Transferred from other hospital?" %}</label>
 <div class="mt-2">
 {{ form.FROMOTHERHOSPITAL }}
 </div>

 {# Conditional Section: Hospital Transfer Details #}
 <div id="hospital-transfer-details"
 class="conditional-section {% if form.FROMOTHERHOSPITAL.value %}show{% endif %}">
 <h6 class="text-primary mb-3">
 {% trans "Transfer Details" %}
 </h6>

 <div class="row">
 {# 7a. Prior Hospital Admission Date #}
 <div class="col-md-6">
 <div class="form-group">
 <label for="{{ form.PRIORHOSPIADMISDATE.id_for_label }}">
 {% trans "7a. Prior Hospital Admission Date (YYYY-MM-DD)" %}
</label>
 <div class="input-group">
 <div >
 <span ></span>
 </div>
 {{ form.PRIORHOSPIADMISDATE }}
 </div>
 {% if form.PRIORHOSPIADMISDATE.errors %}
 <small class="text-danger">{{ form.PRIORHOSPIADMISDATE.errors.0 }}</small>
 {% endif %}
 </div>
 </div>
 <div class="col-md-6">
 <div class="form-group">
 <label for="{{ form.HEALFACILITYNAME.id_for_label }}">
 {% trans "7b. Healthcare Facility Name" %}
</label>
 <div class="input-group">
 <div >
 <span ></span>
 </div>
 {{ form.HEALFACILITYNAME }}
 </div>
 </div>
 </div>
 </div>

 <div class="form-group">
 <label for="{{ form.REASONFORADM.id_for_label }}">
 {% trans "7c. Reason for Admission at Prior Hospital" %}
</label>
 {{ form.REASONFORADM }}
 </div>
 </div>
 </div>

 {# ========== EPIDEMIOLOGY ========== #}
 <div class="form-section-header">
 {% trans "Epidemiology" %}
 </div>

 {# 8. Address Information #}
 <div class="numbered-item" data-number="9">
 <label>{% trans "Current Residence Address" %}</label>

 {# Address System Information Box #}

 {# Primary Address Selection #}
 <div class="mb-4">

 <div class="row">
 <div class="col-md-12">
 <div class="address-selection-group">
 <div class="address-option">
 <input type="radio"
 name="PRIMARY_ADDRESS"
 value="new"
 id="id_PRIMARY_ADDRESS_new"
 {% if personal_form.PRIMARY_ADDRESS.value == 'new' or not personal_form.PRIMARY_ADDRESS.value %}checked{% endif %}
 class="address-system-radio">
 <label for="id_PRIMARY_ADDRESS_new" class="address-option-label">
 <div class="address-option-header">

 <strong>Địa chỉ mới</strong>
 <span class="badge badge-success ml-2"></span>
 </div>
</label>
 </div>

 <div class="address-option">
 <input type="radio"
 name="PRIMARY_ADDRESS"
 value="old"
 id="id_PRIMARY_ADDRESS_old"
 {% if personal_form.PRIMARY_ADDRESS.value == 'old' %}checked{% endif %}
 class="address-system-radio">
 <label for="id_PRIMARY_ADDRESS_old" class="address-option-label">
 <div class="address-option-header">

 <strong>Địa chỉ cũ</strong>
 <span class="badge badge-secondary ml-2"></span>
 </div>
</label>
 </div>

 <div class="address-option">
 <input type="radio"
 name="PRIMARY_ADDRESS"
 value="both"
 id="id_PRIMARY_ADDRESS_both"
 {% if personal_form.PRIMARY_ADDRESS.value == 'both' %}checked{% endif %}
 class="address-system-radio">
 <label for="id_PRIMARY_ADDRESS_both" class="address-option-label">
 <div class="address-option-header">

 <strong>Cả hai địa chỉ</strong>
 <span class="badge badge-primary ml-2"></span>
 </div>
</label>
 </div>
 </div>
 </div>
 </div>
 </div>

 {# NEW ADDRESS FIELDS #}
 <div id="new-address-fields" class="address-fields-container" style="display: none;">
 <div class="address-subsection">
 <div class="address-subsection-header">

 <strong>Địa chỉ theo Đơn vị Hành chính mới</strong>
 <span class="badge badge-success ml-2"></span>
 </div>

 <div class="row mt-3">
 <div class="col-md-3">
 <div class="form-group">
 <label class="text-muted small">
 Đường/Số nhà
</label>
 <div class="input-group">
 <div >
</span>
 </div>
 {{ personal_form.STREET_NEW }}
 </div>
 {% if personal_form.STREET_NEW.errors %}
 <small class="text-danger">{{ personal_form.STREET_NEW.errors.0 }}</small>
 {% endif %}
 </div>
 </div>

 <div class="col-md-3">
 <div class="form-group">
 <label class="text-muted small">
 Phường/Xã
</label>
 <div class="input-group">
 <div >
</span>
 </div>
 {{ personal_form.WARD_NEW }}
 </div>
 {% if personal_form.WARD_NEW.errors %}
 <small class="text-danger">{{ personal_form.WARD_NEW.errors.0 }}</small>
 {% endif %}
 </div>
 </div>

 <div class="col-md-3">
 <div class="form-group">
 <label class="text-muted small">
 Tỉnh/Thành phố
</label>
 <div class="input-group">
 <div >
</span>
 </div>
 {{ personal_form.CITY_NEW }}
 </div>
 {% if personal_form.CITY_NEW.errors %}
 <small class="text-danger">{{ personal_form.CITY_NEW.errors.0 }}</small>
 {% endif %}
 </div>
 </div>
 </div>
 </div>
 </div>

 {# OLD ADDRESS FIELDS - SMART ADDRESS SYSTEM #}
 <div id="old-address-fields" class="address-fields-container" style="display: none;">
 <div class="address-subsection">
 <div class="address-subsection-header">

 <strong>Địa chỉ theo đơn vị hành chính cũ (HCM)</strong>
 <span class="badge badge-secondary ml-2">Smart Selection</span>
 </div>

 {# Smart Address Selection #}
 <div class="row mt-3">
 <div class="col-md-4">
 <div class="form-group">
 <label class="font-weight-bold">
 Quận/Huyện <span class="text-danger">*</span>
</label>
 <select id="district-select"
 class="form-control"
 {% if is_readonly %}disabled{% endif %}>
 <option value="">-- Đang tải... --</option>
 </select>
 <small class="text-muted">Chọn quận/huyện trước</small>
 </div>
 </div>

 <div class="col-md-4">
 <div class="form-group">
 <label class="font-weight-bold">
 Phường/Xã <span class="text-danger">*</span>
</label>
 <select id="ward-select"
 class="form-control"
 disabled
 {% if is_readonly %}disabled{% endif %}>
 <option value="">-- Chọn quận/huyện trước --</option>
 </select>
 {# Hidden input để lưu ward name #}
 <input type="hidden"
 id="ward-hidden-input"
 name="WARD"
 value="{{ personal_form.WARD.value|default:'' }}">
 </div>
 </div>

 <div class="col-md-4">
 <div class="form-group">
 <label class="font-weight-bold">
 Tên đường
</label>
 <div class="position-relative">
 <input type="text"
 id="street-autocomplete"
 name="STREET"
 class="form-control"
 value="{{ personal_form.STREET.value|default:'' }}"
 placeholder="Gõ để tìm kiếm..."
 autocomplete="off"
 {% if is_readonly %}disabled{% endif %}>
 <div id="street-suggestions"
 class="list-group position-absolute w-100"
 style="z-index: 1000; max-height: 300px; overflow-y: auto; display: none;"></div>
 </div>
 <small class="text-muted">Chọn quận trước để tìm đường</small>
 </div>
 </div>
 </div>

 {# Tỉnh/Thành phố - Fixed field #}
 <div class="row">
 <div class="col-md-6">
 <div class="form-group">
 <label class="font-weight-bold">
 Tỉnh/Thành phố <span class="text-danger">*</span>
</label>
 <input type="text"
 id="city-input"
 name="PROVINCECITY"
 class="form-control"
 value="{{ personal_form.PROVINCECITY.value|default:'' }}"
 placeholder="Ví dụ: TP. Hồ Chí Minh"
 {% if is_readonly %}disabled{% endif %}>
 <small class="text-muted">Nhập tỉnh/thành phố</small>
 </div>
 </div>

 <div class="col-md-6">
 <div class="form-group">
 <label class="font-weight-bold">
 Số nhà / Tên tòa nhà
</label>
 <input type="text"
 id="full-address-input"
 class="form-control"
 placeholder="Ví dụ: 123/45, Tòa A, Căn hộ 6B"
 {% if is_readonly %}disabled{% endif %}>
 <small class="text-muted">Chi tiết địa chỉ (tùy chọn)</small>
 </div>
 </div>
 </div>

 {# District hidden input for backend #}
 <input type="hidden" id="district-hidden-input" name="DISTRICT" value="{{ personal_form.DISTRICT.value|default:'' }}">
 </div>
 </div>

 {# Address Preview #}
 <div class="mt-3">
 <div class="alert alert-light border" style="background-color: #f8f9fa;">
 <div class="row align-items-center">
 <div class="col-md-2">
 <strong>Xem trước:</strong>
 </div>
 <div class="col-md-10">
 <div id="address-preview" class="address-preview-content">
 <span class="text-muted font-italic">Địa chỉ sẽ hiển thị tại đây khi bạn nhập...</span>
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>

 {# 9. Toilet Information #}
 <div class="row">
 <div class="col-md-6">
 <div class="numbered-item" data-number="10">
 <label for="{{ form.TOILETNUM.id_for_label }}">
 {% trans "Number of Toilets" %}
</label>
 {{ form.TOILETNUM }}
 </div>
 </div>
 <div class="col-md-6">
 <div class="numbered-item" data-number="11">
 <label for="{{ form.SHAREDTOILET.id_for_label }}">
 {% trans "Shared Toilet?" %}
</label>
 {{ form.SHAREDTOILET }}
 </div>
 </div>
 </div>

 {# 11-12. Residence and Workplace Type #}
 <div class="row">
 <div class="col-md-6">
 <div class="numbered-item" data-number="12">
 <label for="{{ form.RESIDENCETYPE.id_for_label }}">
 {% trans "Residence Type" %}
</label>
 {{ form.RESIDENCETYPE }}
 </div>
 </div>
 <div class="col-md-6">
 <div class="numbered-item" data-number="13">
 <label for="{{ form.WORKPLACETYPE.id_for_label }}">
 {% trans "Workplace Type" %}
</label>
 {{ form.WORKPLACETYPE }}
 </div>
 </div>
 </div>

 {# ========== RISK FACTORS ========== #}
 <div class="form-section-header">
 {% trans "Risk Factors & Medical History" %}
 </div>

 {# 13. Healthcare Contact Risk Factors #}
 <div class="numbered-item" data-number="14">
 <label class="mb-3">{% trans "Healthcare Contact Before Admission?" %}</label>

 {# a. Hospital admission ≥2 days in last 6 months #}
 <div class="risk-factor-item">
 <div class="row align-items-center">
 <div class="col-md-7">
 <span class="risk-factor-label">
 a. {{ form.HOSP2D6M.label }}
</span>
 </div>
 <div class="col-md-5">
 <div class="risk-factor-options">
 <div class="form-check form-check-inline">
 <input type="radio"
 name="HOSP2D6M"
 value="yes"
 id="id_HOSP2D6M_yes"
 {% if form.HOSP2D6M.value == 'yes' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_HOSP2D6M_yes">
 {% trans "Yes" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="HOSP2D6M"
 value="no"
 id="id_HOSP2D6M_no"
 {% if form.HOSP2D6M.value == 'no' or not form.HOSP2D6M.value %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_HOSP2D6M_no">
 {% trans "No" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="HOSP2D6M"
 value="unknown"
 id="id_HOSP2D6M_unknown"
 {% if form.HOSP2D6M.value == 'unknown' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_HOSP2D6M_unknown">
 {% trans "Unknown" %}
</label>
 </div>
 </div>
 </div>
 </div>
 </div>

 {# b. Dialysis in last 3 months #}
 <div class="risk-factor-item">
 <div class="row align-items-center">
 <div class="col-md-7">
 <span class="risk-factor-label">
 b. {{ form.DIAL3M.label }}
</span>
 </div>
 <div class="col-md-5">
 <div class="risk-factor-options">
 <div class="form-check form-check-inline">
 <input type="radio"
 name="DIAL3M"
 value="yes"
 id="id_DIAL3M_yes"
 {% if form.DIAL3M.value == 'yes' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_DIAL3M_yes">
 {% trans "Yes" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="DIAL3M"
 value="no"
 id="id_DIAL3M_no"
 {% if form.DIAL3M.value == 'no' or not form.DIAL3M.value %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_DIAL3M_no">
 {% trans "No" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="DIAL3M"
 value="unknown"
 id="id_DIAL3M_unknown"
 {% if form.DIAL3M.value == 'unknown' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_DIAL3M_unknown">
 {% trans "Unknown" %}
</label>
 </div>
 </div>
 </div>
 </div>
 </div>

 {# c. Catheter in last 3 months #}
 <div class="risk-factor-item">
 <div class="row align-items-center">
 <div class="col-md-7">
 <span class="risk-factor-label">
 c. {{ form.CATHETER3M.label }}
</span>
 </div>
 <div class="col-md-5">
 <div class="risk-factor-options">
 <div class="form-check form-check-inline">
 <input type="radio"
 name="CATHETER3M"
 value="yes"
 id="id_CATHETER3M_yes"
 {% if form.CATHETER3M.value == 'yes' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_CATHETER3M_yes">
 {% trans "Yes" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="CATHETER3M"
 value="no"
 id="id_CATHETER3M_no"
 {% if form.CATHETER3M.value == 'no' or not form.CATHETER3M.value %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_CATHETER3M_no">
 {% trans "No" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="CATHETER3M"
 value="unknown"
 id="id_CATHETER3M_unknown"
 {% if form.CATHETER3M.value == 'unknown' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_CATHETER3M_unknown">
 {% trans "Unknown" %}
</label>
 </div>
 </div>
 </div>
 </div>
 </div>

 {# d. Urinary catheter in last 3 months #}
 <div class="risk-factor-item">
 <div class="row align-items-center">
 <div class="col-md-7">
 <span class="risk-factor-label">
 d. {{ form.SONDE3M.label }}
</span>
 </div>
 <div class="col-md-5">
 <div class="risk-factor-options">
 <div class="form-check form-check-inline">
 <input type="radio"
 name="SONDE3M"
 value="yes"
 id="id_SONDE3M_yes"
 {% if form.SONDE3M.value == 'yes' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_SONDE3M_yes">
 {% trans "Yes" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="SONDE3M"
 value="no"
 id="id_SONDE3M_no"
 {% if form.SONDE3M.value == 'no' or not form.SONDE3M.value %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_SONDE3M_no">
 {% trans "No" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="SONDE3M"
 value="unknown"
 id="id_SONDE3M_unknown"
 {% if form.SONDE3M.value == 'unknown' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_SONDE3M_unknown">
 {% trans "Unknown" %}
</label>
 </div>
 </div>
 </div>
 </div>
 </div>

 {# e. Home wound care #}
 <div class="risk-factor-item">
 <div class="row align-items-center">
 <div class="col-md-7">
 <span class="risk-factor-label">
 e. {{ form.HOME_WOUND_CARE.label }}
</span>
 </div>
 <div class="col-md-5">
 <div class="risk-factor-options">
 <div class="form-check form-check-inline">
 <input type="radio"
 name="HOME_WOUND_CARE"
 value="yes"
 id="id_HOME_WOUND_CARE_yes"
 {% if form.HOME_WOUND_CARE.value == 'yes' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_HOME_WOUND_CARE_yes">
 {% trans "Yes" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="HOME_WOUND_CARE"
 value="no"
 id="id_HOME_WOUND_CARE_no"
 {% if form.HOME_WOUND_CARE.value == 'no' or not form.HOME_WOUND_CARE.value %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_HOME_WOUND_CARE_no">
 {% trans "No" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="HOME_WOUND_CARE"
 value="unknown"
 id="id_HOME_WOUND_CARE_unknown"
 {% if form.HOME_WOUND_CARE.value == 'unknown' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_HOME_WOUND_CARE_unknown">
 {% trans "Unknown" %}
</label>
 </div>
 </div>
 </div>
 </div>
 </div>

 {# f. Long-term care facility #}
 <div class="risk-factor-item">
 <div class="row align-items-center">
 <div class="col-md-7">
 <span class="risk-factor-label">
 f. {{ form.LONG_TERM_CARE.label }}
</span>
 </div>
 <div class="col-md-5">
 <div class="risk-factor-options">
 <div class="form-check form-check-inline">
 <input type="radio"
 name="LONG_TERM_CARE"
 value="yes"
 id="id_LONG_TERM_CARE_yes"
 {% if form.LONG_TERM_CARE.value == 'yes' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_LONG_TERM_CARE_yes">
 {% trans "Yes" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="LONG_TERM_CARE"
 value="no"
 id="id_LONG_TERM_CARE_no"
 {% if form.LONG_TERM_CARE.value == 'no' or not form.LONG_TERM_CARE.value %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_LONG_TERM_CARE_no">
 {% trans "No" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="LONG_TERM_CARE"
 value="unknown"
 id="id_LONG_TERM_CARE_unknown"
 {% if form.LONG_TERM_CARE.value == 'unknown' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_LONG_TERM_CARE_unknown">
 {% trans "Unknown" %}
</label>
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>

 {# 14. Corticoid/PPI Use #}
 <div class="numbered-item" data-number="15">
 <label>{% trans "Medication History (Corticoid, PPI, etc.)" %}</label>

 <div class="risk-factor-item">
 <div class="row align-items-center">
 <div class="col-md-7">
 <span class="risk-factor-label">
 {% trans "Using Corticoid or PPI?" %}
</span>
 </div>
 <div class="col-md-5">
 <div class="risk-factor-options">
 <div class="form-check form-check-inline">
 <input type="radio"
 name="CORTICOIDPPI"
 value="yes"
 id="id_CORTICOIDPPI_yes"
 {% if form.CORTICOIDPPI.value == 'yes' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_CORTICOIDPPI_yes">
 {% trans "Yes" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="CORTICOIDPPI"
 value="no"
 id="id_CORTICOIDPPI_no"
 {% if form.CORTICOIDPPI.value == 'no' or not form.CORTICOIDPPI.value %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_CORTICOIDPPI_no">
 {% trans "No" %}
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="CORTICOIDPPI"
 value="unknown"
 id="id_CORTICOIDPPI_unknown"
 {% if form.CORTICOIDPPI.value == 'unknown' %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_CORTICOIDPPI_unknown">
 {% trans "Unknown" %}
</label>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- CRITICAL: Management form MUST be outside conditional -->
 {% if not is_readonly %}
 <div style="display:none;" id="medication-management-forms">
 {{ medhisdrug_formset.management_form }}
 </div>
 {% endif %}

 {# Conditional Section: Medication History Table #}
 <div id="medication-history-section"
 class="conditional-section {% if form.CORTICOIDPPI.value == 'yes' %}show{% endif %}">
 <h6 class="text-primary mb-3">
 {% trans "Medication History Details" %}
 </h6>

 <div class="table-responsive medication-table">
 <table class="table table-bordered table-sm mb-0">
 <thead>
 <tr>
 <th width="5%">#</th>
 <th width="30%">{% trans "Drug Name" %}</th>
 <th width="20%">{% trans "Dosage" %}</th>
 <th width="20%">{% trans "Duration" %}</th>
 <th width="25%">{% trans "Reason" %}</th>
 </tr>
 </thead>
 <tbody id="medication-formset-body">
 {% for med_form in medhisdrug_formset %}
 <tr class="formset-row">
 {{ med_form.id }}
 <td>{{ med_form.SEQUENCE }}</td>
 <td>{{ med_form.DRUGNAME }}</td>
 <td>{{ med_form.DOSAGE }}</td>
 <td>{{ med_form.USAGETIME }}</td>
 <td>{{ med_form.USAGEREASON }}</td>
 </tr>
 {% endfor %}
 </tbody>
 </table>
 </div>

 {% if not is_readonly %}
 <div class="mt-3">
 <button type="button"
 id="add-medication-btn"
 class="btn btn-success btn-sm">
 <i class="fas fa-plus mr-1"></i>{% trans "Add Medication" %}
 </button>
 </div>
 {% endif %}
 </div>
 </div>

 {# ========== UNDERLYING CONDITIONS ========== #}
 <div class="form-section-header">
 <i class="fas fa-heartbeat mr-2"></i>{% trans "Underlying Conditions" %}
 </div>

 <div class="numbered-item" data-number="16">
 <label>{% trans "Does the patient have any underlying conditions?" %}</label>

 {# Main question: Has underlying conditions? #}
 <div class="risk-factor-item mb-4">
 <div class="row align-items-center">
 <div class="col-md-7">
 <span class="risk-factor-label">
 <strong>{% trans "Có bệnh nền không?" %}</strong>
</span>
 </div>
 <div class="col-md-5">
 <div class="risk-factor-options">
 <div class="form-check form-check-inline">
 <input type="radio"
 name="UNDERLYINGCONDS"
 value="True"
 id="id_UNDERLYINGCONDS_yes"
 {% if form.UNDERLYINGCONDS.value %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_UNDERLYINGCONDS_yes">
 <strong>{% trans "Có" %}</strong>
</label>
 </div>
 <div class="form-check form-check-inline">
 <input type="radio"
 name="UNDERLYINGCONDS"
 value="False"
 id="id_UNDERLYINGCONDS_no"
 {% if form.UNDERLYINGCONDS.value == False and form.UNDERLYINGCONDS.value != None %}checked{% endif %}
 class="form-check-input">
 <label class="form-check-label" for="id_UNDERLYINGCONDS_no">
 <strong>{% trans "Không" %}</strong>
</label>
 </div>
 </div>
 </div>
 </div>
 </div>

 {# Conditional Section: Show only if has underlying conditions #}
 <div id="underlying-conditions-section"
 class="conditional-section {% if form.UNDERLYINGCONDS.value %}show{% endif %}">
 <h6 class="text-primary mb-3">
 <i class="fas fa-list mr-2"></i>{% trans "Select all that apply" %}
 </h6>

 <div class="underlying-conditions-grid">
 {% for field in underlying_form %}
 {% if field.name != 'OTHERDISEASESPECIFY' %}
 <div class="underlying-condition-item">
 <div class="form-check">
 {{ field }}
 <label class="form-check-label" for="{{ field.id_for_label }}">
 {{ field.label }}
</label>
 </div>
 </div>
 {% endif %}
 {% endfor %}
 </div>

 {# Other Disease Specification #}
 <div id="other-disease-detail"
 class="conditional-section mt-3 {% if underlying_form.OTHERDISEASE.value %}show{% endif %}">
 <label for="{{ underlying_form.OTHERDISEASESPECIFY.id_for_label }}">
 <i class="fas fa-edit mr-2"></i>{{ underlying_form.OTHERDISEASESPECIFY.label }}
</label>
 {{ underlying_form.OTHERDISEASESPECIFY }}
 </div>
 </div>{# End of underlying-conditions-section #}
 </div>{# End of numbered-item 15 #}

 {# ========== AUDIT TRAIL ========== #}
 {% if enrollment_case %}
 <div class="form-section-header">
 <i class="fas fa-history mr-2"></i>{% trans "Audit Information" %}
 </div>

 <div class="row">
 <div class="col-md-4">
 <div class="form-group">
 <label>{% trans "Last Modified By" %}</label>
 <input type="text"
 class="form-control"
 value="{{ enrollment_case.last_modified_by_username|default:'N/A' }}"
 readonly>
 </div>
 </div>
 <div class="col-md-4">
 <div class="form-group">
 <label>{% trans "Last Modified At" %}</label>
 <input type="text"
 class="form-control datepicker"
 value="{{ enrollment_case.last_modified_at|date:'d/m/Y H:i'|default:'N/A' }}"
 readonly>
 </div>
 </div>
 <div class="col-md-4">
 <div class="form-group">
 <label>{% trans "Version" %}</label>
 <input type="text"
 class="form-control"
 value="{{ enrollment_case.version|default:'0' }}"
 readonly>
 </div>
 </div>
 </div>
 {% endif %}
 </div>
 </div>

 {# ========== FORM ACTIONS ========== #}
 <div class="d-flex justify-content-between mt-4">
 <div>
 <a href="{% url 'study_43en:screening_case_list' %}"
 class="btn btn-secondary">
 <i class="fas fa-arrow-left mr-1"></i>{% trans "Back" %}
 </a>

 {% if not is_readonly %}
 <button type="reset" class="btn btn-warning ml-2">
 <i class="fas fa-undo mr-1"></i>{% trans "Reset" %}
 </button>
 {% endif %}
 </div>

 <div>
 {% if is_readonly and enrollment_case %}
 <a href="{% url 'study_43en:enrollment_case_update' usubjid=screening_case.USUBJID %}"
 class="btn btn-primary">
 <i class="fas fa-edit mr-1"></i>{% trans "Edit" %}
 </a>
 {% elif not is_readonly %}
 <button type="submit" class="btn btn-primary btn-lg">
 <i class="fas fa-save mr-1"></i>{% trans "Save Information" %}
 </button>
 {% endif %}
 </div>
 </div>
 </form>
 </div>
 </div>
 </div>
</div>

{# ========== CHANGE REASON MODAL ========== #}
{% if show_reason_form and detected_changes %}
 {% include 'default/change_reason_modal.html' %}
{% endif %}

{% endblock %}


{% include 'studies/study_43en/includes/datepicker_scripts.html' %}

{% block dashboard_js %}
{% include 'studies/study_43en/includes/datepicker_scripts.html' %}

<script>
window.enrollmentFormState = {
 isReadonly: {% if is_readonly %}true{% else %}false{% endif %},
 isCreate: {% if is_create %}true{% else %}false{% endif %},
 selectedSiteId: "{{ selected_site_id|default:'all' }}"
};
</script>


{# Custom Scripts #}
<script nonce="{{ request.csp_nonce }}" src="{% static 'studies/study_43en/js/enrollment-form.js' %}"></script>
<script nonce="{{ request.csp_nonce }}" src="{% static 'studies/study_43en/js/change-reason-handler.js' %}"></script>
{# Smart Address System - Load directly from study_44en (v3.4 district-level) #}
<script nonce="{{ request.csp_nonce }}" src="{% static 'studies/study_44en/js/smart_address_hcmc.js' %}"></script>

{# Scripts Loaded Check #}
<script>
console.log('=== ENROLLMENT FORM SCRIPTS DEBUG ===');
console.log('jQuery loaded:', typeof jQuery !== 'undefined');
console.log('Moment loaded:', typeof moment !== 'undefined');
console.log('Awesomplete loaded:', typeof Awesomplete !== 'undefined');
console.log('enrollmentFormState:', window.enrollmentFormState);
console.log('=====================================');
</script>

{# Formset Debug #}
{% if not is_readonly %}
<script>
$(document).ready(function() {
 console.log('=== FORMSET DEBUG ===');
 console.log('Prefix:', '{{ medhisdrug_formset.prefix }}');

 const totalFormsName = '{{ medhisdrug_formset.management_form.TOTAL_FORMS.html_name }}';
 const initialFormsName = '{{ medhisdrug_formset.management_form.INITIAL_FORMS.html_name }}';

 console.log('Expected field names:');
 console.log(' TOTAL_FORMS:', totalFormsName);
 console.log(' INITIAL_FORMS:', initialFormsName);

 const $totalForms = $('[name="' + totalFormsName + '"]');
 const $initialForms = $('[name="' + initialFormsName + '"]');

 console.log('Found in DOM:');
 console.log(' TOTAL_FORMS:', $totalForms.length > 0 ? 'YES (value: ' + $totalForms.val() + ')' : 'NO');
 console.log(' INITIAL_FORMS:', $initialForms.length > 0 ? 'YES (value: ' + $initialForms.val() + ')' : 'NO');

 if ($totalForms.length === 0) {
 console.error(' TOTAL_FORMS NOT FOUND! This will cause validation error.');
 }
 if ($initialForms.length === 0) {
 console.error(' INITIAL_FORMS NOT FOUND! This will cause validation error.');
 }

 console.log('=====================');
});
</script>
{% endif %}

{% endblock %}