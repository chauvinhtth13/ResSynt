{% extends 'studies\study_43en\home_dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Antibiotic Resistance Statistics" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:patient_list' %}">{% trans "Patients" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:patient_detail' usubjid=usubjid %}">{{ usubjid }}</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:microbiology_list' usubjid=usubjid %}">{% trans "Cultures" %}</a></li>
<li class="breadcrumb-item active">{% trans "Resistance Statistics" %}</li>
{% endblock %}



{% block dashboard_content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
              <i class="fas fa-chart-bar mr-2"></i>
              {% trans "Antibiotic Resistance Statistics" %}
            </h3>
            <div>
              <a href="{% url 'study_43en:microbiology_list' usubjid=usubjid %}" 
                 class="btn btn-light btn-sm">
                <i class="fas fa-arrow-left"></i> {% trans "Back to Cultures" %}
              </a>
            </div>
          </div>
        </div>
        <div class="card-body bg-light">
          <div class="row">
            <div class="col-md-3">
              <strong><i ></i>{% trans "Patient" %}:</strong> {{ usubjid }}
            </div>
            <div class="col-md-3">
              <strong><i ></i>{% trans "Site" %}:</strong> {{ screening_case.SITEID }}
            </div>
            <div class="col-md-3">
              <strong><i class="fas fa-calendar mr-2"></i>{% trans "Date" %}:</strong> {{ today|date:"d/m/Y" }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Overview Statistics -->
  <div class="row">
    <!-- Total Tests -->
    <div class="col-md-3">
      <div class="stat-card text-center">
        <div class="stat-big-number text-primary">
          {{ stats.total_tests }}
        </div>
        <div class="stat-label">
          {% trans "Total Tests" %}
        </div>
      </div>
    </div>
    
    <!-- Resistant Tests -->
    <div class="col-md-3">
      <div class="stat-card text-center">
        <div class="stat-big-number text-danger">
          {{ stats.by_sensitivity.R.count|default:0 }}
        </div>
        <div class="stat-label">
          {% trans "Resistant Tests" %}
        </div>
        {% if stats.total_tests > 0 %}
        <small class="text-muted">
          ({{ stats.by_sensitivity.R.percentage|default:0 }}%)
        </small>
        {% endif %}
      </div>
    </div>
    
    <!-- Sensitive Tests -->
    <div class="col-md-3">
      <div class="stat-card text-center">
        <div class="stat-big-number text-success">
          {{ stats.by_sensitivity.S.count|default:0 }}
        </div>
        <div class="stat-label">
          {% trans "Sensitive Tests" %}
        </div>
        {% if stats.total_tests > 0 %}
        <small class="text-muted">
          ({{ stats.by_sensitivity.S.percentage|default:0 }}%)
        </small>
        {% endif %}
      </div>
    </div>
    
    <!-- Intermediate Tests -->
    <div class="col-md-3">
      <div class="stat-card text-center">
        <div class="stat-big-number text-warning">
          {{ stats.by_sensitivity.I.count|default:0 }}
        </div>
        <div class="stat-label">
          {% trans "Intermediate Tests" %}
        </div>
        {% if stats.total_tests > 0 %}
        <small class="text-muted">
          ({{ stats.by_sensitivity.I.percentage|default:0 }}%)
        </small>
        {% endif %}
      </div>
    </div>
  </div>
  
  {% if stats.total_tests > 0 %}
  
  <!-- Carbapenem Resistance Alert -->
  {% if stats.carbapenem_resistance %}
  <div class="row">
    <div class="col-12">
      <div class="alert alert-carbapenem">
        <h5 class="alert-heading">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          {% trans "Carbapenem Resistance Detected" %}
        </h5>
        <p class="mb-0">
          {% trans "This patient has resistance to carbapenem antibiotics (Imipenem, Meropenem, or Ertapenem). Consider using reserve antibiotics and consult infectious disease specialist." %}
        </p>
      </div>
    </div>
  </div>
  {% endif %}
  
  <!-- Resistance by Tier -->
  <div class="row">
    <div class="col-md-6">
      <div class="stat-card">
        <div class="stat-card-header">
          <i class="fas fa-layer-group mr-2"></i>
          {% trans "Resistance by WHO AWaRe Tier" %}
        </div>
        
        {% for tier_code, tier_data in stats.by_tier.items %}
        <div class="tier-stat-row">
          <div>
            <span class="tier-badge {{ tier_code|lower }}">
              {{ tier_data.label }}
            </span>
          </div>
          <div class="flex-grow-1 mx-3">
            <div class="progress-resistance">
              <div class="progress-bar-resistance bg-danger" 
                   style="width: {{ tier_data.resistance_rate }}%">
                {% if tier_data.resistance_rate > 15 %}
                  {{ tier_data.resistance_rate }}%
                {% endif %}
              </div>
            </div>
          </div>
          <div class="text-end" style="min-width: 100px;">
            <strong>{{ tier_data.resistant }}</strong> / {{ tier_data.count }}
            {% if tier_data.resistance_rate <= 15 %}
              <small class="text-muted">({{ tier_data.resistance_rate }}%)</small>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    
    <!-- Top Resistant Antibiotics -->
    <div class="col-md-6">
      <div class="stat-card">
        <div class="stat-card-header">
          <i class="fas fa-exclamation-circle mr-2"></i>
          {% trans "Top Resistant Antibiotics" %}
        </div>
        
        {% if stats.top_resistant_antibiotics %}
        <ul class="antibiotic-list">
          {% for item in stats.top_resistant_antibiotics %}
          <li class="antibiotic-list-item">
            <span class="antibiotic-name">
              {{ item.ANTIBIOTIC_NAME }}
            </span>
            <span class="badge bg-danger">
              {{ item.count }} {% trans "resistant test(s)" %}
            </span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted text-center py-3">
          <i class="fas fa-check-circle text-success"></i>
          {% trans "No resistant antibiotics found" %}
        </p>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Charts -->
  <div class="row">
    <!-- Sensitivity Distribution Chart -->
    <div class="col-md-6">
      <div class="stat-card">
        <div class="stat-card-header">
          <i class="fas fa-chart-pie mr-2"></i>
          {% trans "Sensitivity Distribution" %}
        </div>
        <div class="chart-container">
          <canvas id="sensitivityChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Tier Resistance Chart -->
    <div class="col-md-6">
      <div class="stat-card">
        <div class="stat-card-header">
          <i class="fas fa-chart-bar mr-2"></i>
          {% trans "Resistance Rate by Tier" %}
        </div>
        <div class="chart-container">
          <canvas id="tierChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  
  {% else %}
  
  <!-- Empty State -->
  <div class="row">
    <div class="col-12">
      <div class="stat-card text-center py-5">
        <i class="fas fa-chart-bar text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
        <h4 class="mt-3">{% trans "No Test Data Available" %}</h4>
        <p class="text-muted">
          {% trans "This patient has no antibiotic sensitivity test results yet." %}
        </p>
        <a href="{% url 'study_43en:microbiology_list' usubjid=usubjid %}" 
           class="btn btn-primary">
          <i ></i>
          {% trans "View Cultures" %}
        </a>
      </div>
    </div>
  </div>
  
  {% endif %}
</div>
{% endblock %}

{% block dashboard_js %}
<script nonce="{{ request.csp_nonce }}">
$(document).ready(function() {
  console.log(' Antibiotic Statistics Page Loaded');
  
  {% if stats.total_tests > 0 %}
  
  // ============================================
  // SENSITIVITY DISTRIBUTION PIE CHART
  // ============================================
  const sensCtx = document.getElementById('sensitivityChart');
  if (sensCtx) {
    new Chart(sensCtx, {
      type: 'pie',
      data: {
        labels: [
          '{% trans "Sensitive" %}',
          '{% trans "Intermediate" %}',
          '{% trans "Resistant" %}',
          '{% trans "Unknown" %}',
          '{% trans "Not Determined" %}'
        ],
        datasets: [{
          data: [
            {{ stats.by_sensitivity.S.count|default:0 }},
            {{ stats.by_sensitivity.I.count|default:0 }},
            {{ stats.by_sensitivity.R.count|default:0 }},
            {{ stats.by_sensitivity.U.count|default:0 }},
            {{ stats.by_sensitivity.ND.count|default:0 }}
          ],
          backgroundColor: [
            '#28a745',  // Green - Sensitive
            '#ffc107',  // Yellow - Intermediate
            '#dc3545',  // Red - Resistant
            '#6c757d',  // Gray - Unknown
            '#e9ecef'   // Light gray - Not Determined
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = {{ stats.total_tests }};
                const percent = ((value / total) * 100).toFixed(1);
                return `${label}: ${value} (${percent}%)`;
              }
            }
          }
        }
      }
    });
  }
  
  // ============================================
  // TIER RESISTANCE BAR CHART
  // ============================================
  const tierCtx = document.getElementById('tierChart');
  if (tierCtx) {
    const tierLabels = [];
    const tierRates = [];
    const tierColors = [];
    
    {% for tier_code, tier_data in stats.by_tier.items %}
    tierLabels.push('{{ tier_data.label }}');
    tierRates.push({{ tier_data.resistance_rate }});
    
    {% if tier_code == 'Tier1' %}
      tierColors.push('#28a745');
    {% elif tier_code == 'Tier2' %}
      tierColors.push('#ffc107');
    {% elif tier_code == 'Tier3' %}
      tierColors.push('#dc3545');
    {% elif tier_code == 'Tier4' %}
      tierColors.push('#6f42c1');
    {% elif tier_code == 'Colistin' %}
      tierColors.push('#b91c1c');
    {% else %}
      tierColors.push('#6c757d');
    {% endif %}
    {% endfor %}
    
    new Chart(tierCtx, {
      type: 'bar',
      data: {
        labels: tierLabels,
        datasets: [{
          label: '{% trans "Resistance Rate" %} (%)',
          data: tierRates,
          backgroundColor: tierColors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return '{% trans "Resistance Rate" %}: ' + context.parsed.y.toFixed(1) + '%';
              }
            }
          }
        }
      }
    });
  }
  
  {% endif %}
  
  console.log(' Charts initialized');
});
</script>
{% endblock %}