{% extends 'studies\study_43en\home_dashboard.html' %}
{% load static %}
{% load i18n %}
{% load study_43en_tags %}

{% block title %}{% trans "Laboratory Test List" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'study_43en:patient_detail' usubjid=usubjid %}">{% trans "Patient" %} {{
    usubjid }}</a></li>
<li class="breadcrumb-item active">{% trans "Laboratory Tests" %}</li>
{% endblock %}


{% block dashboard_content %}
<div class="row">
  <div class="col-md-12">
    <div class="card card-primary">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-flask mr-2"></i>{% trans "Patient Laboratory Test Information" %}
        </h3>
      </div>

      <div class="card-body">
        <!-- Patient Information Box -->
        <div class="patient-info-box">
          <div class="row">
            <div class="col-md-4">
              <div class="info-label">
                <i></i>{% trans "Patient ID" %}
              </div>
              <div class="info-value">{{ usubjid }}</div>
            </div>
            <div class="col-md-4">
              <div class="info-label">
                <i></i>{% trans "Site ID" %}
              </div>
              <div class="info-value">{{ screening_case.SITEID }}</div>
            </div>
            <div class="col-md-4">
              <div class="info-label">
                <i class="fas fa-calendar-check mr-2"></i>{% trans "Registration Date" %}
              </div>
              <div class="info-value">
                {% if enrollment_case.ENRDATE %}
                {{ enrollment_case.ENRDATE|date:"d/m/Y" }}
                {% else %}
                N/A
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- Laboratory Tests Table -->
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead>
              <tr>
                <th class="text-center" width="30%">
                  <i class="fas fa-vials mr-2"></i>{% trans "Test Number" %}
                </th>
                <th class="text-center" width="30%">
                  <i class="fas fa-chart-bar mr-2"></i>{% trans "Number of Tests" %}
                </th>
                <th class="text-center" width="40%">
                  <i class="fas fa-tools mr-2"></i>{% trans "Actions" %}
                </th>
              </tr>
            </thead>
            <tbody>
              {% for lab_type, lab_type_name in lab_types %}
              <tr>
                <td class="text-center">
                  <span class="lab-type-name">{{ lab_type_name }}</span>
                </td>
                <td class="text-center">
                  <div class="test-count">
                    {% with tests=tests_by_lab_type|get_item:lab_type %}
                    {% if tests %}
                    <span class="test-count-number">
                      <span class="test-count-fraction">{{ tests|count_performed }}</span> / {{ tests|length }}
                    </span>
                    {% if tests|count_performed > 0 %}
                    <span >
                      <i class="fas fa-check-circle mr-1"></i>{% trans "Completed" %}
                    </span>
                    {% elif tests|count_performed == 0 and tests|length > 0 %}
                    <span >
                      <i ></i>{% trans "Pending" %}
                    </span>
                    {% endif %}
                    {% else %}
                    <span class="test-count-number">0</span>
                    <span class="badge badge-warning">
                      <i class="fas fa-exclamation-triangle mr-1"></i>{% trans "Not Initialized" %}
                    </span>
                    {% endif %}
                    {% endwith %}
                  </div>
                </td>
                <td class="text-center">
                  {% with tests=tests_by_lab_type|get_item:lab_type %}
                  {% if tests %}
                  {# VIEW button - READ ONLY #}
                  {% if perms.study_43en.view_laboratorytest %}
                  <a href="{% url 'study_43en:laboratory_test_view' usubjid=usubjid lab_type=lab_type %}"
                    class="btn btn-info btn-sm">
                    <i></i> {% trans "View" %}
                  </a>
                  {% endif %}

                  {# EDIT button - CAN MODIFY #}
                  {% if perms.study_43en.change_laboratorytest %}
                  <a href="{% url 'study_43en:laboratory_test_bulk_update' usubjid=usubjid lab_type=lab_type %}"
                    class="btn btn-warning btn-sm">
                    <i></i> {% trans "Edit" %}
                  </a>
                  {% endif %}

                  {# Show message if no permission #}
                  {% if not perms.study_43en.view_laboratorytest and not perms.study_43en.change_laboratorytest %}
                  <span class="no-permission-msg">
                    <i></i>{% trans "No Access Permission" %}
                  </span>
                  {% endif %}
                  {% else %}
                  {# CREATE button #}
                  {% if perms.study_43en.add_laboratorytest %}
                  <a href="{% url 'study_43en:laboratory_test_create' usubjid=usubjid lab_type=lab_type %}"
                    class="btn btn-primary btn-sm">
                    <i class="fas fa-plus"></i> {% trans "Create Test" %}
                  </a>
                  {% else %}
                  <span class="no-permission-msg">
                    <i></i>{% trans "No Create Permission" %}
                  </span>
                  {% endif %}
                  {% endif %}
                  {% endwith %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between mt-4">
          <div>
            <a href="{% url 'study_43en:patient_detail' usubjid=usubjid %}" class="btn btn-secondary">
              <i class="fas fa-arrow-left mr-1"></i>{% trans "Back" %}
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script nonce="{{ request.csp_nonce }}">
  $(document).ready(function () {
    console.log('=== LABORATORY TEST LIST ===');
    console.log('Patient ID:', "{{ usubjid }}");

    // Row hover effect
    $('tbody tr').hover(
      function () {
        $(this).addClass('bg-light');
      },
      function () {
        $(this).removeClass('bg-light');
      }
    );

    console.log('Laboratory test list initialized');
  });
</script>
{% endblock %}