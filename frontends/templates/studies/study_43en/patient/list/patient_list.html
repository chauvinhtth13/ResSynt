{% extends 'studies\study_43en\home_dashboard.html' %}
{% load static i18n %}

{% block title %}{% trans "Patient List - Study 43EN" %}{% endblock %}

{% block dashboard_content %}
<div class="card">
  <div class="card-header bg-enrolled-patient">
    <h3 >
      <i ></i>
      {% trans "Study Patient List" %}
    </h3>
  </div>
  
  <div class="card-body">
    {% if total_patients == 0 %}
      <div class="alert alert-info text-center">
        <h4><i class="bi bi-info-circle"></i> {% trans "No patients yet!" %}</h4>
        <p>{% trans "There are currently no patients who are eligible and consented to participate in the study." %}</p>
        <a href="{% url 'study_43en:screening_case_list' %}" class="btn btn-primary">
          <i class="bi bi-search"></i> {% trans "Go to Screening" %}
        </a>
      </div>
    {% else %}
      <!-- Search -->
      <div class="row mb-3">
        <div class="col-md-6">
          <form method="get" class="d-flex">
            <input type="text" name="q" class="form-control" placeholder="{% trans 'Search USUBJID, INITIAL...' %}" value="{{ query }}">
            <button type="submit" class="btn btn-primary ms-2">
              <i class="bi bi-search"></i> {% trans "Search" %}
            </button>
          </form>
        </div>
        <div class="col-md-6 text-end">
          <span class="badge bg-success">
            {% trans "Total Patients:" %} {{ total_patients }}
          </span>
        </div>
      </div>

      <div class="table-outline-wrapper">
        <div class="table-responsive">
          <table class="table table-bordered table-hover table-enrolled-patient">
            <thead>
                <tr>
                    <th class="text-center">{% trans "Patient ID" %}</th>
                    <th class="text-center">{% trans "Screening ID" %}</th>
                    <th class="text-center">{% trans "Enrollment Date" %}</th>
                    <th class="text-center">{% trans "Study Process" %}</th>
                    <th class="text-center" width="150">{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                  {% for patient in page_obj %}
                  <tr>
                      <td class ="text-center">
                          <strong>{{ patient.USUBJID }}</strong>
                      </td>
                      <td class ="text-center">
                          <span>{{ patient.SCRID }}</span>
                      </td>
                      <td class ="text-center">
                          {{ patient.enrollment_date|date:"d/m/Y"|default:"-" }}
                      </td>
                      <td class ="text-center">
                          {% if patient.process_status == 'completed' %}
                              <span class="badge bg-success">
                                  <i class="bi bi-check-circle-fill"></i> {{ patient.process_label }}
                              </span>
                          {% elif patient.process_status == 'ongoing' %}
                              <span class="badge bg-primary">
                                  <i class="bi bi-arrow-repeat"></i> {{ patient.process_label }}
                              </span>
                          {% else %}
                              <span class="badge bg-secondary">
                                  <i class="bi bi-hourglass-split"></i> {{ patient.process_label }}
                              </span>
                          {% endif %}
                      </td>
                      <td class ="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                              <a href="{% url 'study_43en:patient_detail' patient.USUBJID %}" 
                                class="btn btn-info btn-view-patient"
                                data-usubjid="{{ patient.USUBJID }}"
                                title="{% trans 'View Details' %}">
                                  <i ></i></i> {% trans "View" %}
                              </a>
                          </div>
                      </td>
                  </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
      
      <!-- Pagination -->
      {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if query %}&q={{ query }}{% endif %}">{% trans "First" %}</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}">
                  {% trans "Last" %}
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    {% endif %}
  </div>
</div>
{% endblock %}

{% block dashboard_js %}
{% endblock %}