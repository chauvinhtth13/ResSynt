{% load static %}

<!-- Thêm vào phần head của template -->
<!-- Use jsDelivr (allowed by CSP) instead of cdnjs.cloudflare.com -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker.min.css">

<!-- Thêm vào phần cuối body, trước khi đóng thẻ </body> -->
<!-- Load from jsDelivr (allowed by CSP) -->
<script src="{% static 'base/js/jquery-3.7.1.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>

<script nonce="{{ request.csp_nonce }}">
    $(document).ready(function() {
        // Kiểm tra xem datepicker đã được khởi tạo chưa
        if (typeof jQuery === 'undefined') {
            console.error('jQuery không được tải. Datepicker cần jQuery để hoạt động.');
            return;
        }

        if (typeof $.fn.datepicker === 'undefined') {
            console.error('Bootstrap Datepicker không được tải. Kiểm tra lại thư viện và liên kết!');
            return;
        }

        // reusable initializer so dynamically inserted inputs (modals, ajax) work
        function initDatepicker($el) {
            var $items = $el || $('.datepicker');
            $items.each(function() {
                var $this = $(this);
                if ($this.data('datepicker-initialized')) return;

                $this.datepicker({
                    format: 'dd/mm/yyyy',
                    autoclose: true,
                    todayHighlight: true,
                    clearBtn: true,
                    language: 'vi',
                    defaultViewDate: new Date(),
                    startDate: '-100y',
                    endDate: '+10y',
                    forceParse: false
                });

                // mark as initialized
                $this.data('datepicker-initialized', true);
            });
        }

        // Initialize on DOM ready
        initDatepicker();

        // Initialize when a datepicker input receives focus (useful for dynamically added elements)
        $(document).on('focus', '.datepicker', function() {
            var $this = $(this);
            if (!$this.data('datepicker-initialized')) {
                initDatepicker($this);
                // open widget on focus for better UX
                try { $this.datepicker('show'); } catch (e) { /* ignore */ }
            }
        });

        // Initialize datepickers inside Bootstrap modals when they are shown
        $(document).on('shown.bs.modal', function(e) {
            var $modal = $(e.target);
            initDatepicker($modal.find('.datepicker'));
        });
    });
</script>
