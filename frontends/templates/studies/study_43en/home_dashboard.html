<!-- frontends/templates/studies/study_43en/home_dashboard.html -->
{% extends 'default/dashboard.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Dashboard Overview" %} - {{ request.study_code|upper }}{% endblock %}

{% block extra_head_dashboard %}
<!-- jQuery - PHẢI LOAD TRƯỚC Chart.js -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Chart.js & Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
.stat-card {
    transition: transform 0.2s, box-shadow 0.2s;
}
.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}
.stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin: 0 4px;
    display: inline-block;
}
.chart-container {
    position: relative;
    height: 300px;
}
.table-responsive {
    max-height: 400px;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block dashboard_content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1 fw-bold">{% trans "Dashboard Overview" %}</h2>
        <p class="text-muted mb-0">
            {% trans "Welcome back" %}, {{ user.get_full_name|default:user.username }}
        </p>
    </div>
    <div class="text-end">
        <small class="text-muted">{% trans "Last updated" %}:</small><br>
        <strong>{{ today|date:"d/m/Y" }}</strong>
    </div>
</div>

<!-- Stats Cards Row -->
<div class="row g-4 mb-4">
    <!-- Total Screening Card -->
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100 stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1 text-uppercase small">
                            {% trans "Total Screening" %}
                        </h6>
                        <h3 class="mb-0 fw-bold">{{ screening_patients|default:0 }}</h3>
                        <small class="text-muted">
                            {% trans "Patients" %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enrolled Patients Card -->
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100 stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-success bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-person-check-fill text-success" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1 text-uppercase small">
                            {% trans "Enrolled Patients" %}
                        </h6>
                        <h3 class="mb-0 fw-bold">{{ enrolled_patients|default:0 }}</h3>
                        <small class="text-success">
                            <i class="bi bi-arrow-up"></i> {{ percent_target }}% {% trans "of target" %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Total Contacts Card -->
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100 stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-info bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-people text-info" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1 text-uppercase small">
                            {% trans "Total Contacts" %}
                        </h6>
                        <h3 class="mb-0 fw-bold">{{ screening_contacts|default:0 }}</h3>
                        <small class="text-muted">
                            {% trans "Screening" %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enrolled Contacts Card -->
    <div class="col-12 col-sm-6 col-xl-3">
        <div class="card border-0 shadow-sm h-100 stat-card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <div class="bg-warning bg-opacity-10 rounded-3 p-3">
                            <i class="bi bi-person-plus-fill text-warning" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <h6 class="text-muted mb-1 text-uppercase small">
                            {% trans "Enrolled Contacts" %}
                        </h6>
                        <h3 class="mb-0 fw-bold">{{ enrolled_contacts|default:0 }}</h3>
                        <small class="text-muted">
                            {% trans "Participants" %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Project Timeline & Target Progress -->
<div class="row g-4 mb-4">
    <!-- Project Info Card -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 pt-4">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="bi bi-info-circle me-2 text-primary"></i>
                    {% trans "Project Overview" %}
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-3">
                        <strong>{% trans "Project Start Date" %}:</strong>
                        <span class="stat-number text-primary">{{ project_start|date:"d/m/Y"|default:"N/A" }}</span>
                        <span class="text-muted">{% trans "to" %}</span>
                        <span class="stat-number text-info">{{ today|date:"d/m/Y" }}</span>
                    </li>
                    <li class="mb-3">
                        <strong>{% trans "Contacts" %}:</strong>
                        <span class="stat-number text-info">{{ screening_contacts|default:"0" }}</span>
                        <span class="text-muted small">{% trans "Screening" %}</span>
                        <span class="mx-2">|</span>
                        <span class="stat-number text-success">{{ enrolled_contacts|default:"0" }}</span>
                        <span class="text-muted small">{% trans "Enrolled" %}</span>
                    </li>
                    <li>
                        <strong>{% trans "Patients" %}:</strong>
                        <span class="stat-number text-info">{{ screening_patients|default:"0" }}</span>
                        <span class="text-muted small">{% trans "Screening" %}</span>
                        <span class="mx-2">|</span>
                        <span class="stat-number text-success">{{ enrolled_patients|default:"0" }}</span>
                        <span class="text-muted small">{% trans "Enrolled" %}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Target Progress Card -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 pt-4">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="bi bi-bullseye me-2 text-success"></i>
                    {% trans "Enrollment Target Progress" %}
                </h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="enrollPercentPie" style="max-height: 200px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Gender Distribution Charts -->
<div class="row g-4 mb-4">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 pt-4">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="bi bi-gender-ambiguous me-2 text-info"></i>
                    {% trans "Patient Gender Distribution" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="patientGenderChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 pt-4">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="bi bi-gender-ambiguous me-2 text-success"></i>
                    {% trans "Contact Gender Distribution" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="contactGenderChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Screening Comparison Chart -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pt-4">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="bi bi-bar-chart-line me-2 text-primary"></i>
                    {% trans "Monthly Screening Comparison" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="screeningComparisonChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patient Enrollment Chart -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-transparent border-0 pt-4">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="bi bi-graph-up me-2 text-success"></i>
                    {% trans "Patient Enrollment Over Time" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="patientEnrollmentChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Unrecruited Reasons Tables -->
<div class="row g-4">
    <!-- Contact Reasons -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 pt-4">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="bi bi-x-circle me-2 text-warning"></i>
                    {% trans "Contact Unrecruited Reasons" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>{% trans "Reason" %}</th>
                                <th class="text-end">{% trans "Count" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reason in contact_reasons %}
                            <tr>
                                <td>{{ reason.UNRECRUITED_REASON|default:"(Not specified)" }}</td>
                                <td class="text-end">
                                    <span class="badge bg-warning">{{ reason.count }}</span>
                                    <small class="text-muted">({{ reason.percent }}%)</small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">
                                    {% trans "No data available" %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Reasons -->
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-transparent border-0 pt-4">
                <h5 class="card-title mb-0 fw-bold">
                    <i class="bi bi-x-circle me-2 text-danger"></i>
                    {% trans "Patient Unrecruited Reasons" %}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>{% trans "Reason" %}</th>
                                <th class="text-end">{% trans "Count" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reason in patient_reasons %}
                            <tr>
                                <td>{{ reason.UNRECRUITED_REASON|default:"(Not specified)" }}</td>
                                <td class="text-end">
                                    <span class="badge bg-danger">{{ reason.count }}</span>
                                    <small class="text-muted">({{ reason.percent }}%)</small>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">
                                    {% trans "No data available" %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
<!-- frontends/templates/studies/study_43en/home_dashboard.html -->

{% block extra_js_dashboard %}
<script>
// Kiểm tra các thư viện đã load
console.log('Chart.js loaded:', typeof Chart !== 'undefined');
console.log('jQuery loaded:', typeof jQuery !== 'undefined');
console.log('ChartDataLabels loaded:', typeof ChartDataLabels !== 'undefined');

$(document).ready(function() {
    console.log('Initializing charts...');
    
    // 1. Target Progress Chart
    const enrolled = Number({{ enrolled_patients|default:"0" }});
    const target = 750;
    const remain = Math.max(target - enrolled, 0);

    const ctxPie = document.getElementById('enrollPercentPie').getContext('2d');
    new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: ['{% trans "Enrolled" %}', '{% trans "Remaining" %}'],
            datasets: [{
                data: [enrolled, remain],
                backgroundColor: ['rgba(40, 167, 69, 0.85)', 'rgba(220, 220, 220, 0.5)'],
                borderColor: ['#fff', '#fff'],
                borderWidth: 3
            }]
        },
        options: {
            rotation: -90,
            circumference: 180,
            cutout: '70%',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = enrolled + remain;
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                },
                datalabels: {
                    color: ['#fff', '#333'],
                    font: { weight: 'bold', size: 16 },
                    formatter: function(value, context) {
                        const total = enrolled + remain;
                        const percentage = Math.round((value / total) * 100);
                        return percentage + '%';
                    }
                }
            }
        },
        plugins: [
            ChartDataLabels,
            {
                id: 'centerText',
                afterDraw: function(chart) {
                    const width = chart.width;
                    const height = chart.height;
                    const ctx = chart.ctx;
                    const x = width / 2;
                    const y = height * 0.95;
                    
                    ctx.save();
                    ctx.font = 'bold 48px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#28a745';
                    ctx.fillText(enrolled, x - 40, y);
                    
                    ctx.fillStyle = '#000';
                    ctx.fillText('/', x, y);
                    
                    ctx.fillStyle = '#666';
                    ctx.fillText(target, x + 40, y);
                    ctx.restore();
                }
            }
        ]
    });

    // 2. Gender Distribution
    $.ajax({
        url: "{% url 'study_43en:gender_distribution_chart_data' %}",
        type: "GET",
        dataType: "json",
        success: function(response) {
            const patientData = response.data.patient;
            const contactData = response.data.contact;
            
            // Patient chart
            new Chart(document.getElementById('patientGenderChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: patientData.labels,
                    datasets: [{
                        data: patientData.data,
                        backgroundColor: patientData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: function(value) {
                                const total = patientData.data.reduce((a, b) => a + b, 0);
                                return total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            
            // Contact chart
            new Chart(document.getElementById('contactGenderChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: contactData.labels,
                    datasets: [{
                        data: contactData.data,
                        backgroundColor: contactData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 14 },
                            formatter: function(value) {
                                const total = contactData.data.reduce((a, b) => a + b, 0);
                                return total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        },
        error: function(xhr, status, error) {
            console.error("Gender distribution error:", error);
        }
    });

    // 3. Screening Comparison
    $.ajax({
        url: "{% url 'study_43en:screening_comparison_chart_data' %}",
        type: "GET",
        dataType: "json",
        success: function(response) {
            new Chart(document.getElementById('screeningComparisonChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: response.data.labels,
                    datasets: [
                        {
                            label: '{% trans "Patients" %}',
                            data: response.data.patients,
                            backgroundColor: 'rgba(0, 123, 255, 0.7)',
                            borderColor: '#007bff',
                            borderWidth: 1
                        },
                        {
                            label: '{% trans "Contacts" %}',
                            data: response.data.contacts,
                            backgroundColor: 'rgba(23, 162, 184, 0.7)',
                            borderColor: '#17a2b8',
                            borderWidth: 1
                        },
                        {
                            label: '{% trans "Cumulative (Patients)" %}',
                            data: response.data.patientsCumulative,
                            type: 'line',
                            borderColor: '#dc3545',
                            yAxisID: 'y1'
                        },
                        {
                            label: '{% trans "Cumulative (Contacts)" %}',
                            data: response.data.contactsCumulative,
                            type: 'line',
                            borderColor: '#28a745',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '{% trans "Monthly Count" %}' } },
                        y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: '{% trans "Cumulative Count" %}' } }
                    }
                }
            });
        },
        error: function(xhr, status, error) {
            console.error("Screening comparison error:", error);
        }
    });

    // 4. Patient Enrollment
    $.ajax({
        url: "{% url 'study_43en:patient_enrollment_chart_data' %}",
        type: "GET",
        dataType: "json",
        success: function(response) {
            new Chart(document.getElementById('patientEnrollmentChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: response.data.labels,
                    datasets: [
                        {
                            label: '{% trans "Monthly Enrollment" %}',
                            data: response.data.monthly,
                            backgroundColor: 'rgba(0, 123, 255, 0.7)'
                        },
                        {
                            label: '{% trans "Cumulative Total" %}',
                            data: response.data.cumulative,
                            type: 'line',
                            borderColor: '#28a745',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '{% trans "Monthly Count" %}' } },
                        y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: '{% trans "Cumulative Total" %}' } }
                    }
                }
            });
        },
        error: function(xhr, status, error) {
            console.error("Patient enrollment error:", error);
        }
    });
});
</script>
{% endblock %}