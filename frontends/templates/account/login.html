<!-- frontends\templates\account\login.html -->
{% extends 'account/auth_base.html' %}
{% load i18n static allauth account %}

{% block title %}Sign In - ResSync Platform{% endblock %}
{% block auth_content %}
<div class="auth-card">

    <!-- Mobile Brand Header -->
    <header class="auth-card-brand">
        <div class="d-flex gap-3 align-items-center justify-content-center mb-2">
            <img src="{% static 'base/images/logo.png' %}" alt="" class="auth-card-logo" width="40" height="40"
                aria-hidden="true">
            <span class="title auth-card-title" aria-hidden="true">RESSYNT</span>
        </div>
        <p class="subtitle-logo text-center mb-0">
            {% trans "Research Data Management Platform" %}
        </p>
    </header>

    <!-- Welcome Message -->
    <div class="auth-card-header">
        <h2 class="auth-card-heading">{% trans "Welcome back" %}</h2>
        <p class="auth-card-subheading">{% trans "Sign in to continue your research journey." %}</p>
    </div>

    <!-- Lockout Alert - High Priority -->
    {% if is_locked_out %}
    <div class="alert alert-danger border-danger d-flex align-items-start px-3 py-3 mb-3" role="alert" aria-live="assertive">
        <i class="bi bi-shield-lock-fill me-3 fs-4 text-danger" aria-hidden="true"></i>
        <div>
            <strong class="d-block mb-1">{% trans "Access Restricted" %}</strong>
            <p class="small mb-0">
                {% trans "Access has been temporarily restricted due to security reasons. Please contact administrator for assistance." %}
            </p>
        </div>
    </div>
    {% elif prg_has_errors or form.errors %}
    <!-- Standard Error Messages (PRG pattern or form errors) -->
    <div class="alert alert-danger d-flex align-items-center px-3 py-2" role="alert" aria-live="polite">
        <i class="bi bi-exclamation-triangle-fill me-3" aria-hidden="true"></i>
        <div class="small">
            {% if prg_has_errors %}
            {% trans "Invalid username or password. Please try again." %}
            {% else %}
            {% for error in form.non_field_errors %}
            {{ error }}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% elif messages %}
    <!-- Django Messages - only show if no lockout or form errors (avoid duplicates) -->
    {% with first_message=messages|first %}
    {% if first_message %}
    <div class="alert alert-{{ first_message.tags|default:'warning' }} d-flex align-items-center px-3 py-2 mb-3" role="alert" aria-live="polite">
        {% if 'error' in first_message.tags or 'danger' in first_message.tags %}
        <i class="bi bi-x-circle-fill me-2" aria-hidden="true"></i>
        {% elif 'warning' in first_message.tags %}
        <i class="bi bi-exclamation-triangle-fill me-2" aria-hidden="true"></i>
        {% else %}
        <i class="bi bi-info-circle-fill me-2" aria-hidden="true"></i>
        {% endif %}
        <small>{{ first_message }}</small>
    </div>
    {% endif %}
    {% endwith %}
    {% endif %}

    <!-- Login Form -->
    <form method="POST" action="{% url 'account_login' %}" id="loginForm" class="auth-form">
        {% csrf_token %}
        
        <fieldset>
            <!-- Username/Email Input -->
            <div class="mb-4">
                <label for="{{ form.login.id_for_label }}" class="form-label">
                    {% trans "Username or Email" %}
                </label>
                <div class="input-icon-wrapper">
                    <input type="text" id="{{ form.login.id_for_label }}" name="{{ form.login.html_name }}"
                        value="{{ prg_username|default:form.login.value|default:'' }}" class="form-control form-control--with-icon"
                        placeholder="{% trans 'Enter username or email' %}" autocomplete="username" autocapitalize="none"
                        spellcheck="false" required autofocus aria-required="true">
                    <i class="bi bi-person input-icon" aria-hidden="true"></i>
                </div>
            </div>

            <!-- Password Input -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label for="passwordInput" class="form-label mb-0">
                        {% trans "Password" %}
                    </label>
                    <a href="{% url 'account_reset_password' %}" class="forgot-password-link" tabindex="-1">
                        {% trans "Forgotten password?" %}
                    </a>
                </div>
                <div class="input-icon-wrapper">
                    <input type="password" id="passwordInput" name="{{ form.password.html_name }}" 
                        class="form-control form-control--with-icon"
                        placeholder="{% trans 'Enter password' %}" required
                        autocomplete="current-password" aria-required="true">
                    <i class="bi bi-lock input-icon" aria-hidden="true"></i>
                    <button type="button"
                            class="password-toggle-btn" 
                            onclick="togglePassword(this)"
                            aria-label="{% trans 'Toggle password visibility' %}"
                            aria-pressed="false">
                        <i class="fa-regular fa-eye-slash" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-cyber w-100" id="submitBtn">
                <span class="btn-text">
                    <i class="bi bi-box-arrow-in-right me-2" aria-hidden="true"></i>
                    {% trans "Sign In" %}
                </span>
                <span class="btn-loading d-none">
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    {% trans "Signing In..." %}
                </span>
            </button>
        </fieldset>
    </form>

    <!-- Registration Notice -->
    <div class="registration-notice mt-4">
        <span class="registration-notice-text">{% trans "No account?" %}</span>
        <a href="mailto:ressynt@oucru.org?subject={% trans 'Account Request' %}" class="registration-notice-link">
            <span>{% trans "Request access" %}</span>
            <i class="bi bi-arrow-right"></i>
        </a>
    </div>

    <div class="auth-card-footer mt-2">
        <p class="security-note">
            <i class="bi bi-shield-lock-fill" aria-hidden="true"></i>
            {% trans "Secured with 256-bit encryption" %}
        </p>
    </div>
</div>
{% endblock %}