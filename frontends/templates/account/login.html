<!-- frontends\templates\account\login.html -->
{% extends 'account/auth_base.html' %}
{% load i18n static allauth account %}

{% block title %}Sign In - ResSync Platform{% endblock %}
{% block auth_content %}
<div class="auth-card">

    <!-- Mobile Brand Header -->
    <header class="auth-card-brand">
        <div class="d-flex gap-3 align-items-center justify-content-center mb-2">
            <img src="{% static 'base/images/logo.png' %}" alt="" class="auth-card-logo" width="40" height="40"
                aria-hidden="true">
            <span class="title auth-card-title" aria-hidden="true">RESSYNT</span>
        </div>
        <p class="subtitle-logo text-center mb-0">
            {% trans "Research Data Management Platform" %}
        </p>
    </header>

    <!-- Welcome Message -->
    <div class="auth-card-header">
        <h2 class="auth-card-heading">{% trans "Welcome back" %}</h2>
        <p class="auth-card-subheading">{% trans "Sign in to continue your research journey." %}</p>
    </div>

    <!-- Error Messages -->
    <!-- Error Messages -->
    {% if form.errors %}
    <div class="alert alert-danger d-flex align-items-center px-3 py-2" role="alert" aria-live="polite">
        <i class="bi bi-exclamation-triangle-fill me-3" aria-hidden="true"></i>
        <div class="small">
            {% for error in form.non_field_errors %}
            {{ error }}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Login Form -->
    <form method="POST" action="{% url 'account_login' %}" id="loginForm" class="auth-form">
        {% csrf_token %}

        <!-- Username/Email Input -->
        <div class="mb-4">
            <label for="{{ form.login.id_for_label }}" class="form-label">
                {% trans "Username or Email" %}
            </label>
            <div class="input-icon-wrapper">
                <i class="bi bi-person input-icon" aria-hidden="true"></i>
                <input type="text" id="{{ form.login.id_for_label }}" name="{{ form.login.html_name }}"
                    value="{{ form.login.value|default:'' }}" class="form-control form-control--with-icon"
                    placeholder="{% trans 'Enter username or email' %}" autocomplete="username" autocapitalize="none"
                    spellcheck="false" required autofocus aria-required="true">
            </div>
        </div>

        <!-- Password Input -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label for="passwordInput" class="form-label mb-0">
                    {% trans "Password" %}
                </label>
                <a href="{% url 'account_reset_password' %}" class="forgot-password-link" tabindex="-1">
                    {% trans "Forgotten password?" %}
                </a>
            </div>
            <div class="input-icon-wrapper">
                <input type="password" id="passwordInput" name="{{ form.password.html_name }}" class="form-control form-control--with-icon"
                    placeholder="{% trans 'Enter password' %}" required autocomplete="current-password" aria-required="true">
                <i class="bi bi-lock input-icon" aria-hidden="true"></i>
                <button type="button"
                        class="password-toggle-btn" 
                        onclick="togglePassword()"
                        aria-label="{% trans 'Toggle password visibility' %}"
                        aria-pressed="false">
                    <i class="fa-regular fa-eye-slash" id="toggleIcon" aria-hidden="true"></i>
                </button>
            </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-cyber w-100" id="submitBtn">
            <span class="btn-text">
                <i class="bi bi-box-arrow-in-right me-2" aria-hidden="true"></i>
                {% trans "Sign In" %}
            </span>
            <span class="btn-loading d-none">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                {% trans "Signing In..." %}
            </span>
        </button>
    </form>

    <!-- Registration Notice -->
    <div class="registration-notice mt-4">
        <span class="registration-notice-text">{% trans "No account?" %}</span>
        <a href="mailto:ressynt@oucru.org?subject={% trans 'Account Request' %}" class="registration-notice-link">
            <span>{% trans "Request access" %}</span>
            <i class="bi bi-arrow-right"></i>
        </a>
    </div>

    <div class="auth-card-footer mt-2">
        <p class="security-note">
            <i class="bi bi-shield-lock-fill" aria-hidden="true"></i>
            {% trans "Secured with 256-bit encryption" %}
        </p>
    </div>
</div>

<script nonce="{{ request.csp_nonce }}">
    function togglePassword() {
        const passwordInput = document.getElementById('passwordInput');
        const toggleIcon = document.getElementById('toggleIcon');
        const toggleBtn = document.querySelector('.password-toggle-btn');

        const isPassword = passwordInput.type === 'password';

        passwordInput.type = isPassword ? 'text' : 'password';
        toggleIcon.classList.toggle('fa-eye-slash', !isPassword);
        toggleIcon.classList.toggle('fa-eye', isPassword);
        toggleBtn.setAttribute('aria-pressed', isPassword);
    }

    // Keyboard support for password toggle
    document.querySelector('.password-toggle-btn')?.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            togglePassword();
        }
    });

    // Form Submit Loading State
    document.getElementById('loginForm')?.addEventListener('submit', function (e) {
        const submitBtn = document.getElementById('submitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.btn-loading');

        // Basic client-side validation
        if (!this.checkValidity()) {
            e.preventDefault();
            return;
        }

        // Show loading state
        submitBtn.disabled = true;
        btnText?.classList.add('d-none');
        btnLoading?.classList.remove('d-none');
    });

    // Re-enable button if user navigates back
    window.addEventListener('pageshow', function (event) {
        if (event.persisted) {
            const submitBtn = document.getElementById('submitBtn');
            const btnText = submitBtn?.querySelector('.btn-text');
            const btnLoading = submitBtn?.querySelector('.btn-loading');

            if (submitBtn) {
                submitBtn.disabled = false;
                btnText?.classList.remove('d-none');
                btnLoading?.classList.add('d-none');
            }
        }
    });
</script>
{% endblock %}