<!-- frontends/templates/includes/dropdown_header/notification_menu.html -->
{% load static i18n %}

<div class="notification-dropdown">
    <!-- Bell Button -->
    <button class="notification-btn" 
            type="button" 
            id="notificationDropdownButton" 
            data-bs-toggle="dropdown" 
            aria-expanded="false" 
            aria-label="{% trans 'Notifications' %}">
        <i class="bi bi-bell"></i>
        
        <!-- Badge Count -->
        {% if unread_count > 0 %}
        <span class="notification-badge" id="unreadBadge">
            {{ unread_count }}
            <span class="visually-hidden">{% trans 'unread notifications' %}</span>
        </span>
        {% endif %}
    </button>

    <!-- Dropdown Menu -->
    <div class="notification-menu dropdown-menu dropdown-menu-end" 
         aria-labelledby="notificationDropdownButton">
        
        <!-- Header -->
        <div class="notification-header">
            <div class="notification-header-content">
                <div class="notification-header-title">
                    <i class="bi bi-bell-fill"></i>
                    <h6>{% trans "Lịch hẹn sắp tới" %}</h6>
                </div>
                <div class="notification-header-actions">
                    {% if unread_count > 0 %}
                    <span class="notification-header-count" id="unreadCountHeader">
                        {{ unread_count }}
                    </span>
                    {% endif %}
                    {% if upcoming_count > 0 %}
                    <button class="notification-mark-all" 
                            id="markAllReadBtn" 
                            title="{% trans 'Đánh dấu tất cả đã đọc' %}">
                        <i class="bi bi-check2-all"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Notifications List -->
        <div class="notification-body">
            {% if upcoming_patients %}
                {% for notification in upcoming_patients %}
                <div class="notification-item {% if not notification.is_read %}notification-item--unread{% endif %}" 
                     data-notif-id="{{ notification.notif_id }}"
                     data-usubjid="{{ notification.usubjid }}">
                    
                    <!-- Content Left -->
                    <div class="notification-content">
                        <!-- Title Row -->
                        <div class="notification-title-row">
                            <span class="notification-usubjid">{{ notification.usubjid }}</span>
                            <span class="notification-separator">-</span>
                            <span class="notification-patient-name">{{ notification.patient_name }}</span>
                            {% if not notification.is_read %}
                            <span class="notification-unread-dot"></span>
                            {% endif %}
                        </div>
                        
                        <!-- Visit Info -->
                        <div class="notification-visit-info">
                            <i class="bi bi-calendar3"></i>
                            <span>{{ notification.visit_type }}</span>
                        </div>
                        
                        <!-- Date & Status -->
                        <div class="notification-date-row">
                            <div class="notification-date">
                                <i class="bi bi-clock"></i>
                                <span>{{ notification.expected_date|date:"d/m/Y (l)" }}</span>
                            </div>
                            {% if notification.status == 'LATE' %}
                            <span class="notification-status-badge notification-status-badge--late">
                                Trễ hẹn
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Actions Right -->
                    <div class="notification-actions">
                        <a href="{% url 'study_43en:followup_tracking_list' %}?search={{ notification.usubjid }}" 
                           class="notification-btn-action notification-btn-action--view">
                            <span>Chi tiết</span>
                        </a>
                        
                        {% if not notification.is_read %}
                        <button class="notification-btn-action notification-btn-action--mark mark-read-btn" 
                                data-notif-id="{{ notification.notif_id }}"
                                title="{% trans 'Đánh dấu đã đọc' %}">
                            <i class="bi bi-check2"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                
                <!-- Footer -->
                <div class="notification-footer">
                    <a href="{% url 'study_43en:followup_tracking_list' %}" 
                       class="notification-footer-link">
                        <i class="bi bi-arrow-right-circle"></i>
                        <span>{% trans "Xem tất cả lịch hẹn" %}</span>
                    </a>
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="notification-empty">
                    <div class="notification-empty-icon">
                        <i class="bi bi-calendar-check"></i>
                    </div>
                    <p class="notification-empty-text">
                        {% trans "Không có lịch hẹn trong 3 ngày tới" %}
                    </p>
                    <a href="{% url 'study_43en:followup_tracking_list' %}" 
                       class="notification-btn-action notification-btn-action--view">
                        {% trans "Xem lịch theo dõi" %}
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<link rel="stylesheet" href="{% static 'base/css/notification_menu.css' %}">
<script nonce="{{ request.csp_nonce }}" src="{% static 'base/js/notification_menu.js' %}"></script>