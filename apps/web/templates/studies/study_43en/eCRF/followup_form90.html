{% extends 'adminlte_base.html' %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block title %}
{% if is_readonly %}
    {% trans "Xem Thông Tin Theo Dõi 90 Ngày" %}
{% else %}
    {% trans "Form Theo Dõi 90 Ngày 43EN" %}
{% endif %}
{% endblock %}

{% block page_title %}
{% if is_readonly %}
    {% trans "Xem Thông Tin Theo Dõi 90 Ngày" %}
{% else %}
    {% trans "Form Theo Dõi 90 Ngày 43EN" %}
{% endif %}
{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item"><a href="{% url '43en:patient_list' %}">{% trans "Danh sách bệnh nhân" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url '43en:patient_detail' usubjid=screening_case.USUBJID %}">{{ screening_case.USUBJID }}</a></li>
    <li class="breadcrumb-item active">
        {% if is_readonly %}
            {% trans "Xem theo dõi" %}
        {% else %}
            {% trans "Theo dõi 90 ngày" %}
        {% endif %}
    </li>
</ol>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Thông tin bệnh nhân -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card card-outline card-primary">
                <div class="card-header">
                    <h3 class="card-title">{% trans "Thông tin bệnh nhân" %}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>{% trans "Mã bệnh nhân" %}:</strong><br>
                            <span class="text-primary">{{ screening_case.USUBJID }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>{% trans "Ngày sàng lọc" %}:</strong><br>
                            {{ screening_case.SCREENINGFORMDATE|date:"d/m/Y"|default:"-" }}
                        </div>
                        <div class="col-md-3">
                            <strong>{% trans "Trạng thái follow-up" %}:</strong><br>
                            {% if has_followup %}
                                <span class="badge badge-success">{% trans "Đã có dữ liệu" %}</span>
                            {% else %}
                                <span class="badge badge-warning">{% trans "Chưa có dữ liệu" %}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Form chính -->
    <form method="post" novalidate>
        {% csrf_token %}
        
        <!-- Phần 1: Đánh giá tình trạng tại ngày 90 -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-info">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "1. Đánh giá tình trạng tại thời điểm ngày 90" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90ASSESSED %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90ASSESSDATE %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90PATSTATUS %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần 2: Tái nhập viện -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-warning">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "2. Tái nhập viện" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90REHOSP %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90REHOSPCOUNT %}
                                </div>
                            </div>
                        </div>

                        <!-- Chi tiết tái nhập viện -->
                        <div id="rehospitalization-section" class="mt-3" style="display: none;">
                            <h5>{% trans "Chi tiết tái nhập viện" %}</h5>
                            <div id="rehospitalization-formset">
                                {{ rehospitalization_formset.management_form }}
                                {% for form_instance in rehospitalization_formset %}
                                    {% if form_instance.instance.pk %}
                                        <div class="rehospitalization-form border p-3 mb-2" style="background-color: #f8f9fa;">
                                            {% if form_instance.non_field_errors %}
                                                <div class="alert alert-danger">{{ form_instance.non_field_errors }}</div>
                                            {% endif %}
                                            
                                            <div class="row">
                                                <div class="col-md-2">
                                                    {% bootstrap_field form_instance.EPISODE %}
                                                </div>
                                                <div class="col-md-4">
                                                    {% bootstrap_field form_instance.REHOSPDATE %}
                                                </div>
                                                <div class="col-md-4">
                                                    {% bootstrap_field form_instance.REHOSPLOCATION %}
                                                </div>
                                                <div class="col-md-2">
                                                    {% bootstrap_field form_instance.REHOSPSTAYDUR %}
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    {% bootstrap_field form_instance.REHOSPREASONFOR %}
                                                </div>
                                            </div>
                                            
                                            {% for hidden in form_instance.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            {% if not is_readonly %}
                            <button type="button" id="add-rehospitalization" class="btn btn-success btn-sm">
                                <i class="fas fa-plus"></i> {% trans "Thêm lần tái nhập viện" %}
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần 3: Tử vong -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-danger">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "3. Tử vong" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90DECEASED %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90DEATHDATE %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90DEATHCAUSE %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần 4: Sử dụng kháng sinh -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-success">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "4. Sử dụng kháng sinh" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90USEDANTIBIO %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90ANTIBIOCOUNT %}
                                </div>
                            </div>
                        </div>

                        <!-- Chi tiết kháng sinh -->
                        <div id="antibiotic-section" class="mt-3" style="display: none;">
                            <h5>{% trans "Chi tiết kháng sinh" %}</h5>
                            <div id="antibiotic-formset">
                                {{ antibiotic_formset.management_form }}
                                {% for form_instance in antibiotic_formset %}
                                    {% if form_instance.instance.pk %}
                                        <div class="antibiotic-form border p-3 mb-2" style="background-color: #f8f9fa;">
                                            {% if form_instance.non_field_errors %}
                                                <div class="alert alert-danger">{{ form_instance.non_field_errors }}</div>
                                            {% endif %}
                                            
                                            <div class="row">
                                                <div class="col-md-3">
                                                    {% bootstrap_field form_instance.EPISODE %}
                                                </div>
                                                <div class="col-md-5">
                                                    {% bootstrap_field form_instance.ANTIBIONAME %}
                                                </div>
                                                <div class="col-md-4">
                                                    {% bootstrap_field form_instance.ANTIBIODUR %}
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-12">
                                                    {% bootstrap_field form_instance.ANTIBIOREASONFOR %}
                                                </div>
                                            </div>
                                            
                                            {% for hidden in form_instance.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            {% if not is_readonly %}
                            <button type="button" id="add-antibiotic" class="btn btn-success btn-sm">
                                <i class="fas fa-plus"></i> {% trans "Thêm đợt kháng sinh" %}
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần 5: Đánh giá tình trạng chức năng -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-purple">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "5. Đánh giá tình trạng chức năng" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    {% bootstrap_field form.FU90FUNCASSESS %}
                                </div>
                            </div>
                        </div>

                        <!-- Chi tiết đánh giá chức năng -->
                        <div id="functional-assessment-section" class="mt-3" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {% bootstrap_field form.FU90MOBILITY %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {% bootstrap_field form.FU90PERHYGIENE %}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {% bootstrap_field form.FU90DAILYACTIV %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {% bootstrap_field form.FU90PAINDISCOMF %}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {% bootstrap_field form.FU90ANXDEPRESS %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        {% bootstrap_field form.FU90FBSISCORE %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần thông tin hoàn thành -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-secondary">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "Thông tin hoàn thành" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    {% bootstrap_field form.COMPLETEDBY %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    {% bootstrap_field form.COMPLETEDDATE %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                    {% if not is_readonly %}
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> {% trans "Lưu thông tin" %}
                        </button>
                        <a href="{% url '43en:patient_detail' usubjid=screening_case.USUBJID %}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-arrow-left"></i> {% trans "Quay lại" %}
                        </a>
                    {% else %}
                        <a href="{% url '43en:followup_form90' usubjid=screening_case.USUBJID %}" class="btn btn-warning btn-lg">
                            <i class="fas fa-edit"></i> {% trans "Chỉnh sửa" %}
                        </a>
                        <a href="{% url '43en:patient_detail' usubjid=screening_case.USUBJID %}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-arrow-left"></i> {% trans "Quay lại" %}
                        </a>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- SỬ DỤNG DATEPICKER CÓ SẴN -->
{% include 'study_43en/includes/datepicker_scripts.html' %}

<script>
$(document).ready(function() {
    console.log("Initializing followup90 form...");
    
    // Kiểm tra management form
    console.log("Management form rehospitalization:", {
        total: $('#id_rehospitalization90_set-TOTAL_FORMS').val(),
        initial: $('#id_rehospitalization90_set-INITIAL_FORMS').val(),
        min: $('#id_rehospitalization90_set-MIN_NUM_FORMS').val(),
        max: $('#id_rehospitalization90_set-MAX_NUM_FORMS').val()
    });
    
    console.log("Management form antibiotic:", {
        total: $('#id_antibiotic90_set-TOTAL_FORMS').val(),
        initial: $('#id_antibiotic90_set-INITIAL_FORMS').val(),
        min: $('#id_antibiotic90_set-MIN_NUM_FORMS').val(),
        max: $('#id_antibiotic90_set-MAX_NUM_FORMS').val()
    });
    
    // Functions để toggle sections
    function toggleSection(triggerName, sectionId, showValue = 'Yes') {
        var selectedValue = $('input[name="' + triggerName + '"]:checked').val();
        console.log(`Toggle section ${sectionId} based on ${triggerName}=${selectedValue}`);
        if (selectedValue === showValue) {
            $(sectionId).slideDown(400);
        } else {
            $(sectionId).slideUp(400);
        }
    }

    // Event handlers cho radio buttons
    $(document).on('change', 'input[name="FU90REHOSP"]', function() {
        toggleSection('FU90REHOSP', '#rehospitalization-section');
    });

    $(document).on('change', 'input[name="FU90USEDANTIBIO"]', function() {
        toggleSection('FU90USEDANTIBIO', '#antibiotic-section');
    });

    $(document).on('change', 'input[name="FU90FUNCASSESS"]', function() {
        toggleSection('FU90FUNCASSESS', '#functional-assessment-section');
    });

    $(document).on('change', 'input[name="FU90ASSESSED"]', function() {
        if ($(this).val() === 'Yes') {
            $('input[name="FU90ASSESSDATE"]').closest('.form-group').parent().show();
            $('select[name="FU90PATSTATUS"]').closest('.form-group').parent().show();
        } else {
            $('input[name="FU90ASSESSDATE"]').closest('.form-group').parent().hide();
            $('select[name="FU90PATSTATUS"]').closest('.form-group').parent().hide();
        }
    });

    $(document).on('change', 'input[name="FU90DECEASED"]', function() {
        if ($(this).val() === 'Yes') {
            $('input[name="FU90DEATHDATE"]').closest('.form-group').parent().show();
            $('textarea[name="FU90DEATHCAUSE"]').closest('.form-group').parent().show();
        } else {
            $('input[name="FU90DEATHDATE"]').closest('.form-group').parent().hide();
            $('textarea[name="FU90DEATHCAUSE"]').closest('.form-group').parent().hide();
        }
    });

    // Khởi tạo sections khi load trang
    setTimeout(function() {
        toggleSection('FU90REHOSP', '#rehospitalization-section');
        toggleSection('FU90USEDANTIBIO', '#antibiotic-section');
        toggleSection('FU90FUNCASSESS', '#functional-assessment-section');
        
        // Khởi tạo hiển thị/ẩn các trường phụ thuộc
        if ($('input[name="FU90ASSESSED"]:checked').val() !== 'Yes') {
            $('input[name="FU90ASSESSDATE"]').closest('.form-group').parent().hide();
            $('select[name="FU90PATSTATUS"]').closest('.form-group').parent().hide();
        }
        
        if ($('input[name="FU90DECEASED"]:checked').val() !== 'Yes') {
            $('input[name="FU90DEATHDATE"]').closest('.form-group').parent().hide();
            $('textarea[name="FU90DEATHCAUSE"]').closest('.form-group').parent().hide();
        }
    }, 200);

    // TẠO FORM MỚI CHỈ KHI CLICK BUTTON - REHOSPITALIZATION
    $('#add-rehospitalization').click(function() {
        var container = $('#rehospitalization-formset');
        var totalForms = parseInt($('#id_rehospitalization90_set-TOTAL_FORMS').val());
        
        console.log(`Adding new rehospitalization form. Current total: ${totalForms}`);
        
        // Tính toán EPISODE mới dựa trên số form hiện tại
        var existingEpisodes = [];
        $('.rehospitalization-form').each(function() {
            var episodeInput = $(this).find('input[id$="-EPISODE"]');
            if (episodeInput.length) {
                existingEpisodes.push(parseInt(episodeInput.val()));
            }
        });
        
        // Tìm EPISODE lớn nhất và tăng thêm 1
        var newEpisode = 1;
        if (existingEpisodes.length > 0) {
            newEpisode = Math.max(...existingEpisodes) + 1;
        }
        
        console.log(`New rehospitalization episode: ${newEpisode}, existing episodes: ${JSON.stringify(existingEpisodes)}`);
        
        var newIndex = totalForms;

        // Tạo HTML form mới cho rehospitalization
        var newFormHtml = `
            <div class="rehospitalization-form border p-3 mb-2" style="background-color: #f8f9fa; animation: fadeIn 0.3s ease-in;">
                <div class="row">
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="id_rehospitalization90_set-${newIndex}-EPISODE" class="form-label">Đợt</label>
                            <input type="number" name="rehospitalization90_set-${newIndex}-EPISODE" 
                                   value="${newEpisode}" readonly class="form-control" 
                                   id="id_rehospitalization90_set-${newIndex}-EPISODE">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="id_rehospitalization90_set-${newIndex}-REHOSPDATE" class="form-label">Ngày tái nhập viện</label>
                            <input type="text" name="rehospitalization90_set-${newIndex}-REHOSPDATE" 
                                   class="datepicker form-control" autocomplete="off" placeholder="YYYY-MM-DD"
                                   id="id_rehospitalization90_set-${newIndex}-REHOSPDATE">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="id_rehospitalization90_set-${newIndex}-REHOSPLOCATION" class="form-label">Nơi tái nhập viện</label>
                            <input type="text" name="rehospitalization90_set-${newIndex}-REHOSPLOCATION" 
                                   class="form-control" placeholder="Nơi tái nhập viện..."
                                   id="id_rehospitalization90_set-${newIndex}-REHOSPLOCATION">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="id_rehospitalization90_set-${newIndex}-REHOSPSTAYDUR" class="form-label">Thời gian nằm viện</label>
                            <input type="text" name="rehospitalization90_set-${newIndex}-REHOSPSTAYDUR" 
                                   class="form-control" placeholder="Thời gian nằm viện (ví dụ: 5 ngày)"
                                   id="id_rehospitalization90_set-${newIndex}-REHOSPSTAYDUR">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="id_rehospitalization90_set-${newIndex}-REHOSPREASONFOR" class="form-label">Lý do tái nhập viện</label>
                            <textarea name="rehospitalization90_set-${newIndex}-REHOSPREASONFOR" 
                                      class="form-control" rows="2" placeholder="Lý do tái nhập viện..."
                                      id="id_rehospitalization90_set-${newIndex}-REHOSPREASONFOR"></textarea>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="rehospitalization90_set-${newIndex}-id" id="id_rehospitalization90_set-${newIndex}-id">
                <input type="hidden" name="rehospitalization90_set-${newIndex}-follow_up" id="id_rehospitalization90_set-${newIndex}-follow_up">
            </div>
        `;

        // Thêm form mới vào container
        container.append(newFormHtml);
        
        // Update total forms count
        $('#id_rehospitalization90_set-TOTAL_FORMS').val(totalForms + 1);
        
        console.log(`Updated rehospitalization management form: total=${totalForms + 1}`);

        // Initialize datepicker cho form mới
        if (typeof initializeDatepickers === 'function') {
            initializeDatepickers(container.find('.rehospitalization-form:last'));
        } else {
            // Fallback - khởi tạo datepicker manually
            container.find('.rehospitalization-form:last .datepicker').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true,
                language: 'vi',
                orientation: 'bottom auto'
            });
        }
        
        // Tự động cập nhật số lần tái nhập viện
        var currentCount = parseInt($('input[name="FU90REHOSPCOUNT"]').val()) || 0;
        $('input[name="FU90REHOSPCOUNT"]').val(currentCount + 1);
        
        console.log('Added rehospitalization form, total:', totalForms + 1, 'count:', currentCount + 1);
    });

    // TẠO FORM MỚI CHỈ KHI CLICK BUTTON - ANTIBIOTIC
    $('#add-antibiotic').click(function() {
        var container = $('#antibiotic-formset');
        var totalForms = parseInt($('#id_antibiotic90_set-TOTAL_FORMS').val());
        
        console.log(`Adding new antibiotic form. Current total: ${totalForms}`);
        
        // Tính toán EPISODE mới dựa trên số form hiện tại
        var existingEpisodes = [];
        $('.antibiotic-form').each(function() {
            var episodeInput = $(this).find('input[id$="-EPISODE"]');
            if (episodeInput.length) {
                existingEpisodes.push(parseInt(episodeInput.val()));
            }
        });
        
        // Tìm EPISODE lớn nhất và tăng thêm 1
        var newEpisode = 1;
        if (existingEpisodes.length > 0) {
            newEpisode = Math.max(...existingEpisodes) + 1;
        }
        
        console.log(`New antibiotic episode: ${newEpisode}, existing episodes: ${JSON.stringify(existingEpisodes)}`);
        
        var newIndex = totalForms;

        // Tạo HTML form mới cho antibiotic
        var newFormHtml = `
            <div class="antibiotic-form border p-3 mb-2" style="background-color: #f8f9fa; animation: fadeIn 0.3s ease-in;">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="id_antibiotic90_set-${newIndex}-EPISODE" class="form-label">Đợt</label>
                            <input type="number" name="antibiotic90_set-${newIndex}-EPISODE" 
                                   value="${newEpisode}" readonly class="form-control" 
                                   id="id_antibiotic90_set-${newIndex}-EPISODE">
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="form-group">
                            <label for="id_antibiotic90_set-${newIndex}-ANTIBIONAME" class="form-label">Tên kháng sinh</label>
                            <input type="text" name="antibiotic90_set-${newIndex}-ANTIBIONAME"
                                class="form-control" placeholder="Tên thuốc kháng sinh..."
                                   id="id_antibiotic90_set-${newIndex}-ANTIBIONAME">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="id_antibiotic90_set-${newIndex}-ANTIBIODUR" class="form-label">Thời gian sử dụng</label>
                            <input type="text" name="antibiotic90_set-${newIndex}-ANTIBIODUR" 
                                   class="form-control" placeholder="Thời gian sử dụng (ví dụ: 7 ngày)"
                                   id="id_antibiotic90_set-${newIndex}-ANTIBIODUR">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="id_antibiotic90_set-${newIndex}-ANTIBIOREASONFOR" class="form-label">Lý do sử dụng</label>
                            <textarea name="antibiotic90_set-${newIndex}-ANTIBIOREASONFOR" 
                                      class="form-control" rows="2" placeholder="Lý do sử dụng..."
                                      id="id_antibiotic90_set-${newIndex}-ANTIBIOREASONFOR"></textarea>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="antibiotic90_set-${newIndex}-id" id="id_antibiotic90_set-${newIndex}-id">
                <input type="hidden" name="antibiotic90_set-${newIndex}-follow_up" id="id_antibiotic90_set-${newIndex}-follow_up">
            </div>
        `;

        // Thêm form mới vào container
        container.append(newFormHtml);
        
        // Update total forms count
        $('#id_antibiotic90_set-TOTAL_FORMS').val(totalForms + 1);
        
        console.log(`Updated antibiotic management form: total=${totalForms + 1}`);
        
        // Tự động cập nhật số đợt kháng sinh
        var currentCount = parseInt($('input[name="FU90ANTIBIOCOUNT"]').val()) || 0;
        $('input[name="FU90ANTIBIOCOUNT"]').val(currentCount + 1);
        
        console.log('Added antibiotic form, total:', totalForms + 1, 'count:', currentCount + 1);
    });

    // Form validation trước khi submit
    $('form').on('submit', function(e) {
        console.log("Form submission started");
        
        // Log current form state
        console.log("Current rehospitalization forms:", $('.rehospitalization-form').length);
        console.log("Current antibiotic forms:", $('.antibiotic-form').length);
        console.log("Rehospitalization management form:", {
            total: $('#id_rehospitalization90_set-TOTAL_FORMS').val(),
            initial: $('#id_rehospitalization90_set-INITIAL_FORMS').val()
        });
        console.log("Antibiotic management form:", {
            total: $('#id_antibiotic90_set-TOTAL_FORMS').val(),
            initial: $('#id_antibiotic90_set-INITIAL_FORMS').val()
        });
        
        var hasErrors = false;
        var errorMessages = [];
        
        // Validate conditional required fields
        if ($('input[name="FU90ASSESSED"]:checked').val() === 'Yes') {
            if (!$('input[name="FU90ASSESSDATE"]').val()) {
                hasErrors = true;
                errorMessages.push('Vui lòng nhập ngày đánh giá khi chọn "Có" cho câu hỏi đánh giá.');
            }
        }

        if ($('input[name="FU90DECEASED"]:checked').val() === 'Yes') {
            if (!$('input[name="FU90DEATHDATE"]').val()) {
                hasErrors = true;
                errorMessages.push('Vui lòng nhập ngày tử vong.');
            }
            if (!$('textarea[name="FU90DEATHCAUSE"]').val().trim()) {
                hasErrors = true;
                errorMessages.push('Vui lòng nhập nguyên nhân tử vong.');
            }
        }

        if ($('input[name="FU90REHOSP"]:checked').val() === 'Yes') {
            if (!$('input[name="FU90REHOSPCOUNT"]').val()) {
                hasErrors = true;
                errorMessages.push('Vui lòng nhập số lần tái nhập viện.');
            }
            
            // Kiểm tra xem có ít nhất một form tái nhập viện có dữ liệu không
            var hasRehospData = false;
            $('.rehospitalization-form').each(function() {
                if ($(this).find('input[name$="-REHOSPDATE"]').val() || 
                    $(this).find('input[name$="-REHOSPLOCATION"]').val() ||
                    $(this).find('textarea[name$="-REHOSPREASONFOR"]').val()) {
                    hasRehospData = true;
                    return false; // break loop
                }
            });
            
            if (!hasRehospData) {
                hasErrors = true;
                errorMessages.push('Vui lòng nhập ít nhất một lần tái nhập viện.');
            }
        }

        if ($('input[name="FU90USEDANTIBIO"]:checked').val() === 'Yes') {
            if (!$('input[name="FU90ANTIBIOCOUNT"]').val()) {
                hasErrors = true;
                errorMessages.push('Vui lòng nhập số đợt kháng sinh.');
            }
            
            // Kiểm tra xem có ít nhất một form kháng sinh có dữ liệu không
            var hasAntibioData = false;
            $('.antibiotic-form').each(function() {
                if ($(this).find('input[name$="-ANTIBIONAME"]').val() || 
                    $(this).find('input[name$="-ANTIBIODUR"]').val() ||
                    $(this).find('textarea[name$="-ANTIBIOREASONFOR"]').val()) {
                    hasAntibioData = true;
                    return false; // break loop
                }
            });
            
            if (!hasAntibioData) {
                hasErrors = true;
                errorMessages.push('Vui lòng nhập ít nhất một đợt kháng sinh.');
            }
        }

        if (hasErrors) {
            e.preventDefault();
            console.log("Form validation failed:", errorMessages);
            alert('Có lỗi trong form:\n\n' + errorMessages.join('\n'));
            return false;
        }
        
        console.log("Form validation passed, submitting form");
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.card-purple {
    border-top: 3px solid #6f42c1;
}

.card-purple .card-header {
    background-color: rgba(111, 66, 193, 0.1);
    border-bottom: 1px solid rgba(111, 66, 193, 0.2);
}

.rehospitalization-form,
.antibiotic-form {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    transition: all 0.3s ease;
}

.rehospitalization-form:hover,
.antibiotic-form:hover {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

/* Animation cho việc thêm form */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Radio button styling */
.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

/* Form group spacing */
.form-group {
    margin-bottom: 1rem;
}

/* Card spacing */
.card {
    margin-bottom: 1.5rem;
}

/* Button styling */
.btn {
    margin-right: 0.5rem;
}

.btn:last-child {
    margin-right: 0;
}

/* Form label styling */
.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}

/* Border styling for dynamic forms */
.rehospitalization-form,
.antibiotic-form {
    border: 1px solid #dee2e6 !important;
    border-radius: 0.375rem;
}
</style>
{% endblock %}