{% extends 'adminlte_base.html' %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block title %}{% trans "Thông Tin Xét Nghiệm 43EN" %}{% endblock %}

{% block page_title %}{% trans "Thông Tin Xét Nghiệm 43EN" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url '43en:patient_list' %}">{% trans "Danh sách bệnh nhân 43EN" %}</a></li>
<li class="breadcrumb-item"><a href="{% url '43en:patient_detail' usubjid=screening_case.USUBJID %}">{% trans "Bệnh nhân" %} {{ screening_case.USUBJID }}</a></li>
<li class="breadcrumb-item active">{% trans "Thông tin xét nghiệm" %}</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/form-animations.css' %}">
<style>
  /* Disable Bootstrap transitions for collapse to avoid delay */
  .collapsing {
    transition: none !important;
    -webkit-transition: none !important;
  }
  
  .laboratory-card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin-bottom: 20px;
    transition: none; /* Remove transition for immediate response */
  }
  
  .laboratory-card .card-header {
    background-color: #f8f9fa;
    padding: 12px 15px;
    border-left: 4px solid #3b7ddd;
    cursor: pointer;
  }
  
  .laboratory-category {
    font-weight: 700;
    color: #343a40;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.15rem;
  }

  .test-item {
    padding: 10px 15px;
    border-bottom: 1px solid #f1f1f1;
    background-color: #fff;
    transition: background-color 0.2s ease;
  }
  
  .test-item:hover {
    background-color: #f8f9fa;
  }
  
  .test-item:last-child {
    border-bottom: none;
  }
  
  .test-name {
    font-weight: 600;
    color: #343a40;
    font-size: 1.05rem;
  }
  
  .test-result {
    font-weight: 600;
    color: #28a745;
    font-size: 1.05rem;
  }
  
  .test-date {
    color: #6c757d;
    font-size: 0.95rem;
  }
  
  .test-status {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
  }
  
  .badge-not-performed {
    background-color: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
  }
  
  .badge-performed {
    background-color: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
  }

  .card-body {
    padding: 0;
  }
  
  .card-body .list-group {
    border-radius: 0;
  }
  
  .card-body .list-group-item {
    border-left: none;
    border-right: none;
  }
  
  .card-body .list-group-item:first-child {
    border-top: none;
  }
    .category-toggle {
    transition: none; /* Remove transition for immediate response */
    margin-left: 10px;
  }
    
  .collapsed .category-toggle {
    transform: rotate(-90deg);
  }
  
  /* Direct editing styles */
  .direct-edit-container {
    padding: 10px;
    transition: all 0.2s;
  }
  
  .direct-edit-container:focus-within {
    background-color: #f8f9fa;
    border-radius: 4px;
    box-shadow: 0 0 0 0.2rem rgba(59, 125, 221, 0.25);
  }
  
  .edit-input,
  .edit-select,
  .edit-date {
    width: 100%;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  }
  
  .edit-input:focus,
  .edit-select:focus,
  .edit-date:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  
  .category-actions {
    display: flex;
    gap: 5px;
  }
  
  .btn-edit-category, .btn-save-category, .btn-delete-category {
    min-width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
  }
  
  /* Styling for view mode */
  .view-mode {
    padding: 10px;
    border-radius: 4px;
  }
  
  .test-value {
    font-weight: 600;
    color: #28a745;
    font-size: 1.05rem;
    margin-bottom: 5px;
  }
  
  /* Multi-select styles */
  .category-checkbox {
    margin-right: 10px;
    transform: scale(1.25);
    cursor: pointer;
    display: none; /* Hidden by default */
  }
  
  .multi-select-mode .category-checkbox {
    display: inline-block;
  }
  
  .multi-select-mode .laboratory-category {
    background-color: #f0f8ff;
  }
  
  .selected-category {
    background-color: #e6f3ff !important;
    border-left: 4px solid #007bff !important;
  }
  
  /* Edit mode styles */
  .category-edit-mode .test-item {
    background-color: #f8f9fa;
  }
  
  .category-edit-mode .direct-edit-container {
    display: block !important;
  }
  
  .category-edit-mode .view-mode {
    display: none !important;
  }
  
  /* Add result button */
  .add-result-btn {
    margin-top: 10px;
    display: block;
    width: auto;
    text-align: center;
    background-color: #17a2b8;
    border-color: #17a2b8;
    color: white;
  }
  
  /* Save indicator */
  .save-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
  }
  
  /* Category being edited highlight */
  .editing-category {
    box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
    background-color: rgba(25, 135, 84, 0.05);
  }
  .view-only-mode .direct-edit-container {
  display: none !important;
  }

  .view-only-mode .view-mode {
    display: block !important;
  }

  .view-only-mode .btn-edit-category,
  .view-only-mode .btn-save-category,
  .view-only-mode .add-result-btn {
    display: none !important;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">          
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title">
              {% if edit_mode %}
                <i class="fas fa-edit me-2"></i>{% trans "Chỉnh sửa thông tin xét nghiệm" %} {{ screening_case.USUBJID }}
              {% else %}
                <i class="fas fa-flask me-2"></i>{% trans "Thông tin xét nghiệm bệnh nhân" %} {{ screening_case.USUBJID }}
              {% endif %}
            </h3>
            <div>
              {% if has_laboratory_tests %}
                <!-- Khi đã có xét nghiệm, hiển thị nút chuyển đổi chế độ -->
                {% if edit_mode %}
                  <a href="{% url '43en:laboratory_test_list' screening_case.USUBJID %}" class="btn btn-info btn-sm me-2">
                    <i class="fas fa-eye"></i> {% trans "Chuyển sang chế độ xem" %}
                  </a>
                {% else %}
                  <a href="{% url '43en:laboratory_test_list' screening_case.USUBJID %}?mode=edit" class="btn btn-warning btn-sm me-2">
                    <i class="fas fa-edit"></i> {% trans "Chuyển sang chế độ chỉnh sửa" %}
                  </a>
                {% endif %}
              {% endif %}
              <!-- Thêm nút chuyển tiếp đến trang nuôi cấy vi sinh -->
              <a href="{% url 'microbiology_culture_list' usubjid=screening_case.USUBJID %}" class="btn btn-primary btn-sm me-2">
                <i class="fas fa-flask"></i> {% trans "Nuôi cấy vi sinh" %}
              </a>
              <a href="{% url 'clinical_case_update' usubjid=screening_case.USUBJID %}" class="btn btn-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> {% trans "Quay lại thông tin lâm sàng" %}
              </a>
            </div>
          </div>
        </div>
        
        <div class="card-body p-0">
          {% if not lab_tests_by_category %}
            <div class="alert alert-info m-3">
              {% trans "Chưa có thông tin xét nghiệm nào được tạo. Vui lòng tạo mới xét nghiệm." %}
            </div>
            <div class="text-center my-4">
              <p>{% trans "Bạn cần tạo các xét nghiệm cơ bản cho bệnh nhân này." %}</p>
              <button id="btnCreateDefaultTests" class="btn btn-lg btn-success">
                <i class="fas fa-plus-circle me-2"></i> {% trans "Tạo xét nghiệm cho bệnh nhân" %}
              </button>
            </div>
          {% else %}
            <div class="accordion" id="laboratory-accordion">
              {% for category, tests in lab_tests_by_category.items %}
              <div class="laboratory-card" id="category-{{ tests.0.category }}" data-category-code="{{ tests.0.category }}">
                <div class="card-header collapsed" id="heading-{{ forloop.counter }}" data-target="#collapse-{{ forloop.counter }}">
                  <div class="laboratory-category">
                    <div style="display: flex; align-items: center;">
                      <input type="checkbox" class="category-checkbox" data-category="{{ tests.0.category }}" id="checkbox-{{ tests.0.category }}">
                      <span>{{ category }}</span>
                      <i class="fas fa-chevron-down category-toggle ms-2 collapsed"></i>
                    </div>
                    <div class="category-actions">
                      <!-- Ban đầu chỉ hiển thị nút Lưu thay đổi -->
                      <button class="btn btn-info btn-sm btn-edit-category" data-category="{{ tests.0.category }}" style="display: none;">
                        <i class="fas fa-edit"></i> {% trans "Chỉnh sửa nhóm" %}
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- Removed data-parent attribute to allow multiple sections to be open -->
                <div id="collapse-{{ forloop.counter }}" class="collapse" aria-labelledby="heading-{{ forloop.counter }}">
                  <div class="card-body">
                    <div class="list-group category-tests" id="tests-{{ tests.0.category }}">
                      {% if tests.0.category|stringformat:"s" in "CHEST_XRAY,ABDOMINAL_ULTRASOUND,BRAIN_CT_MRI,CHEST_ABDOMEN_CT,ECHOCARDIOGRAPHY,SOFT_TISSUE_ULTRASOUND" %}
                      <div class="list-group-item">
                        <button class="btn btn-info add-result-btn" data-category="{{ tests.0.category }}">
                          <i class="fas fa-plus"></i> {% trans "Thêm kết quả" %}
                        </button>
                      </div>
                      {% endif %}
                      {% for test in tests %}
                      <div class="list-group-item test-item" id="test-item-{{ test.id }}">
                        <div class="row">
                          <div class="col-md-4">
                            <span class="test-name">{{ test.get_test_type_display }}
                              {% if test.category in "CHEST_XRAY,ABDOMINAL_ULTRASOUND,BRAIN_CT_MRI,CHEST_ABDOMEN_CT,ECHOCARDIOGRAPHY,SOFT_TISSUE_ULTRASOUND" and test.sequence > 1 %}
                                <span class="badge bg-info">#{{ test.sequence }}</span>
                              {% endif %}
                            </span>
                            <div class="test-date">
                              {% if test.performed and test.performed_date %}
                                {% trans "Thực hiện ngày" %}: {{ test.performed_date|date:"d/m/Y" }}
                              {% elif test.performed %}
                                {% trans "Đã thực hiện" %}
                              {% else %}
                                {% trans "Chưa thực hiện" %}
                              {% endif %}
                            </div>
                          </div>
                          <div class="col-md-8">                            <div class="direct-edit-container">
                              <div class="row">
                                <div class="col-md-6">
                                  <div class="form-group">
                                    <label>{% trans "Kết quả" %}:</label>
                                    <input type="text" class="form-control edit-input" name="result" value="{{ test.result|default:'' }}" data-test-id="{{ test.id }}">
                                  </div>
                                </div>
                                <div class="col-md-3">
                                  <div class="form-group">
                                    <label>{% trans "Ngày thực hiện" %}:</label>
                                    <input type="date" class="form-control edit-date" name="performed_date" value="{{ test.performed_date|date:'Y-m-d'|default:'' }}" data-test-id="{{ test.id }}">
                                  </div>
                                </div>
                                <div class="col-md-3">
                                  <div class="form-group">
                                    <label>{% trans "Trạng thái" %}:</label>
                                    <select class="form-control edit-select" name="performed" data-test-id="{{ test.id }}">
                                      <option value="true" {% if test.performed %}selected{% endif %}>{% trans "Đã thực hiện" %}</option>
                                      <option value="false" {% if not test.performed %}selected{% endif %}>{% trans "Chưa thực hiện" %}</option>
                                    </select>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="view-mode">
                              {% if test.result %}
                              <div class="test-value">{{ test.result }}</div>
                              {% endif %}
                              <div class="d-flex justify-content-end">
                                <a href="{% url 'laboratory_test_delete' usubjid=screening_case.USUBJID test_id=test.id %}" class="btn btn-outline-danger btn-sm">
                                  <i class="fas fa-trash"></i>
                                </a>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      {% endfor %}
                      <!-- Nút Lưu thay đổi ở cuối mỗi category -->
                      <div class="list-group-item text-end">
                        <button class="btn btn-success btn-save-category" data-category="{{ tests.0.category }}">
                          <i class="fas fa-save"></i> {% trans "Lưu thay đổi" %}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}            
            </div>
          {% endif %}
        </div>
        
        <!-- Workflow Navigation -->
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <a href="{% url 'clinical_case_update' usubjid=screening_case.USUBJID %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Quay lại thông tin lâm sàng" %}
              </a>
            </div>      
            <div>
              <a href="{% url 'microbiology_culture_list' usubjid=screening_case.USUBJID %}" class="btn btn-primary">
                <i class="fas fa-flask"></i> {% trans "Tiếp tục đến Nuôi cấy vi sinh" %} <i class="fas fa-arrow-right"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Save indicator alert -->
<div id="saveIndicator" class="alert alert-success alert-dismissible fade save-indicator" role="alert" style="display: none;">
  <i class="fas fa-check-circle me-2"></i>
  <span id="saveMessage">{% trans "Thay đổi đã được lưu!" %}</span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    // Configure Bootstrap collapse to have no transition duration
    $.fn.collapse.Constructor.Default.duration = 0;

    // Kiểm tra chế độ xem/chỉnh sửa
    const editMode = {% if edit_mode %}true{% else %}false{% endif %};
    
    // Cấu hình trang dựa trên chế độ
    if (!editMode) {
      // Chế độ xem: vô hiệu hóa tất cả các trường nhập liệu
      $('.direct-edit-container input, .direct-edit-container select').prop('disabled', true);
      $('.btn-edit-category, .btn-save-category').hide();
      $('.add-result-btn').hide();
    }
    
    // Khi trang load, kiểm tra từng category xem đã có kết quả hay chưa
    $('.laboratory-card').each(function() {
      const categoryCard = $(this);
      let hasAnyResult = false;
      
      // Kiểm tra xem có kết quả nào không
      categoryCard.find('.test-item').each(function() {
        const result = $(this).find('input[name="result"]').val();
        if (result && result.trim() !== '') {
          hasAnyResult = true;
          return false; // Thoát vòng lặp khi đã tìm thấy kết quả
        }
      });
      
      if (!editMode) {
        // Nếu ở chế độ xem: luôn hiển thị ở chế độ xem, không có nút chỉnh sửa
        categoryCard.removeClass('category-edit-mode');
        categoryCard.find('.btn-save-category, .btn-edit-category').hide();
        categoryCard.find('.direct-edit-container').hide();
        categoryCard.find('.view-mode').show();
      } else {
        // Nếu ở chế độ chỉnh sửa
        if (hasAnyResult) {
          // Nếu đã có kết quả: hiển thị ở chế độ xem, với nút "Chỉnh sửa nhóm"
          categoryCard.removeClass('category-edit-mode');
          categoryCard.find('.btn-save-category').hide();
          categoryCard.find('.btn-edit-category').show();
          categoryCard.find('.direct-edit-container').hide();
          categoryCard.find('.view-mode').show();
        } else {
          // Nếu chưa có kết quả: đặt vào chế độ chỉnh sửa
          categoryCard.addClass('category-edit-mode');
          categoryCard.find('.btn-save-category').show();
          categoryCard.find('.btn-edit-category').hide();
          categoryCard.find('.direct-edit-container').show();
          categoryCard.find('.view-mode').hide();
        }
      }
    });
    
    // Prevent propagation of click events from buttons and interactive elements
    $('.btn-edit-category, .btn-save-category, .category-checkbox').click(function(e) {
      e.stopPropagation();
    });
    
    // Category edit mode toggle
    $('.btn-edit-category').on('click', function(e) {
      e.preventDefault();
      const categoryCode = $(this).data('category');
      const categoryCard = $(`#category-${categoryCode}`);
      
      // Show save button, hide edit button
      $(this).hide();
      categoryCard.find('.btn-save-category').show();
      
      // Set edit mode class
      categoryCard.addClass('category-edit-mode');
      categoryCard.addClass('editing-category');
      
      // Show all edit containers in this category
      categoryCard.find('.direct-edit-container').show();
      categoryCard.find('.view-mode').hide();
      
      // Mở rộng category nếu đang đóng
      const collapseId = categoryCard.find('.card-header').attr('data-target');
      const cardHeader = categoryCard.find('.card-header');
      $(collapseId).collapse('show');
      cardHeader.removeClass('collapsed');
      cardHeader.find('.category-toggle').removeClass('collapsed');
    });
    
    // Category save button
    $('.btn-save-category').on('click', function(e) {
      e.preventDefault();
      const categoryCode = $(this).data('category');
      const categoryCard = $(`#category-${categoryCode}`);
      const saveBtn = $(this);
      
      // Show saving indicator
      const originalText = saveBtn.html();
      saveBtn.html('<i class="fas fa-spinner fa-spin"></i> {% trans "Đang lưu..." %}');
      saveBtn.prop('disabled', true);
      
      // Get all tests in this category
      const testItems = categoryCard.find('.test-item');
      let savedCount = 0;
      let totalTests = testItems.length;
      let errors = false;
      let hasAnyResult = false; // Track if any test has a result
      
      // Check if any test has a result
      testItems.each(function() {
        const result = $(this).find('input[name="result"]').val();
        if (result && result.trim() !== '') {
          hasAnyResult = true;
        }
      });
      
      // If no tests to save, just finalize the save operation
      if (totalTests === 0) {
        finalizeSave(hasAnyResult);
        return;
      }
      
      // Save each test with AJAX
      testItems.each(function(index) {
        const testId = $(this).attr('id').replace('test-item-', '');
        const result = $(this).find('input[name="result"]').val();
        const performedDate = $(this).find('input[name="performed_date"]').val();
        const performed = $(this).find('select[name="performed"]').val() === 'true';
        
        $.ajax({
          url: `/43en/{{ usubjid }}/laboratory/inline-update/`,
          method: 'POST',
          data: {
            'test_id': testId,
            'result': result,
            'performed_date': performedDate,
            'performed': performed,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
          },
          success: function() {
            savedCount++;
            
            // If all tests saved
            if (savedCount === totalTests) {
              finalizeSave(hasAnyResult);
            }
          },
          error: function() {
            errors = true;
            savedCount++;
            
            // If all tests processed (even with errors)
            if (savedCount === totalTests) {
              finalizeSave(hasAnyResult);
            }
          }
        });
      });
      
      // Function to handle save completion
      function finalizeSave(hasResults) {
        // Restore button state
        saveBtn.html(originalText);
        saveBtn.prop('disabled', false);
        
        if (hasResults) {
          // Nếu có kết quả: hiển thị nút Chỉnh sửa nhóm, ẩn nút Lưu thay đổi
          saveBtn.hide();
          categoryCard.find('.btn-edit-category').show();
          
          // Exit edit mode
          categoryCard.removeClass('category-edit-mode');
          categoryCard.removeClass('editing-category');
          
          // Hide edit containers, show view mode
          categoryCard.find('.direct-edit-container').hide();
          categoryCard.find('.view-mode').show();
        } else {
          // Nếu không có kết quả: giữ nguyên ở chế độ chỉnh sửa
          // nhưng bỏ class editing-category để không có highlight
          categoryCard.removeClass('editing-category');
          
          // Vẫn hiện nút Lưu thay đổi, ẩn nút Chỉnh sửa nhóm
          saveBtn.show();
          categoryCard.find('.btn-edit-category').hide();
          
          // Giữ form chỉnh sửa hiện
          categoryCard.find('.direct-edit-container').show();
          categoryCard.find('.view-mode').hide();
          
          // Vẫn giữ category mở
          const collapseId = categoryCard.find('.card-header').attr('data-target');
          $(collapseId).collapse('show');
          categoryCard.find('.card-header').removeClass('collapsed')
            .find('.category-toggle').removeClass('collapsed');
        }
        
        // Show success/error message
        if (!errors) {
          showSaveIndicator('{% trans "Thay đổi đã được lưu thành công!" %}', 'success');
          
          // Update display with current data
          updateCategoryDisplay(categoryCard);
        } else {
          showSaveIndicator('{% trans "Có lỗi xảy ra khi lưu một số xét nghiệm!" %}', 'danger');
        }
      }
    });
    
    // Update category display with current data
    function updateCategoryDisplay(categoryCard) {
      // Kiểm tra xem category có bất kỳ kết quả nào không
      let hasAnyResult = false;
      
      categoryCard.find('.test-item').each(function() {
        const result = $(this).find('input[name="result"]').val();
        const performedDate = $(this).find('input[name="performed_date"]').val();
        const performed = $(this).find('select[name="performed"]').val() === 'true';
        
        // Kiểm tra xem có kết quả không
        if (result && result.trim() !== '') {
          hasAnyResult = true;
        }
        
        // Update view mode
        const viewMode = $(this).find('.view-mode');
        
        // Update result value
        if (result) {
          if (viewMode.find('.test-value').length) {
            viewMode.find('.test-value').text(result);
          } else {
            viewMode.prepend(`<div class="test-value">${result}</div>`);
          }
          viewMode.show();
        } else {
          viewMode.find('.test-value').remove();
          viewMode.hide();
        }
        
        // Update date/status display
        const dateDisplay = $(this).find('.test-date');
        if (performed) {
          if (performedDate) {
            const formattedDate = new Date(performedDate).toLocaleDateString('vi-VN');
            dateDisplay.html(`{% trans "Thực hiện ngày" %}: ${formattedDate}`);
          } else {
            dateDisplay.html(`{% trans "Đã thực hiện" %}`);
          }
        } else {
          dateDisplay.html(`{% trans "Chưa thực hiện" %}`);
        }
      });
      
      // Cập nhật hiển thị nút dựa vào kết quả
      if (hasResults) {
        // Nếu có kết quả: hiển thị nút Chỉnh sửa nhóm, ẩn nút Lưu thay đổi
        categoryCard.find('.btn-save-category').hide();
        categoryCard.find('.btn-edit-category').show();
        
        // Exit edit mode
        categoryCard.removeClass('category-edit-mode');
        categoryCard.removeClass('editing-category');
        
        // Hide edit containers, show view mode
        categoryCard.find('.direct-edit-container').hide();
        categoryCard.find('.view-mode').show();
      } else {
        // Nếu không có kết quả: giữ nguyên ở chế độ chỉnh sửa
        // nhưng bỏ class editing-category để không có highlight
        categoryCard.removeClass('editing-category');
        
        // Vẫn hiện nút Lưu thay đổi, ẩn nút Chỉnh sửa nhóm
        categoryCard.find('.btn-save-category').show();
        categoryCard.find('.btn-edit-category').hide();
        
        // Giữ form chỉnh sửa hiện
        categoryCard.find('.direct-edit-container').show();
        categoryCard.find('.view-mode').hide();
        
        // Vẫn giữ category mở
        const collapseId = categoryCard.find('.card-header').attr('data-target');
        $(collapseId).collapse('show');
        categoryCard.find('.card-header').removeClass('collapsed')
          .find('.category-toggle').removeClass('collapsed');
      }
    }
    
    // Show save indicator
    function showSaveIndicator(message, type = 'success') {
      const indicator = $('#saveIndicator');
      indicator.removeClass('alert-success alert-danger alert-warning')
               .addClass(`alert-${type}`);
      
      $('#saveMessage').text(message);
      indicator.fadeIn().addClass('show');
      
      // Auto hide after 3 seconds
      setTimeout(function() {
        indicator.fadeOut().removeClass('show');
      }, 3000);
    }
    
    // Multi-select functionality
    let selectMode = false;
    let selectedCategories = [];
    
    // Enter multi-select mode
    $('#btnSelectMode').on('click', function() {
      selectMode = !selectMode;
      const $body = $('body');
      
      if (selectMode) {
        // Enable multi-select mode
        $body.addClass('multi-select-mode');
        $(this).html('<i class="fas fa-times"></i> {% trans "Hủy chọn" %}');
        $(this).removeClass('btn-outline-primary').addClass('btn-outline-secondary');
        $('#btnDeleteGroups').show();
        
        // Update button text
        updateSelectedCount();
      } else {
        // Disable multi-select mode
        $body.removeClass('multi-select-mode');
        $(this).html('<i class="fas fa-check-square"></i> {% trans "Chọn nhiều nhóm" %}');
        $(this).removeClass('btn-outline-secondary').addClass('btn-outline-primary');
        $('#btnDeleteGroups').hide();
        
        // Clear selections
        $('.category-checkbox').prop('checked', false);
        $('.card-header').removeClass('selected-category');
        
        selectedCategories = [];
        updateSelectedCount();
      }
    });
    
    // Handle checkbox clicks
    $('.category-checkbox').on('click', function(e) {
      e.stopPropagation(); // Prevent card from toggling
      
      const category = $(this).data('category');
      const isChecked = $(this).prop('checked');
      const cardHeader = $(this).closest('.card-header');
      
      if (isChecked) {
        // Add to selected categories
        selectedCategories.push(category);
        cardHeader.addClass('selected-category');
      } else {
        // Remove from selected categories
        selectedCategories = selectedCategories.filter(c => c !== category);
        cardHeader.removeClass('selected-category');
      }
      
      updateSelectedCount();
    });
    
    // Update selected count badge
    function updateSelectedCount() {
      $('#selectedCount').text(selectedCategories.length);
      
      if (selectedCategories.length > 0) {
        $('#btnDeleteGroups').removeClass('btn-outline-danger').addClass('btn-danger');
      } else {
        $('#btnDeleteGroups').removeClass('btn-danger').addClass('btn-outline-danger');
      }
    }
    
    // Handle bulk delete
    $('#btnDeleteGroups').on('click', function() {
      if (selectedCategories.length === 0) {
        alert('{% trans "Vui lòng chọn ít nhất một nhóm xét nghiệm để xóa." %}');
        return;
      }
      
      if (confirm(`{% trans "Bạn có chắc chắn muốn xóa" %} ${selectedCategories.length} {% trans "nhóm xét nghiệm đã chọn không?" %}`)) {
        // Delete categories one by one using Promise.all
        const deletePromises = selectedCategories.map(category => {
          return new Promise((resolve, reject) => {
            $.ajax({
              url: `/43en/{{ usubjid }}/laboratory/category/${category}/delete/`,
              method: 'POST',
              data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
              },
              success: function(response) {
                resolve(response);
              },
              error: function(error) {
                reject(error);
              }
            });
          });
        });
        
        Promise.all(deletePromises)
          .then(() => {
            // All deletions successful, reload page
            location.reload();
          })
          .catch(error => {
            alert('{% trans "Có lỗi xảy ra khi xóa nhóm xét nghiệm. Vui lòng thử lại!" %}');
            console.error(error);
          });
      }
    });

    // Xử lý nút tạo xét nghiệm mặc định
    $('#btnCreateDefaultTests').on('click', function() {
      const btn = $(this);
      const originalText = btn.html();
      
      // Hiển thị trạng thái đang xử lý
      btn.html('<i class="fas fa-spinner fa-spin me-2"></i> {% trans "Đang tạo..." %}');
      btn.prop('disabled', true);
      
      // Gọi API tạo xét nghiệm mặc định
      $.ajax({
        url: `/43en/{{ screening_case.USUBJID }}/laboratory/create-defaults/`,
        method: 'POST',
        data: {
          'csrfmiddlewaretoken': '{{ csrf_token }}'
        },
        success: function(response) {
          if (response.success) {
            showSaveIndicator('{% trans "Đã tạo xét nghiệm thành công!" %}', 'success');
            // Reload trang sau khi tạo thành công
            setTimeout(function() {
              location.reload();
            }, 1500);
          } else {
            showSaveIndicator(response.message || '{% trans "Có lỗi xảy ra khi tạo xét nghiệm!" %}', 'danger');
            btn.html(originalText);
            btn.prop('disabled', false);
          }
        },
        error: function() {
          showSaveIndicator('{% trans "Có lỗi xảy ra khi tạo xét nghiệm!" %}', 'danger');
          btn.html(originalText);
          btn.prop('disabled', false);
        }
      });
    });
    
    // Xử lý click cho card header - theo cách mới để có thể mở/đóng card
    $('.card-header').on('click', function(e) {
      // Nếu click vào các nút, không xử lý toggle
      if ($(e.target).closest('.btn, .category-actions').length > 0) {
        return;
      }
      
      if (selectMode) {
        e.preventDefault();
        // Toggle checkbox nếu đang ở chế độ chọn nhiều
        const checkbox = $(this).find('.category-checkbox');
        const isChecked = !checkbox.prop('checked');
        checkbox.prop('checked', isChecked);
        
        const category = checkbox.data('category');
        if (isChecked) {
          selectedCategories.push(category);
          $(this).addClass('selected-category');
        } else {
          selectedCategories = selectedCategories.filter(c => c !== category);
          $(this).removeClass('selected-category');
        }
        updateSelectedCount();
      } else {
        // Xử lý mở/đóng collapse
        const collapseId = $(this).attr('data-target');
        $(this).toggleClass('collapsed');
        $(this).find('.category-toggle').toggleClass('collapsed');
        $(collapseId).collapse('toggle');
      }
    });
    
    // Add test result for imaging categories
    $('.add-result-btn').on('click', function(e) {
      e.preventDefault();
      const category = $(this).data('category');
      const $listGroup = $(this).closest('.list-group');
      // Get category display name
      const categoryDisplayName = $(this).closest('.laboratory-card').find('.laboratory-category span').text().trim();
      
      // Create new result form with the same structure as the regular test items
      const $newResultForm = $(`
        <div class="list-group-item test-item new-result-item">
          <div class="row">
            <div class="col-md-4">
              <span class="test-name">${categoryDisplayName}</span>
              <div class="test-date">
                {% trans "Thêm mới" %}
              </div>
              <!-- Hidden field for test_type, automatically set to the category's value -->
              <input type="hidden" name="new_test_type" value="${category}">
            </div>
            <div class="col-md-8">
              <div class="direct-edit-container active-editing">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label>{% trans "Kết quả" %}:</label>
                      <input type="text" class="form-control edit-input" name="new_result" placeholder="Nhập kết quả">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-group">
                      <label>{% trans "Ngày thực hiện" %}:</label>
                      <input type="date" class="form-control edit-date" name="new_performed_date" value="${new Date().toISOString().split('T')[0]}">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="form-group">
                      <label>{% trans "Trạng thái" %}:</label>
                      <select class="form-control edit-select" name="new_performed">
                        <option value="true" selected>{% trans "Đã thực hiện" %}</option>
                        <option value="false">{% trans "Chưa thực hiện" %}</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="row mt-3">
                  <div class="col-12 d-flex justify-content-end">
                    <button class="btn btn-success btn-sm btn-save-new me-2" data-category="${category}">
                      <i class="fas fa-save"></i> {% trans "Lưu" %}
                    </button>
                    <button class="btn btn-secondary btn-sm btn-cancel-new">
                      <i class="fas fa-times"></i> {% trans "Hủy" %}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `);
      
      // Insert form after add button
      $newResultForm.insertAfter($(this).closest('.list-group-item'));
      // No need to load test types since we're using the category itself
      
      // Cancel button event
      $newResultForm.find('.btn-cancel-new').on('click', function() {
        $newResultForm.remove();
      });
      
      // Save new test event
      $newResultForm.find('.btn-save-new').on('click', function() {
        const category = $(this).data('category');
        const testType = category; // Use the category itself as the test type
        const result = $newResultForm.find('input[name="new_result"]').val();
        const performedDate = $newResultForm.find('input[name="new_performed_date"]').val();
        const performed = $newResultForm.find('select[name="new_performed"]').val() === 'true';
        
        if (!result) {
          alert('{% trans "Vui lòng nhập kết quả xét nghiệm!" %}');
          return;
        }
        
        // Show saving indicator
        const saveBtn = $(this);
        const originalText = saveBtn.html();
        saveBtn.html('<i class="fas fa-spinner fa-spin"></i> {% trans "Đang lưu..." %}');
        saveBtn.prop('disabled', true);
        
        // Send AJAX to create new test
        $.ajax({
          url: `/43en/{{ usubjid }}/laboratory/quick-create/`,
          method: 'POST',
          data: {
            'test_type': testType,
            'category': category,
            'result': result,
            'performed_date': performedDate,
            'performed': performed,
            'csrfmiddlewaretoken': '{{ csrf_token }}'
          },
          success: function(response) {
            if (response.success) {
              showSaveIndicator('{% trans "Tạo xét nghiệm thành công!" %}', 'success');
              
              // Reload page to show new test
              setTimeout(() => {
                location.reload();
              }, 1000);
            } else {
              showSaveIndicator(response.message || '{% trans "Có lỗi xảy ra. Vui lòng thử lại!" %}', 'danger');
              saveBtn.html(originalText);
              saveBtn.prop('disabled', false);
            }
          },
          error: function() {
            showSaveIndicator('{% trans "Có lỗi xảy ra khi tạo xét nghiệm. Vui lòng thử lại!" %}', 'danger');
            saveBtn.html(originalText);
            saveBtn.prop('disabled', false);
          }
        });
      });
    });
  });
</script>
{% endblock %}
