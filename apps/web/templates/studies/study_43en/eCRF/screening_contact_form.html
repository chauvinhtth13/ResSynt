{% extends "study_43en/base_43en.html" %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block title %}{{ title }}{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">{% trans "Dashboard" %}</a></li>
<li class="breadcrumb-item"><a href="{% url 'screening_contact_list' %}">{% trans "Người tiếp xúc" %}</a></li>
<li class="breadcrumb-item active">{{ title }}</li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header{% if is_view_only %} bg-info{% endif %}">
        <h3 class="card-title">
          <i class="fas fa-user-friends mr-2"></i>
          {% trans "Thông tin Người tiếp xúc" %}
        </h3>
        {% if is_view_only %}
          <span class="badge badge-warning readonly-badge">
            <i class="fas fa-eye"></i> {% trans "Chỉ xem" %}
          </span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if form.errors %}
          <div class="alert alert-danger alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            <h5><i class="icon fas fa-ban"></i> {% trans "Lỗi!" %}</h5>
            <ul>
              {% for field in form %}
                {% for error in field.errors %}
                  <li><strong>{{ field.label }}</strong>: {{ error }}</li>
                {% endfor %}
              {% endfor %}
              {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if not is_view_only %}
        <form method="post" id="screeningContactForm">
          {% csrf_token %}
        {% else %}
        <div id="screeningContactFormReadonly" class="readonly-form">
        {% endif %}

        <!-- Thông tin cơ bản -->
        <div class="card card-default">
          <div class="card-header">
            <h3 class="card-title">{% trans "Thông tin cơ bản" %}</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                {% bootstrap_field form.screening_id layout='horizontal' %}
              </div>
              {# USUBJID chỉ render nếu có trong form.fields #}
              {% if form.USUBJID %}
              <div class="col-md-6">
                {% bootstrap_field form.USUBJID layout='horizontal' %}
              </div>
              {% endif %}
              <div class="col-md-6">
                {% bootstrap_field form.SITEID layout='horizontal' %}
              </div>
              <div class="col-md-6">
                {% bootstrap_field form.INITIAL layout='horizontal' %}
              </div>
              <div class="col-md-12">
                {% bootstrap_field form.SUBJIDENROLLSTUDY layout='horizontal' %}
              </div>
              <div class="col-md-6">
                {% bootstrap_field form.SCREENINGFORMDATE layout='horizontal' field_class='datepicker' %}
              </div>
            </div>
          </div>
        </div>

        <!-- Tiêu chí tiếp xúc -->
        <div class="card card-default mt-3">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-check-circle mr-2"></i>
              {% trans "Tiêu chí tiếp xúc" %}
            </h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="control-label">{{ form.LIVEIN5DAYS3MTHS.label }}*</label>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_LIVEIN5DAYS3MTHS_1" name="LIVEIN5DAYS3MTHS" value="1" class="custom-control-input"
                  {% if form.instance.LIVEIN5DAYS3MTHS == True %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_LIVEIN5DAYS3MTHS_1">{% trans "Có" %}</label>
              </div>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_LIVEIN5DAYS3MTHS_0" name="LIVEIN5DAYS3MTHS" value="0" class="custom-control-input"
                  {% if form.instance.LIVEIN5DAYS3MTHS == False or form.instance.LIVEIN5DAYS3MTHS == None %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_LIVEIN5DAYS3MTHS_0">{% trans "Không" %}</label>
              </div>
              {% if form.LIVEIN5DAYS3MTHS.errors %}
                <div class="text-danger">{{ form.LIVEIN5DAYS3MTHS.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group">
              <label class="control-label">{{ form.MEALCAREONCEDAY.label }}*</label>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_MEALCAREONCEDAY_1" name="MEALCAREONCEDAY" value="1" class="custom-control-input"
                  {% if form.instance.MEALCAREONCEDAY == True %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_MEALCAREONCEDAY_1">{% trans "Có" %}</label>
              </div>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_MEALCAREONCEDAY_0" name="MEALCAREONCEDAY" value="0" class="custom-control-input"
                  {% if form.instance.MEALCAREONCEDAY == False or form.instance.MEALCAREONCEDAY == None %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_MEALCAREONCEDAY_0">{% trans "Không" %}</label>
              </div>
              {% if form.MEALCAREONCEDAY.errors %}
                <div class="text-danger">{{ form.MEALCAREONCEDAY.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group">
              <label class="control-label">{{ form.CONSENTTOSTUDY.label }}*</label>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_CONSENTTOSTUDY_1" name="CONSENTTOSTUDY" value="1" class="custom-control-input"
                  {% if form.instance.CONSENTTOSTUDY == True %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_CONSENTTOSTUDY_1">{% trans "Có" %}</label>
              </div>
              <div class="custom-control custom-radio">
                <input type="radio" id="id_CONSENTTOSTUDY_0" name="CONSENTTOSTUDY" value="0" class="custom-control-input"
                  {% if form.instance.CONSENTTOSTUDY == False or form.instance.CONSENTTOSTUDY == None %}checked{% endif %}
                  {% if is_view_only %}disabled{% endif %} required>
                <label class="custom-control-label" for="id_CONSENTTOSTUDY_0">{% trans "Không" %}</label>
              </div>
              {% if form.CONSENTTOSTUDY.errors %}
                <div class="text-danger">{{ form.CONSENTTOSTUDY.errors }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Thông tin hoàn thành -->
        <div class="card card-default mt-3">
          <div class="card-header">
            <h3 class="card-title">{% trans "Thông tin hoàn thành" %}</h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                {% bootstrap_field form.COMPLETEDBY layout='horizontal' %}
              </div>
              <div class="col-md-6">
                {% bootstrap_field form.COMPLETEDDATE layout='horizontal' field_class='datepicker' %}
              </div>
            </div>
          </div>
        </div>

        <!-- Nút hành động -->
        <div class="mt-4">
          {% if not is_view_only %}
            <button type="submit" class="btn btn-primary" id="submitButton">
              <i class="fas fa-save mr-1"></i> {% trans "Lưu" %}
            </button>
          {% endif %}
          <a href="{% url 'screening_contact_list' %}" class="btn btn-secondary">
            <i class="fas fa-times-circle mr-1"></i> {% if is_view_only %}{% trans "Quay lại" %}{% else %}{% trans "Hủy" %}{% endif %}
          </a>
          {% if contact and not is_view_only %}
            <a href="{% url 'screening_contact_delete' contact.USUBJID|default:contact.screening_id %}" class="btn btn-danger float-right">
              <i class="fas fa-trash"></i> {% trans "Xóa" %}
            </a>
          {% endif %}
          {% if contact.USUBJID %}
          {% if not contact.enrollmentcontact %}
            <a href="{% url 'enrollment_contact_create' usubjid=contact.USUBJID %}" class="btn btn-info">
              <i class="fas fa-user-plus"></i> Đăng ký thông tin chi tiết
            </a>
          {% else %}
            <a href="{% url 'enrollment_contact_view' usubjid=contact.USUBJID %}" class="btn btn-success">
              <i class="fas fa-eye"></i> Xem đăng ký chi tiết
            </a>
            <a href="{% url 'enrollment_contact_update' usubjid=contact.USUBJID %}" class="btn btn-warning">
              <i class="fas fa-edit"></i> Sửa đăng ký chi tiết
            </a>
          {% endif %}
        {% endif %}
        </div>

        {% if not is_view_only %}
        </form>
        {% else %}
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{% include 'study_43en/includes/datepicker_scripts.html' %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  $(document).ready(function() {
    // Cài đặt Select2
    $('.select2').select2({
      placeholder: "{% trans 'Chọn bệnh nhân' %}",
      allowClear: true
    });
    
    // Cài đặt datepicker
    $('.datepicker').datepicker({
      format: 'dd/mm/yyyy',
      autoclose: true,
      todayHighlight: true
    });
    
    // Đánh dấu các radio button có class custom-control
    $('.custom-control-input').parent().addClass('custom-control');
    
    // Kiểm tra và hiển thị popup khi tạo USUBJID mới
    $('#screeningContactForm').on('submit', function(e) {
      // Kiểm tra các điều kiện trước khi submit
      var livingTogether = $('input[name="LIVEIN5DAYS3MTHS"]:checked').val() === '1';
      var mealCare = $('input[name="MEALCAREONCEDAY"]:checked').val() === '1';
      var consent = $('input[name="CONSENTTOSTUDY"]:checked').val() === '1';
      var patient = $('select[name="SUBJIDENROLLSTUDY"]').val();
      
      if (livingTogether && mealCare && consent && patient) {
        // Nếu đủ điều kiện, submit form với AJAX
        e.preventDefault();
        var formData = $(this).serialize();
        
        $.ajax({
          type: 'POST',
          url: $(this).attr('action'),
          data: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          },
          success: function(response) {
            if (response.success && response.usubjid) {
              // Hiển thị popup với thông tin USUBJID
              Swal.fire({
                title: '{% trans "Thành công" %}',
                html: '<p>{% trans "Đã tạo mã người tiếp xúc:" %}</p><h2 class="text-primary">' + response.usubjid + '</h2>',
                icon: 'success',
                confirmButtonText: '{% trans "Đóng" %}'
              }).then((result) => {
                // Chuyển hướng sau khi đóng popup
                window.location.href = "{% url 'screening_contact_list' %}";
              });
            } else {
              // Form đã được lưu nhưng không tạo USUBJID, chuyển hướng
              window.location.href = "{% url 'screening_contact_list' %}";
            }
          },
          error: function(xhr, status, error) {
            // Nếu có lỗi, submit form theo cách thông thường
            $(this).off('submit').submit();
          }
        });
      }
    });
    
    // Nếu đang ở chế độ xem thì disable tất cả các trường
    {% if is_view_only %}
      $('#screeningContactForm input, #screeningContactForm select, #screeningContactForm textarea').attr('disabled', 'disabled');
    {% endif %}
  });
</script>
{% endblock %}