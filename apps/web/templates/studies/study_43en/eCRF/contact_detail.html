{% extends 'adminlte_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Chi tiết Contact" %} {{ screening_contact.USUBJID }}{% endblock %}

{% block page_title %}{% trans "Chi tiết Contact" %} {{ screening_contact.USUBJID }}{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url '43en:contact_list' %}">{% trans "Danh sách Contact" %}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ screening_contact.USUBJID }}</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Card -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                    <i class="fas fa-users"></i>
                    {% trans "THÔNG TIN CHI TIẾT CONTACT" %}
                </h4>
                <span class="badge bg-light text-dark fs-6">{{ screening_contact.USUBJID }}</span>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <p><strong>{% trans "USUBJID:" %}</strong> {{ screening_contact.USUBJID }}</p>
                    <p><strong>{% trans "Tên viết tắt:" %}</strong> {{ screening_contact.INITIAL }}</p>
                    <p><strong>{% trans "Screening ID:" %}</strong> {{ screening_contact.screening_id|default:"-" }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>{% trans "Bệnh nhân liên quan:" %}</strong> 
                        {% if screening_contact.SUBJIDENROLLSTUDY %}
                            <a href="{% url '43en:patient_detail' usubjid=screening_contact.SUBJIDENROLLSTUDY.USUBJID %}" class="text-primary">
                                {{ screening_contact.SUBJIDENROLLSTUDY.USUBJID }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </p>
                    <p><strong>{% trans "Ngày sàng lọc:" %}</strong> {{ screening_contact.SCREENINGFORMDATE|date:"d/m/Y"|default:"-" }}</p>
                    <p><strong>{% trans "Site ID:" %}</strong> {{ screening_contact.SITEID }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>{% trans "Hoàn thành:" %}</strong> {{ completion_percentage }}%</p>
                    <div class="progress mb-2">
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ completion_percentage }}%;" 
                             aria-valuenow="{{ completion_percentage }}" aria-valuemin="0" aria-valuemax="100">
                            {{ completion_percentage }}%
                        </div>
                    </div>
                    <p><strong>{% trans "Trạng thái:" %}</strong> 
                        {% if has_enrollment %}
                            <span class="badge bg-success">{% trans "Đã tham gia nghiên cứu" %}</span>
                        {% else %}
                            <span class="badge bg-warning">{% trans "Chưa tham gia nghiên cứu" %}</span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Card Expected Dates -->
    <div class="card mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-calendar-alt"></i>
                {% trans "Lịch dự kiến theo dõi contact" %}
            </h5>
        </div>
        <div class="card-body">
            {% if has_enrollment %}
            <table class="table table-bordered table-sm mb-0">
                <thead>
                    <tr>
                        <th>{% trans "Lần thăm khám" %}</th>
                        <th>{% trans "Mốc theo dõi" %}</th>
                        <th>{% trans "Khoảng dự kiến" %}</th>
                        <th>{% trans "Ngày dự kiến" %}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span class="badge badge-primary">V3</span></td>
                        <td>D28</td>
                        <td>
                            {% if enrollment_contact %}
                                {{ enrollment_contact.ENRDATE|date:"d/m/Y"|add_days:25|date:"d/m/Y" }} - 
                                {{ enrollment_contact.ENRDATE|date:"d/m/Y"|add_days:31|date:"d/m/Y" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <strong>
                                {% if enrollment_contact %}
                                    {{ enrollment_contact.ENRDATE|date:"d/m/Y"|add_days:28|date:"d/m/Y" }}
                                {% else %}
                                    -
                                {% endif %}
                            </strong>
                        </td>
                    </tr>
                    <tr>
                        <td><span class="badge badge-primary">V4</span></td>
                        <td>D90</td>
                        <td>
                            {% if enrollment_contact %}
                                {{ enrollment_contact.ENRDATE|date:"d/m/Y"|add_days:87|date:"d/m/Y" }} - 
                                {{ enrollment_contact.ENRDATE|date:"d/m/Y"|add_days:93|date:"d/m/Y" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <strong>
                                {% if enrollment_contact %}
                                    {{ enrollment_contact.ENRDATE|date:"d/m/Y"|add_days:90|date:"d/m/Y" }}
                                {% else %}
                                    -
                                {% endif %}
                            </strong>
                        </td>
                    </tr>
                </tbody>
            </table>
            {% else %}
            <div class="alert alert-warning mb-0">
                {% trans "Chưa có lịch dự kiến cho contact này. Contact cần được tuyển (enrollment) trước." %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Forms Table -->
    <div class="card mt-3">
        <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">
                <i class="fas fa-list"></i>
                {% trans "DANH SÁCH CÁC FORM" %}
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 5%">#</th>
                            <th style="width: 25%">{% trans "Tên Form" %}</th>
                            <th style="width: 15%">{% trans "Trạng thái" %}</th>
                            <th style="width: 15%">{% trans "Ngày cập nhật" %}</th>
                            <th style="width: 20%">{% trans "Người thực hiện" %}</th>
                            <th style="width: 20%">{% trans "Thao tác" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 1. Screening Contact -->
                        <tr>
                            <td><strong>1</strong></td>
                            <td>
                                {% trans "Sàng lọc Contact (Screening)" %}
                            </td>
                            <td>
                                <span class="badge bg-success">
                                    {% trans "Hoàn thành" %}
                                </span>
                            </td>
                            <td>{{ screening_contact.SCREENINGFORMDATE|date:"d/m/Y"|default:"-" }}</td>
                            <td>{{ screening_contact.COMPLETEDBY|default:"-" }}</td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{% url '43en:screening_contact_view' usubjid_or_id=screening_contact.USUBJID %}" 
                                       class="btn btn-info" title="{% trans 'Xem chi tiết' %}">
                                        <i class="fas fa-eye"></i> {% trans "Xem" %}
                                    </a>
                                    <a href="{% url '43en:screening_contact_update' usubjid_or_id=screening_contact.USUBJID %}" 
                                       class="btn btn-warning" title="{% trans 'Chỉnh sửa' %}">
                                        <i class="fas fa-edit"></i> {% trans "Sửa" %}
                                    </a>
                                </div>
                            </td>
                        </tr>

                        <!-- 2. Enrollment Contact -->
                        <tr>
                            <td><strong>2</strong></td>
                            <td>
                                {% trans "Tuyển Contact (Enrollment)" %}
                            </td>
                            <td>
                                {% if enrollment_contact %}
                                    <span class="badge bg-success">
                                        {% trans "Hoàn thành" %}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        {% trans "Chưa hoàn thành" %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if enrollment_contact %}
                                    {{ enrollment_contact.ENRDATE|date:"d/m/Y"|default:"-" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if enrollment_contact %}
                                    {{ enrollment_contact.COMPLETEDBY|default:"-" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% if not enrollment_contact %}
                                        <a href="{% url '43en:enrollment_contact_create' usubjid=screening_contact.USUBJID %}" 
                                           class="btn btn-success" title="{% trans 'Tạo enrollment' %}">
                                            <i class="fas fa-plus"></i> {% trans "Tạo" %}
                                        </a>
                                    {% else %}
                                        <a href="{% url '43en:enrollment_contact_view' usubjid=screening_contact.USUBJID %}" 
                                           class="btn btn-info" title="{% trans 'Xem chi tiết' %}">
                                            <i class="fas fa-eye"></i> {% trans "Xem" %}
                                        </a>
                                        <a href="{% url '43en:enrollment_contact_update' usubjid=screening_contact.USUBJID %}" 
                                           class="btn btn-warning" title="{% trans 'Chỉnh sửa' %}">
                                            <i class="fas fa-edit"></i> {% trans "Sửa" %}
                                        </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                        <!-- 3. Sample Collection -->
                        <tr>
                            <td><strong>3</strong></td>
                            <td>
                                {% trans "Mẫu thu thập Contact (Sample Collection)" %}
                                {% if sample_count > 0 %}
                                    <span class="badge bg-info ms-2">{{ sample_count }} {% trans "mẫu" %}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if has_sample %}
                                    <span class="badge bg-success">
                                        {% trans "Hoàn thành" %}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        {% trans "Chưa hoàn thành" %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if sample_collection %}
                                    {{ sample_collection.COMPLETEDDATE|date:"d/m/Y"|default:"-" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if sample_collection %}
                                    {{ sample_collection.COMPLETEDBY|default:"-" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% if enrollment_contact %}
                                        {% if not has_sample %}
                                            <a href="{% url '43en:contact_sample_collection_list' usubjid=screening_contact.USUBJID %}" 
                                               class="btn btn-success" title="{% trans 'Tạo mẫu thu thập' %}">
                                                <i class="fas fa-plus"></i> {% trans "Tạo" %}
                                            </a>
                                        {% else %}
                                            <a href="{% url '43en:contact_sample_collection_list' usubjid=screening_contact.USUBJID %}" 
                                               class="btn btn-info" title="{% trans 'Xem danh sách mẫu' %}">
                                                <i class="fas fa-eye"></i> {% trans "Xem" %}
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small">
                                            <i class="fas fa-info-circle"></i>
                                            {% trans "Cần hoàn thành Enrollment trước" %}
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                        <!-- 4. Follow-up 28 ngày -->
                        <tr>
                            <td><strong>4</strong></td>
                            <td>
                                {% trans "Theo dõi Contact 28 ngày (Follow-up)" %}
                            </td>
                            <td>
                                {% if followup_28 %}
                                    <span class="badge bg-success">
                                        {% trans "Hoàn thành" %}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        {% trans "Chưa hoàn thành" %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if followup_28 %}
                                    {{ followup_28.FU28ASSESSDATE|date:"d/m/Y"|default:"-" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if followup_28 %}
                                    {{ followup_28.COMPLETEDBY|default:"-" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% if enrollment_contact %}
                                        {% if not followup_28 %}
                                            <a href="{% url '43en:contact_followup_28_edit' usubjid=screening_contact.USUBJID %}" 
                                               class="btn btn-success" title="{% trans 'Tạo follow-up 28 ngày' %}">
                                                <i class="fas fa-plus"></i> {% trans "Tạo" %}
                                            </a>
                                        {% else %}
                                            <a href="{% url '43en:contact_followup_28_view' usubjid=screening_contact.USUBJID %}" 
                                               class="btn btn-info" title="{% trans 'Xem follow-up 28 ngày' %}">
                                                <i class="fas fa-eye"></i> {% trans "Xem" %}
                                            </a>
                                            <a href="{% url '43en:contact_followup_28_edit' usubjid=screening_contact.USUBJID %}" 
                                               class="btn btn-warning" title="{% trans 'Chỉnh sửa follow-up 28 ngày' %}">
                                                <i class="fas fa-edit"></i> {% trans "Sửa" %}
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small">
                                            <i class="fas fa-info-circle"></i>
                                            {% trans "Cần hoàn thành Enrollment trước" %}
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>

                        <!-- 5. Follow-up 90 ngày -->
                        <tr>
                            <td><strong>5</strong></td>
                            <td>
                                {% trans "Theo dõi Contact 90 ngày (Follow-up)" %}
                            </td>
                            <td>
                                {% if followup_90 %}
                                    <span class="badge bg-success">
                                        {% trans "Hoàn thành" %}
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        {% trans "Chưa hoàn thành" %}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {% if followup_90 %}
                                    {{ followup_90.FU90ASSESSDATE|date:"d/m/Y"|default:"-" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if followup_90 %}
                                    {{ followup_90.COMPLETEDBY|default:"-" }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% if enrollment_contact %}
                                        {% if not followup_90 %}
                                            <a href="{% url '43en:contact_followup_90_edit' usubjid=screening_contact.USUBJID %}" 
                                               class="btn btn-success" title="{% trans 'Tạo follow-up 90 ngày' %}">
                                                <i class="fas fa-plus"></i> {% trans "Tạo" %}
                                            </a>
                                        {% else %}
                                            <a href="{% url '43en:contact_followup_90_view' usubjid=screening_contact.USUBJID %}" 
                                               class="btn btn-info" title="{% trans 'Xem follow-up 90 ngày' %}">
                                                <i class="fas fa-eye"></i> {% trans "Xem" %}
                                            </a>
                                            <a href="{% url '43en:contact_followup_90_edit' usubjid=screening_contact.USUBJID %}" 
                                               class="btn btn-warning" title="{% trans 'Chỉnh sửa follow-up 90 ngày' %}">
                                                <i class="fas fa-edit"></i> {% trans "Sửa" %}
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted small">
                                            <i class="fas fa-info-circle"></i>
                                            {% trans "Cần hoàn thành Enrollment trước" %}
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>



    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.progress {
    height: 20px;
}

.completed-items, .pending-items {
    line-height: 1.8;
}

.completed-items div, .pending-items div {
    padding: 2px 0;
}

.table th {
    background-color: #343a40;
    color: white;
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
}

.table td {
    vertical-align: middle;
    text-align: center;
}

.table td:first-child {
    font-weight: bold;
}

.table td:nth-child(2) {
    text-align: left;
}

.badge {
    font-size: 0.875em;
}

.card-title {
    font-weight: 600;
}

.btn-group .btn {
    margin-right: 0.25rem;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

.fs-6 {
    font-size: 1.1rem !important;
}

.card-body h5 {
    color: #495057;
}

.card-body p {
    margin-bottom: 0.5rem;
}

.quick-stats .card {
    transition: transform 0.2s;
}

.quick-stats .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .table-responsive .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .btn-lg {
        padding: 0.5rem 1rem;
        font-size: 1rem;
    }
    
    .card-body h4 {
        font-size: 1.1rem;
    }
    
    .progress {
        height: 15px;
    }
}

@media (max-width: 576px) {
    .btn-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .btn-group .btn {
        margin-right: 0;
        width: 100%;
    }
    
    .action-buttons .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
}

/* Print styles */
@media print {
    .btn, .breadcrumb {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        break-inside: avoid;
    }
    
    .card-header {
        background-color: #f8f9fa !important;
        color: #000 !important;
    }
    
    .badge {
        border: 1px solid #000;
    }
}
</style>
{% endblock %}
