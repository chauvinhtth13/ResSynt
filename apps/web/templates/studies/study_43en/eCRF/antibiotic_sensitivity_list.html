{% extends 'adminlte_base.html' %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}
{% load antibiotic_filters %}

{% block title %}{% trans "Độ nhạy kháng sinh" %}{% endblock %}

{% block page_title %}{% trans "Độ nhạy kháng sinh" %}{% endblock %}

<!-- Xóa block extra_css đầu tiên ở đây -->

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'screening_case_list' %}">{% trans "Danh sách Bệnh nhân 43EN" %}</a></li>                <li class="breadcrumb-item"><a href="{% url 'patient_detail' usubjid=screening_case.USUBJID %}">{% trans "Bệnh nhân" %} {{ screening_case.USUBJID }}</a></li>
<li class="breadcrumb-item"><a href="{% url 'microbiology_culture_list' usubjid=screening_case.USUBJID %}">{% trans "Nuôi cấy vi sinh" %}</a></li>
<li class="breadcrumb-item active">{% trans "Độ nhạy kháng sinh" %} - {{ culture.sample_id }}</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/form-animations.css' %}">
<link rel="stylesheet" href="{% static 'css/antibiotic_sensitivity.css' %}">
{% endblock %}

{% block content %}
<!-- Thêm vào đầu phần content trong file HTML -->
<input type="hidden" id="usubjid" value="{{ screening_case.USUBJID }}">
<input type="hidden" id="culture-id" value="{{ culture.id }}">
{% csrf_token %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">          
          <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title">{% trans "Kết quả độ nhạy kháng sinh" %} - {{ culture.sample_id }}</h3>
            <div>
              <a href="{% url 'microbiology_culture_list' usubjid=screening_case.USUBJID %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left"></i> {% trans "Quay lại nuôi cấy" %}
              </a>
            </div>
          </div>
        </div>
        
        <div class="card-body p-0">          
          <div class="accordion" id="antibiotics-accordion">
              {% if not antibiotics_by_tier.values|length %}
                <div class="alert alert-info m-3">
                  {% trans "Chưa có kết quả kháng sinh nào được tạo. Vui lòng thêm kết quả kháng sinh." %}
                </div>
              {% endif %}
              
              {% for tier_code, tier_name in all_tiers %}
              <div class="antibiotic-card" id="tier-{{ tier_code }}" data-tier-code="{{ tier_code }}">                <div class="card-header tier-header" id="heading-{{ forloop.counter }}" data-target="#collapse-{{ forloop.counter }}">
                  <div class="antibiotic-tier">
                    <div style="display: flex; align-items: center;">
                      <span>{{ tier_name }}</span>
                      <i class="fas fa-chevron-down tier-toggle ms-2"></i>
                    </div>
                    <div class="tier-actions">
                      <button class="btn btn-info btn-sm btn-edit-tier" data-tier="{{ tier_code }}" style="display: none;">
                        <i class="fas fa-edit"></i> {% trans "Chỉnh sửa nhóm" %}
                      </button>
                    </div>
                  </div>
                </div>
                
                <div id="collapse-{{ forloop.counter }}" class="collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading-{{ forloop.counter }}">
                  <div class="card-body">
                    <!-- Container for antibiotics in this tier - will be populated by JavaScript -->
                    <div class="list-group tier-antibiotics" id="antibiotics-{{ tier_code }}">
                      <!-- Antibiotic items will be loaded by JavaScript from the API -->
                      <!-- This is intentionally empty as it will be populated by the API response -->
                    </div>
                  </div>
                  <!-- Thêm nút lưu thay đổi ở cuối tier, sau card-body -->
                  <div class="card-footer p-2">
                    <div class="d-flex justify-content-end align-items-center">
                      <button class="btn btn-success btn-save-tier" data-tier="{{ tier_code }}" style="display:none;">
                        <i class="fas fa-save"></i> {% trans "Lưu thay đổi" %}
                      </button>
                    </div>
                  </div>
                </div>
              </div>{% endfor %}
            </div>
        </div>
        
        <!-- Workflow Navigation -->
        <div class="card-footer">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <a href="{% url 'microbiology_culture_list' usubjid=screening_case.USUBJID %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Quay lại danh sách nuôi cấy" %}
              </a>
            </div>
            
            <div>
              <a href="{% url 'laboratory_test_list' usubjid=screening_case.USUBJID %}" class="btn btn-primary">
                <i class="fas fa-flask"></i> {% trans "Quay lại xét nghiệm" %}
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Save indicator alert -->
<div id="saveIndicator" class="alert alert-success alert-dismissible fade save-indicator position-fixed" 
     role="alert" style="display: none; top: 80px; right: 20px; z-index: 1050; min-width: 300px;">
  <i class="fas fa-check-circle me-2"></i>
  <span class="message">{% trans "Thay đổi đã được lưu!" %}</span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/antibiotic_sensitivity.js' %}"></script>
{% endblock %}