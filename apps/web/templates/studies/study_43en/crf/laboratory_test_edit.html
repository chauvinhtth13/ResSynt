{% extends 'adminlte_base.html' %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block title %}{% trans "Cập Nhật Xét Nghiệm 43EN" %}{% endblock %}
{% block page_title %}{% trans "Cập Nhật Xét Nghiệm 43EN" %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'admin_dashboard' %}">Dashboard</a></li>
<li class="breadcrumb-item"><a href="{% url 'enrollment_case_list' %}">{% trans "Danh sách Bệnh nhân 43EN" %}</a></li>
<li class="breadcrumb-item"><a href="{% url '43en:patient_detail' usubjid=enrollment_case.USUBJID %}">{% trans "Bệnh nhân" %} {{ enrollment_case.USUBJID }}</a></li>
<li class="breadcrumb-item"><a href="{% url 'laboratory_test_list' usubjid=enrollment_case.USUBJID %}">{% trans "Xét nghiệm" %}</a></li>
<li class="breadcrumb-item active">{% trans "Cập nhật xét nghiệm" %}</li>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/form-animations.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<style>
  .form-card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);}
  .card-header-primary { background-color: #3b7ddd; color: white; font-weight: 600;}
  .form-group { margin-bottom: 1.5rem;}
  .form-label { font-weight: 500; color: #495057;}
  .form-control:focus { border-color: #3b7ddd; box-shadow: 0 0 0 0.2rem rgba(59,125,221,0.25);}
  .test-info { background-color: #f8f9fa; border-radius: 5px; padding: 15px; margin-bottom: 20px; border-left: 3px solid #3b7ddd;}
  .test-info p { margin-bottom: 0.5rem; font-size: 0.9rem;}
  .test-info p strong { min-width: 150px; display: inline-block;}
  .datepicker.dropdown-menu { max-width: 300px;}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card form-card">
        <div class="card-header card-header-primary">
          <h3 class="card-title">{% trans "Cập nhật xét nghiệm" %}</h3>
        </div>
        <div class="card-body">
          <div class="test-info">
            <p><strong>{% trans "Bệnh nhân" %}:</strong> {{ enrollment_case.USUBJID }}</p>
            <p>
              <strong>{% trans "Xét nghiệm" %}:</strong>
              {% if lab_test.get_TESTTYPE_display %}
                {{ lab_test.get_TESTTYPE_display }}
              {% elif lab_test.TESTTYPE %}
                <span class="text-danger">{% trans "Không xác định" %} ({{ lab_test.TESTTYPE }})</span>
              {% else %}
                <span class="text-danger">{% trans "Chưa nhập loại xét nghiệm" %}</span>
              {% endif %}
            </p>
            <p>
              <strong>{% trans "Nhóm xét nghiệm" %}:</strong>
              {% if lab_test.get_CATEGORY_display %}
                {{ lab_test.get_CATEGORY_display }}
              {% elif lab_test.CATEGORY %}
                <span class="text-danger">{% trans "Không xác định" %} ({{ lab_test.CATEGORY }})</span>
              {% else %}
                <span class="text-danger">{% trans "Chưa nhập nhóm" %}</span>
              {% endif %}
            </p>
          </div>
          <form method="post" action="{% url 'laboratory_test_edit' usubjid=enrollment_case.USUBJID test_id=lab_test.id %}">
            {% csrf_token %}
            <div class="form-group">
              <label class="form-label" for="{{ form.CATEGORY.id_for_label }}">{% trans "Nhóm xét nghiệm" %}:</label>
              {{ form.CATEGORY }}
              {% if form.CATEGORY.errors %}
                <div class="invalid-feedback d-block">{{ form.CATEGORY.errors }}</div>
              {% endif %}
              {% if not lab_test.get_CATEGORY_display and lab_test.CATEGORY %}
                <div class="text-danger small mt-1">{% trans "Nhóm này không hợp lệ, vui lòng chọn lại." %}</div>
              {% endif %}
            </div>
            <div class="form-group">
              <label class="form-label" for="{{ form.TESTTYPE.id_for_label }}">{% trans "Loại xét nghiệm" %}:</label>
              {{ form.TESTTYPE }}
              {% if form.TESTTYPE.errors %}
                <div class="invalid-feedback d-block">{{ form.TESTTYPE.errors }}</div>
              {% endif %}
              {% if not lab_test.get_TESTTYPE_display and lab_test.TESTTYPE %}
                <div class="text-danger small mt-1">{% trans "Loại xét nghiệm này không hợp lệ, vui lòng chọn lại." %}</div>
              {% endif %}
            </div>
            <div class="form-group">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="{{ form.PERFORMED.name }}" id="{{ form.PERFORMED.id_for_label }}" {% if form.PERFORMED.value %}checked{% endif %}>
                <label class="form-check-label" for="{{ form.PERFORMED.id_for_label }}">
                  {% trans "Đã thực hiện xét nghiệm" %}
                </label>
              </div>
              {% if form.PERFORMED.errors %}
                <div class="invalid-feedback d-block">{{ form.PERFORMED.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group performed-field" {% if not form.PERFORMED.value %}style="display: none;"{% endif %}>
              <label class="form-label" for="{{ form.PERFORMEDDATE.id_for_label }}">{% trans "Ngày thực hiện" %}:</label>
              {{ form.PERFORMEDDATE }}
              {% if form.PERFORMEDDATE.errors %}
                <div class="invalid-feedback d-block">{{ form.PERFORMEDDATE.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group performed-field" {% if not form.PERFORMED.value %}style="display: none;"{% endif %}>
              <label class="form-label" for="{{ form.RESULT.id_for_label }}">{% trans "Kết quả" %}:</label>
              {{ form.RESULT }}
              {% if form.RESULT.errors %}
                <div class="invalid-feedback d-block">{{ form.RESULT.errors }}</div>
              {% endif %}
            </div>
            <div class="form-group mt-4">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> {% trans "Lưu thay đổi" %}
              </button>
              <a href="{% url 'laboratory_test_list' usubjid=enrollment_case.USUBJID %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> {% trans "Hủy" %}
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.vi.min.js"></script>
<script>
  $(document).ready(function() {
    // Show/hide performed date and result fields based on performed checkbox
    $('#{{ form.PERFORMED.id_for_label }}').change(function() {
      if ($(this).is(':checked')) {
        $('.performed-field').slideDown();
      } else {
        $('.performed-field').slideUp();
      }
    });
    // Khởi tạo datepicker nếu có
    if ($('.datepicker').length > 0 && !$('.datepicker').hasClass('datepicker-initialized')) {
      $('.datepicker').datepicker({
        format: 'yyyy-mm-dd',
        autoclose: true,
        todayHighlight: true,
        language: 'vi'
      }).addClass('datepicker-initialized');
    }
  });
</script>
{% endblock %}