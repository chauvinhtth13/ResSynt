{% extends 'adminlte_base.html' %}
{% load static %}
{% load i18n %}
{% load django_bootstrap5 %}

{% block title %}{% trans "Chi Tiết Theo Dõi 28 Ngày" %}{% endblock %}
{% block page_title %}{% trans "Chi Tiết Theo Dõi 28 Ngày" %}{% endblock %}

{% block breadcrumb %}
<ol class="breadcrumb float-sm-right">
    <li class="breadcrumb-item"><a href="{% url '43en:patient_list' %}">{% trans "Danh sách bệnh nhân" %}</a></li>
    <li class="breadcrumb-item"><a href="{% url '43en:patient_detail' usubjid=screening_case.USUBJID %}">{{ screening_case.USUBJID }}</a></li>
    <li class="breadcrumb-item active">{% trans "Chi tiết theo dõi" %}</li>
</ol>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Thông tin bệnh nhân -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card card-outline card-primary">
                <div class="card-header">
                    <h3 class="card-title">{% trans "Thông tin bệnh nhân" %}</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>{% trans "Mã bệnh nhân" %}:</strong><br>
                            <span class="text-primary">{{ screening_case.USUBJID }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>{% trans "Ngày sàng lọc" %}:</strong><br>
                            {{ screening_case.SCREENINGFORMDATE|date:"d/m/Y"|default:"-" }}
                        </div>
                        <div class="col-md-3">
                            <strong>{% trans "Trạng thái follow-up" %}:</strong><br>
                            {% if has_followup %}
                                <span class="badge badge-success">{% trans "Đã có dữ liệu" %}</span>
                            {% else %}
                                <span class="badge badge-warning">{% trans "Chưa có dữ liệu" %}</span>
                            {% endif %}
                        </div>
                        <div class="col-md-3">
                            <strong>{% trans "Thao tác" %}:</strong><br>
                            {% if has_followup %}
                                <a href="{% url '43en:followup_form' usubjid=screening_case.USUBJID %}" class="btn btn-warning btn-sm">
                                    {% trans "Chỉnh sửa" %}
                                </a>
                            {% else %}
                                <a href="{% url '43en:followup_form' usubjid=screening_case.USUBJID %}" class="btn btn-primary btn-sm">
                                    {% trans "Tạo mới" %}
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if has_followup %}
        <!-- Phần 1: Đánh giá tình trạng tại ngày 28 -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-info">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "1. Đánh giá tình trạng tại ngày 28" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>{% trans "Đánh giá tình trạng" %}:</strong><br>
                                <span class="badge badge-{% if followup_case.FU28ASSESSED == 'Yes' %}success{% elif followup_case.FU28ASSESSED == 'No' %}danger{% else %}secondary{% endif %}">
                                    {{ followup_case.get_FU28ASSESSED_display|default:"-" }}
                                </span>
                            </div>
                            <div class="col-md-4">
                                <strong>{% trans "Ngày đánh giá" %}:</strong><br>
                                {{ followup_case.FU28ASSESSDATE|date:"d/m/Y"|default:"-" }}
                            </div>
                            <div class="col-md-4">
                                <strong>{% trans "Tình trạng bệnh nhân" %}:</strong><br>
                                {{ followup_case.get_FU28PATSTATUS_display|default:"-" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần 2: Tái nhập viện -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-warning">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "2. Tái nhập viện" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>{% trans "Tái nhập viện" %}:</strong><br>
                                <span class="badge badge-{% if followup_case.FU28REHOSP == 'Yes' %}warning{% elif followup_case.FU28REHOSP == 'No' %}success{% else %}secondary{% endif %}">
                                    {{ followup_case.get_FU28REHOSP_display|default:"-" }}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <strong>{% trans "Số lần tái nhập viện" %}:</strong><br>
                                {{ followup_case.FU28REHOSPCOUNT|default:"-" }}
                            </div>
                        </div>

                        {% if rehospitalizations %}
                        <div class="mt-3">
                            <h5>{% trans "Chi tiết tái nhập viện" %}</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>{% trans "Lần" %}</th>
                                            <th>{% trans "Ngày tái nhập viện" %}</th>
                                            <th>{% trans "Nơi tái nhập viện" %}</th>
                                            <th>{% trans "Thời gian nằm viện" %}</th>
                                            <th>{% trans "Lý do tái nhập viện" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rehosp in rehospitalizations %}
                                        <tr>
                                            <td>{{ rehosp.EPISODE }}</td>
                                            <td>{{ rehosp.REHOSPDATE|date:"d/m/Y"|default:"-" }}</td>
                                            <td>{{ rehosp.REHOSPLOCATION|default:"-" }}</td>
                                            <td>{{ rehosp.REHOSPSTAYDUR|default:"-" }}</td>
                                            <td>{{ rehosp.REHOSPREASONFOR|default:"-" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần 3: Tử vong -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-danger">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "3. Tử vong" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>{% trans "Tử vong" %}:</strong><br>
                                <span class="badge badge-{% if followup_case.FU28DECEASED == 'Yes' %}danger{% elif followup_case.FU28DECEASED == 'No' %}success{% else %}secondary{% endif %}">
                                    {{ followup_case.get_FU28DECEASED_display|default:"-" }}
                                </span>
                            </div>
                            <div class="col-md-4">
                                <strong>{% trans "Ngày tử vong" %}:</strong><br>
                                {{ followup_case.FU28DEATHDATE|date:"d/m/Y"|default:"-" }}
                            </div>
                            <div class="col-md-4">
                                <strong>{% trans "Nguyên nhân tử vong" %}:</strong><br>
                                {{ followup_case.FU28DEATHCAUSE|default:"-" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần 4: Sử dụng kháng sinh -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-success">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "4. Sử dụng kháng sinh" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>{% trans "Sử dụng kháng sinh" %}:</strong><br>
                                <span class="badge badge-{% if followup_case.FU28USEDANTIBIO == 'Yes' %}info{% elif followup_case.FU28USEDANTIBIO == 'No' %}success{% else %}secondary{% endif %}">
                                    {{ followup_case.get_FU28USEDANTIBIO_display|default:"-" }}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <strong>{% trans "Số đợt kháng sinh" %}:</strong><br>
                                {{ followup_case.FU28ANTIBIOCOUNT|default:"-" }}
                            </div>
                        </div>

                        {% if antibiotics %}
                        <div class="mt-3">
                            <h5>{% trans "Chi tiết kháng sinh" %}</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>{% trans "Đợt" %}</th>
                                            <th>{% trans "Tên kháng sinh" %}</th>
                                            <th>{% trans "Thời gian sử dụng" %}</th>
                                            <th>{% trans "Lý do sử dụng" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for antibio in antibiotics %}
                                        <tr>
                                            <td>{{ antibio.EPISODE }}</td>
                                            <td>{{ antibio.ANTIBIONAME|default:"-" }}</td>
                                            <td>{{ antibio.ANTIBIODUR|default:"-" }}</td>
                                            <td>{{ antibio.ANTIBIOREASONFOR|default:"-" }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần 5: Đánh giá tình trạng chức năng -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-purple">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "5. Đánh giá tình trạng chức năng" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <strong>{% trans "Đánh giá chức năng" %}:</strong><br>
                                <span class="badge badge-{% if followup_case.FU28FUNCASSESS == 'Yes' %}info{% elif followup_case.FU28FUNCASSESS == 'No' %}success{% else %}secondary{% endif %}">
                                    {{ followup_case.get_FU28FUNCASSESS_display|default:"-" }}
                                </span>
                            </div>
                        </div>

                        {% if followup_case.FU28FUNCASSESS == 'Yes' %}
                        <div class="row">
                            <div class="col-md-6">
                                <strong>{% trans "5a. Vận động (đi lại)" %}:</strong><br>
                                {{ followup_case.get_FU28MOBILITY_display|default:"-" }}
                            </div>
                            <div class="col-md-6">
                                <strong>{% trans "5b. Vệ sinh cá nhân" %}:</strong><br>
                                {{ followup_case.get_FU28PERHYGIENE_display|default:"-" }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>{% trans "5c. Sinh hoạt hằng ngày" %}:</strong><br>
                                {{ followup_case.get_FU28DAILYACTIV_display|default:"-" }}
                            </div>
                            <div class="col-md-6">
                                <strong>{% trans "5d. Đau/ khó chịu" %}:</strong><br>
                                {{ followup_case.get_FU28PAINDISCOMF_display|default:"-" }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>{% trans "5e. Lo lắng/ Trầm cảm" %}:</strong><br>
                                {{ followup_case.get_FU28ANXDEPRESS_display|default:"-" }}
                            </div>
                            <div class="col-md-6">
                                <strong>{% trans "Điểm FBSI" %}:</strong><br>
                                {{ followup_case.get_FU28FBSISCORE_display|default:"-" }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Thông tin hoàn thành -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-secondary">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "Thông tin hoàn thành" %}</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>{% trans "Người hoàn thành" %}:</strong><br>
                                {{ followup_case.COMPLETEDBY|default:"-" }}
                            </div>
                            <div class="col-md-6">
                                <strong>{% trans "Ngày hoàn thành" %}:</strong><br>
                                {{ followup_case.COMPLETEDDATE|date:"d/m/Y"|default:"-" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- Chưa có dữ liệu follow-up -->
        <div class="row">
            <div class="col-12">
                <div class="card card-outline card-warning">
                    <div class="card-body text-center">
                        <h4>{% trans "Chưa có dữ liệu theo dõi 28 ngày" %}</h4>
                        <p>{% trans "Bệnh nhân này chưa có thông tin theo dõi 28 ngày." %}</p>
                        <a href="{% url '43en:followup_form' usubjid=screening_case.USUBJID %}" class="btn btn-primary">
                            {% trans "Tạo thông tin theo dõi" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Buttons -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    {% if has_followup %}
                        <a href="{% url '43en:followup_form' usubjid=screening_case.USUBJID %}" class="btn btn-warning btn-lg">
                            {% trans "Chỉnh sửa" %}
                        </a>
                    {% endif %}
                    <a href="{% url '43en:patient_detail' usubjid=screening_case.USUBJID %}" class="btn btn-secondary btn-lg">
                        {% trans "Quay lại" %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card-purple {
    border-top: 3px solid #6f42c1;
}

.card-purple .card-header {
    background-color: rgba(111, 66, 193, 0.1);
    border-bottom: 1px solid rgba(111, 66, 193, 0.2);
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.badge {
    font-size: 0.875em;
}
</style>
{% endblock %}
