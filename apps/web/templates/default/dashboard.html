<!-- templates/default/dashboard.html -->
{% load static i18n %}
<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE|default:'vi' }}">
<head>
    <!-- Meta tags for character encoding, compatibility, and responsive viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    
    <!-- Page title with translation support -->
    <title>{% trans "ResSync Dashboard" %}</title>
    
    <!-- Stylesheets: Base, TailwindCSS, and Dashboard-specific -->
    <link rel="stylesheet" href="{% static 'css/default/base.css' %}" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{% static 'css/default/dashboard.css' %}" />
</head>
<body class="bg-gray-100 text-gray-700 h-screen overflow-hidden">
    <!-- Main container for layout -->
    <div class="relative flex h-full">
        <!-- Sidebar: Navigation panel with study logo and dynamic content -->
        <aside id="sidebar" class="bg-blue-950 text-gray-100 shadow-2xl flex flex-col"
               role="navigation" aria-label="{% trans 'Primary navigation' %}">
            <div class="flex items-center px-2 py-2 ml-2">
                <div class="flex items-center gap-3">
                    {% if study_folder %}
                        {% static 'images/studies/'|add:study_folder|add:'/logo.webp' as logo_path %}
                        {% if logo_path %}
                            <div class="flex-shrink-0 p-1 bg-white rounded-lg border border-white/10">
                                <img src="{{ logo_path }}"
                                     alt="{% trans 'Study logo' %}"
                                     loading="lazy" class="h-10 w-auto object-contain" decoding="async"
                                     onerror="this.parentElement.style.display='none';">
                            </div>
                        {% endif %}
                    {% endif %}
                    <div class="flex flex-col">
                        <h1 class="text-lg font-bold text-white tracking-wide">{{ request.study.code|upper }}</h1>
                        <p class="text-sm text-slate-300 font-medium">{% trans "Research Study" %}</p>
                    </div>
                </div>
            </div>
            <!-- Include study-specific sidebar content -->
            {% include 'studies/'|add:study_folder|add:'/sidebar.html' with request=request %}
        </aside>

        <!-- Main content area -->
        <div class="flex-1 flex flex-col min-w-0">
            <!-- Header: Sticky navigation with sidebar toggle, notifications, language, and user menu -->
            <header class="sticky top-0 z-20 flex justify-between items-center gap-1 px-4 md:px-6 py-2 bg-white border-b border-gray-200">
                <!-- Sidebar toggle button -->
                <button id="toggleSidebarBtn"
                        class="hidden md:inline-flex items-center rounded-2xl px-3 py-3 text-gray-700 hover:bg-gray-100 hover:text-blue-600 hover:ring-1 hover:ring-blue-600 transition"
                        aria-label="{% trans 'Hide sidebar' %}" aria-pressed="false" aria-controls="sidebar">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                        <path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"/>
                    </svg>
                </button>

                <!-- Right-side header controls -->
                <div class="ml-auto flex items-center gap-0">
                    <!-- Notifications button -->
                    <button class="flex items-center rounded-2xl px-3 py-3 text-gray-700 hover:bg-gray-100 hover:text-blue-600 hover:ring-1 hover:ring-blue-600 focus:outline-none transition"
                            aria-label="{% trans 'Notifications' %}">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                            <path d="M160-200v-66.67h80v-296q0-83.66 49.67-149.5Q339.33-778 420-796v-24q0-25 17.5-42.5T480-880q25 0 42.5 17.5T540-820v24q80.67 18 130.33 83.83Q720-646.33 720-562.67v296h80V-200H160Zm320-301.33ZM480-80q-33 0-56.5-23.5T400-160h160q0 33-23.5 56.5T480-80ZM306.67-266.67h346.66v-296q0-72-50.66-122.66Q552-736 480-736t-122.67 50.67q-50.66 50.66-50.66 122.66v296Z"/>
                        </svg>
                    </button>
                    <div class="w-px bg-slate-200 mx-3 self-stretch"></div>

                    <!-- Language switcher dropdown -->
                    <div class="relative" data-dropdown="language">
                        <button type="button" data-dropdown-trigger aria-haspopup="menu" aria-expanded="false" aria-controls="lang-menu"
                                class="flex items-center gap-2 rounded-2xl px-3 py-3 text-gray-700 hover:bg-gray-100 hover:text-blue-600 hover:ring-1 hover:ring-blue-600 focus:outline-none transition">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                                <path d="M480-80q-83.33 0-156.33-31.5-73-31.5-127.17-85.67-54.17-54.16-85.33-127.5Q80-398 80-481.33 80-565 111.17-637.5q31.16-72.5 85.33-126.67 54.17-54.16 127.17-85Q396.67-880 480-880q83.67 0 156.5 30.83 72.83 30.84 127 85Q817.67-710 848.83-637.5 880-565 880-481.33q0 83.33-31.17 156.66-31.16 73.34-85.33 127.5-54.17 54.17-127 85.67T480-80Zm0-66q32-36 54-80t36-101.33H390.67Q404-272.67 426-227.67T480-146Zm-91.33-13.33q-22.67-36.34-39.17-77.5Q333-278 322-327.33H182.67q35 64 82.83 103.33t123.17 64.67ZM572-160q66.67-21.33 119.5-64.33t85.83-103H638.67Q627-278.67 610.83-237.5 594.67-196.33 572-160ZM158-394h151.33q-3-24.67-3.83-45.5-.83-20.83-.83-41.83 0-23.67 1.16-43.17Q307-544 310-566.67H158q-6.33 22.67-8.83 41.84-2.5 19.16-2.5 43.5 0 24.33 2.5 44.5 2.5 20.16 8.83 42.83Zm219.33 0h206q3.67-27.33 4.84-46.83 1.16-19.5 1.16-40.5 0-20.34-1.16-39.17-1.17-18.83-4.84-46.17h-206q-3.66 27.34-4.83 46.17-1.17 18.83-1.17 39.17 0 21 1.17 40.5t4.83 46.83ZM650-394h152q6.33-22.67 8.83-42.83 2.5-20.17 2.5-44.5 0-24.34-2.5-43.5-2.5-19.17-8.83-41.84H650.67q3 30 4.16 48.84Q656-499 656-481.33q0 21.66-1.5 41.16-1.5 19.5-4.5 46.17Zm-12-239.33h139.33Q745.67-696 692.83-739q-52.83-43-121.5-61.67Q594-765 610.17-724.5 626.33-684 638-633.33Zm-247.33 0h180q-11.34-50-35-96-23.67-46-55.67-83.34-30 30-51 72.34-21 42.33-38.33 107Zm-208 0h140Q333-682 348.83-722.17 364.67-762.33 388-800q-68.67 18.67-120.5 61t-84.83 105.67Z"/>
                            </svg>
                            <span id="current-language" class="font-semibold text-sm tracking-wider uppercase">{{ LANGUAGE_CODE|lower|default:'vi' }}</span>
                        </button>
                        <div id="lang-menu" role="menu" aria-label="{% trans 'Select language' %}" data-dropdown-menu hidden class="absolute right-0 mt-2 min-w-[9rem] rounded-xl border border-gray-200 bg-white shadow-lg">
                            <form method="post" action="{% url 'set_language' %}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.path }}">
                                <button type="submit" name="language" value="vi" data-lang="vi" role="menuitem" class="flex w-full items-center rounded-t-lg px-3 py-2 text-sm hover:bg-slate-100 {% if LANGUAGE_CODE == 'vi' %}font-semibold bg-slate-100{% endif %}">
                                    <span class="w-8 text-left font-semibold">vi</span><span>{% trans 'Vietnamese' %}</span>
                                </button>
                                <button type="submit" name="language" value="en" data-lang="en" role="menuitem" class="flex w-full items-center rounded-b-lg px-3 py-2 text-sm hover:bg-slate-100 {% if LANGUAGE_CODE == 'en' %}font-semibold bg-slate-100{% endif %}">
                                    <span class="w-8 text-left font-semibold">en</span><span>{% trans 'English' %}</span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="w-px bg-slate-200 mx-3 self-stretch"></div>

                    <!-- User menu dropdown -->
                    <div class="relative" data-dropdown="user">
                        <button id="userMenuBtn" data-dropdown-trigger class="flex items-center gap-2 rounded-2xl px-3 py-3 text-gray-700 hover:bg-gray-100 hover:text-blue-600 hover:ring-1 hover:ring-blue-600 transition"
                                aria-haspopup="menu" aria-expanded="false" aria-controls="userMenu">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                                <path d="M226-262q59-42.33 121.33-65.5 62.34-23.17 132.67-23.17 70.33 0 133 23.17T734.67-262q41-49.67 59.83-103.67T813.33-480q0-141-96.16-237.17Q621-813.33 480-813.33t-237.17 96.16Q146.67-621 146.67-480q0 60.33 19.16 114.33Q185-311.67 226-262Zm253.88-184.67q-58.21 0-98.05-39.95Q342-526.58 342-584.79t39.96-98.04q39.95-39.84 98.16-39.84 58.21 0 98.05 39.96Q618-642.75 618-584.54t-39.96 98.04q-39.95 39.83-98.16 39.83ZM480.31-80q-82.64 0-155.64-31.5-73-31.5-127.34-85.83Q143-251.67 111.5-324.51T80-480.18q0-82.82 31.5-155.49 31.5-72.66 85.83-127Q251.67-817 324.51-848.5T480.18-880q82.82 0 155.49 31.5 72.66 31.5 127 85.83Q817-708.33 848.5-635.65 880-562.96 880-480.31q0 82.64-31.5 155.64-31.5 73-85.83 127.34Q708.33-143 635.65-111.5 562.96-80 480.31-80Zm-.31-66.67q54.33 0 105-15.83t97.67-52.17q-47-33.66-98-51.5Q533.67-284 480-284t-104.67 17.83q-51 17.84-98 51.5 47 36.34 97.67 52.17 50.67 15.83 105 15.83Zm0-366.66q31.33 0 51.33-20t20-51.34q0-31.33-20-51.33T480-656q-31.33 0-51.33 20t-20 51.33q0 31.34 20 51.34 20 20 51.33 20Zm0-71.34Zm0 369.34Z"/>
                            </svg>
                            <span id="username-display" class="font-semibold text-sm tracking-wider">{{ user.get_full_name|default:user.username }}</span>
                        </button>
                        <div id="userMenu" data-dropdown-menu hidden class="absolute right-0 mt-2 w-52 origin-top-right rounded-xl bg-white shadow-xl border border-gray-100 divide-y divide-gray-100 animate-slide-in"
                             role="menu" aria-label="{% trans 'User menu' %}">
                            <div class="py-0">
                                <form method="post" action="{% url 'select_study' %}" data-choose-study-form>
                                    {% csrf_token %}
                                    <input type="hidden" name="clear_study" value="1">
                                    <button type="submit" class="flex items-center gap-3 px-4 py-3 text-sm text-blue-600 hover:bg-blue-50 rounded-t-lg transition-colors duration-200 w-full text-left">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                                            <path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/>
                                        </svg>
                                        {% trans "Choose another study" %}
                                    </button>
                                </form>
                            </div>
                            <form method="post" action="{% url 'logout' %}">
                                {% csrf_token %}
                                <button type="submit" class="flex items-center gap-3 px-4 py-3 text-sm text-red-700 hover:bg-red-50 rounded-b-lg transition-colors duration-200 w-full text-left">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor" aria-hidden="true" class="h-5 w-5">
                                        <path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z"/>
                                    </svg>
                                    {% trans "Log Out" %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main content area with study-specific content -->
            <main class="flex-1 overflow-y-auto p-6 md:p-8">
                {% include 'studies/'|add:study_folder|add:'/content.html' with request=request %}
            </main>
        </div>
    </div>

    <!-- JavaScript: Dashboard and study-specific scripts -->
    <script defer src="{% static 'js/default/base.js' %}"></script>
    <script type="module" src="{% static 'js/default/dashboard.js' %}"></script>
    {% with study_js='js/studies/'|add:study_folder|add:'/custom.js' %}
        {% if study_folder %}
            <script type="module" src="{% static study_js %}"></script>
        {% endif %}
    {% endwith %}
</body>
</html>