{% load static i18n %}
<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE|default:'vi' }}">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{% trans 'ResSync — Select Study' %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'css/default/select_study.css' %}">
</head>
<body class="min-h-screen text-gray-800 font-sans bg-gray-100">
  <header class="sticky top-0 z-20 flex justify-between items-center gap-2 px-4 md:px-6 py-4 bg-white border-b border-gray-200">
      <div class="relative items-center ml-4">
        <img src="{% static 'images/default/logo.webp' %}" alt="{% trans 'ResSync logo' %}" class="h-8 w-auto" loading="lazy" decoding="async">
      </div>
      <nav class="flex items-center gap-0">
        <div class="relative" data-dropdown>
          <button type="button" data-dropdown-trigger aria-haspopup="menu" aria-expanded="false" aria-controls="lang-menu"
            class="flex items-center gap-2 rounded-full px-3 py-1 text-gray-700 hover:bg-gray-100 hover:text-blue-600 hover:ring-1 hover:ring-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <span class="material-symbols-outlined">translate</span>
            <span id="current-language" class="font-semibold uppercase tracking-wide">{{ LANGUAGE_CODE|lower|default:'vi' }}</span>
          </button>
          <div id="lang-menu" role="menu" aria-label="{% trans 'Select language' %}" data-dropdown-menu hidden class="absolute right-0 mt-2 min-w-[9rem] origin-top-right rounded-xl border border-gray-200 bg-white p-1.5 shadow-lg transition">
            <form method="post" action="{% url 'set_language' %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}">
              <button type="submit" name="language" value="vi" role="menuitem" class="flex w-full items-center rounded-lg px-3 py-2 text-sm hover:bg-slate-100 {% if LANGUAGE_CODE == 'vi' %}font-semibold bg-slate-100{% endif %}">
                <span class="w-8 text-left font-semibold">vi</span><span>{% trans 'Vietnamese' %}</span>
              </button>
              <button type="submit" name="language" value="en" role="menuitem" class="flex w-full items-center rounded-lg px-3 py-2 text-sm hover:bg-slate-100 {% if LANGUAGE_CODE == 'en' %}font-semibold bg-slate-100{% endif %}">
                <span class="w-8 text-left font-semibold">en</span><span>{% trans 'English' %}</span>
              </button>
            </form>
          </div>
        </div>
        <div class="w-px bg-slate-200 mx-2 self-stretch"></div>
        <div class="relative" data-dropdown>
          <button type="button" data-dropdown-trigger aria-haspopup="menu" aria-expanded="false" aria-controls="user-menu" 
          class="flex items-center gap-2 rounded-full px-3 py-1 text-gray-700 hover:bg-gray-100 hover:text-blue-600 hover:ring-1 hover:ring-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <span class="material-symbols-outlined">account_circle</span>
            <span id="username-display" class="tracking-wide font-semibold">{{ user.get_full_name|default:user.username }}</span>
          </button>
          <div id="user-menu" role="menu" aria-label="{% trans 'User menu' %}" data-dropdown-menu hidden class="absolute right-0 mt-2 w-48 origin-top-right rounded-xl border border-slate-200 bg-white p-1.5 shadow-lg transition">
            {% if is_superuser %}
            <a href="{% url 'admin:index' %}" role="menuitem" class="block rounded-lg px-3 py-2 text-sm font-medium text-blue-600 hover:bg-slate-100">{% trans 'Go to Admin' %}</a>
            {% endif %}
            <form method="post" action="{% url 'logout' %}">
              {% csrf_token %}
              <button type="submit" role="menuitem" class="w-full rounded-lg px-3 py-2 text-left text-sm font-medium text-red-600 hover:bg-red-100">{% trans 'Sign Out' %}</button>
            </form>
          </div>
        </div>
      </nav>
  </header>
  <main class="mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
    {% if error %}
      <div role="alert" class="mb-6 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-red-700">
        {{ error }}
      </div>
    {% endif %}
    <section role="search" aria-labelledby="study-search-title" class="mb-10">
      <div class="mx-auto w-full">
        <div class="relative">
          <div class="flex items-center rounded-full border border-slate-300 bg-white transition focus-within:border-blue-400 focus-within:ring-2 focus-within:ring-blue-500">
            <span class="pl-4 text-gray-400" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </span>
            <input id="study-id-search" type="search" autocomplete="off" enterkeyhint="search" placeholder="{% trans 'Search by Study Code or Name…' %}" class="w-full bg-white px-3 py-3 text-sm text-gray-700 placeholder:text-gray-400 focus:outline-none rounded-full">
          </div>
        </div>
      </div>
    </section>
    <section class="overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm">
      <div class="flex items-center justify-between border-b border-slate-200 px-4 sm:px-6 lg:px-8 py-4">
        <h2 class="text-lg sm:text-xl font-bold">{% trans 'Research Studies' %}</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-slate-50 text-gray-600">
            <tr>
              <th scope="col" class="px-4 sm:px-6 lg:px-8 py-3 text-left text-xs uppercase tracking-wider whitespace-nowrap font-bold">{% trans 'Study Code' %}</th>
              <th scope="col" class="px-4 sm:px-6 lg:px-8 py-3 text-left text-xs uppercase tracking-wider whitespace-nowrap font-bold">{% trans 'Study Name' %}</th>
              <th scope="col" class="px-4 sm:px-6 lg:px-8 py-3 text-left text-xs uppercase tracking-wider whitespace-nowrap font-bold">{% trans 'Last Updated' %}</th>
              <th scope="col" class="px-4 sm:px-6 lg:px-8 py-3 text-left text-xs uppercase tracking-wider whitespace-nowrap font-bold">{% trans 'Actions' %}</th>
            </tr>
          </thead>
          <tbody id="studies-body">
            {% for study in studies %}
            <tr class="border-b border-slate-200 last:border-0" data-row>
              <td class="px-4 sm:px-6 lg:px-8 py-3 font-semibold" data-col="code">{{ study.code }}</td>
              <td class="px-4 sm:px-6 lg:px-8 py-3" data-col="name">{{ study.name|default_if_none:_('(No name)') }}</td>
              <td class="px-4 sm:px-6 lg:px-8 py-3 whitespace-nowrap" data-col="updated">{{ study.updated_at|date:"d-m-Y H:i:s" }}</td>
              <td class="px-4 sm:px-6 lg:px-8 py-3 text-right">
                <form method="post" action="{% url 'select_study' %}">
                  {% csrf_token %}
                  <input type="hidden" name="study_id" value="{{ study.id }}">
                  <button type="submit" class="inline-flex items-center gap-2 rounded-full bg-blue-600 px-5 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 hover:shadow-md active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="h-4 w-4" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                    </svg>
                    {% trans 'Open Study' %}
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr id="no-results-row" data-empty-row>
              <td colspan="4" class="px-4 sm:px-6 lg:px-8 py-6 text-center text-gray-500">{% trans 'No studies found.' %}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
  </main>
  <script defer src="{% static 'js/default/select_study.js' %}"></script>
</body>
</html>