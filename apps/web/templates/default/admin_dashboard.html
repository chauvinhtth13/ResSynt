{% extends 'adminlte_base.html' %}
{% load static %}
{% load i18n %}
{% url 'contact_cumulative_chart_data' %}
{% block title %}{% trans "Dashboard" %} | {% trans "Quản lý Bệnh nhân" %}{% endblock %}

{% block extra_css %}
<style>
.main-card, .sub-card {
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: none;
    transition: none;
}

.stat-number, .sub-stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: #333;
}
.sub-stat-label {
    font-size: 1rem;
    font-weight: 500;
    margin-bottom: 0;
}
.sub-stat-label.text-success {
    color: #161717 !important;
}
.sub-stat-label.text-warning {
    color: #131313 !important;
}
.sample-summary {
    max-height: 220px;
    overflow-y: auto;
    display: none;
}
.sample-item {
    padding: 6px 12px;
    margin: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    font-weight: 500;
    color: white;
    background: #888;
    max-width: 100%;
    box-sizing: border-box;
}
.sample-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
    display: inline-block;
}
canvas {
    max-height: 260px !important;
    height: 260px !important;
}
.card-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
.sample-summary {
    width: 100%;
    text-align: center;
    margin-top: 10px;
}
.stat-number {
    font-size: 2.1rem;
    font-weight: bold;
    margin: 0 4px;
    display: inline-block;
}
.sub-stat-label {
    font-size: 1rem;
    font-weight: 500;
    margin-bottom: 0;
    margin-left: 2px;
}
.text-info { color: #0056b3 !important; }
.text-success { color: #28a745 !important; }
.text-primary { color: #0056b3 !important; }


</style>
{% endblock %}

{% block content %}

<!-- Nội dung Dashboard -->
<!-- Card tổng hợp giới thiệu số lượng contact, patient -->
<div class="row">
  <!-- Card thông tin bên trái -->
  <div class="col-lg-6">
    <div class="card main-card card-info">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-info-circle mr-2"></i>
          Tổng quan số lượng đối tượng nghiên cứu
        </h3>
      </div>
      <div class="card-body" style="align-items: flex-start;">
        <ul class="list-unstyled mb-0">
          <li>
            <strong>Ngày bắt đầu dự án:</strong>
            <span class="stat-number text-primary">{{ project_start|date:"d/m/Y" }}</span>
            <span class="sub-stat-label text-muted">đến</span>
            <span class="stat-number text-info">{{ today|date:"d/m/Y" }}</span>
          </li>
          <li class="mt-2">
            <strong>Người tiếp xúc (Contact):</strong>
            <span class="stat-number text-info">{{ screening_contacts|default:"0" }}</span>
            <span class="sub-stat-label text-muted">Sàng lọc</span> |
            <span class="stat-number text-success">{{ enrolled_contacts|default:"0" }}</span>
            <span class="sub-stat-label text-muted">Tham gia</span>
          </li>
          <li class="mt-2">
            <strong>Bệnh nhân (Patient):</strong>
            <span class="stat-number text-info">{{ screening_patients|default:"0" }}</span>
            <span class="sub-stat-label text-muted">Sàng lọc</span> |
            <span class="stat-number text-success">{{ enrolled_patients|default:"0" }}</span>
            <span class="sub-stat-label text-muted">Tham gia</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <!-- Card half pie bên phải -->
  <div class="col-lg-6">
    <div class="card main-card card-success">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-chart-pie mr-2"></i>
          Biểu đồ tỷ lệ bệnh nhân đã tuyển so với mục tiêu
        </h3>
      </div>
      <div class="card-body">
        <canvas id="enrollPercentPie" width="180" height="90"></canvas>
      </div>
    </div>
  </div>
</div>


<!-- Biểu đồ phân bố giới tính -->
<div class="row mt-4">
    <!-- Biểu đồ giới tính của bệnh nhân -->
    <div class="col-lg-6">
        <div class="card main-card card-info">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie mr-2"></i>
                    {% trans "Phân bố giới tính của Bệnh nhân" %}
                </h3>
            </div>
            <div class="card-body">
                <canvas id="patientGenderChart" style="height:300px;max-width:100%;"></canvas>
            </div>
        </div>
    </div>

    <!-- Biểu đồ giới tính của người tiếp xúc -->
    <div class="col-lg-6">
        <div class="card main-card card-success">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie mr-2"></i>
                    {% trans "Phân bố giới tính của Người tiếp xúc" %}
                </h3>
            </div>
            <div class="card-body">
                <canvas id="contactGenderChart" style="height:300px;max-width:100%;"></canvas>
            </div>
        </div>
    </div>
</div>

  <!-- Biểu đồ so sánh số lượng sàng lọc -->
  <div class="row mt-4">
    <div class="col-lg-12">
      <div class="card main-card card-info">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-chart-bar mr-2"></i>
            {% trans "So sánh số lượng sàng lọc giữa Bệnh nhân và Người tiếp xúc" %}
          </h3>
        </div>
        <div class="card-body">
          <canvas id="screeningComparisonChart" style="height:350px;max-width:100%;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Biểu đồ tích lũy bệnh nhân tham gia -->
  <!-- <div class="row mt-4">
    <div class="col-lg-12">
      <div class="card main-card card-success">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-chart-line mr-2"></i>
            {% trans "Biểu đồ tích lũy bệnh nhân tham gia" %}
          </h3>
        </div>
        <div class="card-body">
          <canvas id="patientCumulativeChart" style="height:350px;max-width:100%;"></canvas>
        </div>
      </div>
    </div>
  </div> -->

  <!-- Biểu đồ tích lũy bệnh nhân tham gia (enrollment) -->
  <div class="row mt-4">
    <div class="col-lg-12">
      <div class="card main-card card-primary">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-chart-bar mr-2"></i>
            {% trans "Biểu đồ số lượng bệnh nhân tham gia theo tháng" %}
          </h3>
        </div>
        <div class="card-body">
          <canvas id="patientEnrollmentChart" style="height:350px;max-width:100%;"></canvas>
        </div>
      </div>
    </div>
  </div>


  <!-- Bảng tổng hợp lý do không tham gia nghiên cứu (Patient & Contact) -->
  <div class="row mt-4">
    <!-- Contact Reasons Table -->
    <div class="col-lg-6">
      <div class="card main-card card-warning">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-ban mr-2"></i>
            {% trans "Lý do người tiếp xúc không tham gia nghiên cứu" %}
          </h3>
        </div>
        <div class="card-body">
          <table class="table table-bordered table-sm">
            <thead>
              <tr>
                <th>Lý do</th>
                <th>Số lượng</th>
              </tr>
            </thead>
            <tbody>
              {% for reason in contact_reasons %}
              <tr>
                <td>{{ reason.UNRECRUITED_REASON }}</td>
                <td>{{ reason.count }} ({{ reason.percent }}%)</td>
              </tr>
              {% empty %}
              <tr><td colspan="2">Không có dữ liệu</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Patient Reasons Table -->
    <div class="col-lg-6">
      <div class="card main-card card-danger">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-ban mr-2"></i>
            {% trans "Lý do bệnh nhân không tham gia nghiên cứu" %}
          </h3>
        </div>
        <div class="card-body">
          <table class="table table-bordered table-sm">
            <thead>
              <tr>
                <th>{% trans "Lý do" %}</th>
                <th>{% trans "Số lượng" %}</th>
              </tr>
            </thead>
            <tbody>
              {% for reason in patient_reasons %}
              <tr>
                <td>{{ reason.UNRECRUITED_REASON|default:"(Không ghi rõ)" }}</td>
                <td>{{ reason.count }} ({{ reason.percent }}%)</td>
              </tr>
              {% empty %}
              <tr><td colspan="2">{% trans "Không có dữ liệu" %}</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<div>
<!-- 1. Sửa cấu trúc cho phần Biểu đồ phân bố mẫu (trong phần content) -->
<!-- Thêm row bao quanh 2 biểu đồ phân bố mẫu -->
<!-- <div class="row mt-4"> -->
  <!-- Biểu đồ phân bố mẫu của người tiếp xúc -->
  <!-- <div class="col-lg-6">
    <div class="card main-card card-info">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-chart-pie mr-2"></i>
          {% trans "Phân bố mẫu sinh học của Người tiếp xúc" %}
        </h3>
      </div>
      <div class="card-body">
          <canvas id="contactSamplesChart" style="height:300px;max-width:100%;"></canvas>
          <div class="sample-summary contact-summary mt-3" style="display:none;">
              <h6 class="text-center">Tổng số mẫu theo loại:</h6>
              <div class="d-flex justify-content-center flex-wrap" id="contactSampleSummary"></div>
          </div>
      </div>
    </div>
  </div> -->

  <!-- Biểu đồ phân bố mẫu của bệnh nhân -->
  <!-- <div class="col-lg-6">
    <div class="card main-card card-success">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-chart-pie mr-2"></i>
          {% trans "Phân bố mẫu sinh học của Bệnh nhân" %}
        </h3>
      </div>
      <div class="card-body">
        <canvas id="patientSamplesChart" style="height:300px;max-width:100%;"></canvas> -->
        <!-- Thêm bảng chú thích -->
        <!-- <div class="sample-summary patient-summary mt-3" style="display:none;">
          <h6 class="text-center">Tổng số mẫu theo loại:</h6>
          <div class="d-flex justify-content-center flex-wrap" id="patientSampleSummary"></div>
        </div>
      </div>
    </div>
  </div>
</div> -->


{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Thêm vào trước đoạn <script> vẽ chart -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
$(document).ready(function() {
    // Vẽ half pie cho tỷ lệ bệnh nhân tham gia nghiên cứu
    const enrolled = Number({{ enrolled_patients|default:"0" }});
    const target = 750;
    const remain = Math.max(target - enrolled, 0);

    const ctxPie = document.getElementById('enrollPercentPie').getContext('2d');
    new Chart(ctxPie, {
        type: 'doughnut',
        data: {
            labels: ['Đã tuyển', 'Chưa tuyển'],
            datasets: [{
                data: [enrolled, remain],
                backgroundColor: [
                    'rgba(0, 123, 255, 0.85)', // xanh dương đậm cho đã tuyển
                    'rgba(220, 220, 220, 0.8)' // xám nhạt cho chưa tuyển
                ],
                borderColor: ['#fff', '#fff'],
                borderWidth: 3
            }]
        },
        options: {
            rotation: -90,
            circumference: 180,
            cutout: '70%',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = enrolled + remain;
                            const percentage = Math.round((value / total) * 100);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                },
                datalabels: {
                    color: ['#fff', '#333'],
                    font: { weight: 'bold', size: 18 }, // Tăng kích thước từ 16 lên 18
                    formatter: function(value, context) {
                        const total = enrolled + remain;
                        const percentage = Math.round((value / total) * 100);
                        return percentage + '%';
                    }
                }
            }
        },
        plugins: [
            ChartDataLabels,
            {
                id: 'centerTextPlugin',
                afterDraw: function(chart) {
                    // Lấy kích thước chart
                    const width = chart.width;
                    const height = chart.height;
                    const ctx = chart.ctx;
                    
                    // Vị trí để vẽ text
                    const x = width / 2;
                    const y = height *0.95;
                    
                    ctx.save();
                    
                    // Vẽ số người đã tuyển - phóng to lên 30px
                    
                    ctx.font = 'bold 80px sans-serif'; // Thay Arial bằng sans-serif
                    ctx.fillStyle = '#268fff';
                    ctx.fillText('0{{ enrolled_patients|default:"0" }}', x-150, y);
                    
                    // Vẽ dấu gạch ngang - phóng to lên 22px
                    ctx.fillStyle = '#000000';
                    ctx.font = 'bold 80px sans-serif';
                    ctx.fillText('/', x-10, y);
                    
                    // Vẽ mục tiêu 750 - phóng to lên 18px
                    ctx.font = 'bold 80px sans-serif';
                    ctx.fillText('750', x + 20, y);
                    
                    
                    
                    ctx.restore();
                }
            }
        ]
    });

    // 1. Biểu đồ tích lũy bệnh nhân
    $.ajax({
        url: "{% url 'patient_cumulative_chart_data' %}",
        type: "GET",
        dataType: "json",
        success: function(response) {
            const data = response.data;
            const ctx = document.getElementById('patientCumulativeChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(item => item.month),
                    datasets: [{
                        label: '{% trans "Số bệnh nhân tích lũy" %}',
                        data: data.map(item => item.count),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40,167,69,0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'line' // Tất cả legend là icon line
                            }
                        }
                    }
                }
            });
        },
        error: function(error) {
            console.error("Lỗi khi tải dữ liệu biểu đồ tích lũy:", error);
            document.getElementById('patientCumulativeChart').innerHTML = 
                '<div class="alert alert-warning m-3 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Lỗi khi tải dữ liệu</div>';
        }
    });

    // 2. Biểu đồ so sánh screening
    $.ajax({
        url: "{% url 'screening_comparison_chart_data' %}",
        type: "GET",
        dataType: "json",
        success: function(response) {
            const data = response.data;
            const ctx = document.getElementById('screeningComparisonChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: '{% trans "Bệnh nhân" %}',
                            data: data.patients,
                            backgroundColor: 'rgba(0, 123, 255, 0.7)',
                            borderColor: '#007bff',
                            borderWidth: 1
                        },
                        {
                            label: '{% trans "Người tiếp xúc" %}',
                            data: data.contacts,
                            backgroundColor: 'rgba(23, 162, 184, 0.7)',
                            borderColor: '#17a2b8',
                            borderWidth: 1
                        },
                        {
                            label: '{% trans "Tích lũy (Bệnh nhân)" %}',
                            data: data.patientsCumulative,
                            type: 'line',
                            fill: false,
                            borderColor: '#dc3545',
                            tension: 0.1,
                            yAxisID: 'y1'
                        },
                        {
                            label: '{% trans "Tích lũy (Người tiếp xúc)" %}',
                            data: data.contactsCumulative,
                            type: 'line',
                            fill: false,
                            borderColor: '#28a745',
                            tension: 0.1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Số lượng hàng tháng'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: 'Số lượng tích lũy'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tháng'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        },
        error: function(error) {
            console.error("Lỗi khi tải dữ liệu biểu đồ so sánh:", error);
            document.getElementById('screeningComparisonChart').innerHTML = 
                '<div class="alert alert-warning m-3 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Lỗi khi tải dữ liệu</div>';
        }
    });

    // 3. Biểu đồ phân bố mẫu sinh học
    // function createSampleSummary(data, containerId) {
    //     const container = document.getElementById(containerId);
    //     container.innerHTML = '';
        
        // Tính tổng
        // const total = data.counts.reduce((sum, val) => sum + val, 0);
        
        // Tạo thẻ hiển thị cho mỗi loại mẫu
        // data.labels.forEach((label, index) => {
        //     const count = data.counts[index];
        //     const color = data.colors[index];
        //     const percentage = Math.round((count / total) * 100);
            
        //     const sampleItem = document.createElement('div');
        //     sampleItem.className = 'sample-item';
        //     sampleItem.style.backgroundColor = color + 'CC'; // Thêm độ trong suốt
        //     sampleItem.style.maxWidth = "100%"; // Giới hạn chiều rộng tối đa
        //     sampleItem.innerHTML = `
        //         <span class="sample-color" style="background-color: ${color}"></span>
        //         <span>${label}: <strong>${count}</strong> (${percentage}%)</span>
        //     `;
            
        //     container.appendChild(sampleItem);
        // });
        
        // Hiển thị tổng số mẫu
        // const totalItem = document.createElement('div');
        // totalItem.className = 'sample-item';
        // totalItem.style.backgroundColor = '#6c757d';
        // totalItem.style.maxWidth = "100%";
        // totalItem.innerHTML = `<span><strong>Tổng cộng: ${total}</strong></span>`;
        // container.appendChild(totalItem);
        
        // Hiển thị phần tổng hợp với delay
    //     setTimeout(() => {
    //         container.parentElement.style.display = 'block';
    //     }, 100);
    // }

    // Hiển thị loader
    // document.getElementById('patientSamplesChart').innerHTML = 
    //     '<div class="d-flex justify-content-center"><div class="spinner-border text-success" role="status"><span class="sr-only">Đang tải...</span></div></div>';
    // document.getElementById('contactSamplesChart').innerHTML = 
    //     '<div class="d-flex justify-content-center"><div class="spinner-border text-info" role="status"><span class="sr-only">Đang tải...</span></div></div>';

    // Tải dữ liệu phân bố mẫu
    // $.ajax({
    //     url: "{% url 'sample_distribution_chart_data' %}",
    //     type: "GET",
    //     dataType: "json",
    //     success: function(response) {
    //         const data = response.data;
            
    //         // Kiểm tra dữ liệu trả về
    //         if (!data || !data.patient || !data.contact) {
    //             console.error("Invalid data format returned from API");
    //             document.getElementById('patientSamplesChart').innerHTML = 
    //                 '<div class="alert alert-warning m-3 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Dữ liệu không hợp lệ</div>';
    //             document.getElementById('contactSamplesChart').innerHTML = 
    //                 '<div class="alert alert-warning m-3 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Dữ liệu không hợp lệ</div>';
    //             return;
    //         }
            
            // Vẽ biểu đồ cho bệnh nhân
            // if (data.patient.labels.length > 0) {
            //     const patientCtx = document.getElementById('patientSamplesChart').getContext('2d');
            //     new Chart(patientCtx, {
            //         type: 'doughnut',
            //         data: {
            //             labels: data.patient.labels,
            //             datasets: [{
            //                 data: data.patient.counts,
            //                 backgroundColor: data.patient.colors,
            //                 borderWidth: 1
            //             }]
            //         },
            //         options: {
            //             animation: false, // Tắt animation cho biểu đồ này
            //             plugins: {
            //                 legend: {
            //                     position: 'bottom',
            //                     labels: {
            //                         boxWidth: 12,
            //                         padding: 15
            //                     }
            //                 },
            //                 tooltip: {
            //                     callbacks: {
            //                         label: function(context) {
            //                             const label = context.label || '';
            //                             const value = context.raw || 0;
            //                             const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
            //                             const percentage = Math.round((value / total) * 100);
            //                             return `${label}: ${value} (${percentage}%)`;
            //                         }
            //                     }
            //                 }
            //             },
            //             cutout: '60%'
            //         }
            //     });
                
                // Thêm delay trước khi tạo phần tổng hợp mẫu
            //     setTimeout(() => {
            //         createSampleSummary(data.patient, 'patientSampleSummary');
            //     }, 100);
            // } else {
            //     document.getElementById('patientSamplesChart').innerHTML = 
            //         '<div class="text-center p-5 text-muted">Không có dữ liệu mẫu của bệnh nhân</div>';
            // }
            
            // Vẽ biểu đồ cho người tiếp xúc
            // if (data.contact.labels.length > 0) {
            //     const contactCtx = document.getElementById('contactSamplesChart').getContext('2d');
            //     new Chart(contactCtx, {
            //         type: 'doughnut',
            //         data: {
            //             labels: data.contact.labels,
            //             datasets: [{
            //                 data: data.contact.counts,
            //                 backgroundColor: data.contact.colors,
            //                 borderWidth: 1
            //             }]
            //         },
            //         options: {
            //             animation: false, // Tắt animation cho biểu đồ này
            //             plugins: {
            //                 legend: {
            //                     position: 'bottom',
            //                     labels: {
            //                         boxWidth: 12,
            //                         padding: 15
            //                     }
            //                 },
            //                 tooltip: {
            //                     callbacks: {
            //                         label: function(context) {
            //                             const label = context.label || '';
            //                             const value = context.raw || 0;
            //                             const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
            //                             const percentage = Math.round((value / total) * 100);
            //                             return `${label}: ${value} (${percentage}%)`;
            //                         }
            //                     }
            //                 }
            //             },
            //             cutout: '60%'
            //         }
            //     });
                
                // Thêm delay trước khi tạo phần tổng hợp mẫu
    //             setTimeout(() => {
    //                 createSampleSummary(data.contact, 'contactSampleSummary');
    //             }, 100);
    //         } else {
    //             document.getElementById('contactSamplesChart').innerHTML = 
    //                 '<div class="text-center p-5 text-muted">Không có dữ liệu mẫu của người tiếp xúc</div>';
    //         }
    //     },
    //     error: function(error) {
    //         console.error("Lỗi khi tải dữ liệu phân bố mẫu:", error);
    //         document.getElementById('patientSamplesChart').innerHTML = 
    //             '<div class="alert alert-warning m-3 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Lỗi khi tải dữ liệu</div>';
    //         document.getElementById('contactSamplesChart').innerHTML = 
    //             '<div class="alert alert-warning m-3 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Lỗi khi tải dữ liệu</div>';
    //     }
    // });

    // Vẽ biểu đồ phân bố giới tính
    $.ajax({
        url: "{% url 'gender_distribution_chart_data' %}",
        type: "GET",
        dataType: "json",
        success: function(response) {
            const patientData = response.data.patient;
            const contactData = response.data.contact;
            
            // Vẽ biểu đồ giới tính của bệnh nhân
            const patientCtx = document.getElementById('patientGenderChart').getContext('2d');
            new Chart(patientCtx, {
                type: 'pie',
                data: {
                    labels: patientData.labels,
                    datasets: [{
                        data: patientData.data,
                        backgroundColor: patientData.colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = patientData.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold' },
                            formatter: function(value, context) {
                                const total = patientData.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return percentage + '%';
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
            
            // Vẽ biểu đồ giới tính của người tiếp xúc
            const contactCtx = document.getElementById('contactGenderChart').getContext('2d');
            new Chart(contactCtx, {
                type: 'pie',
                data: {
                    labels: contactData.labels,
                    datasets: [{
                        data: contactData.data,
                        backgroundColor: contactData.colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = contactData.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold' },
                            formatter: function(value, context) {
                                const total = contactData.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return percentage + '%';
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        },
        error: function(error) {
            console.error("Error loading gender distribution data:", error);
        }
    });

    $.ajax({
        url: "{% url 'patient_enrollment_chart_data' %}",
        type: "GET",
        dataType: "json",
        success: function(response) {
            const data = response.data;
            const ctx = document.getElementById('patientEnrollmentChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: '{% trans "Số bệnh nhân tham gia theo tháng" %}',
                            data: data.monthly,
                            backgroundColor: 'rgba(0, 123, 255, 0.7)',
                            borderColor: '#007bff',
                            borderWidth: 1
                        },
                        {
                            label: '{% trans "Số lượng tích lũy" %}',
                            data: data.cumulative,
                            type: 'line',
                            fill: false,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y1'
                        },
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '{% trans "Số lượng hàng tháng" %}'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            title: {
                                display: true,
                                text: '{% trans "Số lượng tích lũy" %}'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '{% trans "Tháng" %}'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        },
        error: function(error) {
            console.error("Lỗi khi tải dữ liệu biểu đồ tham gia:", error);
            document.getElementById('patientEnrollmentChart').innerHTML = 
                '<div class="alert alert-warning m-3 text-center"><i class="fas fa-exclamation-triangle mr-2"></i>Lỗi khi tải dữ liệu</div>';
        }
    });

});
</script>
{% endblock %}